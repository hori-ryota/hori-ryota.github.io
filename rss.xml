<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Hori Blog RSS Feed]]></title><description><![CDATA[フリーランスでバックエンドエンジニアとして活動している Ryota Hori のブログです。ドメイン駆動設計や Go の話など。]]></description><link>https://hori-ryota.com</link><generator>GatsbyJS</generator><lastBuildDate>Tue, 22 Sep 2020 02:41:21 GMT</lastBuildDate><item><title><![CDATA[Gatsby.jsとBulmaでブログをリニューアルした]]></title><description><![CDATA[全然ブログを更新していなかったので久々に書こうと思い、勢いでリニューアルしました。これまではHugoを使っていたのですが、今回はGatsby.jsとBulmaを組み合わせてみました。 乗り換えにあたって検討したことと、Gatsby.jsとBulmaで苦労したこと、調整したことなどを残しておきます。]]></description><link>https://hori-ryota.com/blog/2020-09-22-revamp-blog-with-gatsby-and-bulma/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2020-09-22-revamp-blog-with-gatsby-and-bulma/</guid><pubDate>Tue, 22 Sep 2020 03:00:00 GMT</pubDate><content:encoded>&lt;p&gt;全然ブログを更新していなかったので久々に書こうと思い、勢いでリニューアルしました。これまではHugoを使っていたのですが、今回はGatsby.jsとBulmaを組み合わせてみました。&lt;/p&gt;
&lt;p&gt;乗り換えにあたって検討したことと、Gatsby.jsとBulmaで苦労したこと、調整したことなどを残しておきます。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;HugoからGatsby.jsに乗り換えた理由&lt;/h2&gt;
&lt;p&gt;HugoはGo製の静的サイトジェネレータで、登場時には既存ツールに比べてとにかく爆速で話題でした。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://gohugo.io/&quot;&gt;The world’s fastest framework for building websites | Hugo&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;とりあえずMarkdownで記事を書いておけば移植性も高いと思い軽いノリで導入したのですが、たしかに爆速で移植性も高くいい感じでした。&lt;/p&gt;
&lt;p&gt;一方でどうしても使いこなせなかった点がいくつかありました。&lt;/p&gt;
&lt;p&gt;Hugoを導入したのは2015年なので今では改善されている問題も多いですが、Hugoを調整するよりもGatsby.jsに乗り換える方がベターと判断して乗り換えました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.gatsbyjs.com/&quot;&gt;Gatsby&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;以下、乗り換えの動機です。&lt;/p&gt;
&lt;h3&gt;Goのtemplateがつらかった&lt;/h3&gt;
&lt;p&gt;HugoはGo製なので、themeのテンプレートはGoのtemplateです。詳細は省きますがあまりHTMLの出力に適しているとはいい難く、自作テーマを作成する気にはならず既存のテーマを拝借していました。&lt;/p&gt;
&lt;p&gt;Gatsby.jsはReactベースなのでHTML出力に適しているだけでなく、各種の最適化もいい感じに行ってくれるので自作テーマの作りやすさが段違いでした。&lt;/p&gt;
&lt;h3&gt;Hugoでは画像の扱いが面倒&lt;/h3&gt;
&lt;p&gt;Markdownの画像記法だけでは &lt;code class=&quot;language-text&quot;&gt;width&lt;/code&gt; や &lt;code class=&quot;language-text&quot;&gt;height&lt;/code&gt; のパラメータが入るわけでもなく、また画像の最適化も自動ではやってくれません。Exif情報などのメタデータも削除してくれないので単体では使い勝手が満足できませんでした。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://gohugo.io/content-management/shortcodes/&quot;&gt;HugoにはShortcodeと呼ばれる独自記法&lt;/a&gt;があり、これを用いることで対処はできるのですが求めていたのはシンプルなMarkdownでの記事作成だったので欲求に合わず。&lt;/p&gt;
&lt;p&gt;最終的には自作ツールで画像の変換をかけつつ、パラメータ指定は気にせずに大きな画像をそのまま提供している状態でした。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/create-shellscript-for-hugo-images/&quot;&gt;Hugo のサムネ作成、画像追加、画像最適化を自動化するシェル芸 | Hori Blog&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;なお、今ではHugoも &lt;a href=&quot;https://gohugo.io/content-management/image-processing/&quot;&gt;Image Processing&lt;/a&gt; という名で画像周りの前処理は挟めるようですが、表示側の調整は今でもshortcodeを用いるようです。&lt;/p&gt;
&lt;p&gt;Gatsby.jsでは（pluginを入れれば）shortcodeを用いずに画像の事前処理も表示分けもできる上、テーマ側でも難しい条件分岐をせずにシンプルな記載で適用できるのでとても楽でした。&lt;/p&gt;
&lt;h3&gt;Hugoのテーマの移植性の低さ&lt;/h3&gt;
&lt;p&gt;これはGatsby.jsで解決されているわけではないですが、Gatsby.jsでは自作テーマを用いるので気にならなかった点です。&lt;/p&gt;
&lt;p&gt;HugoにはMarkdownで記載することによるテーマ間の移植性の高さを期待していたのですが、試したテーマの範囲では互換性の低さが目立ちました。全体設定ファイルのパラメータ名だけでなく、パラメータの書式（camelCaseとか）も異なり、また記事ファイルに記載するfrontmatter（メタデータ）の記法もバラバラだったため、テーマ変更の手間は大きかったです。&lt;/p&gt;
&lt;h3&gt;最速である必要はない&lt;/h3&gt;
&lt;p&gt;Hugoは確かに爆速ではあるのですが、最終的にはテキスト処理の爆速については自分のユースケースでは以下の理由でメリットが薄くなりました。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ボトルネックは画像の最適化処理であり、記事生成の速度はあまり差別化にならなかった&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;記事数がとっても多くなったらまた考えればいい&lt;/li&gt;
&lt;li&gt;画像の最適化処理がHugoで高速な可能性もあるが、必要があれば自前で処理を切り出せばいい&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;速度が欲しくなるのは全ファイルの生成ではなくlive reload時の速度であり、これはGatsby.jsも十分に速かった&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;各種の最適化の恩恵を受けたかった&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.gatsbyjs.com/#gatsby-is-fast&quot;&gt;gatsby-is-fast | Gatsby&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;表示が爆速。フロント周りの知識は弱いのですが、そんなに苦労せずいい感じに作れて満足。&lt;/p&gt;
&lt;h2&gt;Bulmaの使用&lt;/h2&gt;
&lt;p&gt;見た目へのこだわりは薄く「それっぽくいい感じ」であれば満足だったのですが、既存のテーマで丁度いいものがなかったので自作しました。&lt;/p&gt;
&lt;p&gt;デザインは&lt;a href=&quot;https://www.gatsbyjs.com/docs/bulma/&quot;&gt;Gatsby.jsのドキュメントで紹介されていた&lt;/a&gt;こともありCSSフレームワークのBulmaを使用しました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://bulma.io/&quot;&gt;Bulma: Free, open source, and modern CSS framework based on Flexbox&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;さくさくそれっぽく作れていい感じだったのですが、クラス名のスコープがグローバルなのでCode Highlightのライブラリなどと競合して思ったより辛かったです。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/jgthms/bulma/issues/302&quot;&gt;please namespace all classes · Issue #302 · jgthms/bulma&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;作る際に工夫＆調整したあれこれ&lt;/h2&gt;
&lt;p&gt;Gatsby.jsとBulmaでいくつか工夫や調整が必要だったところがあったので参考になるかと思い残しておきます。&lt;/p&gt;
&lt;h3&gt;BulmaとPrism.jsの競合&lt;/h3&gt;
&lt;p&gt;Bulmaはシンプルなclass名を使用させたいようなのですが、めっちゃ競合しました。仕方ないので &lt;code class=&quot;language-text&quot;&gt;inherit&lt;/code&gt; を当てまくって対処。うーむ…&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;layout.scss&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scss&quot;&gt;&lt;pre class=&quot;language-scss&quot;&gt;&lt;code class=&quot;language-scss&quot;&gt;&lt;span class=&quot;token selector&quot;&gt;article .content &lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token selector&quot;&gt;.tag, .number, .table, .title &lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;display&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inline&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;padding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inherit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inherit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;line-height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inherit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;text-align&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inherit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;vertical-align&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inherit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;border-radius&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inherit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;font-weight&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inherit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;white-space&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inherit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;background&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inherit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;margin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; inherit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Gatsby.jsでremarkすると &lt;code class=&quot;language-text&quot;&gt;li&lt;/code&gt; 要素の入れ子が崩れる&lt;/h3&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;article.md&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;markdown&quot;&gt;&lt;pre class=&quot;language-markdown&quot;&gt;&lt;code class=&quot;language-markdown&quot;&gt;&lt;span class=&quot;token list punctuation&quot;&gt;-&lt;/span&gt; foo
    &lt;span class=&quot;token list punctuation&quot;&gt;-&lt;/span&gt; bar
    &lt;span class=&quot;token list punctuation&quot;&gt;-&lt;/span&gt; baz&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;みたいな要素があると&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;article.html&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;ul&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;li&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;p&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;foo&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;p&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;ul&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;li&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;bar&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;li&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;li&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;baz&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;li&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;ul&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;li&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;ul&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;のように &lt;code class=&quot;language-text&quot;&gt;&amp;lt;p&amp;gt;&lt;/code&gt; タグが入るためmarginなどが適用されズレました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/gatsbyjs/gatsby/issues/10870&quot;&gt;[gatsby-transformer-remark] Nested lists inserting rogue paragraphs · Issue #10870 · gatsbyjs/gatsby&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;これはmdastのListItem要素でtextがparagraph要素として入ってくることによる挙動だと思います。出力を調整して &lt;code class=&quot;language-text&quot;&gt;&amp;lt;p&amp;gt;&lt;/code&gt; タグが入らなくしてもいいのですが、意識が低いのでCSSだけで対処。ついでに &lt;code class=&quot;language-text&quot;&gt;&amp;lt;ul&amp;gt;&lt;/code&gt; &lt;code class=&quot;language-text&quot;&gt;&amp;lt;ol&amp;gt;&lt;/code&gt; のmarginも気に入らなかったので &lt;code class=&quot;language-text&quot;&gt;&amp;lt;li&amp;gt;&lt;/code&gt; と同じに調整。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;layout.scss&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scss&quot;&gt;&lt;pre class=&quot;language-scss&quot;&gt;&lt;code class=&quot;language-scss&quot;&gt;&lt;span class=&quot;token selector&quot;&gt;article .content li &lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token selector&quot;&gt;&lt;span class=&quot;token parent important&quot;&gt;&amp;amp;&lt;/span&gt; &gt; p &lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;margin-bottom&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 0 &lt;span class=&quot;token important&quot;&gt;!important&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token selector&quot;&gt;&lt;span class=&quot;token parent important&quot;&gt;&amp;amp;&lt;/span&gt; &gt; ul, &lt;span class=&quot;token parent important&quot;&gt;&amp;amp;&lt;/span&gt; &gt; ol &lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;margin-top&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 0.25em &lt;span class=&quot;token important&quot;&gt;!important&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;embed系の埋め込み&lt;/h3&gt;
&lt;p&gt;HugoではSpeakerdeckはshortcodeで、Twitterはembed用HTMLを直書きしていたのですがGatsbyではプラグインでembed用のHTMLを差し込むようにしました。&lt;/p&gt;
&lt;p&gt;まず前提として、このブログでは（今のところ）参考リンク系は以下のような書式で書いています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;markdown&quot;&gt;&lt;pre class=&quot;language-markdown&quot;&gt;&lt;code class=&quot;language-markdown&quot;&gt;&lt;span class=&quot;token blockquote punctuation&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token url&quot;&gt;[&lt;span class=&quot;token content&quot;&gt;title&lt;/span&gt;](url)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この形式で該当のURLが貼られたときにembed用のHTMLと差し替える処理を入れていきます。&lt;/p&gt;
&lt;p&gt;remarkでの処理差し込みは公式ドキュメントに記載があるので、こちらのやり方で実施しました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.gatsbyjs.com/tutorial/remark-plugin-tutorial/&quot;&gt;Creating a Remark Transformer Plugin | Gatsby&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;./plugins/remark-custom/package.json&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;private&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;remark-custom&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;index.jsx&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;./plugins/remark-custom/index.jsx&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; visit &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;unist-util-visit&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; fetch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;node-fetch&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;isOuterUrl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;url&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token regex&quot;&gt;/^https?:\/\//&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;exports&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; markdownAST &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; oembedTarget &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// link to iframely&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;visit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;markdownAST&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;blockquote&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;blockquote&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;blockquote&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;blockquote&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;paragraph&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; paragraph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; blockquote&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;paragraph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;paragraph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;link&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; link &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; paragraph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isOuterUrl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;link&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    oembedTarget&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;blockquote&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; Promise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    oembedTarget&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; link &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;link&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;startsWith&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;https://speakerdeck.com/&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; res &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;https://speakerdeck.com/oembed.json?url=&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; link&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; json &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;html&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;lt;div
          style=&quot;position: relative; width:100%; height:0; padding-top:&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;height &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;width&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;%;&quot;
          &gt;
          &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;html&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token regex&quot;&gt;/width=&quot;\d+&quot;/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;width=100%&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token regex&quot;&gt;/height=&quot;\d+&quot;/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;height=&quot;100%&quot;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;style=&quot;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;style=&quot;position:absolute;top:0;left:0;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
          &amp;lt;/div&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;link&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;startsWith&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;https://twitter.com/&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; res &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;https://publish.twitter.com/oembed?omit_script=true&amp;amp;url=&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; link&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; json &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;html&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;html&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; markdownAST&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;gatsby-config.js&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;module.exports = &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
~~~
~~~
  plugins&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
~~~
~~~
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      resolve&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; `gatsby-transformer-remark`&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      options&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
~~~
~~~
        plugins&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
~~~
~~~
          `remark-custom`&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
~~~
~~~&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;いったん動けばいいやのオレオレで作っているので汚いのはご容赦ください。後にリファクタの上、キャッシュを入れてリクエスト頻度を減らしたりsleep処理を入れる予定です。&lt;/p&gt;
&lt;p&gt;いくつかの対応が混在しているので分解して紹介します。&lt;/p&gt;
&lt;h4&gt;該当する書式の取得&lt;/h4&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;./plugins/remark-custom/index.jsx&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token function&quot;&gt;visit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;markdownAST&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;blockquote&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;blockquote&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;blockquote&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;blockquote&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;paragraph&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; paragraph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; blockquote&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;paragraph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;paragraph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;link&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; link &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; paragraph&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isOuterUrl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;link&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  oembedTarget&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;blockquote&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;blockquote（&lt;code class=&quot;language-text&quot;&gt;&amp;gt;&lt;/code&gt;）内にlink（&lt;code class=&quot;language-text&quot;&gt;[]()&lt;/code&gt;）が1つしかない要素を拾っています。また、内部リンクは処理しないので &lt;code class=&quot;language-text&quot;&gt;isOuterUrl(link.url)&lt;/code&gt; でフィルタリングしています。&lt;/p&gt;
&lt;p&gt;外部リクエストが生じるので一旦 &lt;code class=&quot;language-text&quot;&gt;push&lt;/code&gt; して保持した上で以下の処理で回しています。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;./plugins/remark-custom/index.jsx&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; Promise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  oembedTarget&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; link &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;oEmbedからembed用のHTMLを取得&lt;/h4&gt;
&lt;p&gt;SpeakerdeckもTwitterもoEmbed機能に対応しているため、Getリクエストでデータを取得します。以下はTwitterの処理。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;./plugins/remark-custom/index.jsx&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;link&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;startsWith&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;https://twitter.com/&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; res &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;https://publish.twitter.com/oembed?omit_script=true&amp;amp;url=&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; link&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; json &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;html&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;children &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;html&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ASTを編集するのではなく、 &lt;code class=&quot;language-text&quot;&gt;target.type&lt;/code&gt; を &lt;code class=&quot;language-text&quot;&gt;html&lt;/code&gt; にすれば &lt;code class=&quot;language-text&quot;&gt;target.value&lt;/code&gt; にHTMLを入れるだけで差し替えが可能です。&lt;/p&gt;
&lt;p&gt;Twitterの場合は &lt;code class=&quot;language-text&quot;&gt;omit_script=true&lt;/code&gt; をつけてwidget用のscriptを読み込まないようにしています。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.twitter.com/en/docs/twitter-api/v1/tweets/post-and-engage/api-reference/get-statuses-oembed&quot;&gt;GET statuses/oembed | Docs | Twitter Developer&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;その上でpluginを入れて横断的にscriptを読み込んでいます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.gatsbyjs.com/plugins/gatsby-plugin-twitter/&quot;&gt;gatsby-plugin-twitter | Gatsby&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4&gt;Speakerdeckの表示を調整&lt;/h4&gt;
&lt;p&gt;現在（2020-09-21）取れるSpeakerdeckのEmbed用HTMLではwidth, heightが固定値でスマートフォンなどでの閲覧時にはみ出ます。これを防ぐためHTMLを置換しています。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;./plugins/remark-custom/index.jsx&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;lt;div
  style=&quot;position: relative; width:100%; height:0; padding-top:&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;height &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;width&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;%;&quot;
  &gt;
  &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;html&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token regex&quot;&gt;/width=&quot;\d+&quot;/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;width=100%&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token regex&quot;&gt;/height=&quot;\d+&quot;/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;height=&quot;100%&quot;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;style=&quot;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;style=&quot;position:absolute;top:0;left:0;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
  &amp;lt;/div&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;汚い対応ですが、パーツへの対応が凝集されているのでヨシとしています。&lt;/p&gt;
&lt;h2&gt;その他やったこと&lt;/h2&gt;
&lt;h3&gt;Cloudflareを挟んでいたのをやめた&lt;/h3&gt;
&lt;p&gt;Cloudflare + GitHub Pagesの構成だったのですが、GitHub PagesがカスタムドメインのHTTPSに対応したのでお役御免となりました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.blog/2018-05-01-github-pages-custom-domains-https/&quot;&gt;Custom domains on GitHub Pages gain support for HTTPS - The GitHub Blog&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;CIでの更新を止めた&lt;/h3&gt;
&lt;p&gt;masterブランチにpushしたらCircleCIで更新するようにしていたのですが、ブログの更新作業とは合わないのでやめました。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;編集 → 更新 → 確認&lt;/code&gt; までが1サイクルであり、確認がCIで自動化できていない場合に中間の &lt;code class=&quot;language-text&quot;&gt;更新&lt;/code&gt; を非同期的にやる利点はない&lt;/li&gt;
&lt;li&gt;逆に &lt;code class=&quot;language-text&quot;&gt;更新&lt;/code&gt; を非同期的にCIで行うために生じるオーバーヘッドが大きい&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;更新処理の冪等性はGatsby.jsにより十分に保たれており、また &lt;code class=&quot;language-text&quot;&gt;gatsby clean&lt;/code&gt; による掃除もできるので「綺麗な環境」で処理する必要はない&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;もし必要ならDockerとかでいい&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;自分のプライベートPCでしか作業しないので環境差分を考慮する必要も薄い&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;スマートフォンなどから更新したくなったらgit push起点じゃない明示実行でなにか用意することはあるかも&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;という感じで、今はpublish用のShell Scriptを用意して使っています。&lt;/p&gt;
&lt;h2&gt;おわり&lt;/h2&gt;
&lt;p&gt;Gatsby.jsいいですね。フロント周りの知識は全然追えてないのですが、それでもいい感じのレイアウトとLighthouseでぼちぼちのスコアを手に入れました。爆速です。&lt;/p&gt;
&lt;p&gt;Twitterのwidgetを入れるとスコアが下がるのが悲しいところ。&lt;/p&gt;
&lt;p&gt;SEOのスコアが &lt;code class=&quot;language-text&quot;&gt;Links do not have descriptive text&lt;/code&gt; で上がりきっていないですが &lt;code class=&quot;language-text&quot;&gt;more&lt;/code&gt; ボタンはともかくtagの &lt;code class=&quot;language-text&quot;&gt;Go&lt;/code&gt; が引っかかってしまっているのはどうするのがいいのやら。&lt;/p&gt;
&lt;p&gt;それはそれとして、これ。&lt;/p&gt;
&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;blogを更新しようと思う度にリニューアルに手を付けてしまうので一生書けない（今回はgatsbyとbulmaで作ってみる予定）&lt;/p&gt;&amp;mdash; hori (@hori_ryota) &lt;a href=&quot;https://twitter.com/hori_ryota/status/1304743938444521472?ref_src=twsrc%5Etfw&quot;&gt;September 12, 2020&lt;/a&gt;&lt;/blockquote&gt;

&lt;p&gt;サムネイルも必須じゃない形式にしたので更新のハードルは下がったはず。きっとこれからは書く。はず。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[DDDの個人的な現状 in 2019]]></title><description><![CDATA[個人的な話となり恐縮ですが、2019年はドメイン駆動設計の戦術周りでたくさんの試行錯誤ができた有意義な年となりました。 活動していく中で課題感に共感を得られたり方向性の違いを実感できたり学びが多かったので、雑記として残しておこうかと思います。]]></description><link>https://hori-ryota.com/blog/2019-12-24-ddd-in-2019/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2019-12-24-ddd-in-2019/</guid><pubDate>Tue, 24 Dec 2019 02:00:00 GMT</pubDate><content:encoded>&lt;p&gt;個人的な話となり恐縮ですが、2019年はドメイン駆動設計の戦術周りでたくさんの試行錯誤ができた有意義な年となりました。&lt;/p&gt;
&lt;p&gt;活動していく中で課題感に共感を得られたり方向性の違いを実感できたり学びが多かったので、雑記として残しておこうかと思います。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;&lt;a href=&quot;https://qiita.com/advent-calendar/2019/ddd-1&quot;&gt;ドメイン駆動設計#1 Advent Calendar 2019&lt;/a&gt;の記事です。&lt;/p&gt;
&lt;h2&gt;今年やったこと&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;「人間がやるべき本質的作業だけに注力しよう」を掲げてDDDを導入&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;プロジェクトがビジネス上の事情で霧散しがち&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;フルスクラッチでDDD！を繰り返せて幸運…？&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;DDDを狙ったcode generatorを作成&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/blog/create-go-genconstructor/&quot;&gt;DDD するのに Go でも required を表現したくて go-genconstructor を作った&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/blog/create-go-genaccessor/&quot;&gt;DDD がしたいので Go の Accessor を go generate する go-genaccessor を作った&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/blog/create-go-generror/&quot;&gt;表現力の高い Go の Error 群を go generate する go-generror を作った&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/hori-ryota/go-genappevent&quot;&gt;hori-ryota/go-genappevent&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/hori-ryota/go-genapi&quot;&gt;hori-ryota/go-genapi&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;↑はすべて &lt;a href=&quot;https://github.com/hori-ryota/go-codegen&quot;&gt;hori-ryota/go-codegen&lt;/a&gt; に移植中&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;登壇した&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://speakerdeck.com/horiryota/gorasisatogo-generate&quot;&gt;Goらしさとgo generate - Speaker Deck&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://speakerdeck.com/horiryota/microservicestobffdecheng-sitakatutashi-jie&quot;&gt;MicroservicesとBFFで成したかった世界 - Speaker Deck&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://speakerdeck.com/horiryota/dddnaragai-nian-ceng-dakehong-tuteitai-with-code-generator&quot;&gt;DDDなら概念層だけ触っていたい！ with Code Generator - Speaker Deck&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;9月くらいから休憩中なこともあってgenerator芸が未達なのが残念。&lt;/p&gt;
&lt;h2&gt;DDDのスタンスについて&lt;/h2&gt;
&lt;p&gt;DDDのスタンスは色々な方向性があり、方向性を共有せずにDDDの各要素の話をすると混乱が生じやすいことを学びました。&lt;/p&gt;
&lt;p&gt;前提として私のスタンスを述べておきます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;概念を実装する層では&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;o: 想定する概念をなるべく率直に表現したい&lt;/li&gt;
&lt;li&gt;x: 実際に使う概念のみ表現する&lt;/li&gt;
&lt;li&gt;x: 特定の要素（ルールや計算）に特化して実装する&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;DRY (Don’t Repeat Yourself) については&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;o: 変更欲求に対してDRYであることが重要&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;x: なんども使うから共通化&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;o: コードの重複ではなく変更（削除）しやすいほうが重要&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;チームの結合度と概念の結合度について&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;x: 通信を挟むなら（チームも別だし）相互に疎に開発できるよう結合度を下げたい&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;o: APIの両端は密結合なのだから概念の結合度に開発を寄せたい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;実装上は疎結合っぽくしているけど実質は概念も人間も密結合なのが嫌&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;色々ありますが、基本的には「概念が主、解決手段が従」に偏重させようとしています。&lt;/p&gt;
&lt;p&gt;もしよければ &lt;a href=&quot;https://hori-ryota.com/blog/starting-development-with-ddd/&quot;&gt;継続的に価値を提供するドメイン駆動設計入門&lt;/a&gt; も併せて読んでいただけると勘所を押さえられるかと思います。&lt;/p&gt;
&lt;h2&gt;最近の個人的なDDD&lt;/h2&gt;
&lt;p&gt;今年は新規立ち上げプロジェクトには恵まれたのですが、プロジェクト継続には恵まれない一年でした。&lt;/p&gt;
&lt;p&gt;DDDによるサービス立ち上げを複数行ってみて、個人的に思うことが色々とあったので所感を記しておきます。&lt;/p&gt;
&lt;h3&gt;概念層以外を手実装するのはかなり厳しい&lt;/h3&gt;
&lt;p&gt;DDDの実装は二層に大別されます。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;概念層&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;対象アプリケーションの概念を実装で &lt;strong&gt;表現&lt;/strong&gt; する層&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;非概念層&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;対象アプリケーション外との帳尻合わせ、技術的詳細&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;概念層を概念表現に特化させるため、非概念層は概念層の変更に強く依存することになります。&lt;/p&gt;
&lt;p&gt;となると、概念に対し概念層をDRYに保てる一方で、非概念層にも変更が生じるのでDRY原則に反します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 371px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c66a959b96b0b8ef6e6f8c11951e8bd8/d4635/fig1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+klEQVQoz12Sz3PSQBTH+Zs9OmPHq/XoRafjpfZQe/CiHbGYOiX8GALZgoWSwsoPhZAGkmx+EDbZX24AKfgm2d3se5/d73svOSEEF/vGOKNySmwTIy/b4If+PcsJwnhK5SNSSleUUb45bfTtyiiV1uwTnKbpYjG27R5CdgYPjGfW+GgCn5vDF6F15PfPFoN27PvTys9Zf7QHZ7PEdHAKwIf5XA0CP6dXXrYbx/fguN149avzult/Y4ByOF+g3jiYWHuys9Fxfg8GX8ajS9uux3GcSxKBsVjhbIxjuciCJnBYKBRq5Qr2w/20KeNoYXmuGUbhOudD4ylhQZRg7LgO8hHxlwwnG9GZbs5ZQgTffh7AnFDftIMwjJZLKsuHV9JSL2SUbgNkK9Zn/av2jpQvTps6+HhxoXxXNE1TFKUPoXSkKGy1WlCuhTDanWq1CgCIoujgZrZcea7z0HtwXddam7w5S1Xuzx4xJYLQKAg8z/N9X0rL7fQklHtDa4WW//8K62JhJwqnbjB1GKFPsjdtROhxZtVNqM5Nrd250vUfhLBdkwllkxGYGsoMqpXyJwjvN64t7KE/zebpjfpOLZ/U6++LxfMgiHdwkhAIC2r5bbF0omky4PoQ9mxd/wr0vFa7vLsrAHCDcbqDGeOGUdNqn/VG/vY23+22Nq6/yavSjlO0PmkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;非概念層を実装しなければいけない様子の図&quot;
        title=&quot;非概念層を実装しなければいけない様子の図&quot;
        src=&quot;/static/c66a959b96b0b8ef6e6f8c11951e8bd8/d4635/fig1.png&quot;
        srcset=&quot;/static/c66a959b96b0b8ef6e6f8c11951e8bd8/12f09/fig1.png 148w,
/static/c66a959b96b0b8ef6e6f8c11951e8bd8/e4a3f/fig1.png 295w,
/static/c66a959b96b0b8ef6e6f8c11951e8bd8/d4635/fig1.png 371w&quot;
        sizes=&quot;(max-width: 371px) 100vw, 371px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;つまり、変更箇所が散り、作業の工数が負担となるため概念と概念層の成長に負の影響が生じてしまいます。&lt;/p&gt;
&lt;p&gt;非概念層への作業は非概念層の事情のみに依存し、概念層の変更には（ほぼ）自動で追従して欲しいと実感しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 306px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/60cade1b9c8f9aa7a1d8f1042d5b685b/98b92/fig2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70.94594594594594%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAAByUlEQVQoz4VTWW/aQBD2/1cf8lb6UKlSq7ZESQ8MgTjGURpoqrqJ7aQkdrBTgwEn4APwtes96Dqmal8az65Wc+y338xolts8KRTjbOaQHG1NSv+Ncv/HFffwOv755uV4oJeePM+jKPB9N4rW1WCSwYt6+952Ch1T2/5+eblrmrzjfFmvl9ymIm867SsgSpiKcjwedU9Oaqr6zve7njepYF658+mVHk7vS99sdjt3+4t5fzS6gBBWMHeEQ77V/Hp2VpoEk9UiiOIEIfRkzQX5BhMcP3gwy7bgPKcI/8mLVtXMGp4AFKc5Quw6SgHMAMaYEFLFXHAzOqqfa0ddkfG7I0cURUmSZFlmT1R2uzjSRQgApKwGkAMAsjRlJxsYDkKmJMwDAHOlEGb0cZKYELYe4auJuxza4fBXEgR083fIONP85jgdy2qPx4Kq7u3WnxmqYuq3n/b2xc7hlaJ5D7OhwVt6wzKaR0Ltc+MVAHk5qpzjyJr2utXakaTa8fGLO/Njr75PYxDN/dQPYRh5E1tR3nal53xzx7r70Ou9Xy6jLdgwzlWV17S2ph0MBoL8o3FtXBdtIqT8BkHoqeoBi7J9cyOcnjbTNCvBvwH31hG9uIf2+gAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;非概念層を自動反映にした場合の図&quot;
        title=&quot;非概念層を自動反映にした場合の図&quot;
        src=&quot;/static/60cade1b9c8f9aa7a1d8f1042d5b685b/98b92/fig2.png&quot;
        srcset=&quot;/static/60cade1b9c8f9aa7a1d8f1042d5b685b/12f09/fig2.png 148w,
/static/60cade1b9c8f9aa7a1d8f1042d5b685b/e4a3f/fig2.png 295w,
/static/60cade1b9c8f9aa7a1d8f1042d5b685b/98b92/fig2.png 306w&quot;
        sizes=&quot;(max-width: 306px) 100vw, 306px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;現状の解決策はcode generatorによる依存実装の自動生成ですが、Go言語との相性の良さもありそれなりに形になってきています。&lt;/p&gt;
&lt;h3&gt;自分がドメインエキスパートになる気概が必要&lt;/h3&gt;
&lt;p&gt;体制によると思いますが、最もボトルネックになりがちなのがドメインエキスパートの時間確保でした。加えて、世にないサービスを新しく生むプロジェクトの場合、ドメインエキスパートは部分的なエキスパートでしかない場合も多いのではないでしょうか。&lt;/p&gt;
&lt;p&gt;モデリングの初稿はともかく、実装との相互作用による昇華を狙う場合、すべてをドメインエキスパートに確認してから実装するのでは試行錯誤の量が足りませんでした。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 363px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ec0067478b25ec169d091cc26d9d39a4/4e786/fig3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 79.05405405405406%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsSAAALEgHS3X78AAACC0lEQVQoz4VSXXPSQBTllzrjOOODY3+SgH1wfNFR62hxtHVsbUWaBAIEmmn4KiQ0hE2ymyXZr8R8gAqt9T7sZu/ec+/Zc1JKNsEDiCYDIeLkVsSCw6s+o2QnX8ovMwAeTRqV/SjarsivBMLKs6ozs/JEvAUuzpGHBudNkcRbFfkeU26cNcMw/Pfkm6Wl9Bhlu5wpI8CfN3sE4V0wAGA6ndq2bc7MgTEwDMNxnDTJWNaFIixwKDcujo6P+1pvlzbnnERRWpquK9enLA/OBePUQ3wVZS8iBLpe4IC7aBf0uOB4/SoeEuLCFP/3KIZwnGfWShRgIZI0GQURmi1pyKiLxYoktywjHg4sb2ty2nexGNkL1ZrIln426nz7/ukV8EAQYN/3IYLABUsACKPXQ9nUTlqdr8Nhv2BUSnWx7eZ8/s62a65/5LifG/WyXPvCCfOXwLjUF9YcuR6y7Cv9oKHsS1K5Xj8syGe0x+OOohyo6mGr+aHbqSnye0PTMvM8X5Vkz3bSbzQ2lcbHn+evpYu3qlr/A6aUQYgRwilVBDFM7SnML6TarFQk12rbmky5iHfVvjPijdaxyBre9H8szPFvC/4DXuNFFLPs9wKD2nzSzgyiK8Hi0v24zF5ojdpPdeWxcvqoJz2UTh4Mu0+wtWe2Xt4/OQPzCA21F3q70pXLmlLV5Mql+nysV3vym19gK4mJVYsI7QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;待ちが多くて試行錯誤しづらい様子の図&quot;
        title=&quot;待ちが多くて試行錯誤しづらい様子の図&quot;
        src=&quot;/static/ec0067478b25ec169d091cc26d9d39a4/4e786/fig3.png&quot;
        srcset=&quot;/static/ec0067478b25ec169d091cc26d9d39a4/12f09/fig3.png 148w,
/static/ec0067478b25ec169d091cc26d9d39a4/e4a3f/fig3.png 295w,
/static/ec0067478b25ec169d091cc26d9d39a4/4e786/fig3.png 363w&quot;
        sizes=&quot;(max-width: 363px) 100vw, 363px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;意思決定の分散や認識合わせの不足を招くのは良くないですが、実装の試行錯誤ができ、ドメインエキスパートと揉むポイントを絞れる程度には業務知識を学習しておく気概が必要だと感じました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 477px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/731bf9be59cfb09cbd369f57fb14060b/d743b/fig4.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 63.51351351351351%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAB00lEQVQoz4WSy27TQBSG/X5skZAQO16CN2BRie5YsGBViYoFVTa0SBAhtVHSlCStU9vx3U5wE8vjS3ydu3GcigaRwr8YjebM958z54xQt2Kwik2N1w/ilETGjFFaPy6h5hsERWvl7BtlrOU2J7Qo5c9fEUb/hFuRrASytRugJQwVm1SQbx33wkmS+L4fBsDSDX+5jOMYY1xjaqt6/6KXgJBXiJQV53wPzLbCmELYxCkhOM05oRijIlmzun0CRDgtmnXXotnfl00hxhmsac1KxCltrjBMcVrtNLBpKmZlc4c1DluTTeYwssFKBq44G3bntoZhBYAGfMU3xyDUNHWUJus8zyGCSRLHP32w0PxAUWcjgRBimme2c+LdnSrq8aB7ElmuJH6YqR9X/hd30el/f+9KGiorRZxGAciDRL85HQzfDfpHQlP6YqEZxrVhiJZ54y1dSqll3xrqWBqdW5bo2FKRFTXjYOWTppeE3c1NXZ84jiI8OkSOV5pECPvPnPmDakYQzjyUejiz59NPaeCwyiNZ+Iftvdhu5nYq5Vwcv5hOn1+cP+10nlwNnwHwErivsijeYnt+2G+YVEC8PJxcHvzoHfS6r+XJoXz9Rr99mybh3/AvZTvbXZTyUykAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;仮モデリングによって試行錯誤がしやすくなった様子の図&quot;
        title=&quot;仮モデリングによって試行錯誤がしやすくなった様子の図&quot;
        src=&quot;/static/731bf9be59cfb09cbd369f57fb14060b/d743b/fig4.png&quot;
        srcset=&quot;/static/731bf9be59cfb09cbd369f57fb14060b/12f09/fig4.png 148w,
/static/731bf9be59cfb09cbd369f57fb14060b/e4a3f/fig4.png 295w,
/static/731bf9be59cfb09cbd369f57fb14060b/d743b/fig4.png 477w&quot;
        sizes=&quot;(max-width: 477px) 100vw, 477px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;最終的には調整による二度手間が生じることもありますが、高めた戦術の練度はそのまま活用できるかと思います。&lt;/p&gt;
&lt;h3&gt;まずはソロ討伐から&lt;/h3&gt;
&lt;p&gt;これは特に個人的な手応えですが、ドメイン駆動設計の実装で初期に複数人で作業するととても辛かったです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;概念層は概念の変更によってドラスティックに変わる&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;根本的な設計レベルで柔軟に試行錯誤したいため、共同作業が足枷になりすぎる&lt;/li&gt;
&lt;li&gt;共同作業には規約が欲しいが、試行錯誤前に作っても無駄感&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ドメインエキスパートとの認識共有は超少人数のほうが動きやすい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;認識共有する人数が増えるとコストが爆増&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;スケールデメリットが大きすぎるので、概念層の実装ラインは一本にしたほうがいい、という手応えです。&lt;/p&gt;
&lt;p&gt;工数を見積もってウォーターフォール的に分担作業ができるタイミングまでは共同作業にせず、どちらかといえば練兵に努めたほうが最終的にはスピードも増す印象です。&lt;/p&gt;
&lt;p&gt;コンテキスト境界を考慮してうまくチーム分割ができる場合や、手数が必要になる非概念層の実装が負担になってきた場合にはスケールメリットが活かせるかと思います。&lt;/p&gt;
&lt;h3&gt;CQRSやPresentation層について&lt;/h3&gt;
&lt;p&gt;DDDの戦術における勘所は想定概念と実装表現を同期させることだと思っていますが、いわゆる「ドメイン」「業務知識」以外の扱いに悩みを持つ人が多い印象です。&lt;/p&gt;
&lt;p&gt;特に取得や出力のロジック（Query, Presentation）は「業務知識」とは異なる複雑なロジックによるデータ取得が必要になる場合もあり、業務知識と混在させると辛くなりがちです。&lt;/p&gt;
&lt;p&gt;個人的な解釈ですが、「業務知識」といった用語にとらわれず、「欲求」ごとに「概念」をモデリングし、素直に実装で表現することが勘所になると思っています。蓄積されたデータを「取得したい」「表示したい」といった欲求は副作用を生じさせる「業務知識」の欲求とは異なるため、個別に扱うのが自然だと考えています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;データ形式が似ているため型定義を使い回しやすい&lt;/li&gt;
&lt;li&gt;データ取得のロジックも業務知識のRDBにSELECT文を使用すれば足りがち&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;といった事情で「業務知識」のリソースを使いまわして逃げ切れることもそれなりに多いですね、くらいの雰囲気で捉えておくのがいいと思います。&lt;/p&gt;
&lt;p&gt;更新系と参照系が密結合になるのはわかりやすく辛いので、なんとか工数を確保して結合度を下げていきたい気持ちが強いです。&lt;/p&gt;
&lt;h3&gt;コンテキスト境界とサービス境界とチーム境界と管理境界とマイクロサービス&lt;/h3&gt;
&lt;p&gt;基本的にはチームごとのmonorepoとし、コンテキスト境界に合わせてディレクトリを切っていくのを好むようになりました。サービス（entrypointによって起動する何か）はコンテキスト境界と一致せず、各コンテキスト（ディレクトリ）で必要なだけmain関数を配置しています。&lt;/p&gt;
&lt;p&gt;ロジックを持ち、libraryとして依存させるだけで通信せずに活用されるコンテキストもあります（ID Contextの新規ID発行処理など）。&lt;/p&gt;
&lt;p&gt;コンテキストを分けDDDによって開発するのは「凝集度を高め結合度を下げ、概念と実装の好循環を生みたい」というDev的な欲求です。Ops的な欲求におけるマイクロサービスと併せて使う必要は必ずしもなく、それぞれで良し悪しを検討すればいいと思っています。&lt;/p&gt;
&lt;p&gt;個人的にはコンテキストごとに起動を分けたほうが素直で楽なのでマイクロサービスっぽくした上で、リポジトリごとにゴリッとデプロイしがちです。マイクロサービスらしくないデプロイフローに見えますが、monorepoをまとめて一つのアプリケーションとして扱っているため、実体としてサービスが分かれているかを気にする必要を感じないのでこうなりました。&lt;/p&gt;
&lt;h3&gt;Kotlin Multiplatform Projects&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://kotlinlang.org/docs/reference/multiplatform.html&quot;&gt;Multiplatform Projects - Kotlin Programming Language&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;プラットフォームや通信の境界に依らずモデルを共有したい場合、実装言語の違いが課題になってきます。&lt;/p&gt;
&lt;p&gt;2019年はKotlin Multiplatform Projectsが活況でした。Kotlinで実装すれば各プラットフォームに対応できるため、モデルを共通化する用途として最も期待しています。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://aakira.app/blog/2018/12/kotlin-mpp-reason/&quot;&gt;Kotlin Multiplatform構想 ~今やる理由編~ | AABrain&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;一方で、現状（2019-12-24時点）ではKotlin Multiplatform Projectsにロックインされる形での開発しかできず、Multiplatformにライブラリ提供をすることは難しいです。成果物はiOS用の &lt;code class=&quot;language-text&quot;&gt;.framework&lt;/code&gt; ファイルや、Javascriptの実装を出力することができるのでPublishさえどうにかなれば…というところです。依存ライブラリの扱いもあるので公開ライブラリとしては課題が多いですが、内部ライブラリとして提供する分には可能性がありそうです（試し中）。&lt;/p&gt;
&lt;p&gt;現状は各プラットフォームの開発がKotlin Multiplatform Projects内に閉じられる。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/299afc968564deda73cda4fbd10f29da/d6331/kotlinmpp.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 38.513513513513516%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABQklEQVQY022PWW+CQBSF+f9/p0l9QNS0ipSdBiuIMoMjKFGRlmWGZaBjmqY1+j3c3Nwl5xyuv6Pruu12vtnwPhB8n7ftSdf1D+GaX9orDaW0rmsAjJUneq7oujPP0+u6uYddcrIsG4YhSZKmaaxRVfV8PmNc51mVxmmeEUzq8paiKAghCKGrMvNJ/2iZn69sF0A+Dl8c5/lwCH6y/M/FKoSQY15vctCu7/pkj1bLOfB172OeRGFP+66lD54xxhUDk6rE5WdGsrw4Ji1hKSm55HXVtrgqTheSFddtXjaEXRMmCSHgokgKgoFri2kCw0jY7UaW/nRJj3E8jRDvuPzxFEVoEoVjAAZr5y05bPZ7Yb0emqbOWZaoqsLSsQBcKaqgKCNNf0UosKypqo5NcxZA37SmsjyS5eHSefeBpygCmy8W9jdo07etEkacrgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;現状でのKotlin Multiplatform Projectsの使用感の図&quot;
        title=&quot;現状でのKotlin Multiplatform Projectsの使用感の図&quot;
        src=&quot;/static/299afc968564deda73cda4fbd10f29da/fcda8/kotlinmpp.png&quot;
        srcset=&quot;/static/299afc968564deda73cda4fbd10f29da/12f09/kotlinmpp.png 148w,
/static/299afc968564deda73cda4fbd10f29da/e4a3f/kotlinmpp.png 295w,
/static/299afc968564deda73cda4fbd10f29da/fcda8/kotlinmpp.png 590w,
/static/299afc968564deda73cda4fbd10f29da/d6331/kotlinmpp.png 702w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Kotlin Multiplatform Projectsで開発したライブラリを各プラットフォームの開発に提供したい。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e671de0b105dd23990104b74d2e9e2a6/cab8c/kotlinmpp-lib.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAAB0ElEQVQoz1VQa2+bMBTl//+SdpM2deuySpWibvuwJSUhgdCAeSXhaWyDg3mFAOlNJ03dkXxlHZ9zfe6VhmHwfd+yLM/zdrudEKKu66qq2rY7nfq27aHW/6NpGpC1bSv1fQ/mOI6TJImiqOs6YIZh5MeQkC1lRhCirjsPQ/8P4ziCOcuyqxk6Xd5jHKGEB01bfTX0B0P/1Z3O75/hQLg851czJPnLjcN46S+c8CPNOckYzhnhbVHTKBV52Tc9Tem5P7+Za865dE3IiShDEnoNz0UR5sRN9nbb1XnqkNgqylzkSU6cIz+QaF9lpKzCMLSvP0NG216uV7ezP3e+b2rqZ2V5O5/fH3y00T7Jzze6PvO8+UK+WSoflNXUc1VV/fj0dItxKsGEVV0nYcJYVlYVoyyOEs4LIUpKWBLjohDHQhBMgQfy7U5SnMJqJcqoaVpoizDGrut67k5b69AVNu9Y7lY3cJoGQWgjB2S27TBGQQM8iCUhKtdeP//+gpAVBIeXzXQxu1uvZT8ITP2HPL+HfggmWD0oi4muLzCmyJgvZhPTRFLTnHz/RVG+WxbsgOr6dLX6pmkypdQwfy6Xk8MeYG02j4oyQUhl7Og4sqo+gv4VC4Mc4jaJjqgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;やりたいKotlin Multiplatform Projectsの使用感の図&quot;
        title=&quot;やりたいKotlin Multiplatform Projectsの使用感の図&quot;
        src=&quot;/static/e671de0b105dd23990104b74d2e9e2a6/fcda8/kotlinmpp-lib.png&quot;
        srcset=&quot;/static/e671de0b105dd23990104b74d2e9e2a6/12f09/kotlinmpp-lib.png 148w,
/static/e671de0b105dd23990104b74d2e9e2a6/e4a3f/kotlinmpp-lib.png 295w,
/static/e671de0b105dd23990104b74d2e9e2a6/fcda8/kotlinmpp-lib.png 590w,
/static/e671de0b105dd23990104b74d2e9e2a6/cab8c/kotlinmpp-lib.png 744w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;おわり&lt;/h2&gt;
&lt;p&gt;完全に雑記になってしまい申し訳ないですが、今の素直な手応えとして所感を記してみました。&lt;/p&gt;
&lt;p&gt;Kotlin Multiplatform ProjectsやGitHub Package Registryなど、管理面で相性の良い仕組みも盛り上がってきており、より一層DDDの実践が現実的になってきていると感じております。&lt;/p&gt;
&lt;p&gt;一般的にはDDDの戦術は工数が増えるためスピード感が重要なプロジェクトでは避けられがちな印象がありますが、凝集度を高め結合度を下げる欲求が生まれるのであればプロジェクトの規模に関わらず得られるものが多いと思います。&lt;/p&gt;
&lt;p&gt;秋くらいからサービス開発以外に興味が向いているためgenerator業が停滞していますが、早く概念表現だけでアプリケーション開発が概ね完結するよう仕上げていきたい所存です。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[継続的に価値を提供するドメイン駆動設計入門]]></title><description><![CDATA[世界へ継続的に価値を提供するコストはもっと低くてもいいはずだと思う。 継続的な価値提供への一つの手法としてドメイン駆動設計があるが、特にアプリケーション設計においては大局的な理解を得ることが難しいように思われる。 ドメイン駆動設計によるアプリケーション開発においてどういうことを実現したいのか。 本記事では大局的な思想に注目することで設計の入門となることを期待したい。]]></description><link>https://hori-ryota.com/blog/2019-09-04-starting-development-with-ddd/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2019-09-04-starting-development-with-ddd/</guid><pubDate>Wed, 04 Sep 2019 11:06:00 GMT</pubDate><content:encoded>&lt;p&gt;世界へ継続的に価値を提供するコストはもっと低くてもいいはずだと思う。&lt;/p&gt;
&lt;p&gt;継続的な価値提供への一つの手法としてドメイン駆動設計があるが、特にアプリケーション設計においては大局的な理解を得ることが難しいように思われる。&lt;/p&gt;
&lt;p&gt;ドメイン駆動設計によるアプリケーション開発においてどういうことを実現したいのか。&lt;/p&gt;
&lt;p&gt;本記事では大局的な思想に注目することで設計の入門となることを期待したい。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;ドメイン駆動設計で成したい欲求&lt;/h2&gt;
&lt;p&gt;アプリケーション提供において、開発は専門化し価値提供欲求と分断されることが起こりがちである。加えて、アプリケーションの大規模化に伴い開発内においても局所的な専門化が生じやすい現状がある。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a2eef30f7aa23f7686cddefff7592007/91e7e/fig1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 29.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABIUlEQVQY03WPXW6DMBCEuf9NeoO+VXlBlWpI1QCFBNvEEDAGDNj82vzUF+j3sjujkXbWOs9z4BR+Xzatz384tpNg8Pn51raVkfkdRO67rF6WEXPLs8hXWh1625dVjZPWZtu3bTvMWNQqJ5o+4tjpeLXLicE7Ca6C11Ycx1fgyJqLmsdhBIBDKR3qdhC96HoUPVznWpRMrWpqBAwfXwDUvF0aMUhpdULMvWBeoLTGGHOarqM0dQTCPC/SLONltkxyHyfiuMgECqLXeWFNEQSWHIaplxUkatMkSZB3Yc/w1EeFU05Znufk1y6Qp7rxFcGUPNHto8nRXIsSPS1zzbZt3/OQAWNKSwPCyHXc28/NeKxkxsRJ4ns+xol5ykQghFEY/gGlc0d6s2cLzwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;局所的な専門化が生じている図&quot;
        title=&quot;局所的な専門化が生じている図&quot;
        src=&quot;/static/a2eef30f7aa23f7686cddefff7592007/fcda8/fig1.png&quot;
        srcset=&quot;/static/a2eef30f7aa23f7686cddefff7592007/12f09/fig1.png 148w,
/static/a2eef30f7aa23f7686cddefff7592007/e4a3f/fig1.png 295w,
/static/a2eef30f7aa23f7686cddefff7592007/fcda8/fig1.png 590w,
/static/a2eef30f7aa23f7686cddefff7592007/91e7e/fig1.png 692w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;特定の目的を達成することで価値を提供するアプリケーションにおいて、想定する概念の認識がチーム内で分断されることの弊害は大きい。&lt;/p&gt;
&lt;p&gt;ドメイン駆動設計においては役職を超えてチーム内で想定する概念の認識を揃えることで乖離をなくし、想定する概念の表現（モデル）を共に育てることで相乗効果を生む。&lt;/p&gt;
&lt;p&gt;加えて、価値の提供手段においても想定概念との協調を図ることにより、モデルとともに成長し継続的に価値を提供し続けられる提供手段となることを期待したい。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 368px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/63ad4dde3109a6f56dcb73a5f707a062/2b727/fig2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 93.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAAC5ElEQVQ4y21UWXOjRhD2/89jHvKWSlXKZTuH96hssrEl2fKBtIsua42EBAiQsEDcWFxzkmZlb+wtNVTTzMw30/31Bwec86qq8jzfbDa+7202ju/7QRA8e89/Ns/zsiyrXtjBDqzr+unpm5OTP+7vZUopxpiAR4hRTiknpL4Z47PZjDH2Pdh1vcVC0rSuZd0hVBZFkTw+YowcW/E9zfcXvq85jinL+8C2ba+WF6L4y/Lh/WYiPGirlbmMFE1V3pjWXxv3zHE/SpO3V1dXsHgHeQl2FKWryO+06Qd7OSeYVrwKA7/bPOpfHovtk0H7WGgenTXO94AhSUjprvPprnmz0HR1NteMBfjxzedxbzRo3YIfdXq6YbwiDOjhX61IM5RDrSkiuMiy1A1SL8SEUM6KZEsoAf5IXr4CW5Z1eHj45+mpPBpHXuiuHsIwcDTDXSyDjRslcRRHjmLEYWw7jjKbVfQFYQ6QaBhuEGTmujB1ThktELKDepJX2IvhuZWmJPARoQBmCO8yrcGgBIQQRCgIB7//lm7T3a7QrW2a4mQLsTPsS41GSaiqKqzE1TfCQDogL3grvEg560DBMFragWMs1bmSrb0aPFYsUcKcKooC6bi2s7btVyeXYeJ+mZOvMckKRikEOM3Bxwsr0i2EkaqqAI5AuGH4dHK/32+32x1BMEzzwbLiOAZ57hKjjMnTKYjXNM2FpqmaCnJlmDylHUWRIAjX19fdbrc/6Pc/iaPuZ2kClzSZTKS7sXgjiL3ecDS8bV3OZbnesSj5N5HsqAMPuq2LDxNoOLQXvo3Miygm9RSv33H0WINLVEM4P6j2GfFThiiNc57jl+O0wCxF7HlwD5gwtpAEQ26Pb9+vTOV/MfOK5I/mZcvqtJO1zlHxHbheVJalbjYGo1/Pmz8Oh39T8tTVCtPl4OM/b38Qb37uNH7Sxdaek6HyTuff8/OjVvP44uLDkyJ2P5wkWatT9UvPmN5Dw/4DjNccSZjpJKgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;目指したいフロー&quot;
        title=&quot;目指したいフロー&quot;
        src=&quot;/static/63ad4dde3109a6f56dcb73a5f707a062/2b727/fig2.png&quot;
        srcset=&quot;/static/63ad4dde3109a6f56dcb73a5f707a062/12f09/fig2.png 148w,
/static/63ad4dde3109a6f56dcb73a5f707a062/e4a3f/fig2.png 295w,
/static/63ad4dde3109a6f56dcb73a5f707a062/2b727/fig2.png 368w&quot;
        sizes=&quot;(max-width: 368px) 100vw, 368px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;本記事で伝えたいこと&lt;/h2&gt;
&lt;p&gt;ドメイン駆動設計の最も重要な要素はチーム内で概念認識を共有し昇華し続ける「ユビキタス言語」の作成であると捉えているが、ユビキタス言語の作成には総員で献身的にコストを投入する必要があり、早期に手応えを還元することはチームモチベーションのコントロールに重要と考える。&lt;/p&gt;
&lt;p&gt;開発とユビキタス言語の作成は相互に行き来することで昇華していくものではあるが、開発フェーズでの落胆による失墜を防ぐため、無鉄砲に広範囲の導入をする前に開発の根幹については手応えを得ておき、方針には習熟しておきたい。&lt;/p&gt;
&lt;p&gt;よって本記事では主に開発者に向けてアプリケーションのアーキテクチャ設計について触れていく。&lt;/p&gt;
&lt;p&gt;なお、ユビキタス言語に始まるモデリングの勘所については &lt;a href=&quot;https://www.amazon.co.jp/dp/B00GRKD6XU&quot;&gt;エリック・エヴァンスのドメイン駆動設計&lt;/a&gt; で十分把握できるため原典にあたっていただくことをおすすめする。&lt;/p&gt;
&lt;h2&gt;ドメイン駆動設計における実装&lt;/h2&gt;
&lt;p&gt;ドメイン駆動設計においては以下の2つを区別することが重要となる。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;概念層&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;対象アプリケーションの概念を実装で &lt;strong&gt;表現&lt;/strong&gt; する層&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;非概念層&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;対象アプリケーション外との帳尻合わせ、技術的詳細&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;概念層&lt;/h3&gt;
&lt;p&gt;更に、概念層はdomain層とapplication層の2層に分かれる。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;domain層&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;対象とする領域の各概念、要素が何であり何でないのかを表現する層。&lt;/li&gt;
&lt;li&gt;提供手段に依らず存在しうる概念をここで表現する。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;application層&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;domain層で描く概念は何かしらの提供手段により提供される。我々はソフトウェアによってそれを提供し、アプリケーションと呼称することが多い。&lt;/li&gt;
&lt;li&gt;このアプリケーションがどのようなものであり、どのように挙動するのかを概念として表現するのがapplication層である。&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;application層では技術的詳細には立ち入らず、どのような要素がありどう組み合わせて使用するのかの表現に留める。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一方、アプリケーションの知識としてのロジック（パーツの条件分岐など）は積極的に実装として表現する。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;これら概念を表現する概念層ではとにかく表現力にこだわり、モデリングとの親和性を高め相乗効果を狙いたい。&lt;/p&gt;
&lt;h3&gt;非概念層&lt;/h3&gt;
&lt;p&gt;概念層では表現力にこだわり、外側の技術的詳細は「それ以外」とし、概念層の表現力を高く保つことが重要である。概念表現以外を担うのが非概念層である。&lt;/p&gt;
&lt;p&gt;非概念層はadapter層とinfrastructure層に分かれる。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;adapter層&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;概念の外殻を担い、外部（含：技術的詳細）との調整を行う層。&lt;/li&gt;
&lt;li&gt;概念層では表現力にこだわり、adapter層で帳尻合わせを行いたい。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;infrastructure層&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;より低レイヤーな技術的詳細。driverやprotocolなどの詳細実装。&lt;/li&gt;
&lt;li&gt;アプリケーションの知識というよりは外部ライブラリとして扱う方が適切なことが多く、筆者はアプリケーションとは別管理にすることが多い&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;全体を図にすると以下のようになる。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 425px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3b72eb91b0595570ae6f39aec59ed46c/2fbbf/layermap.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3ElEQVQoz4VRi47SQBTt//+Ea4yRZdcVmiURRJRHd6FCJSC0U6EWpq9pKVNg+qbgdBuNYTWeTCaTm3PuPXMPQ4iHkOzYc3pHkX/OcTr/A4RghMAvcsBAyANQEsXyYnFj2zJlZFl2egba8Xg86zovSiUJ3ErSG9dVGM8z4WqgrzndEAjZ5nNPf52cF72dtVYeNdDSjbFPPIaW0ihN/LBQpGkaRWEURwV8QopDkWXHnBAmoeMV5FycxUmKSdFfksH7euNTq91p9z7Um4qyCujn4sjZYmTbuYH0mAVxQWbSA7ZAfyU0MZzF+x0UZW0+FId1IDTmQmOniVkYnnaHzVJWwTJxkLXkNbGL4bc0DBhiwTF3M+i+nnJ3SFVdVTOlvsCVx4/lYf1K6t9vdJ1oJl+rgokYQEXgrvufX1Gyaxi57SSIw71PzdEtu3hLV5OQ0N/gAOFgs/fDcPlDGY3HI0Gg5NiPIlp7cs6cf+/26aFB2OO4drvzpfPQ4/kB9+BohouxoWnIQn9kkYfHXASirlbybDrhGpMmOxt2DQiz7d5RVQkA0zQvgnwuhnttIY1up0L5+5A9IJTo6GutKgLZ+q94vV53Ot1apVople4r7MdW6+27uxdXL1mWdRznQvwTrFeROyusEVgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;layermap&quot;
        title=&quot;layermap&quot;
        src=&quot;/static/3b72eb91b0595570ae6f39aec59ed46c/2fbbf/layermap.png&quot;
        srcset=&quot;/static/3b72eb91b0595570ae6f39aec59ed46c/12f09/layermap.png 148w,
/static/3b72eb91b0595570ae6f39aec59ed46c/e4a3f/layermap.png 295w,
/static/3b72eb91b0595570ae6f39aec59ed46c/2fbbf/layermap.png 425w&quot;
        sizes=&quot;(max-width: 425px) 100vw, 425px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;戻り値の矢印は省略してあるが、すべての矢印に対して存在する。&lt;/li&gt;
&lt;li&gt;infrastructure層はレイヤーに依らず活用するライブラリの役割を担うため、図には出てこない。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;概念層では概念の表現に注力し、モデリングと合わせて育てることで継続的な価値提供が可能なアプリケーションとなることが期待される。&lt;/p&gt;
&lt;p&gt;以上が大局的な設計の方針であり、各層で成したい目的を強く意識して実装することが鍛え続けられるアーキテクチャを実現するために重要となる。&lt;/p&gt;
&lt;h3&gt;層構造のまとめ&lt;/h3&gt;
&lt;p&gt;重要な点をまとめると以下のようになる。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;概念層では実装により概念を &lt;strong&gt;表現&lt;/strong&gt; することに注力する&lt;/li&gt;
&lt;li&gt;domain層は提供手段に依らない根本的な概念を表現する層である&lt;/li&gt;
&lt;li&gt;application層は提供手段の概念を表現する層である&lt;/li&gt;
&lt;li&gt;adapter層によりapplication層と外界との帳尻合わせを行う&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ここまでが層構造の概要である。ドメイン駆動設計の書籍で紹介されている集約やドメインサービスなどの各戦術要素は概念層の表現手法の一つであるため、知見として活用するのには大いに役立つ一方、要素ありきで原典準拠を求めるものではないことに注意したい。&lt;/p&gt;
&lt;p&gt;とはいえパターンの活用により得られるものは大きいため、モデリングや実装の改善とともにパターンを学習していくのはおすすめする。&lt;/p&gt;
&lt;h2&gt;各層の具体的な実践指針&lt;/h2&gt;
&lt;p&gt;現実にはどの層に何を配置するか迷いが生じることが多い。&lt;/p&gt;
&lt;p&gt;具体的な設計の指針としては擬似的に各レイヤーに視点を起き、立って見回すことをおすすめしたい。&lt;/p&gt;
&lt;p&gt;オニオンアーキテクチャのようなものを想定して欲しい。周囲は壁に囲まれており、立っている層より内側しか見えない。外側は壁と扉のみであり、インターフェースまでしかわからない。インターフェースを決める権限は内側に託されている。外界の詳細を妄想するのではなく、内側から見た理想を描くことを基本としたい。&lt;/p&gt;
&lt;h3&gt;domain層&lt;/h3&gt;
&lt;p&gt;domain層では「提供手段がソフトウェアである」とは認識せず対象の概念知識しか知らない。外は見えない。見えるもののみを表現する。&lt;/p&gt;
&lt;p&gt;一方、見えるものは積極的に表現する。詳細なロジックについても概念知識であれば実装で表現する。&lt;/p&gt;
&lt;p&gt;表現に使えるパターンとしては「集約」「仕様」「エンティティ」「値オブジェクト」「ドメインサービス」などが代表的かと思うが、パターンの原典準拠よりも &lt;strong&gt;何であり何でないのか&lt;/strong&gt; を表現することが重要である。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/26744cd01901a7b299483a69a3a9ec23/d7ba6/stand-in-domain.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 24.324324324324326%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAAxUlEQVQY022Myw6CMBRE+/+f4UoXPja6V6NEFMNDaQQTkKIooAJabEuoVhONr8ksJmfuXIAQchwHY0wpJW+6CJRl5BO+JI5FD/Icc15e+fVLDOenYHdP/Kd7SOyBePK3K8uyYMVj/OknoYSBU7S+pIgIJyFLQ5L5JPXx3mU4ZOdws5LjQDtERhpDmmyjQA2QcoxnvHBwZgPPNky1u5j1RfAszTYHSygJ4tpTF06GvYquNEy9ac07rilrSl0Z1cZSFRotqLdv+8YXVYTAfzMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;stand-in-domain&quot;
        title=&quot;stand-in-domain&quot;
        src=&quot;/static/26744cd01901a7b299483a69a3a9ec23/fcda8/stand-in-domain.png&quot;
        srcset=&quot;/static/26744cd01901a7b299483a69a3a9ec23/12f09/stand-in-domain.png 148w,
/static/26744cd01901a7b299483a69a3a9ec23/e4a3f/stand-in-domain.png 295w,
/static/26744cd01901a7b299483a69a3a9ec23/fcda8/stand-in-domain.png 590w,
/static/26744cd01901a7b299483a69a3a9ec23/efc66/stand-in-domain.png 885w,
/static/26744cd01901a7b299483a69a3a9ec23/d7ba6/stand-in-domain.png 1107w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;表現力に関する一つの例として、筆者は差し替え可能であることを是とし何でもインターフェースにすることには反対である。そのインターフェースにした概念は、 &lt;strong&gt;概念として&lt;/strong&gt; 差し替え可能なのか？違うなら混乱を招くノイズなので実体のみで表現したい。過度な抽象化を避けることも表現力の重要な要素である。&lt;/p&gt;
&lt;p&gt;実装の詳細を混ぜない〜という言及からentityのようなものだけが入ると誤解されることも多いが、ロジックも含めてのドメイン概念である。&lt;/p&gt;
&lt;h3&gt;application層&lt;/h3&gt;
&lt;p&gt;application層では「提供手段」の概念知識を表現する。我々はアプリケーションをソフトウェアにより提供することが多い。&lt;/p&gt;
&lt;p&gt;ソフトウェアにおいてはデータの入出力によりドメイン概念への影響を生じさせることが多く、価値提供のためにはアプリケーションにデータの入出力とやりたいこと（＝usecase）を定義することが主軸となる。&lt;/p&gt;
&lt;p&gt;また、アプリケーションは周囲と連携して価値提供を実現することが多く、何らかの外部通知処理やデータ取得処理、認可などの機能呼び出しが必要になると想定される。これらもapplication概念として表現する。&lt;/p&gt;
&lt;p&gt;例えば、domain概念の範囲においては明示的に「永続化」するまでもなく作用した時点で完結している。一方、ソフトウェアでのアプリケーション提供においては往々にしてメモリ内では完結せず、永続化や同期が必要になる。アプリケーションとしての事情であればapplication層で表現するのが適切と考えられる。（もちろん、domain概念として永続化の概念があればそれはdomain層で表現する。）&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a7a7b51fd509baec7a161c1616f6f334/f79fa/stand-in-application.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 34.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABS0lEQVQY03WPaWuDQBCG/f//oh/7MVAaCm1Ketnch+sVjUlcc3hF47G6h7s1hNJPfXgY3oEZmJHEL+wPyihlhDB6kzasuSEEb22uPeOcSzvo2euts3FRRVgjCOGYUIwJoaKVMoEJq8oS47osURyn53NWVe0AzfNc8rdGCOfRXkl9LYZKFurocsRFkvogi9XkBKosKP2I5EVeZLL8AEAPwrFtA4QqKd477Wbi6wFcHrazwFukoYuyuA3BfnrcTS6hl0VJXSKMkQLeVfVtOOrq+qyusVTVtfiP5ipnvKGc3wJpOOXXx4Uo2rPPnpWeFgGcht7s4itHZxTBeZ2cksPY3fTTaJzH0yKdR/6gOKsocs1lZ716KrNReBhJrqVZmrwCsqV+2/rAUL4sbeA55kzuDj87ptIzlde2GstnY9l3wOT95W74cW9rj2DS/QHCBH97Njp+QAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;stand-in-application&quot;
        title=&quot;stand-in-application&quot;
        src=&quot;/static/a7a7b51fd509baec7a161c1616f6f334/fcda8/stand-in-application.png&quot;
        srcset=&quot;/static/a7a7b51fd509baec7a161c1616f6f334/12f09/stand-in-application.png 148w,
/static/a7a7b51fd509baec7a161c1616f6f334/e4a3f/stand-in-application.png 295w,
/static/a7a7b51fd509baec7a161c1616f6f334/fcda8/stand-in-application.png 590w,
/static/a7a7b51fd509baec7a161c1616f6f334/efc66/stand-in-application.png 885w,
/static/a7a7b51fd509baec7a161c1616f6f334/f79fa/stand-in-application.png 940w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;domain層と同じくapplication層からは外が見えない。見える範囲で（必要な）想定できるものを配置する。知る必要のない、詳細がわからないものはinterfaceだけ配置する。&lt;/p&gt;
&lt;p&gt;application層で表現するのは「どのようなものがあり、どう組み合わせるか」という概念知識である。価値をどのように提供するかには深く立ち入り、その各パーツがどのようにそれを実現するか（技術的詳細）には立ち入らない。&lt;/p&gt;
&lt;p&gt;例えばトランザクションの仕組みが必要なら導入する。実現の技術的詳細は知らないのでinterfaceでいい。adapter層でなんとかする。interfaceによりトランザクションを持つ実装に手段が限定されるのは正しい状態である。必要なパーツ（概念）なのであれば。&lt;/p&gt;
&lt;p&gt;あくまで外部（他アプリケーションやインフラなど）の事情を知らずにソフトウェアとしての対象アプリケーション領域内の知識で完結させることが判断基準となる。&lt;/p&gt;
&lt;h3&gt;adapter層&lt;/h3&gt;
&lt;p&gt;アプリケーションは周囲と連携して価値提供をする。連携するための実装を配置するのがadapter層である。&lt;/p&gt;
&lt;p&gt;外部との通信など、ソフトウェアのインターフェースとアプリケーション概念との帳尻を合わせる。&lt;/p&gt;
&lt;p&gt;例えば通信仕様に即したデータオブジェクトを定義し、アプリケーション概念内のドメインオブジェクトとの相互変換を担い、通信実装との入出力を実現する。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b1f461f63805bf2583344711a011a540/c23ad/stand-in-adapter.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 31.08108108108108%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8ElEQVQY05VPy26DMBDk/7+nh/baSw9J1ECVHFKpGBNnjR+RsU3BgHEX2nxAR9buaGZ2bWd0wzAMIYS1Dj32vuvwhHEMD7RtS0jJWG2t8d5P02SMyXAgpbQsC9ZO86/zK5C9vbG+denX2CzTqt3uqSiej8cXpcSq4DBuTQ9gbg5TDNM8xznGTfqzYozeeWedtS7Oq+qcyyy+Q4hv52V9Bnq485NkuWlKwy8ScuTyVkgoruXeQMWrnJED0HfNPz5PbxnefqX0rrWWIHilmlo2VAvQgiFRopacImmg0oJLXjc3ImCNASMZfl0rPY5j+j9+AKLEUlARgKKpAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;stand-in-adapter&quot;
        title=&quot;stand-in-adapter&quot;
        src=&quot;/static/b1f461f63805bf2583344711a011a540/fcda8/stand-in-adapter.png&quot;
        srcset=&quot;/static/b1f461f63805bf2583344711a011a540/12f09/stand-in-adapter.png 148w,
/static/b1f461f63805bf2583344711a011a540/e4a3f/stand-in-adapter.png 295w,
/static/b1f461f63805bf2583344711a011a540/fcda8/stand-in-adapter.png 590w,
/static/b1f461f63805bf2583344711a011a540/efc66/stand-in-adapter.png 885w,
/static/b1f461f63805bf2583344711a011a540/c83ae/stand-in-adapter.png 1180w,
/static/b1f461f63805bf2583344711a011a540/c23ad/stand-in-adapter.png 1193w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;概念層を清浄に保てば保つほど、adapter層での退屈で筋力の要る実装は肥大していく。adapter層の犠牲により高い価値を提供し続ける概念層が保たれるため、内外の変化に順応しやすい設計とできると望ましい。（筆者は主に過度な共通化を避け、捨てやすさを重視したシンプルな実装で満たすことで順応性を高めることが多い。）&lt;/p&gt;
&lt;p&gt;とはいえadapter層の実装工数は無視できないリスクとなる。ストレスとなる実装は過度の使い回しなどの「ズル」を招き、結果として破綻へと繋がりやすい。強制力による解決も現実的ではないので、多少の妥協により概念層を汚すことも多々ある（データ変換用の記述をdomain層に置いたり、テスト用の実装を追加したりなど）。トレードオフの取捨選択は手腕が問われる要所であり、チームで共通認識とすべき勘所である。&lt;/p&gt;
&lt;h3&gt;infrastructure層&lt;/h3&gt;
&lt;p&gt;アプリケーションに依らず必要となる汎用的なライブラリを実装する。管理都合を除けば同じリポジトリで管理する必要はなく、外部ライブラリ化していきたい。&lt;/p&gt;
&lt;h2&gt;全体としての実践手順&lt;/h2&gt;
&lt;p&gt;抽象的な層構造について理解したら次は実践手順の話となる。&lt;/p&gt;
&lt;p&gt;まずはどの層から手を付けるか？という議論には概念層の好きな方から、と答える。肝となるのは概念層でいかに相乗効果を生むかであり、詳細に立ち入る前に概念を描きたい。&lt;/p&gt;
&lt;p&gt;domain層とapplicaiton層の順序はどちらでもいい。モデリングと併せて高速に行き来するものである。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 178px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8d04b7145776e10eba6dbcea7209b33e/43e0d/fig3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 195.2702702702703%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAnCAIAAACABf9ZAAAACXBIWXMAAAsSAAALEgHS3X78AAAE30lEQVRIx5VWW3PaRhTmH3fy1ofO9CFtp5O6Tuxk4sRxsWNsY2JzscEEDJi7uAkM4mYhIcRVAkmRACNASKIrcNJkmhZ8RtLsrvbb7+ic7xzQzRcmimOeF6ZTiWF6kiTN1zMduBmGy2avKxUXDLsxzJ7LhXi+D9ZVVV0BHgz6qdSHyQQShBDH+Uaj2HAYhmEzcGQlXseyTK3mZdngxsYTg+GXw8On83kFx300Ta8GC0I/m7UoSrpRd7VbLpq+mc8z+byVYZjVYHDjOFYs2u/FSLPtlZV4JmMnCGytgC3Ppph22uMKbewW0SS7Buc/zKqigOeMHw5gdAlTVWXdVC1MlaeS2FlwKuoj8rw0ZSqNGtTinEeANSdVwCc9MCuK8hjmBZX0Ccjl7mG6Hrmu3xdQtFSt40ggFNx4CwY4drcmua5QSDebH8fjxL0YH44T43Ecgg5g2L8OXIeiOY4LpNMnpaIZXOGwPpc7dTheFQrFld+vq1QQlgkmUkfxhCENn7g9O622F8ldpVKp1WDgdjpzUscceNlWRm1EydaoXVmsL1IpeDVYHI2iybjjx2fefaM/HXM93Xa/1PujIZZh1yoMVZpN611VljUqcSp1uPlSZN8Cvz5oIWFVA4s9bsLyYCDPZuD9VBgOyc46UtPAkxbTo7sIglSrVRzDURwrQzCazRdLxVKppC2C3GMYDMOFQgGslMtlsJnneZ0izWY9vkaSNpvNYrEYDAaX231ydLz/bAtsMp2arBbLqdHo8XgSyeR4PJ7NZosWgAcCAZ00GClsv0rW3h8cHB8dGU1G68XF1s7O3ss3kb2zc7P1nX7/4PDIennJ9/tf4l8nyZubG500FBVuQDYa7Y72nRP+XqSZCUXxOST30yYHw4O7Ur9YGFawOc+rg9FsNAXbSJL0+/066V6U2X6T6tCN5gQv99EQjTjoOwfddFFdr8D6qeZHhvIIlO/Wq3cZNvlicFonSKK2AA9H4JvbLIOHoyLunMoJs2Pz0PSbw/3K7ty+uNr6YN7w+nc9gd3j89+fbT2Zz3PdpPnjyVk4BulAD5I6LFkju3S3mclkHSbYfnDr1NfTZq7mpqpOruGhUUf71oaFTsGr2Nlh+MIRTyRCoZCWKpnpY/kiw2mSEoRhE61huTwSgWDvzc0Pv0b2jhMeXzoQzsWSaLbUprpawOp1ze2lktBI6rtNs18m5dH43zp7CNhyQiClFqK1EUWWv1ya+Fo9dSYvOpWyXJQXef4G3Gg1G0hZ5gYPnfgz/4iklpr/P2aQdIZlQdhF6qGYVEXDjClWAYJf2H+D6/Ver7fYzQBXlYVv008DBip8VV7ql1O+DwbGhpHKH+/locDDWeKtUeJ6M7qr8veqVnLfYwYTLVXiRMgnOxknHjH27ux0xcG1runyJezVB87fCEhEbLeXTnwLrtUYQRAQZNq5hvNG89Vzp2/n7PL5me1Px/Vr/fHT3fc/z+fpjOmvdlv73SYI4qtoNxosq4WqDkVwv4W6tQ/bAbEXGnb8YjfMll1EyJKyGKPX3vFUK4xms6mV5EOeCQK0S5AwFMMj/rDzzHr+es/44tXx5pZhY9v0bv/igyUYjGBEFewETECbPp9P9/nfkAhBEDgsGAxGoSgUj0UT8UgsFo7FImAcj8XiMSgaDX424HO32/0bZ2REcdfIOV8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;順序によらず常に行き来する&quot;
        title=&quot;順序によらず常に行き来する&quot;
        src=&quot;/static/8d04b7145776e10eba6dbcea7209b33e/43e0d/fig3.png&quot;
        srcset=&quot;/static/8d04b7145776e10eba6dbcea7209b33e/12f09/fig3.png 148w,
/static/8d04b7145776e10eba6dbcea7209b33e/43e0d/fig3.png 178w&quot;
        sizes=&quot;(max-width: 178px) 100vw, 178px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;忘れがちだが、概念層はモデリング結果を実装に落とし込むだけの層ではない。概念層での実装表現からもモデリングにフィードバックを与え、共に昇華していくことが重要である。&lt;/p&gt;
&lt;p&gt;例えば「財布」のようなものを表現するときに、入出金の履歴をいかに持つかが議論になる。初期のモデリングで全てを「財布」が保持していた場合、実装上は有限個しか保持することは難しいため乖離が生じる。この場合、実装により回避（有限個だけ持たせ、それ以外は通信が生じる呼び出しにより解決など）とするよりも「レシート」のような概念を導入し「財布」には直近のもののみ保持し、定期的に「レシート台帳」に移す、というモデルを検討するなど、相互に影響し合うことで発展させていくほうが望ましい。&lt;/p&gt;
&lt;p&gt;実践手順においてはチーム事情によるところが非常に多いため、柔軟に対応することが求められる。高い価値提供へつながるモデリングと概念層の実現に繋がれば手法は問わないため、例えば「まずは動くようにしてから改善を回す」といったアプローチも積極的に活用していきたい。断絶を防ぎ相乗効果を生み続けることが重要である。&lt;/p&gt;
&lt;p&gt;参考までに筆者のフローを例として上げると、ざっくりdomain層に要素を仮置きし、早い段階でapplication層で試行錯誤し違和感を抽出することでモデルへのフィードバックを素早く得、ユースケースの洗い出しをした後にフルスクラッチで工程を繰り返す、というアプローチを好んでいる。2,3回繰り返すと概ね勝算が得られることが多い。永続化などの技術的詳細は可能な限り（動かしたいという人に突かれるまで）後に回す。可能な限り、概念層の実装がモデリングのDSLとして活用できるよう工夫する。&lt;/p&gt;
&lt;h2&gt;アプリケーションのスコープ&lt;/h2&gt;
&lt;p&gt;人間は多くのことを同時に考慮することはできない。考える領域を適切に区切る（スコープを区切る）ことが必要となる。&lt;/p&gt;
&lt;p&gt;アプリケーション内の層構造もスコープの一種であるが、複雑度を軽減するためにはアプリケーション自体のスコープも必要となる。ドメイン駆動設計では「境界づけられたコンテキスト」と呼称される。&lt;/p&gt;
&lt;p&gt;スコープによりモデル内の複雑度は軽減され、概念要素間もスコープ間では疎結合に保てる。&lt;/p&gt;
&lt;p&gt;同じチーム内であっても、似たようなモデル要素であっても、コンテキストをまたがる要素は独立したものとして扱いadapterによって仲介させる。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 456px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8d0f565108ed972c9d7efb1fe46435a2/7f664/context.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAACi0lEQVQozyVSC3OiMBDm//+Du7mZTlvbu76utRZrrx1ri1anPU+RoEAAQRAkPMJDfCF6od35MtnZ5Mu3m11q/2nz+TyK4i/4vu95HsZ4Pk9JPAxDEsE4IA7GBaIo2mw2hEWRlSRJUBwFcUw2nCTpbrdDyO10WgSTiZ5l2+VyGRcWEnwJZFlWkMm70yk7Hj/I6gOEVYzVLNuZZmfAXfTZy+HwbrWMFotkojcU9V6CtGW1HcfebrcFmchK0tuQv5RHZVEsu560Xm+1yZss3OgyLSt/SGZJjAWRloWyJJY1vWEYep7n1FfN6Xwxs6c64CzLcpGHHTdCgcGPlF7fmVjItHzXC0JsQzgzdQe5q9W6qNkwjHq9zjSbPZYLTNefeVNV+2h3Xhjmqfoo8VIyT6eGoY6k1kurUat3P3qe75PqJUmiTNMUIRS63THLRGIXD7ujwUCE8rDNcK8VV/xYYws5aAT4Pn3D1q40wMSuRWT7vR4VheF2v19pKvw47b4fjton7/R9jEL08jD8dwL6p3LzasJD+PZXb5yDwS+J/akNmoQMeECRfq43680inY44C/TtiQIGA9K3JHAN0J/yrDczEEKqrHimNhU4c9Dz0YyQOY6jyL3ss+O7LM9XGXEUWSGjQJx8meVrktaeCKiqmu/y/TbfLja7zz8GAFDFMAXmehNgXUoj8tkKzwPbMpYrN3a02B4n85kgcDKUo2i2TGdYFxepg5DebrcI2QHgXBAuJem3plUY5nu9/jge9yEsghBeC8JZpfKd43hVrQnChSheqeoNy5aOj79Rtm1VKoc0XaBWK1WrR83mK8u+397+oOmju7vDp6fTcrnE88Pn5+tK5YAEq9XjRuOsVDr4DzYJpRIHk1kIAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;context&quot;
        title=&quot;context&quot;
        src=&quot;/static/8d0f565108ed972c9d7efb1fe46435a2/7f664/context.png&quot;
        srcset=&quot;/static/8d0f565108ed972c9d7efb1fe46435a2/12f09/context.png 148w,
/static/8d0f565108ed972c9d7efb1fe46435a2/e4a3f/context.png 295w,
/static/8d0f565108ed972c9d7efb1fe46435a2/7f664/context.png 456w&quot;
        sizes=&quot;(max-width: 456px) 100vw, 456px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;実践手順についてのまとめ&lt;/h2&gt;
&lt;p&gt;ここまでを理解した上でドメイン駆動設計の原典に触れると各戦術要素の意義が捉えやすくなるはずである。なぜその要素がほしいのか、欲求から考えられると自身のアーキテクチャへの取捨選択の助けとなる。&lt;/p&gt;
&lt;p&gt;重ねて述べるが設計を含めた戦術はあくまで手法であり、開発において重要なのは価値提供欲求との親和性である。価値提供欲求とともに鍛え続けられる提供手段を提供した上で、提供できる価値の向上に努めることが目的である。&lt;/p&gt;
&lt;p&gt;相乗効果を生めるよう、各レイヤーでの目的を強く意識し相互にフィードバックを回すことが勘所となる。&lt;/p&gt;
&lt;h2&gt;ドメイン駆動設計の（著者の）現状と課題&lt;/h2&gt;
&lt;p&gt;最後に、おまけとしてドメイン駆動設計を実践する上での悩ましい諸問題について触れたい。&lt;/p&gt;
&lt;p&gt;個人的にはある程度の解決策を見出しているものもあるが、良いアイデアがあれば是非アドバイスをお願いしたい。&lt;/p&gt;
&lt;h3&gt;Go言語の表現力が足りない&lt;/h3&gt;
&lt;p&gt;著者はGo言語を主に活用しているが、シンプルかつ素直な実装となりやすく、実装の主旨を汲み取りやすいところがメリットである。&lt;/p&gt;
&lt;p&gt;反面、表現力を高めるのに筋力（コード量）が必要となることが多く、特に「何ができないか」という制限を表現する場合に悩みが多い。&lt;/p&gt;
&lt;p&gt;一例としては「必須値」を表現する required や、「読み取り専用」である readonly を表現するのですらプライベートフィールドとコンストラクタやアクセサが必要となり、一つ一つ手で実装するとコストが跳ね上がる。&lt;/p&gt;
&lt;p&gt;また、実装自体も意図を伝えるにはコード量がノイズとなりやすく、フィールドに連動した挙動であるのに実装箇所も散りがちで把握しづらい。&lt;/p&gt;
&lt;p&gt;著者は一つの解として struct tag に情報記述の上で code generator を活用する手法を用い、厳密な制限について（package privateなので他オブジェクトから変更できてしまう）は意図の表明を明確にすることに留めて一定の妥協をしている。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/hori-ryota/go-codegen/tree/master/codegen/go_accessor&quot;&gt;go-codegen/codegen/go_accessor at master · hori-ryota/go-codegen&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/hori-ryota/go-codegen/tree/master/codegen/go_constructor&quot;&gt;go-codegen/codegen/go_constructor at master · hori-ryota/go-codegen&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;表現力を保つための実装コストが高い&lt;/h3&gt;
&lt;p&gt;表現力を高めるために導入する型安全なエラー型や、結果整合などに活用するアプリケーションイベントなど、意図したい概念のシンプルさに対し実装コストが高く感じるものが多い。&lt;/p&gt;
&lt;p&gt;また、概念層だけでなくadapter層においても関連実装が必要になり、全体としての実装コストを高騰させる。加えて概念層に、概念の表現としてはノイズとなるコードが大量に生じ、見通しの悪い実装となる。&lt;/p&gt;
&lt;p&gt;著者はコード中にコメントによる定義記述（例：&lt;code class=&quot;language-text&quot;&gt;//errcode InvalidWorkingTime,startAt int64,endAt int64&lt;/code&gt;）を仕込み、 code generator により各実装を生成するアプローチを取っている。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/hori-ryota/go-codegen/tree/master/codegen/error/go_definition&quot;&gt;go-codegen/codegen/error/go_definition at master · hori-ryota/go-codegen&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;TODO: appevent&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;adapter層の実装がつらい&lt;/h3&gt;
&lt;p&gt;アプリケーション間の連携にはserverとclientの形式を取ることが多い。現在ではマイクロサービス構成にしてネットワーク通信を挟むことも多い。&lt;/p&gt;
&lt;p&gt;境界づけられたコンテキストは小さく保ちスコープを狭くすることで各アプリケーションをシンプルに保てるが、反面アプリケーション間の連携を実装するコストが跳ね上がる。&lt;/p&gt;
&lt;p&gt;API定義からのコード生成によるアプローチも考えられるが、筆者はusecaseの入出力とclientは密結合な概念であると考え、usecaseの入出力からserver, clientを生成するアプローチを好んでいる。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/hori-ryota/go-codegen/tree/master/codegen/api&quot;&gt;go-codegen/codegen/api at master · hori-ryota/go-codegen&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;なお、clientにはGo言語だけでなくKotlinも想定することで、Kotlin Multiplatformの恩恵により全プラットフォーム向けのclientライブラリを提供することを狙っている。&lt;/p&gt;
&lt;p&gt;永続化に代表される他のadapterについても可能な限りコード生成による省エネ化を図っていきたい。&lt;/p&gt;
&lt;h3&gt;プライベートフィールドの扱い&lt;/h3&gt;
&lt;p&gt;Go言語においてだが、特に永続化のためにプライベートフィールドのデータを他packageから取得したくなることが多い。domain層を汚したくはないが、dumpとrestoreにより露出するような実装が必要となってしまっている。&lt;/p&gt;
&lt;h3&gt;Query側へのアプローチ&lt;/h3&gt;
&lt;p&gt;ここまではドメイン知識に基づく実装について言及したが、実サービスにおいては閲覧のためのデータ取得が必要となる場合が多い。&lt;/p&gt;
&lt;p&gt;特定のドメイン要素への作用を意図した操作であればドメイン駆動設計の領分であるが、データ閲覧を目的とした取得操作には別の対応が必要となる。&lt;/p&gt;
&lt;p&gt;筆者はCQRSという作用（Command）と取得（Query）を分離した設計方針を活用したいが、素直に実装するとQuery側を実現する実装コストが高くCommand側の要素を転用したい欲求にかられる。&lt;/p&gt;
&lt;p&gt;Query側へドメイン知識の流出が生じることも問題な上、コード生成を活用してもQuery側のデータオブジェクトは取得側の事情へ柔軟に対応したいため、単純なdump的なコード生成では破綻する可能性が高いことも悩みを深める。&lt;/p&gt;
&lt;p&gt;他のgeneratorでも活用しているが、Go言語の型を2つ指定すれば対応するフィールド及びアクセサを用いてconvertする処理を生成する仕組みは実装したので、補助的な generator の活用でアプローチできないか模索中。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/hori-ryota/go-codegen/blob/master/util/typeutil/printer_print_converter.go&quot;&gt;go-codegen/printer_print_converter.go at master · hori-ryota/go-codegen&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;frontend側へのアプローチ&lt;/h3&gt;
&lt;p&gt;ドメインオブジェクトにはbackendでもfrontendでも共通で用いたいものが多い。特にvalidationなどに用いる仕様はAPIと同じく連携コストを肥大させる要因であり、かつ本来はfrontendで管理したいものではないのでbackendから生成できれば恩恵は大きいと考えている。&lt;/p&gt;
&lt;p&gt;application概念も含めた全概念を同期させるのは取得できる情報や実処理（永続化 or 通信による移譲 など）の差によって単純には難しいと考えている。validationルールだけでも同期できると嬉しいが、せっかくなのでもう少し恩恵を大きくしたい。&lt;/p&gt;
&lt;p&gt;（なお、APIと違いロジックを含む概念層のGo言語実装をKotlinに変換するところも悩み中である。おとなしく最初からbackendをKotlinで実装すれば変換は楽になると思われるが、今度はドメイン駆動設計のDSLとして活用しているGo言語の良さとのトレードオフになる。）&lt;/p&gt;
&lt;h3&gt;チーム境界&lt;/h3&gt;
&lt;p&gt;CQRSのアプローチを取り、backendとfrontendでモデル共有ができたとき、チームはbackend/frontendではなくcommand/queryで分掌できるのではないかと考えている。コンテキスト間も含めて人は相互に横断するが、チーム単位としてはcommand/queryで帽子を被りかえられるのではないだろうか。&lt;/p&gt;
&lt;p&gt;ドメイン知識に興味が強いcommandチームと、UIに興味が強いqueryチーム。うまく行けば実装上、仕様上でも相互に汚染しづらい鍛え続けられるアーキテクチャ＆チームとなるのではないかと検討している。&lt;/p&gt;
&lt;p&gt;（Go言語→Kotlin Multiplatform生成なCommandチームと、BFFも活用しつつの取得用backend＆FlutterなQueryチーム、なんて夢を抱いている）&lt;/p&gt;
&lt;h2&gt;おわりに&lt;/h2&gt;
&lt;p&gt;ドメイン駆動設計については多くの有益な言及がありますが、ドメイン駆動設計の対象は広くて深いため、全体地図が描けるまでは迷子になりがちです。&lt;/p&gt;
&lt;p&gt;ドメイン駆動設計本を呼んでいても実装の各戦術要素に着目しがちなこともあり、そもそも何を成したいのかという目的意識を見失いがちです。設計の根本的な目的の整理からアプローチすることで一助となればと思い記述してみました。継続的に価値を生み続ける助けとなれば幸いです。&lt;/p&gt;
&lt;p&gt;code generator を中心とするアプローチはまだ自分も道半ばなので、継続的に発信していく予定です。ぜひ交流いただいて知見共有ができれば嬉しいです。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[表現力の高い Go の Error 群を go generate する go-generror を作った]]></title><description><![CDATA[連日 DDD と go generate で投稿していますが、今回は表現力と安全性の高い Error 周りを生成する go-generror を作りました。]]></description><link>https://hori-ryota.com/blog/2019-02-22-create-go-generror/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2019-02-22-create-go-generror/</guid><pubDate>Fri, 22 Feb 2019 02:05:00 GMT</pubDate><content:encoded>&lt;p&gt;連日 DDD と go generate で投稿していますが、今回は表現力と安全性の高い Error 周りを生成する go-generror を作りました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;&lt;a href=&quot;https://github.com/hori-ryota/go-generror&quot;&gt;hori-ryota/go-generror&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;対象ディレクトリ内のファイルを走査して Error 型を生成する&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Error&lt;/code&gt; と &lt;code class=&quot;language-text&quot;&gt;ErrorDetail&lt;/code&gt; の2層構造&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Error&lt;/code&gt; : &lt;code class=&quot;language-text&quot;&gt;error&lt;/code&gt; インターフェースを実装し、 &lt;code class=&quot;language-text&quot;&gt;ErrorCode&lt;/code&gt; を一つ、 &lt;code class=&quot;language-text&quot;&gt;ErrorDetail&lt;/code&gt; を複数持つ。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ErrorCode&lt;/code&gt;: HTTP の StatusCode のような使用感を想定。生成された &lt;code class=&quot;language-text&quot;&gt;Error&lt;/code&gt; が &lt;code class=&quot;language-text&quot;&gt;IsFoo() bool&lt;/code&gt; のような判定メソッドを持つ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;引数を元に生成される&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ErrorDetail&lt;/code&gt; : エラーの詳細定義が目的。 UI や Log に出力したい、サービス内エラー詳細。 &lt;code class=&quot;language-text&quot;&gt;ErrorDetailCode&lt;/code&gt; とパラメータを持つ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ErrorDetailCode&lt;/code&gt; : 詳細エラーのコード。コードごとに固定長の型安全なパラメータを定義する&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;//errcode&lt;/code&gt; のコメントを検知して生成される&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;デフォルトがカレントディレクトリなので &lt;code class=&quot;language-text&quot;&gt;//go:generate go-generror&lt;/code&gt; を対象ディレクトリに記述すれば &lt;code class=&quot;language-text&quot;&gt;go generate&lt;/code&gt; で起動する&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;動作サンプル&lt;/h2&gt;
&lt;p&gt;こんな感じで定義します。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;example.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; example

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;errors&quot;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//go:generate go-generror Unknown BadRequest PermissionDenied NotFound&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; NameSpec &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	lessThan &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;
	moreThan &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s NameSpec&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Validate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Error &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;//errcode NameIsInvalidLength,lessThan int,moreThan int&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lessThan &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;moreThan &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ErrorBadRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;errors&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;invalid name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;NameIsInvalidLengthError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lessThan&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;moreThan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Validate&lt;/code&gt; のメソッド内に &lt;code class=&quot;language-text&quot;&gt;//errcode&lt;/code&gt; が記述されています。&lt;/p&gt;
&lt;p&gt;こんな感じで出力されます。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;error_gen.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Code generated ; DO NOT EDIT&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; example

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;strconv&quot;&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;strings&quot;&lt;/span&gt;

	&lt;span class=&quot;token string&quot;&gt;&quot;github.com/hori-ryota/zaperr&quot;&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;go.uber.org/zap&quot;&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;go.uber.org/zap/zapcore&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ErrorCode &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	errorUnknown          ErrorCode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Unknown&quot;&lt;/span&gt;
	errorBadRequest       ErrorCode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;BadRequest&quot;&lt;/span&gt;
	errorPermissionDenied ErrorCode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;PermissionDenied&quot;&lt;/span&gt;
	errorNotFound         ErrorCode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;NotFound&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c ErrorCode&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; Error &lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;Details&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;ErrorDetail

	&lt;span class=&quot;token function&quot;&gt;IsUnknown&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;IsBadRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;IsPermissionDenied&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;IsNotFound&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;newError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;source &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; code ErrorCode&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; details &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;ErrorDetail&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Error &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; errorImpl&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		source&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;  source&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		code&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;    code&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		details&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; details&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ErrorUnknown&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;source &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; details &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;ErrorDetail&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Error &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;newError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;source&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errorUnknown&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; details&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ErrorBadRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;source &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; details &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;ErrorDetail&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Error &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;newError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;source&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errorBadRequest&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; details&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ErrorPermissionDenied&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;source &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; details &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;ErrorDetail&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Error &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;newError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;source&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errorPermissionDenied&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; details&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ErrorNotFound&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;source &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; details &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;ErrorDetail&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Error &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;newError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;source&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errorNotFound&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; details&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; errorImpl &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	source  &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;
	code    ErrorCode
	details &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;ErrorDetail
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e errorImpl&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; fmt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%s:%s:%s&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;details&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;source&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e errorImpl&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Details&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;ErrorDetail &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;details
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e errorImpl&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IsUnknown&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; errorUnknown
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e errorImpl&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IsBadRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; errorBadRequest
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e errorImpl&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IsPermissionDenied&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; errorPermissionDenied
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e errorImpl&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IsNotFound&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; errorNotFound
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ErrorDetail &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	code ErrorDetailCode
	args &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;newErrorDetail&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;code ErrorDetailCode&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; args &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ErrorDetail &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ErrorDetail&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		code&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; code&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		args&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e ErrorDetail&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; strings&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Join&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;args&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ErrorDetailCode &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c ErrorDetailCode&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; ErrorDetailNameIsInvalidLength ErrorDetailCode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;NameIsInvalidLength&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;NameIsInvalidLengthError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	lessThan &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	moreThan &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ErrorDetail &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;newErrorDetail&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
		ErrorDetailNameIsInvalidLength&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		strconv&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;FormatInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;int64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lessThan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		strconv&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;FormatInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;int64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;moreThan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e errorImpl&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;MarshalLogObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;enc zapcore&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ObjectEncoder&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	zaperr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ToNamedField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;sourceError&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;source&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;AddTo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;enc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	zap&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;code&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;AddTo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;enc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	zap&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Any&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;details&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;details&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;モチベーション&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;ドメイン駆動設計（以下 DDD ）をやっていきたい&lt;/li&gt;
&lt;li&gt;DDD ではドメイン層で対象領域の概念をコードで表現することが重要&lt;/li&gt;
&lt;li&gt;本質以外の作業はノイズなので人間にやらせたくない&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Go の &lt;code class=&quot;language-text&quot;&gt;error&lt;/code&gt; は表現力に乏しく、ドメイン層でのエラーは独自定義が望まれる&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;上層で型安全でないアサーション地獄をするのは Type-safe な言語のメリットを消している&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;サービス開発で特にコミュニケーション＆作業コストが高い領域なので自動生成の恩恵が大きい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;メンテが後手に回りがちなドキュメントとにらめっこしがち&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ドキュメントを読んで型安全でない string とパラメータ群の switch 文。つらい。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;副産物としてドキュメントを提供していきたい&lt;/li&gt;
&lt;li&gt;副産物として型安全な Formatter 等を提供していきたい&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ということで &lt;code class=&quot;language-text&quot;&gt;go generate&lt;/code&gt; で自動生成することにしました。使用感は良さそう。&lt;/p&gt;
&lt;p&gt;今回は「この Error 型が正しい！」という話ではなく、エラー定義を parse して成果物を generate することのメリットの話が重要なポイントです。&lt;/p&gt;
&lt;h3&gt;エラー定義から成果物を generate するメリットについて&lt;/h3&gt;
&lt;p&gt;エラー出力は以下のような理由によりメンテナンスコストが高く、型安全でなく、テストしづらいものだと思います。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;サービス仕様の変更により種類が増減しやすい&lt;/li&gt;
&lt;li&gt;増減が多いこともありドキュメントの更新が漏れやすい&lt;/li&gt;
&lt;li&gt;正常系テストでは生じないものも多く、 backend 実装者のモチベーションが低くなりがち&lt;/li&gt;
&lt;li&gt;新しいエラーを作るのが面倒で既存エラーに便乗したくなりがち&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;可変な値を出力文言に組み入れたいが、対応コストが高くなりがち&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;バリデーションロジックとの整合性担保が悩ましい&lt;/li&gt;
&lt;li&gt;型安全でなく、エラー種ごとに switch 文などで対応しがち&lt;/li&gt;
&lt;li&gt;型安全でなく、多言語対応での対応漏れ検知が難しい&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;仕様書との対応確認が目視&lt;/li&gt;
&lt;li&gt;使っていなさそうなエラー種が消していいのかわからない&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ちゃんとモチベーション高く管理すれば全て解決はできると思いますが、異常系対応のコストはなるべく低く保ちたいです。&lt;/p&gt;
&lt;p&gt;欲しいものは以下と考えます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;backend として&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;安全に補完の恩恵をうけつつエラー生成したい&lt;/li&gt;
&lt;li&gt;定義だけ書きたい。型安全にする系の退屈な実装は定義から作っといて欲しい&lt;/li&gt;
&lt;li&gt;使用箇所で気軽に定義したい（含：ドキュメントの更新など）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;frontend として&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;安全に補完の恩恵をうけつつエラー対応したい&lt;/li&gt;
&lt;li&gt;事情が変わったら適切に検知したい&lt;/li&gt;
&lt;li&gt;対応すべきものが把握しやすいのがいい&lt;/li&gt;
&lt;li&gt;文言管理はまとめたい&lt;/li&gt;
&lt;li&gt;多言語対応したい&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;backend 実装箇所でのエラー定義生成とすることで、上記の欲求は以下のように改善されます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;backend として&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;安全に補完の恩恵をうけつつエラー生成したい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;型安全な生成コードで Type-safe の恩恵に預かれる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;定義だけ書きたい。型安全にする系の退屈な実装は定義から作っといて欲しい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;定義から実装を生成するので楽&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;使用箇所で気軽に定義したい（含：ドキュメントの更新など）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;実装箇所に定義を書けば邪魔にならないところに生成される&lt;/li&gt;
&lt;li&gt;ドキュメントなども必要であれば然るべきところに自動生成できる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;frontend として&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;安全に補完の恩恵をうけつつエラー対応したい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;型安全な Formatter interface を生成すれば Type-safe の恩恵に預かれる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;事情が変わったら適切に検知したい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;型安全な Formatter interface を生成すれば Type-safe の恩恵に預かれる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;対応すべきものが把握しやすいのがいい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;型安全な Formatter interface を生成すれば Type-safe の恩恵に預かれる&lt;/li&gt;
&lt;li&gt;ドキュメントなども必要であれば然るべきところに自動生成できる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;文言管理はまとめたい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Formatter interface を生成し、実装をまとめれば OK&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;多言語対応したい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Formatter interface の実装を言語ごとに実装すれば OK&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;go-generror&lt;/code&gt; では &lt;code class=&quot;language-text&quot;&gt;generror.Run&lt;/code&gt; を exported 定義しているので、独自定義の &lt;code class=&quot;language-text&quot;&gt;main.go&lt;/code&gt; を用意すればデフォルトファイル以外の生成が可能です。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;templates &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;template&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Template&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    generror&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;GodefTmpl&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    customTmpl1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    customTmpl2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

renderers &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;generror&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TemplParam&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;templates&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; templates &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    tmpl &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; tempates&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    dstFileName &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; dstFileNames&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    renderers&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param generror&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TmplParam&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

        param&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ImportPackages &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ImportPackages&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        param&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ImportPackages &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ImportPackages&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;strings&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        param&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ImportPackages &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ImportPackages&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;go.uber.org/zap&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        param&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ImportPackages &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ImportPackages&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;go.uber.org/zap/zapcore&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        param&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ImportPackages &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ImportPackages&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;github.com/hori-ryota/zaperr&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        buf &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bytes&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Buffer&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; tmpl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Execute&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; param&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; err
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

        out&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; format&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Source&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Bytes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; err
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ioutil&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;WriteFile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstFileName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; out&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0644&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; generror&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; renderers&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;よって、以下のようなテンプレートを用意することで（サンプルは Go ですが） Formatter を生成することができます。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;customTmpl.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ErrorFormatter &lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DetailErrorCodes &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Code &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Params &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Name &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Type &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; end &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; end &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ErrorDetail &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    Code &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
    Args &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;FormatError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;formatter ErrorFormatter&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err ErrorDetail&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Code &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DetailErrorCodes &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;{{ .Code }}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; formatter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Code &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; $i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; $v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Params &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Args&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; $i &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; $v&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Type &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; end &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; end &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;generated&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;error_gen.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ErrorFormatter &lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;NameIsInvalidLengthError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
		lessThan &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		moreThan &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;FooError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
		arg1 &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		arg2 time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Time&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		arg3 &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;BarError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ErrorDetail &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	Code &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
	Args &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;FormatError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;formatter ErrorFormatter&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err ErrorDetail&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Code &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;NameIsInvalidLength&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; formatter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NameIsInvalidLengthError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
			err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Args&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Args&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Foo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; formatter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;FooError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
			err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Args&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Args&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Time&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Args&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Bar&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; formatter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;BarError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この型安全な &lt;code class=&quot;language-text&quot;&gt;ErrorFormatter&lt;/code&gt; を実装することで各種メリットを享受できるようになります。通信層での型変換も自動生成が可能です。&lt;/p&gt;
&lt;p&gt;ただのテンプレート生成なので Go 言語以外の他言語にも工夫次第で対応できます（個人的には Kotlin 対応を試し中です）。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;これでドメインの重要な表現であるエラー周りについても、見やすく楽に、表現力は高く定義することが可能になりました。ドメイン層での概念の表現に集中することは非常に重要なため、大きなメリットとなります。&lt;/p&gt;
&lt;p&gt;Go は基本的に &lt;code class=&quot;language-text&quot;&gt;error&lt;/code&gt; インターフェースを推奨しますが、それは内部実装に依存せずに汎用的な error として扱うことを呼び出し元に求めることが前提です。呼び出し元に型安全を求めるのにわざわざ表現力を落とした &lt;code class=&quot;language-text&quot;&gt;error&lt;/code&gt; インターフェースで抽象化して型アサーションする必要はないし、デメリットが大きいと思っています。&lt;/p&gt;
&lt;p&gt;さて、代表的な「型の恩恵を受けたいが丁寧にやると手が疲れる」概念である error と event の前者が達成できたので、次は event を仕込む予定です。&lt;/p&gt;
&lt;p&gt;event はその特性上、 generics が無いことや複数送受信などで実装が複雑になりがちですが、 generator を使うことで効率化と快適さを得ることができるはずです。&lt;/p&gt;
&lt;p&gt;乞うご期待。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[DDD するのに Go でも required を表現したくて go-genconstructor を作った]]></title><description><![CDATA[go-genaccessor に続き、今度は required を表現するために constructor を生成する go-genconstructor を作りました。]]></description><link>https://hori-ryota.com/blog/2019-02-21-create-go-genconstructor/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2019-02-21-create-go-genconstructor/</guid><pubDate>Thu, 21 Feb 2019 03:00:00 GMT</pubDate><content:encoded>&lt;p&gt;go-genaccessor に続き、今度は required を表現するために constructor を生成する go-genconstructor を作りました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;&lt;a href=&quot;https://github.com/hori-ryota/go-genconstructor&quot;&gt;hori-ryota/go-genconstructor&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;対象ディレクトリ内のファイルを走査して constructor を生成する&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;//genconstructor&lt;/code&gt; のついた struct を検知して自動生成&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;required&lt;/code&gt; の struct tag がついたもののみコンストラクタの引数にとることで required を表現&lt;/li&gt;
&lt;li&gt;タグのパラメータに指定することで const value 対応&lt;/li&gt;
&lt;li&gt;デフォルトがカレントディレクトリなので &lt;code class=&quot;language-text&quot;&gt;//go:generate go-genconstructor&lt;/code&gt; を対象ディレクトリに記述すれば &lt;code class=&quot;language-text&quot;&gt;go generate&lt;/code&gt; で起動する&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;基本的な思想は &lt;a href=&quot;/blog/create-go-genaccessor&quot;&gt;go-genaccessor&lt;/a&gt; と同じですね。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/create-go-genaccessor&quot;&gt;DDD がしたいので Go の Accessor を go generate する go-genaccessor を作った&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;動作サンプル&lt;/h2&gt;
&lt;p&gt;こんな感じで定義します。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;person.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; example

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;time&quot;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//go:generate go-genconstructor&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//genconstructor&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; Person &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	id        &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;`required:&quot;&quot;`&lt;/span&gt;
	name      &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;`required:&quot;&quot;`&lt;/span&gt;
	tags      &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
	createdAt time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Time &lt;span class=&quot;token string&quot;&gt;`required:&quot;time.Now()&quot;`&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こんな感じで出力されます。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;constructor_gen.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Code generated by go-genconstructor; DO NOT EDIT.&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; example

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;time&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;NewPerson&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	id &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	name &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Person &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; Person&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		id&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;        id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		name&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;      name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		createdAt&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;モチベーション&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;ドメイン駆動設計（以下 DDD ）をやっていきたい&lt;/li&gt;
&lt;li&gt;DDD ではドメイン層で対象領域の概念をコードで表現することが重要&lt;/li&gt;
&lt;li&gt;本質以外の作業はノイズなので人間にやらせたくない&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;requied を表現するには constructor が必要だが、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;各 struct に実装して回るのは非本質的&lt;/li&gt;
&lt;li&gt;field の増減時に編集作業が生じるのは非本質的&lt;/li&gt;
&lt;li&gt;コード量が増えるため概念の読み取りにノイズが大きすぎる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ということで例のごとく &lt;code class=&quot;language-text&quot;&gt;go generate&lt;/code&gt; で自動生成することにしました。超捗る。&lt;/p&gt;
&lt;h2&gt;こだわりポイント&lt;/h2&gt;
&lt;p&gt;基本的には &lt;a href=&quot;/blog/create-go-genaccessor&quot;&gt;go-genaccessor&lt;/a&gt; と同じですが&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;DDD なので概念がシンプルに表現できていて欲しい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;struct tag への記載による定義とすることで、何が required なのかわかりやすく、表現力が高い&lt;/li&gt;
&lt;li&gt;struct tag で表現できているので constructor の実装はノイズになる。よって1ファイルにまとめて生成。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;概念を表現する作業に集中したい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;型解析ではなく ast での parse とすることで、コンパイルエラーが生じる状態のコードでも generator を実行可能にした&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;固定値や現在時刻を持つ field 定義もサポートしたい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;createdAt 系とか&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;TypeName() string&lt;/code&gt; みたいな struct 固定の値とか&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ライブラリにロックインしそうな定義記述はできれば避けたい。実現したいことを定義で表現し、ツールは何でもいいとしたい。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;表現力を高め、かつ楽ができるようにしています。&lt;/p&gt;
&lt;h2&gt;go-genaccessor との組み合わせ&lt;/h2&gt;
&lt;p&gt;struct タグは干渉しないので &lt;a href=&quot;/blog/create-go-genaccessor&quot;&gt;go-genaccessor&lt;/a&gt; と組み合わせることができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; example

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;time&quot;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//go:generate go-genaccessor&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//go:generate go-genconstructor&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//genconstructor&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; Person &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	id        &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;    &lt;span class=&quot;token string&quot;&gt;`required:&quot;&quot; getter:&quot;&quot;`&lt;/span&gt;
	name      &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;    &lt;span class=&quot;token string&quot;&gt;`required:&quot;&quot; getter:&quot;&quot; setter:&quot;Rename&quot;`&lt;/span&gt;
	tags      &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;  &lt;span class=&quot;token string&quot;&gt;`getter:&quot;&quot; setter:&quot;&quot;`&lt;/span&gt;
	createdAt time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Time &lt;span class=&quot;token string&quot;&gt;`required:&quot;time.Now()&quot; getter:&quot;&quot;`&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;コードに各実装が溢れかえるよりも遥かに意図を汲み取りやすい表現になっているのではないでしょうか。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;go-genconstructor はドメイン層に限らず、 required の概念が必要なところで各所使っていけるものです。 stateless な各 service 系でも依存実装を必ず持つことが保証できます。&lt;/p&gt;
&lt;p&gt;Go の互換性を大事にする思想は素晴らしいものではありますが、 required は required なのできちんと制約を表現することが大事です。そもそも required なものが追加される時点で互換性は失っています。実行時エラーとするよりはコンパイルエラーの恩恵を享受するほうが利便性としても、安全性としても、表現力としても良いと思います。&lt;/p&gt;
&lt;p&gt;readonly と required が表現できるようになったことで DDD における値周りのモデリングは快適になったかと思います。 DDD の他の要素は愚直にコードで表現していってもいいのですが、 generics が無いこともあって人間がやるには辛い作業が生じる概念がいくつかあります。&lt;/p&gt;
&lt;p&gt;次は代表的な「型の恩恵を受けたいが丁寧にやると手が疲れる」概念である error と event について generator を仕込んでいく予定です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;エラーを表現するための &lt;code class=&quot;language-text&quot;&gt;go-generror&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;結果整合性のために用いるアプリケーションイベントのための &lt;code class=&quot;language-text&quot;&gt;go-genappevent&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;乞うご期待。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[DDD がしたいので Go の Accessor を go generate する go-genaccessor を作った]]></title><description><![CDATA[Go で DDD をやっていくため、 struct に getter setter を生やせる go-genaccessor を作りました。]]></description><link>https://hori-ryota.com/blog/2019-02-20-create-go-genaccessor/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2019-02-20-create-go-genaccessor/</guid><pubDate>Wed, 20 Feb 2019 12:40:00 GMT</pubDate><content:encoded>&lt;p&gt;Go で DDD をやっていくため、 struct に getter setter を生やせる go-genaccessor を作りました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;&lt;a href=&quot;https://github.com/hori-ryota/go-genaccessor&quot;&gt;hori-ryota/go-genaccessor&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;対象ディレクトリ内のファイルを走査して accessor を生成する&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;getter&lt;/code&gt; &lt;code class=&quot;language-text&quot;&gt;setter&lt;/code&gt; の struct tag を検知して自動生成&lt;/li&gt;
&lt;li&gt;タグのパラメータに指定することで alias 対応&lt;/li&gt;
&lt;li&gt;デフォルトがカレントディレクトリなので &lt;code class=&quot;language-text&quot;&gt;//go:generate go-genaccessor&lt;/code&gt; を対象ディレクトリに記述すれば &lt;code class=&quot;language-text&quot;&gt;go generate&lt;/code&gt; で起動する&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;動作サンプル&lt;/h2&gt;
&lt;p&gt;こんな感じで定義します。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;person.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; example

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;encoding&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//go:generate go-genaccessor&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; Person &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	id   &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;                 &lt;span class=&quot;token string&quot;&gt;`getter:&quot;&quot;`&lt;/span&gt;
	name &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;                 &lt;span class=&quot;token string&quot;&gt;`getter:&quot;&quot; setter:&quot;Rename&quot;`&lt;/span&gt;
	tags &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;               &lt;span class=&quot;token string&quot;&gt;`getter:&quot;&quot; setter:&quot;&quot;`&lt;/span&gt;
	text encoding&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TextMarshaler &lt;span class=&quot;token string&quot;&gt;`getter:&quot;&quot; setter:&quot;&quot;`&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こんな感じで出力されます。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;accessor_gen.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Code generated by go-genaccessor; DO NOT EDIT.&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; example

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;encoding&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m Person&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m Person&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;Person&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Rename&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; s
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m Person&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Tags&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tags
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;Person&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SetTags&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tags &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; s
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m Person&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Text&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; encoding&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TextMarshaler &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;Person&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SetText&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s encoding&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TextMarshaler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; s
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;モチベーション&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;ドメイン駆動設計（以下 DDD ）をやっていきたい&lt;/li&gt;
&lt;li&gt;DDD ではドメイン層で対象領域の概念をコードで表現することが重要&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Go で readonly を表現するのがつらすぎる&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;field はプライベートにし、必要な field に適切な getter を実装する必要がある&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;概念の表現に集中するには作業ノイズが大きすぎる&lt;/li&gt;
&lt;li&gt;コード量が増えるため概念の読み取りにノイズが大きすぎる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ということで &lt;code class=&quot;language-text&quot;&gt;go generate&lt;/code&gt; で自動生成することにしました。超捗る。&lt;/p&gt;
&lt;p&gt;コードジェネレータでの生成はフレームワークと違って用途が合わなくなっても過去の生成物はそのまま利用できるのが美味しいですね。&lt;/p&gt;
&lt;h2&gt;こだわりポイント&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;DDD なので概念がシンプルに表現できていて欲しい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;struct tag への記載による定義とすることで、何が読み取り可 or 書き込み可なのかわかりやすく、表現力が高い&lt;/li&gt;
&lt;li&gt;struct tag で表現できているので accessor の実装はノイズになる。よって1ファイルにまとめて生成。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;概念を表現する作業に集中したい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;型解析ではなく ast での parse とすることで、コンパイルエラーが生じる状態のコードでも generator を実行可能にした&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;setter の乱用は防ぎたいが、シンプルな値置換はサポートしたい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;alias を導入することで &lt;code class=&quot;language-text&quot;&gt;Rename&lt;/code&gt; のような表現力が高いシンプルな値置換を generate 対象にした&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;副産物として getter も alias 設定が可能となり、ダックタイピング等がしやすくなった&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ライブラリにロックインしそうな定義記述はできれば避けたい。実現したいことを定義で表現し、ツールは何でもいいとしたい。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;単に楽ができればいいというわけではなく、表現力を高めるための一助となることを目的としました。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;ドメイン層とアプリケーション層ではそれぞれドメイン概念とアプリケーション概念を的確に表現することがとても重要なので、本質的な表現以外は全てノイズと考えて人間は気にしないでいいようにしていきたいです。&lt;/p&gt;
&lt;p&gt;私事ですが、諸事情で動画配信エンジニアは引退して開発効率おじさんに業務転換することにしました。 まずは正しい DDD の浸透にモチベーションがあるので、ちょこちょこ発信していければと思います。&lt;/p&gt;
&lt;p&gt;手始めに generator を色々と整えているのですが、直近では&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;required を表現するための &lt;code class=&quot;language-text&quot;&gt;go-genconstructor&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;エラーを表現するための &lt;code class=&quot;language-text&quot;&gt;go-generror&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;結果整合性のために用いるアプリケーションイベントのための &lt;code class=&quot;language-text&quot;&gt;go-genappevent&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;の公開を予定しています。乞うご期待。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CircleCI 2.0 で Go 1.10 の build cache をいい感じに効かせる]]></title><description><![CDATA[今更ながら CircleCI 2.0 を本格的に触りました。 CircleCI 2.0 になりキャッシュの柔軟性が向上したようなので、 Go 1.10 から導入された build cache と併せて最適化してみました。]]></description><link>https://hori-ryota.com/blog/2018-05-19-circleci-golang-buildcache-key/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2018-05-19-circleci-golang-buildcache-key/</guid><pubDate>Sat, 19 May 2018 08:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今更ながら CircleCI 2.0 を本格的に触りました。 CircleCI 2.0 になりキャッシュの柔軟性が向上したようなので、 Go 1.10 から導入された build cache と併せて最適化してみました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;前提知識&lt;/h2&gt;
&lt;h3&gt;ドキュメントなど&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://circleci.com/docs/2.0/language-go/&quot;&gt;Language Guide: Go - CircleCI&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://circleci.com/docs/2.0/caching/&quot;&gt;Caching Dependencies - CircleCI&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://golang.org/cmd/go/#hdr-Build_and_test_caching&quot;&gt;go - hdr-Build&lt;em&gt;and&lt;/em&gt;test_caching - The Go Programming Language&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;戦略&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;依存管理は &lt;a href=&quot;https://github.com/golang/dep&quot;&gt;dep&lt;/a&gt; を使う&lt;/li&gt;
&lt;li&gt;vendor は Gopkg.lock が一緒なら同じものを用いる&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;build cache は基本的にはブランチごとに管理&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ただし、新規ブランチは master からキャッシュを拾いたい&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;お急ぎの人のための結論&lt;/h2&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /go/src/github.com/hori&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ryota/hoge &lt;span class=&quot;token comment&quot;&gt;# 対象のリポジトリに合わせて変更&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/golang&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;1.10.2
    &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;GOCACHE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/tmp/go/cache&quot;&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; git submodule sync
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; git submodule update &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;init
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;restore_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; vendor&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gopkg.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; dep
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ensure
          &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
            if [ ! -d vendor ]; then
              if ! type dep &gt;/dev/null 2&gt;&amp;amp;1; then
                go get github.com/golang/dep/cmd/dep
              fi
              dep ensure
            fi&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; vendor&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gopkg.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; vendor
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dep
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; /go/bin/dep
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;restore_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; .Branch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;master&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; build
          &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; make build
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; .Branch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; .Revision &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; /tmp/go/cache
          &lt;span class=&quot;token key atrule&quot;&gt;when&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; on_fail
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; prepare cache dir if not exists
          &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; mkdir &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;p $GOCACHE
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;persist_to_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; tmp/go/cache
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; go/src/github.com/hori&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ryota/hoge/artifacts

  &lt;span class=&quot;token key atrule&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /go/src/github.com/hori&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ryota/hoge
    &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/golang&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;1.10.2
    &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;GOCACHE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/tmp/go/cache&quot;&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;restore_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; vendor&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gopkg.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; test
          &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; make test
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; .Branch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; .Revision &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; /tmp/go/cache
          &lt;span class=&quot;token key atrule&quot;&gt;when&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; always
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;persist_to_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; .
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; artifacts

  &lt;span class=&quot;token key atrule&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /go/src/github.com/hori&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ryota/hoge
    &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/golang&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;1.10.2
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; .
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; deploy
        &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; make deploy

&lt;span class=&quot;token key atrule&quot;&gt;workflows&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; test &lt;span class=&quot;token comment&quot;&gt;# if needed&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;requires&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; deploy &lt;span class=&quot;token comment&quot;&gt;# if needed&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;requires&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; test &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;解説&lt;/h2&gt;
&lt;p&gt;キャッシュの挙動とともに上から解説していきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /go/src/github.com/hori&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ryota/hoge &lt;span class=&quot;token comment&quot;&gt;# 対象のリポジトリに合わせて変更&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/golang&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;1.10.2&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Go なので &lt;code class=&quot;language-text&quot;&gt;woking_directory&lt;/code&gt; を GOPATH 内に設定しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;    &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;GOCACHE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/tmp/go/cache&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;build cache の保存先は &lt;code class=&quot;language-text&quot;&gt;$GOCACHE&lt;/code&gt; で指定できます。扱いやすいように明示的に設定。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; git submodule sync
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; git submodule update &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;init&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;本題と関係ないですが submodule を取得するならここ。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;restore_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; vendor&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gopkg.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; dep
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ensure
          &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
            if [ ! -d vendor ]; then
              if ! type dep &gt;/dev/null 2&gt;&amp;amp;1; then
                go get github.com/golang/dep/cmd/dep
              fi
              dep ensure
            fi&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; vendor&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gopkg.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; vendor
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dep
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; /go/bin/dep&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここは &lt;code class=&quot;language-text&quot;&gt;vendor&lt;/code&gt; のキャッシュです。まず &lt;code class=&quot;language-text&quot;&gt;restore_cache&lt;/code&gt; ですが、 &lt;code class=&quot;language-text&quot;&gt;restore_cache&lt;/code&gt; は &lt;code class=&quot;language-text&quot;&gt;keys&lt;/code&gt; で指定したリストを順番にチェックし、初めに見つけた最初のキャッシュのみ取得します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;restore_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; vendor&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gopkg.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; dep&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;よってこの場合だと &lt;code class=&quot;language-text&quot;&gt;vendor-{{ checksum &amp;quot;Gopkg.lock&amp;quot; }}&lt;/code&gt; があれば使用し、なければ &lt;code class=&quot;language-text&quot;&gt;dep&lt;/code&gt; を取得します。更になければ無視。&lt;code class=&quot;language-text&quot;&gt;vendor&lt;/code&gt; が存在していたら &lt;code class=&quot;language-text&quot;&gt;dep&lt;/code&gt; は入れる必要がないので便利ですね。&lt;/p&gt;
&lt;p&gt;次に &lt;code class=&quot;language-text&quot;&gt;ensure&lt;/code&gt; 部ですが、 &lt;code class=&quot;language-text&quot;&gt;vendor/&lt;/code&gt; と &lt;code class=&quot;language-text&quot;&gt;dep&lt;/code&gt; の存在によって処理を分岐させます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ensure
          &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
            if [ ! -d vendor ]; then
              if ! type dep &gt;/dev/null 2&gt;&amp;amp;1; then
                go get github.com/golang/dep/cmd/dep
              fi
              dep ensure
            fi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;vendor/&lt;/code&gt; ディレクトリがなかった場合のみ、 &lt;code class=&quot;language-text&quot;&gt;dep&lt;/code&gt; の存在チェックをして、なければインストール。その後 &lt;code class=&quot;language-text&quot;&gt;dep&lt;/code&gt; を使って &lt;code class=&quot;language-text&quot;&gt;ensure&lt;/code&gt; しています。&lt;/p&gt;
&lt;p&gt;最後はキャッシュに保存。 CircleCI 2.0 のキャッシュは key がすでに存在すれば上書きせずにスルーします。今回は &lt;code class=&quot;language-text&quot;&gt;vendor&lt;/code&gt; は &lt;code class=&quot;language-text&quot;&gt;Gopkg.lock&lt;/code&gt; に対して一意とし、 &lt;code class=&quot;language-text&quot;&gt;dep&lt;/code&gt; の更新性も考慮しないので決め打ちです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; vendor&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gopkg.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; vendor
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dep
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; /go/bin/dep&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;もし &lt;code class=&quot;language-text&quot;&gt;dep&lt;/code&gt; の更新を行いたい場合は key にリビジョンや日付などの suffix をつけても良いかもです。&lt;/p&gt;
&lt;p&gt;次に build cache です。方針のおさらいをしておきます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;build cache は基本的にはブランチごとに管理&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ただし、新規ブランチは master からキャッシュを拾いたい&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;これを実現するための &lt;code class=&quot;language-text&quot;&gt;restore_cache&lt;/code&gt; がこちら。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;restore_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; .Branch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;master&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上からチェックされるので意図通りの取得ができるかと思います。3つ目の &lt;code class=&quot;language-text&quot;&gt;build-cache-&lt;/code&gt; のみのものは使われることはないと思いますが、一応つけてみました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;save_cache&lt;/code&gt; 側がこちら。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; build
          &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; make build
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; .Branch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; .Revision &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; /tmp/go/cache
          &lt;span class=&quot;token key atrule&quot;&gt;when&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; on_fail&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;CircleCI 2.0 のキャッシュは、 key が前方一致する中で最新のものを取得する仕組みになっています。&lt;/p&gt;
&lt;p&gt;なので更新性のあるデータについては &lt;code class=&quot;language-text&quot;&gt;{{ .Revision }}&lt;/code&gt; のような suffix をつけて保存しておき、取得側では suffix を取り除いた key を用いるとうまくいきます。同じ Revision でも更新性をもたせたい場合は &lt;code class=&quot;language-text&quot;&gt;{{ epoch }}&lt;/code&gt; などを併用すると良いかと思います。&lt;/p&gt;
&lt;p&gt;変数の一覧はこちら。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://circleci.com/docs/2.0/caching/#using-keys-and-templates&quot;&gt;Caching Dependencies - CircleCI&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ここで &lt;code class=&quot;language-text&quot;&gt;when: on_fail&lt;/code&gt; を使っている理由はこちら。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;build が成功した場合は test 後のキャッシュを保存したい&lt;/li&gt;
&lt;li&gt;build が失敗した場合でも何らかのキャッシュが作成される場合、保存しておきたい&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;まぁ、一つ前の revision のキャッシュが残っているのであれば頑張って保存するほどじゃないかなーとは思っています。前方一致で取れるのを知らずに &lt;code class=&quot;language-text&quot;&gt;CIRCLE_PREVIOUS_BUILD_NUM&lt;/code&gt; らへんで頑張ろうとしていたときの名残り。&lt;/p&gt;
&lt;p&gt;そして build の workflow のラスト。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; prepare cache dir if not exists
          &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; mkdir &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;p $GOCACHE
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;persist_to_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; tmp/go/cache
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; go/src/github.com/hori&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ryota/hoge/artifacts&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;persist_to_workspace&lt;/code&gt; で次の workflow にデータを渡します。ディレクトリがないと失敗するので &lt;code class=&quot;language-text&quot;&gt;mkdir -p&lt;/code&gt; して保証。 &lt;code class=&quot;language-text&quot;&gt;artifacts&lt;/code&gt; ディレクトリは build の成果物などなどの想定です。&lt;/p&gt;
&lt;p&gt;次に test の workflow ですが、ここは &lt;code class=&quot;language-text&quot;&gt;vendor&lt;/code&gt; の &lt;code class=&quot;language-text&quot;&gt;restore_cache&lt;/code&gt; をして test して build cache を &lt;code class=&quot;language-text&quot;&gt;save_cache&lt;/code&gt; するだけです。 &lt;code class=&quot;language-text&quot;&gt;vendor&lt;/code&gt; は &lt;code class=&quot;language-text&quot;&gt;attach_workspace&lt;/code&gt; するより &lt;code class=&quot;language-text&quot;&gt;restore_cache&lt;/code&gt; のほうが速かった。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;  &lt;span class=&quot;token key atrule&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /go/src/github.com/hori&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ryota/hoge
    &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/golang&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;1.10.2
    &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;GOCACHE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/tmp/go/cache&quot;&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;restore_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; vendor&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gopkg.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; test
          &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; make test
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; .Branch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; .Revision &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; /tmp/go/cache
          &lt;span class=&quot;token key atrule&quot;&gt;when&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; always&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ただし、 test が失敗してもキャッシュは保存したいので &lt;code class=&quot;language-text&quot;&gt;when: always&lt;/code&gt; を使用しています。&lt;/p&gt;
&lt;p&gt;あとは &lt;code class=&quot;language-text&quot;&gt;artifacts&lt;/code&gt; らへんの必要なものを deploy などの後続 workflow に渡してあげれば完了です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;persist_to_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; .
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; artifacts
  &lt;span class=&quot;token key atrule&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /go/src/github.com/hori&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ryota/hoge
    &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/golang&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;1.10.2
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; .
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; deploy
        &lt;span class=&quot;token key atrule&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; make deploy

&lt;span class=&quot;token key atrule&quot;&gt;workflows&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; test &lt;span class=&quot;token comment&quot;&gt;# if needed&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;requires&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; deploy &lt;span class=&quot;token comment&quot;&gt;# if needed&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;requires&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; test &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;context は横断的に環境変数を設定できるもののようなので、 deploy や test に必要な認証情報などなどを渡したりしています。workflow に対して複数設定できるようになって欲しい。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;同一 key に対して上書き更新をかけられないとのことだったので最初は混乱しましたが、前方一致での検索と把握して納得しました。&lt;/p&gt;
&lt;p&gt;build cache を効かせるととにかく爆速になるのでおすすめです。&lt;/p&gt;
&lt;p&gt;キャッシュの有無による挙動変更はゴリゴリ書くしかなかったので、 step 間に条件分岐など仕込めるようになったらうれしいですね。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Go の channel 処理パターン集]]></title><description><![CDATA[この記事は Go Advent Calendar 2017 の1日目の記事です。 Go の長所に goroutine による非同期処理がありますが、どうしても channel の取り回しで黒魔術化しがちです。少しでも闇を減らしていきたいので、 channel らへんの取り回しについてパターンをまとめました。チートシート的に使えれば嬉しいです。]]></description><link>https://hori-ryota.com/blog/2017-12-01-golang-channel-pattern/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-12-01-golang-channel-pattern/</guid><pubDate>Thu, 30 Nov 2017 15:00:00 GMT</pubDate><content:encoded>&lt;p&gt;この記事は &lt;a href=&quot;https://qiita.com/advent-calendar/2017/go&quot;&gt;Go Advent Calendar 2017&lt;/a&gt; の1日目の記事です。&lt;/p&gt;
&lt;p&gt;Go の長所に goroutine による非同期処理がありますが、どうしても channel の取り回しで黒魔術化しがちです。少しでも闇を減らしていきたいので、 channel らへんの取り回しについてパターンをまとめました。チートシート的に使えれば嬉しいです。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;Go の channel の基礎&lt;/h2&gt;
&lt;p&gt;入門資料として使いたいので、本題に入る前にざっくり基礎を。&lt;/p&gt;
&lt;h3&gt;定義のパターン&lt;/h3&gt;
&lt;p&gt;channel には capacity という概念があります。 capacity は channel 内でバッファリングしておける容量のことで、 capacity に空きが無い場合は送信側が処理待ち（ブロック）します。&lt;/p&gt;
&lt;p&gt;capacity なしの定義（int型で capacity 0）&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;ch &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;capacity ありの定義（int型で capacity 10）&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;ch &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;close&lt;/h3&gt;
&lt;p&gt;channel は close によって閉じることができます。受信側で検知できるので、受信側に終了を伝えるために使います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;送信のパターン&lt;/h3&gt;
&lt;p&gt;channel で定義した型の値を投入することができます。前述の通り、 capacity に余裕がなければ受信されるまでブロックします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;ch &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;受信のパターン&lt;/h3&gt;
&lt;p&gt;受信の書き方は6パターンあります。&lt;/p&gt;
&lt;p&gt;受信、もしくは close したことだけ検知するパターン。非同期処理の終了を待つ場合に使うことが多いです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ch&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;値を取得するパターン。 close された場合はゼロ値が入ります&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ch&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;値が入ったのか close されたのかを判別するパターン。 ok が false なら close です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ok &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ch
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;ok &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// closed&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;select-case で待ち受けるパターン。順序は保証されませんが複数 channel を同時に待ち受けることができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ch1&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ch 1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ch2&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ch 2&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;default をつけると既に値が入っている channel がなければ待たずに default が実行されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ch1&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ch 1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ch2&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ch 2&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// default&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;for-range で処理することもできます。 close されたらループを抜けます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; ch &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// closed&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;使うときの主な注意点&lt;/h2&gt;
&lt;p&gt;踏みがちな注意点です。これらを回避するために黒魔術が生まれがちです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;close した channel に event を送ると panic する&lt;/li&gt;
&lt;li&gt;多重に close しても panic する&lt;/li&gt;
&lt;li&gt;受信が先にいなくなると block し続ける&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;close 済みな channel を操作すると無視するのではなくしっかり panic するのが Go らしいところです。曖昧さの排除。&lt;/p&gt;
&lt;h2&gt;よくあるアンチパターン&lt;/h2&gt;
&lt;p&gt;実用的なパターン集に入る前に、見かけがちなアンチパターンを紹介しておきます。ブロックし続ける可能性があったり、 panic する可能性があったりします。&lt;/p&gt;
&lt;h3&gt;終了を受信側に伝えるのに終了 event を送る&lt;/h3&gt;
&lt;p&gt;シンプルな処理なら上手く動かせると思いますが、受信側が終了用 channel 以外の何かしらで待ちを抜けた場合に迷子になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
    done &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    done &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// この辺で return や panic したら A の goroutine が受け取り側がなく待ち続ける&lt;/span&gt;

    &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;done
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;close させるのが良いですね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    done &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;

    &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;done
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;たまに select-case でこういうコードを見かけたりもしますが、前述の通りブロックし続ける可能性があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;worker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;jobChan &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; done &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;jobChan&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;jobs &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    jobChan &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    done &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;worker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;jobChan&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; done&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; jobs &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        jobChan &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; j
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    done &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記ようにシンプルな処理なら、出来る限り for-range を使っていくのがおすすめです。 close されると抜けてくれます。サンプルは以下。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;worker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;jobChan &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; jobChan &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;jobs &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    jobChan &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;jobChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;worker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;jobChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; jobs &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        jobChan &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; j
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;close される可能性のある channel を第一戻り値だけで受ける&lt;/h3&gt;
&lt;p&gt;select で待ち受ける場合にうっかりやりがちです。 close されると第一戻り値はゼロ値になるので、想定外の挙動になる可能性があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;valueORCloseChan&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// do something with v&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// close された場合は vがゼロ値&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;otherChan&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ok で判定して分岐させます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ok &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;valueORCloseChan&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;ok &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token comment&quot;&gt;// closed&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// do something with v&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;otherChan&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;goroutine から複数 event が来る可能性があるのに始めのものを受けたら抜ける&lt;/h3&gt;
&lt;p&gt;error 用の channel を待つ場合にありがちです。始めのもの以外は迷子になります。特に capacity が 0 の channel の goroutine はずっとブロックし続けます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wg &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WaitGroup&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errChan &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;doSomething&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// ここが複数回発火すると詰まる&lt;/span&gt;
        errChan &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; err
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;


&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    wg &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WaitGroup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    errChan &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    done &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; 
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;errchan&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; err
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;受け取るのは一つでいいのであれば、イベント送信側を sync.Once で 1 event しか送られないように統一するのが便利です。もし sync.Once を渡していくのが複雑になる場合は、そもそも設計が複雑すぎる方を疑いたい。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; once sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Once

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wg &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WaitGroup&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errChan &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;doSomething&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        once&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Do&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            errChan &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; err
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;


&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    wg &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WaitGroup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    errChan &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    done &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; 
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;errchan&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; err
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;select の発火順は無保証なのでちょっと怪しいコードです。真面目にやるなら done ではなく errChan を close ですね。&lt;/p&gt;
&lt;p&gt;受け取るのが error であれば &lt;a href=&quot;https://godoc.org/golang.org/x/sync/errgroup&quot;&gt;errgroup&lt;/a&gt; がオススメです。 sync.WaitGroup のような使用感で、 context を使って一つ失敗したら他の処理を cancel する機構付きなので非常に便利。&lt;/p&gt;
&lt;h3&gt;イベント送信時に channel が closed か調べたい&lt;/h3&gt;
&lt;p&gt;複数の送信側処理があり、受信は一つで良い場合に欲しくなるやつ。たまに欲しくなります。&lt;/p&gt;
&lt;p&gt;が、今のところ便利なインターフェースは提供されていません。&lt;/p&gt;
&lt;p&gt;受信してみて第二戻り値が false なら closed ですが、受信すると第一戻り値を普通に受け取っちゃう場合もあるのでよろしくない。&lt;/p&gt;
&lt;p&gt;一応こんな感じで実装してみましたが、アンチパターン臭がすごい。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;isClosed&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ok &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ch&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;ok &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            ch &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; v
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isClosed&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        ch &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SomeValue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のコードは lock を仕込んでおらず、チェック後に close されている可能性が残っているので実用的ではないです。 lock 処理まで入れるとがんじがらめな黒魔術になるので別の手段を取ったほうが良さそう。&lt;/p&gt;
&lt;h3&gt;高速に送りまくる&lt;/h3&gt;
&lt;p&gt;例えばシンプルな slice 処理に比べるとパフォーマンスがどうしても悪くなるので、高パフォーマンスが必要な箇所ではベンチを取って検証した方がいいです。&lt;/p&gt;
&lt;p&gt;ちょっと雑ですが、シンプルに slice で入れ出しする場合と channel を経由して入れ出しする場合のベンチを取ってみました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;BenchmarkWithSimpleSlice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;testing&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;B&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	src &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	dst &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	b&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ResetTimer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token comment&quot;&gt;// write&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; src &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			dst&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; src&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;token comment&quot;&gt;// read&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;src&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; dst&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;BenchmarkWithChannel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;testing&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;B&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	src &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	ch &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	b&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ResetTimer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token comment&quot;&gt;// write&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; src &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			ch &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; src&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;token comment&quot;&gt;// read&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;src&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ch
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;結果が以下。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt; BenchmarkWithSimpleSlice       2000000              8991 ns/op
 BenchmarkWithChannel             30000            580989 ns/op&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;570,000 ns/op&lt;/code&gt; くらいの差が出ているので、 &lt;code class=&quot;language-text&quot;&gt;57 ns/item&lt;/code&gt; くらいでしょうか。ベンチマークとしての妥当性はともかく、高パフォーマンスが必要なところではある程度の考慮が必要になりそうなことは伝わるかと思います。&lt;/p&gt;
&lt;h2&gt;channel で並列数管理する場合のパターン&lt;/h2&gt;
&lt;p&gt;ここから実用的なパターン集です。&lt;/p&gt;
&lt;p&gt;並列数10だとこんな感じ。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;jobs &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    sem &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; jobs &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        sem &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            j&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;sem
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;capacity の仕組みを使ってブロックさせることで並列数管理をしています。&lt;/p&gt;
&lt;p&gt;worker 的な用途で使う場合、 queue 取得のタイミングに注意。 channel に入れる前に queue を取得すると持ったままブロックします。考慮するなら以下のような感じでしょうか。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;jobs &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    sem &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        sem &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        j&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ok &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;jobs
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;ok &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            j&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;sem
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;重み付けなどが必要になったら &lt;a href=&quot;https://godoc.org/golang.org/x/sync/semaphore&quot;&gt;semaphore&lt;/a&gt; が便利です。&lt;/p&gt;
&lt;h2&gt;channel で処理の終了を待つパターン&lt;/h2&gt;
&lt;p&gt;シンプルに待つだけ。 close して使うのがおすすめです。ちなみに、値が要らない場合は &lt;code class=&quot;language-text&quot;&gt;struct{}&lt;/code&gt; がサイズ 0 のデータなのでおすすめです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    done &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// wait&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;done
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;channel の closed を検知するパターン&lt;/h2&gt;
&lt;p&gt;アンチパターンと言ったばかりですが、 close するだけの channel なら使い所があります。&lt;/p&gt;
&lt;p&gt;特に、メソッド内で context の状態を確認するのにたまに使います。 cancel されているか確認するのに Done() で返ってくる chan が closed か判定したい。 select-case の default を使います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; isDone &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ctx&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        isDone &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        isDone &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こんな感じ。自分はメソッド化して使ったりします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;isDone&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Context&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ctx&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;たまに Done 検知のサンプルで default がないものがありますが、 select 文では default がないとどれかの channel からイベントが返るまでブロックするので注意です。&lt;/p&gt;
&lt;h2&gt;channel で繰り返し処理する場合のパターン集&lt;/h2&gt;
&lt;p&gt;基本的には &lt;code class=&quot;language-text&quot;&gt;送信側を先に片付ける -&amp;gt; channel を close する -&amp;gt; 受信側が待ちを抜ける&lt;/code&gt; の順番で処理するように意識するのが大事です。 select 待ち受けも使い所はありますが、なるべく for-range と defer を使っていく方がおすすめです。&lt;/p&gt;
&lt;h3&gt;送信側は1つ and 受信側は1つ&lt;/h3&gt;
&lt;p&gt;並列化するほどじゃないけど受け取り処理はさっさと済ませて遅延処理させたいシンプルなパターン。 channel の capacity が溢れない程度に受信側が上手いこと処理してくれている（間に合っている）場合はコレで足りる。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;worker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; queue &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    queue &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;worker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        j&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;someHandle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; err
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        queue &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; j
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;間に合わなくなってきたら次述のように受信側を増やしていきます。&lt;/p&gt;
&lt;h3&gt;送信側は1つ and 受信側は複数&lt;/h3&gt;
&lt;p&gt;受け取り側の処理が1つじゃ追いつかない場合によく書く worker スタイル。ただの groutine 起動との違いは並列数の管理です。&lt;/p&gt;
&lt;p&gt;送信側が1つなので、受信側が複数に増えても channel を close してあげれば問題なし。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;worker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; queue &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; workerNum &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    queue &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; workerNum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;worker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        j&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;someHandle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; err
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        queue &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; j
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;送信側は複数 and 受信側は1つ&lt;/h3&gt;
&lt;p&gt;並列処理の結果を収集したい場合によく書く。キャンセルにしろ正常終了にしろ、全ての送信処理が終わったことを確認してから受信側を抜ける必要がある。&lt;/p&gt;
&lt;p&gt;送信処理の goroutine があといくつ残っているかを数えてあげて、全て片付いたら close してあげれば OK 。atomic 系で数えてあげてもいいけど、 sync.WaitGroup が好みです。&lt;/p&gt;
&lt;p&gt;とあるページング的リクエストを分割して並列実行し、結果を配列に集めるパターン。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;someRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;token builtin&quot;&gt;uint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; resultChan &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    results &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; results &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        resultChan &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; r
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Result &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    resultChan &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Result&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    wg &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WaitGroup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;99&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        from &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;
        to &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;someRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; resultChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;resultChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    results &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Result&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; resultChan &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        results &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; results
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;各送信側にキャンセルを伝えたい場合は専用の channel を渡してあげてもいいけど、 context を渡すのが楽。外部コマンドや外部リクエストにもそのまま渡せるので。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;someRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;token builtin&quot;&gt;uint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; resultChan &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    results &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; results &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        resultChan &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; r
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Context&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Result &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    resultChan &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Result&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    wg &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WaitGroup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;99&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        from &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;
        to &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;someRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; resultChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;resultChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    results &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Result&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; resultChan &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        results &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; results
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;送信側は複数 and 受信側は複数&lt;/h3&gt;
&lt;p&gt;Dispatcher - Worker 的な。 Dispatcher を独自に用意しているサンプルが散見されますが、型によって受け渡す worker を変えて云々、みたいな分岐が必要なければ channel 自体が dispatcher になります。&lt;/p&gt;
&lt;p&gt;基本的には受信側が増える分には close を使えば問題なし。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;worker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; queue &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// do something&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;someRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;token builtin&quot;&gt;uint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; callbackJobQueue &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    results &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; results &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        callbackQueue &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;NewJob&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    workerNum &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    queue &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    wg &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WaitGroup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; workerNum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;worker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;99&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        from &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;
        to &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;someRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; queue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;結果を収集したければ worker に収集用の channel を渡せば OK 。&lt;/p&gt;
&lt;h3&gt;select 待ち受けについて&lt;/h3&gt;
&lt;p&gt;基本的には for-range をおすすめします。 select を使うのは以下のような場合かなーと。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ループではなく一回だけ発火するやーつ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;全て close 待ち&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;どれかが close されたら処理を抜ける場合。とはいえ発火順序は保証されないので使い所があまり思いつかなかった&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;待ち受ける複数 channel のうち、一つしか返ってこないことが保証される場合&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;非同期処理で resolve か reject のどちらかだけ返ってくる場合など。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;一個受けたらもう抜けちゃっていいやつ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;例えば signal 処理。プロセスを終了するなら一個だけ受ければいい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://golang.org/pkg/os/signal/&quot;&gt;signal&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;抜ける気がないループ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;プロセスが死ぬまで動かし続けるので色々気にしないでいい場合&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ちゃんと送信側が片付いたことを全て確認できている&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;前述の送信側が複数あるパターンと同じく、 sync.WaitGroup などでちゃんと管理できている場合。ただし、 for-range と違い全ての channel が受信済みであることも保証しないと受信漏れが生じるのでややこしい。&lt;/li&gt;
&lt;li&gt;それぞれで for-range を組むほうがシンプルになりがち（個人の見解）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;受信漏れの考慮に苦心しがちなので、 channel でループする場合は for-range に寄せていったほうが楽かなーと思っています。&lt;/p&gt;
&lt;p&gt;timeout 処理や context.Done のハンドリングは悩ましいところですが、なるべく context の仕組みに頼り、どうしても必要なところは受信漏れを考慮した上で select 待ち受けするのがいいかと。 capacity なしの結果用 channel を返す上、 timeout 処理がちゃんと実装されていないメソッドがあったとしても、 context 対応でシンプルに使える wrapper を用意したいところ。&lt;/p&gt;
&lt;p&gt;ちなみにありがちなミスとして、 select in for loop で close された channel があると暴走します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    ch1 &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    ch2 &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; ch1&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            log&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; ch2&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            log&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のように select-case で closed な channel があるとひたすら発火して &lt;code class=&quot;language-text&quot;&gt;1&lt;/code&gt; が出力され続けます。多段の event 待ち受けで受信側から送信側に送信停止を伝播させたい場合にやりがち。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch1 &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Event&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stopA &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    t &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NewTicker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Second&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Stop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;t&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;C&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            ch1 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;handle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;stopA&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch1 &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Event&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ch2 &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stopB &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stopA &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ok &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;ch1&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;ok &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            ch2 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;NewJob&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt;stopB&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stopA&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;C&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch2 &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Job&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stopB &lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; ch2 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; j&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stopB&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のような Event を受けて Job を dispatch するコードだと、 B の &lt;code class=&quot;language-text&quot;&gt;stopB&lt;/code&gt; の case が連続発火して &lt;code class=&quot;language-text&quot;&gt;stopA&lt;/code&gt; を多重 close し、 panic します。&lt;/p&gt;
&lt;p&gt;対処としては channel ごとに待ち受ける goroutine を分けて処理したり、 nil で上書きして case 判定から除外したりでしょうか？ 個人的には設計が怪しくなっていると判断してリファクタしたくなります。&lt;/p&gt;
&lt;h3&gt;エラー収集（一つだけ拾えば OK ）&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://godoc.org/golang.org/x/sync/errgroup&quot;&gt;errgroup&lt;/a&gt; が楽すぎるので使っていきましょう&lt;/p&gt;
&lt;h3&gt;エラー収集（複数集める）&lt;/h3&gt;
&lt;p&gt;for-range で各処理から error を集め、処理が全て終わったら close します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    errChan &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    wg &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WaitGroup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;doSomething&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                errChan &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; err
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;errChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    errors &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; errChan &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        errors &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;errors&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; errors
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;エラー収集（結果も集める）&lt;/h3&gt;
&lt;p&gt;結果と error をまとめた struct を用意すれば error のみと同じように書けます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; Wrapper &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    Result Result
    Error  &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Wrapper &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    resultChan &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Wrapper&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    wg &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WaitGroup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            result&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;doSomething&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            resultChan &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; Wrapper&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                Result&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                Error&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;  err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;resultChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    results &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Wrapper&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; resultChan &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        results &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; results
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;channel を増やして並べる書き方もできます。ただし、 capacity に注意しないとブロックします（以下の例だと &lt;code class=&quot;language-text&quot;&gt;errChan&lt;/code&gt; を先に処理しているので、 &lt;code class=&quot;language-text&quot;&gt;resultChan&lt;/code&gt; が飽和したら詰まる）。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Result&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    errChan &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    resultChan &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;chan&lt;/span&gt; Result&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    wg &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WaitGroup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            result&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;doSomething&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                errChan &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; err
                &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            resultChan &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; result
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;errChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;resultChan&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    errors &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; errChan &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        errors &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;errors&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    results &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;Result&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; resultChan &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        results &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; results&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; errors
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;前者のほうが安全ですが、個人的には後続処理で結果と error を分離するなら capacity に気をつけながら後者でもいいかなーと思っています。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;とりあえずこの辺のパターンを組み合わせれば頻出する処理は書けるかと思います。誤りや改善点など、何かありましたらぜひご指摘いただければ幸いです。&lt;/p&gt;
&lt;p&gt;なお、実際には sync.WaitGroup を channel に変換しているところなどはメソッド化して使うのがオススメです。&lt;/p&gt;
&lt;p&gt;個人的にはシンプルな for-range ではなく select-case の loop で色々やり始めたら黄色信号かなーと思っているのですが、使い所も確かにあるので難しい。&lt;/p&gt;
&lt;p&gt;重めの処理を非同期 worker でゴリゴリやりたくなったらぜひ参考にしてみてください！&lt;/p&gt;</content:encoded></item><item><title><![CDATA[gRPC with NLB は idle timeout に気をつけないと死ぬ]]></title><description><![CDATA[先日発表された AWS の Network Load Balancer (NLB) を gRPC で使ってみたのですが、 idle timeout 周りで盛大にミスったので知見共有です。]]></description><link>https://hori-ryota.com/blog/2017-10-22-failed-to-grpc-with-nlb/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-10-22-failed-to-grpc-with-nlb/</guid><pubDate>Sun, 22 Oct 2017 08:00:00 GMT</pubDate><content:encoded>&lt;p&gt;先日発表された AWS の Network Load Balancer (NLB) を gRPC で使ってみたのですが、 idle timeout 周りで盛大にミスったので知見共有です。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;経緯&lt;/h2&gt;
&lt;p&gt;先日、 NLB こと Network Load Balancer が AWS にてリリースされました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://aws.amazon.com/jp/blogs/news/new-network-load-balancer-effortless-scaling-to-millions-of-requests-per-second/&quot;&gt;新しいNetwork Load Balancer – 秒間数百万リクエストに簡単にスケーリング | Amazon Web Services ブログ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;NLB は TCP レベルでのロードバランシングができ、プレウォーミングなしで高パフォーマンスを発揮できるため既存のAWS の LB に比べ gRPC との相性が良いです。&lt;/p&gt;
&lt;p&gt;マイクロサービス構成を取っている生放送サービスにて gRPC の経路に NLB を導入したのですが、一部のサービスにて接続エラーが生じるようになったので知見を共有いたします。&lt;/p&gt;
&lt;h2&gt;症状&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;一部のサービスにて &lt;code class=&quot;language-text&quot;&gt;rpc error: code = Unavailable desc = transport is closing&lt;/code&gt; のようなエラーが生じた&lt;/li&gt;
&lt;li&gt;Go のサービスだけでなく、 Java のサービスでも生じた&lt;/li&gt;
&lt;li&gt;頻繁に gRPC 通信をしない経路にて生じている様子&lt;/li&gt;
&lt;li&gt;NLB を通さず Client - Server を直結した場合は生じない&lt;/li&gt;
&lt;li&gt;NLB の Monitoring を見たところ、 &lt;code class=&quot;language-text&quot;&gt;TCP_ELB_Reset_Count&lt;/code&gt; が入っている&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;原因&lt;/h2&gt;
&lt;p&gt;ドキュメントに記載がありました（現在は英語版ドキュメントのみ）&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Connection Idle Timeout&lt;/p&gt;
&lt;p&gt;For each request that a client makes through a load balancer, the load balancer maintains two connections. A front-end connection is between a client and the load balancer, and a back-end connection is between the load balancer and a target. For each front-end connection, the load balancer manages an idle timeout that is triggered when no data is sent over the connection for a specified time period. If no data has been sent or received by the time that the idle timeout period elapses, the front-end connection is broken. If a client sends data after the idle timeout period has elapses, it receives a TCP RST packet to indicate that the connection is no longer valid.&lt;/p&gt;
&lt;p&gt;Elastic Load Balancing sets the idle timeout value to 350 seconds. You cannot modify this value. Your targets can use TCP keepalive packets to reset the idle timeout.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://docs.aws.amazon.com/elasticloadbalancing/latest/network/network-load-balancers.html#connection-idle-timeout&quot;&gt;Network Load Balancers - Elastic Load Balancing&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;TCP_ELB_Reset_Count&lt;/code&gt; が計測されていることからも分かる通り、 350s 以上 idle している connection は NLB 側から RST Packet （
RESET 用の packet ）を送出して接続を切るようです。&lt;/p&gt;
&lt;p&gt;よって通信頻度の低いサービスにて久々に通信しようとすると接続が切断されており、エラーが生じたというのが原因と思われます。&lt;/p&gt;
&lt;h2&gt;対応&lt;/h2&gt;
&lt;p&gt;まず Client 側に Keepalive の設定を入れました。&lt;/p&gt;
&lt;p&gt;Client のサンプルとして Go と Java を載せておきます。&lt;/p&gt;
&lt;p&gt;Go&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;conn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; grpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Dial&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;address&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; grpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;WithKeepaliveParams&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;keepalive&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ClientParameters&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    Time&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;                &lt;span class=&quot;token number&quot;&gt;150&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Second&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    PermitWithoutStream&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/grpc/grpc-go/blob/a5986a5c88227370a9c0a82e5277167229c034cd/keepalive/keepalive.go#L31-L39&quot;&gt;grpc-go/keepalive.go at master · grpc/grpc-go&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Java&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;NettyChannelBuilder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;forAddress&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hostName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;enableKeepAlive&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;keepAliveTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;150&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TimeUnit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;SECONDS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;keepAliveWithoutCalls&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;timeout が 350s なので半分弱くらいの 150s にしておきました。&lt;/p&gt;
&lt;p&gt;これで Client 側が 350s で切断される問題は解消したのですが、検証していたところなぜか 10m - 20m くらいの idle で切断される場合があることがわかりました。&lt;/p&gt;
&lt;p&gt;Server 側にも Keepalive の設定を追加することで解消しました。 Server は Go です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;server &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; grpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NewServer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    grpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;KeepaliveParams&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;keepalive&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ServerParameters&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        Time&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;150&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Second&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここまでの対応で今のところ安定しております。&lt;/p&gt;
&lt;h2&gt;残る疑問点&lt;/h2&gt;
&lt;p&gt;とりあえずエラーは静まったのですが、把握しきれていないことが何点かあるのでメモしておきます。&lt;/p&gt;
&lt;p&gt;もし詳細をご存じの方、把握できた方がいらっしゃいましたらご教示願えると嬉しいです！&lt;/p&gt;
&lt;h3&gt;Keepalive を短時間にすることの弊害&lt;/h3&gt;
&lt;p&gt;今のところ問題なさそうですが、負荷などへの影響をちゃんと検証していないので不明です。&lt;/p&gt;
&lt;h3&gt;10m - 20m で切断される現象&lt;/h3&gt;
&lt;p&gt;何が原因なのかよくわかっておらず。検証した条件を載せておきます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1m, 5m, 6m, 10m, 20m, 30m 間隔で通信を行う6 connection を、並列して1台のサーバに対し接続した場合、 20m 以上でエラー&lt;/li&gt;
&lt;li&gt;NLB 経由せず Client - Server を直結した場合は生じない&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;解せぬ。&lt;/p&gt;
&lt;h3&gt;EnforcementPolicy の挙動&lt;/h3&gt;
&lt;p&gt;Server 側に EnforcementPolicy という設定がありまして、頻繁すぎる Keepalive を許容しないようにできるっぽいです。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/grpc/grpc-go/blob/a5986a5c88227370a9c0a82e5277167229c034cd/keepalive/keepalive.go#L58-L65&quot;&gt;grpc-go/keepalive.go at master · grpc/grpc-go&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// EnforcementPolicy is used to set keepalive enforcement policy on the server-side.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Server will close connection with a client that violates this policy.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; EnforcementPolicy &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;// MinTime is the minimum amount of time a client should wait before sending a keepalive ping.&lt;/span&gt;
	MinTime time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Duration &lt;span class=&quot;token comment&quot;&gt;// The current default value is 5 minutes.&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;// If true, server expects keepalive pings even when there are no active streams(RPCs).&lt;/span&gt;
	PermitWithoutStream &lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// false by default.&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;MinTime&lt;/code&gt; 以下の Keepalive 間隔の Client がいた場合、接続を拒否するような設定に見えます。&lt;/p&gt;
&lt;p&gt;デフォルト値が 5m なので今回の 150s 設定だと切断されそうに思えるのですが、普通に接続されました。今後のバージョンアップで挙動が変わる可能性もあるので、正解を把握しておきたいところ。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;検証が済んでいなかったり最適設定といいきれる状態までまとめられていないのですが、 NLB 導入時に踏みそうな症状なのでいったん共有です。&lt;/p&gt;
&lt;p&gt;idle が長い connection に心あたりがある場合は検証してから本番導入をおすすめします。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CA.go #2 で golang.org/x/sync について喋りました #ca_go]]></title><description><![CDATA[CA.go #2 - connpass にて golang.org/x/sync 以下にある4つのパッケージを用いて効率的に非同期処理をする技術についてお話しました。]]></description><link>https://hori-ryota.com/blog/2017-09-06-cago-2-x-sync/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-09-06-cago-2-x-sync/</guid><pubDate>Wed, 06 Sep 2017 14:30:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://cyberagent.connpass.com/event/64974/&quot;&gt;CA.go #2 - connpass&lt;/a&gt; にて golang.org/x/sync 以下にある4つのパッケージを用いて効率的に非同期処理をする技術についてお話しました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;登壇内容&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://speakerdeck.com/horiryota/syncniyoruxiao-lu-de-nafei-tong-qi-chu-li&quot;&gt;golang.org/x/sync による効率的な非同期処理&lt;/a&gt; と題し、 &lt;a href=&quot;https://godoc.org/golang.org/x/sync&quot;&gt;golang.org/x/sync&lt;/a&gt; の使い所と雑感、注意点について紹介しました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://godoc.org/golang.org/x/sync&quot;&gt;sync - GoDoc&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div
          style=&quot;position: relative; width:100%; height:0; padding-top:74.92957746478874%;&quot;
          &gt;
          &lt;iframe id=&quot;talk_frame_405683&quot; src=&quot;//speakerdeck.com/player/45885cc31e40446a932ac73b560eca86&quot; width=100% height=&quot;100%&quot; style=&quot;position:absolute;top:0;left:0;border:0; padding:0; margin:0; background:transparent;&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen=&quot;allowfullscreen&quot; mozallowfullscreen=&quot;true&quot; webkitallowfullscreen=&quot;true&quot;&gt;&lt;/iframe&gt;

          &lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;/blog/cago-1-sync-pool&quot;&gt;第一回&lt;/a&gt;で紹介した sync.Pool と同じく “明日から使える” 系です。&lt;/p&gt;
&lt;p&gt;内容はスライドを参照いただければ問題ないかと思いますが、概要としては以下です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;golang.org/x&lt;/code&gt; は Go のプロジェクトではあるが標準パッケージとは別で管理されているライブラリ群&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;golang.org/x/sync&lt;/code&gt; は標準パッケージの &lt;code class=&quot;language-text&quot;&gt;sync&lt;/code&gt; や &lt;code class=&quot;language-text&quot;&gt;sync/atomic&lt;/code&gt; に入れる前のおためし版的な扱いっぽい&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;syncmap&lt;/code&gt; は排他制御付きの &lt;code class=&quot;language-text&quot;&gt;map&lt;/code&gt; 。 Go 1.9 から標準パッケージの仲間入り&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;errgroup&lt;/code&gt; は &lt;code class=&quot;language-text&quot;&gt;sync.WaitGroup&lt;/code&gt; みたいに全非同期処理が終わるまで wait するやつ。エラーが起きた場合、 &lt;code class=&quot;language-text&quot;&gt;context&lt;/code&gt;で cancel させて始めのエラーを返す&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;semaphore&lt;/code&gt; は重み付きの並列数管理。 &lt;code class=&quot;language-text&quot;&gt;context&lt;/code&gt; に対応しているので待ち時間のタイムアウトもできる&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;singleflight&lt;/code&gt; は並列に叩かれる処理で使うもので、1つ目以外の処理リクエストは待たせておいて、1つ目の処理が終わったら待たせていた他の処理リクエストにも戻り値を配ってくれるやつ。キャッシュ切れ時の origin リクエストに使ったりすると良さそう&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;どれも chan を使って自作できそうな（今までは自作していた）ようなものではありますが、特にトラブル時の問題切り分けを煩雑にしないためにも積極的に利用していきたいところです。&lt;/p&gt;
&lt;p&gt;特にマイクロサービス構成の動画サービスでは各所で重いデータのリクエストや更新管理の難しいキャッシュデータが生まれがちなので、 &lt;code class=&quot;language-text&quot;&gt;singleflight&lt;/code&gt; は今後ぜひ使っていきたいなーと思っております。&lt;/p&gt;
&lt;p&gt;スライドには使用イメージとしてサンプルコードも載せてありますので、ぜひ見ていただけると嬉しいです。&lt;/p&gt;
&lt;h2&gt;スライド制作&lt;/h2&gt;
&lt;p&gt;以前から使っている &lt;a href=&quot;https://twitter.com/ahomu&quot;&gt;@ahomu&lt;/a&gt; さん製の &lt;a href=&quot;https://github.com/ahomu/Talkie&quot;&gt;Talkie&lt;/a&gt; をラップした、 &lt;a href=&quot;https://github.com/hori-ryota/talkiego&quot;&gt;talkiego&lt;/a&gt; で作りました。今回のスライドを作るにあたって &lt;a href=&quot;https://highlightjs.org/&quot;&gt;highlight.js&lt;/a&gt; の Go 対応と、 &lt;code class=&quot;language-text&quot;&gt;serve&lt;/code&gt; コマンドのオプション指定機能を追加しました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/hori-ryota/talkiego&quot;&gt;hori-ryota/talkiego: talkiego is wrapper for Talkie.&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;カスタムテーマは未対応ですが、カスタム CSS は対応してみたのでとりあえず色々とカスタムはできるはず。とはいえ自分はデフォルトでしか使っていないです。&lt;/p&gt;
&lt;h2&gt;お礼&lt;/h2&gt;
&lt;p&gt;前回に引き続き、今回も主催兼、司会兼、第一登壇者で参加させていただきました。登壇タイトルの更新が遅かったり、登壇者の入れ替えがあったり、ご迷惑をおかけいたしました。&lt;/p&gt;
&lt;p&gt;ポツポツと雨が降っているにも関わらず多くの方々に足を運んでいただき嬉しく思っております。ぜひ今後も有益な情報を提供できるよう尽力してますので、今後とも宜しくお願いいたします。&lt;/p&gt;
&lt;p&gt;次回からは登壇からは身を引いて、運用に回ろうかなーと思っております（といいつつまた出てくるかもです）。&lt;/p&gt;
&lt;p&gt;また2,3ヶ月後に第三回を実施したいなーと思っています。よろしくお願いいたします！&lt;/p&gt;</content:encoded></item><item><title><![CDATA[社内勉強会で HLS と Key frame について改めて解説した]]></title><description><![CDATA[チーム全体のスキルアップのため、ネット生放送において超重要な HLS と Key frame について改めて解説してみました。 非エンジニア職を対象とした資料なのでそれなりに入門編としてわかりやすくできたんじゃないかなーと思っております。]]></description><link>https://hori-ryota.com/blog/2017-08-08-study-hls-keyframe-20170808/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-08-08-study-hls-keyframe-20170808/</guid><pubDate>Tue, 08 Aug 2017 14:59:00 GMT</pubDate><content:encoded>&lt;p&gt;チーム全体のスキルアップのため、ネット生放送において超重要な HLS と Key frame について改めて解説してみました。&lt;/p&gt;
&lt;p&gt;非エンジニア職を対象とした資料なのでそれなりに入門編としてわかりやすくできたんじゃないかなーと思っております。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;内容&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://speakerdeck.com/horiryota/10fen-tiyoi-dewakarufresh-dong-hua-falsekan-suo&quot;&gt;10分（ちょい）でわかるFRESH! 動画の勘所&lt;/a&gt; と題し、 HLS とは何か、なぜ使うのかの解説と、遅延などへの影響が大きい Key frame とはなんぞや、について解説しました。&lt;/p&gt;
&lt;div
          style=&quot;position: relative; width:100%; height:0; padding-top:74.92957746478874%;&quot;
          &gt;
          &lt;iframe id=&quot;talk_frame_402546&quot; src=&quot;//speakerdeck.com/player/3ecf2f1e48514dea8440decb8f84a4ae&quot; width=100% height=&quot;100%&quot; style=&quot;position:absolute;top:0;left:0;border:0; padding:0; margin:0; background:transparent;&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen=&quot;allowfullscreen&quot; mozallowfullscreen=&quot;true&quot; webkitallowfullscreen=&quot;true&quot;&gt;&lt;/iframe&gt;

          &lt;/div&gt;
&lt;p&gt;非エンジニア職でも概要がつかめるよう意識しました。&lt;/p&gt;
&lt;h2&gt;なぜやったのか&lt;/h2&gt;
&lt;p&gt;生放送サービスを運営するにあたって、やはり動画に対する基礎的な知識は非エンジニア職でも必要になってきます。&lt;/p&gt;
&lt;p&gt;特に遅延が起きたり画質が乱れたり、現場での対応はもちろんですが営業などする際の説得力にも違いが出てくると思います。&lt;/p&gt;
&lt;p&gt;幸いにも、普段から何かと積極的にこれってどういうことなの？と質問してくれる非エンジニア職が多いチームに恵まれ、ぜひ改めて勉強会をしてほしいと言っていただいたので開催することができました。&lt;/p&gt;
&lt;p&gt;本当はもっとはやく自主的にやるべきだったのですが、ちょうどチーム内で勉強会が運営され始めたタイミングだったので便乗しました。運営ありがとうございます。&lt;/p&gt;
&lt;h2&gt;スライド制作&lt;/h2&gt;
&lt;p&gt;今回も、先日ブログ記事にもした &lt;a href=&quot;https://github.com/hori-ryota/talkiego&quot;&gt;talkiego&lt;/a&gt; を使用しております。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/talkiego/&quot;&gt;良い感じにスライドを作れる Talkie をラップした talkiego を作った · Hori Blog&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;40枚程度のスライドなら絵を除けば1時間くらいで作れちゃうので、 &lt;a href=&quot;https://github.com/ahomu/Talkie&quot;&gt;Talkie&lt;/a&gt; 作者の &lt;a href=&quot;https://twitter.com/ahomu&quot;&gt;@ahomu&lt;/a&gt; さん最高です。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;今回は社内勉強会でしたが、外部発信も増やしていくのでよろしくお願いいたします。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[良い感じにスライドを作れる Talkie をラップした talkiego を作った]]></title><description><![CDATA[ここのところ、プレゼン用スライドの制作は @ahomu さん製の Talkie をお借りしているのですが、 Talkie はソースを丸っと落として index.html を編集する必要があります。 Markdown だけ記述してコマンド一発で起動できるようにしたかったので talkiego を作りました。]]></description><link>https://hori-ryota.com/blog/2017-07-29-talkiego/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-07-29-talkiego/</guid><pubDate>Sat, 29 Jul 2017 07:25:00 GMT</pubDate><content:encoded>&lt;p&gt;ここのところ、プレゼン用スライドの制作は &lt;a href=&quot;https://twitter.com/ahomu&quot;&gt;@ahomu&lt;/a&gt; さん製の &lt;a href=&quot;https://github.com/ahomu/Talkie&quot;&gt;Talkie&lt;/a&gt; をお借りしているのですが、 Talkie はソースを丸っと落として index.html を編集する必要があります。&lt;/p&gt;
&lt;p&gt;Markdown だけ記述してコマンド一発で起動できるようにしたかったので &lt;a href=&quot;https://github.com/hori-ryota/talkiego&quot;&gt;talkiego&lt;/a&gt; を作りました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;Talkie とは&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/ahomu/Talkie&quot;&gt;ahomu/Talkie: Simple slide presentation library. Responsive scaling &amp;#x26; markdown ready.&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/ahomu/Talkie&quot;&gt;Talkie&lt;/a&gt; は &lt;a href=&quot;https://twitter.com/ahomu&quot;&gt;@ahomu&lt;/a&gt; さん製の良い感じにおしゃれなスライドを作れるライブラリです。&lt;/p&gt;
&lt;p&gt;似たようなツールとして &lt;a href=&quot;http://lab.hakim.se/reveal-js/&quot;&gt;reveal.js&lt;/a&gt; があるのですが、個人的には Talkie の方が日本語のレイアウトが綺麗に決まるので Talkie を愛用しています。&lt;/p&gt;
&lt;p&gt;reveal.js でもダメではないのですが、ちょっと真ん中にギュッと寄ってしまう感がありまして、好みではなかったです。&lt;/p&gt;
&lt;h2&gt;talkiego とは&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/hori-ryota/talkiego&quot;&gt;talkiego&lt;/a&gt; は Markdown ファイル単体を引数で取れば Talkie で起動してくれるツールです。&lt;/p&gt;
&lt;p&gt;reveal.js でいうところの &lt;a href=&quot;https://github.com/yusukebe/revealgo&quot;&gt;yusukebe/revealgo&lt;/a&gt; です。&lt;/p&gt;
&lt;h2&gt;作った経緯&lt;/h2&gt;
&lt;p&gt;Talkie は Node.js 製で、使用するには index.html の編集が必要になります。 slide を作るときに丸っと Talkie を落として編集するのではなくコンテンツ部分だけ書かれた Markdown ファイルを読み込むようにしたかったのが動機です。&lt;/p&gt;
&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;talkie.js、単体mdファイルから錬成できるようなラッパー欲しくなってきた&lt;/p&gt;&amp;mdash; hori (@hori_ryota) &lt;a href=&quot;https://twitter.com/hori_ryota/status/875887520986275842?ref_src=twsrc%5Etfw&quot;&gt;June 17, 2017&lt;/a&gt;&lt;/blockquote&gt;

&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;&lt;a href=&quot;https://t.co/WLcueJxxGs&quot;&gt;https://t.co/WLcueJxxGs&lt;/a&gt; こういうの？&lt;/p&gt;&amp;mdash; (・∋・) (@ahomu) &lt;a href=&quot;https://twitter.com/ahomu/status/875888753151062016?ref_src=twsrc%5Etfw&quot;&gt;June 17, 2017&lt;/a&gt;&lt;/blockquote&gt;

&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;ですです。同ディレクトリに各ファイル展開するのではなく、mdと必要なimgだけ配置しておいてコマンドだけ叩けば表示できるような&lt;/p&gt;&amp;mdash; hori (@hori_ryota) &lt;a href=&quot;https://twitter.com/hori_ryota/status/875889375418109953?ref_src=twsrc%5Etfw&quot;&gt;June 17, 2017&lt;/a&gt;&lt;/blockquote&gt;

&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;ああ、なるほろ&lt;/p&gt;&amp;mdash; (・∋・) (@ahomu) &lt;a href=&quot;https://twitter.com/ahomu/status/875890079582961664?ref_src=twsrc%5Etfw&quot;&gt;June 17, 2017&lt;/a&gt;&lt;/blockquote&gt;

&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;がっつりプレゼン資料作るだけじゃなくてペライチ提出にも使いたくなったので、Decksetばりに気軽に書き捨てできるようなとこまで頑張ってみようかなと&lt;/p&gt;&amp;mdash; hori (@hori_ryota) &lt;a href=&quot;https://twitter.com/hori_ryota/status/875890615086497792?ref_src=twsrc%5Etfw&quot;&gt;June 17, 2017&lt;/a&gt;&lt;/blockquote&gt;

&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;まじか、期待してる&lt;/p&gt;&amp;mdash; (・∋・) (@ahomu) &lt;a href=&quot;https://twitter.com/ahomu/status/875891637724958720?ref_src=twsrc%5Etfw&quot;&gt;June 17, 2017&lt;/a&gt;&lt;/blockquote&gt;

&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;まだ色々途中ですが一旦作りました。&lt;br&gt;talkiego serve hoge.md&lt;br&gt;で表示できて満足です∠( ﾟдﾟ)／&lt;br&gt;&lt;br&gt;&amp;quot;hori-ryota/talkiego&amp;quot;&lt;a href=&quot;https://t.co/e1eBtI69n9&quot;&gt;https://t.co/e1eBtI69n9&lt;/a&gt;&lt;br&gt;&lt;br&gt;あゆむさんレビュー通ったらブログ書きます…！&lt;/p&gt;&amp;mdash; hori (@hori_ryota) &lt;a href=&quot;https://twitter.com/hori_ryota/status/876451676403580928?ref_src=twsrc%5Etfw&quot;&gt;June 18, 2017&lt;/a&gt;&lt;/blockquote&gt;

&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;ｳｺﾞｲﾀｱｱｱ!&lt;br&gt;&lt;br&gt;極端に言ったらカスタムテンプレート利用できればどうとでもなりそうだね👌&lt;/p&gt;&amp;mdash; (・∋・) (@ahomu) &lt;a href=&quot;https://twitter.com/ahomu/status/876722828950642688?ref_src=twsrc%5Etfw&quot;&gt;June 19, 2017&lt;/a&gt;&lt;/blockquote&gt;

&lt;h2&gt;使い方&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/hori-ryota/talkiego&quot;&gt;talkiego&lt;/a&gt; の README.md に書いてありますが、簡単に載せておきます。&lt;/p&gt;
&lt;p&gt;Talkie の index.html だとこんな感じで書きますが、&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;index.html&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;html&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;head&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;meta&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;charset&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;utf-8&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;title&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;Talkie.js - HTML/CSS/JavaScript Presentation Library&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;title&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;link&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;rel&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;stylesheet&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;./dist/talkie.min.css&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;link&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;rel&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;stylesheet&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;./dist/talkie-default.min.css&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;link&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;rel&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;stylesheet&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/monokai_sublime.min.css&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;head&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;body&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;&amp;lt;!-- put your slides --&gt;&lt;/span&gt;

&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;template&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;layout&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;cover&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;text/x-markdown&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
# Talkie.js
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;template&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;template&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;layout&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;title&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;invert&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;text/x-markdown&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
          &lt;span class=&quot;token attr-name&quot;&gt;backface&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;https://farm8.staticflickr.com/7469/16209884502_211d01ac0d_z_d.jpg&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
          &lt;span class=&quot;token attr-name&quot;&gt;backface-filter&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;blur(3px) brightness(.9)&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
# Backface (北極)
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;template&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;layout&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;bullets&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;text/x-markdown&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token style-attr language-css&quot;&gt;&lt;span class=&quot;token attr-name&quot;&gt; &lt;span class=&quot;token attr-name&quot;&gt;style&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&quot;&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token property&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;#ff0000&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token script&quot;&gt;&lt;span class=&quot;token language-javascript&quot;&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; foo
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; bar
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; baz
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token script&quot;&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;./dist/talkie.min.js&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token script&quot;&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token script&quot;&gt;&lt;span class=&quot;token language-javascript&quot;&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; talkie &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Talkie&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      wide&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      control&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addEventListener&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;DOMContentLoaded&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    talkie&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;changed&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;subscribe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;current&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;clear&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// print presenter notes&lt;/span&gt;
      console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;talkie&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;notes&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getAttribute&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;data-page&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;body&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;html&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;talkiego だとこうなります。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;index.md&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;markdown&quot;&gt;&lt;pre class=&quot;language-markdown&quot;&gt;&lt;code class=&quot;language-markdown&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;&amp;lt;!-- rootopt: wide control --&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;&amp;lt;!-- cover: --&gt;&lt;/span&gt;
&lt;span class=&quot;token title important&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;#&lt;/span&gt; Talkie.js&lt;/span&gt;

&lt;span class=&quot;token hr punctuation&quot;&gt;---&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;&amp;lt;!-- title: invert
            backface=https://farm8.staticflickr.com/7469/16209884502_211d01ac0d_z_d.jpg
            backfaceFilter=&quot;blur(3px) brightness(.9)&quot; --&gt;&lt;/span&gt;
&lt;span class=&quot;token title important&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;#&lt;/span&gt; Backface (北極)&lt;/span&gt;

&lt;span class=&quot;token hr punctuation&quot;&gt;---&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;&amp;lt;!-- bullets: style=&quot;color:#ff0000;&quot; --&gt;&lt;/span&gt;

&lt;span class=&quot;token list punctuation&quot;&gt;*&lt;/span&gt; foo
&lt;span class=&quot;token list punctuation&quot;&gt;*&lt;/span&gt; bar
&lt;span class=&quot;token list punctuation&quot;&gt;*&lt;/span&gt; baz&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;で、この作った Markdown ファイル (index.md) を引数にとって起動します（デフォルト値は index.md にしてあります）。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;talkiego serve index.md&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;backface などのオプションの記述は必要ですが、コンテンツだけを独立した Markdown ファイルにできました。&lt;/p&gt;
&lt;p&gt;Markdown ファイルだけなので、企画案などのペライチを量産するときにもとても捗ります。&lt;/p&gt;
&lt;h2&gt;実装について&lt;/h2&gt;
&lt;p&gt;とりあえずコマンドなのでベースは &lt;a href=&quot;https://github.com/spf13/cobra&quot;&gt;spf13/cobra&lt;/a&gt; を使用しました。&lt;/p&gt;
&lt;p&gt;Talkie は Node.js ですが、スライドを動かすには dist ディレクトリに生成される静的ファイルを用いれば Node サーバの起動はしなくても動かせます。よって今回は &lt;a href=&quot;https://github.com/jessevdk/go-assets&quot;&gt;jessevdk/go-assets&lt;/a&gt; で Talkie のデフォルトテンプレートファイルを Go のソースコードにバイナリとして埋め込み、 FileServer として使用することでファイルを返せるようにしました。&lt;/p&gt;
&lt;p&gt;assets 系の埋め込みは &lt;a href=&quot;https://github.com/jteeuwen/go-bindata&quot;&gt;jteeuwen/go-bindata&lt;/a&gt; も人気ですが、今回はシンプルにファイルサーバとして使用するので &lt;code class=&quot;language-text&quot;&gt;http.FileSystem&lt;/code&gt; の実装を持っている &lt;a href=&quot;https://github.com/jessevdk/go-assets&quot;&gt;jessevdk/go-assets&lt;/a&gt; を使用しています。&lt;/p&gt;
&lt;h3&gt;大変だったところ&lt;/h3&gt;
&lt;p&gt;オプションのダブルクォーテーションをオプショナルにしたため、 parser を自作する羽目になりちょっと苦労しました。複数行も対応したため、空白で分割した後に quoted 状況に応じて結合したりなどなど。 CSV ファイルを扱うときもそうなのですが、良い感じでダブルクォーテーションを扱ってくれるライブラリが欲しいところです。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;parser.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseProps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	dst &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	fs &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; strings&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Fields&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token comment&quot;&gt;// split key:value or key=value&lt;/span&gt;
		sep &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; strings&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;IndexAny&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;:=&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; sep &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			dst&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;fs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

		k&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; fs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;sep&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;sep&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;strings&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;HasPrefix&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			dst&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; v
			&lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;token comment&quot;&gt;// quoted&lt;/span&gt;
		i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; fmt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%s %s&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; strings&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;HasSuffix&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;strings&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;HasSuffix&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\\\&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;
			&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
			i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

		dst&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; strings&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Trim&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; dst
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;とりあえず必要な書式で動けばいいやーと思いざっくり実装にしてあるので、正確な quoted の挙動にはなっていないかもしれませんが、及第点としたいところ。&lt;/p&gt;
&lt;h2&gt;今後の展望&lt;/h2&gt;
&lt;p&gt;このへんはあると便利だなーと思ってはいますが、とりあえず自分はデフォルトテンプレートがあれば困っていないのでどうしようかなと。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Talkie のディレクトリを指定すると埋め込んだ assets ではなく指定した Talkie を見る&lt;/li&gt;
&lt;li&gt;Talkie のオプション（ &lt;code class=&quot;language-text&quot;&gt;wide&lt;/code&gt; など。勝手に RootOpt と呼んでいる）をコマンド引数で指定できるように&lt;/li&gt;
&lt;li&gt;watch オプションで変更検知&lt;/li&gt;
&lt;li&gt;カスタム CSS ファイルなどを読み込めるように&lt;/li&gt;
&lt;li&gt;HOME ディレクトリらへんにコンフィグファイルを置いて、デフォルト設定として用いる&lt;/li&gt;
&lt;li&gt;オプションのエイリアスやシンボル、モジュール化&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;プルリクお待ちしております。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;スライドを作らなければいけないと思うと急にツールを整えたくなる病でカッとなって作ったのですが、狙い通り便利なものができたので捗っています。&lt;/p&gt;
&lt;p&gt;デザインセンスが無いので、ネタだけ用意すれば見た目はそれっぽくしてくれるツール群は本当に助かります。ありがとうございます。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CA.go #1 で sync.Pool について喋りました #ca_go]]></title><description><![CDATA[1ヶ月ほど前になってしまいましたが、 CA.go #1 - connpass にてメモリ効率を瀑上げする sync.Pool について話をしてきました。]]></description><link>https://hori-ryota.com/blog/2017-07-17-cago-1-sync-pool/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-07-17-cago-1-sync-pool/</guid><pubDate>Mon, 17 Jul 2017 03:00:00 GMT</pubDate><content:encoded>&lt;p&gt;1ヶ月ほど前になってしまいましたが、 &lt;a href=&quot;https://cyberagent.connpass.com/event/58120/&quot;&gt;CA.go #1 - connpass&lt;/a&gt; にてメモリ効率を瀑上げする sync.Pool について話をしてきました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;登壇内容&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://speakerdeck.com/horiryota/sync-dot-pool-depu-shang-gememorixiao-lu&quot;&gt;sync.Pool で瀑上げメモリ効率&lt;/a&gt; と題し、 sync.Pool の利点と実装における注意点を紹介してきました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://golang.org/pkg/sync/#Pool&quot;&gt;sync - The Go Programming Language&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div
          style=&quot;position: relative; width:100%; height:0; padding-top:74.92957746478874%;&quot;
          &gt;
          &lt;iframe id=&quot;talk_frame_396710&quot; src=&quot;//speakerdeck.com/player/9650c58c8e504359bc237bfa5664836b&quot; width=100% height=&quot;100%&quot; style=&quot;position:absolute;top:0;left:0;border:0; padding:0; margin:0; background:transparent;&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen=&quot;allowfullscreen&quot; mozallowfullscreen=&quot;true&quot; webkitallowfullscreen=&quot;true&quot;&gt;&lt;/iframe&gt;

          &lt;/div&gt;
&lt;p&gt;“明日から使える sync.Pool” を目指したのですが、登壇後にいただいたアンケートでも概ね好評だったようで良かったです。&lt;/p&gt;
&lt;p&gt;内容はスライドを参照いただければ問題ないかと思いますが、概要としては以下です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;sync.Pool はいわゆるメモリプールの仕組み。 Go 1.3 から標準パッケージに入った&lt;/li&gt;
&lt;li&gt;メモリを捨てずに再利用することで新しくメモリを確保しなくて済む&lt;/li&gt;
&lt;li&gt;大きなメモリ確保が必要なループを回しても、 sync.Pool を使えばアロケーションが走らないので高効率&lt;/li&gt;
&lt;li&gt;使いまわすので値が入ったままになる。初期化処理を工夫する必要がある&lt;/li&gt;
&lt;li&gt;interface{} で扱うので wrapper を用意したほうが良さそう&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;スライドにはベンチマークも載せてありますが、シンプルに使えてかなりの効果が出ました。&lt;/p&gt;
&lt;p&gt;例えば動画サービスなら HLS の Playlist データで用いる配列や、パケット処理などで便利に使えます。&lt;/p&gt;
&lt;h2&gt;スライド制作&lt;/h2&gt;
&lt;p&gt;以前から使っている &lt;a href=&quot;https://twitter.com/ahomu&quot;&gt;@ahomu&lt;/a&gt; さん製の &lt;a href=&quot;https://github.com/ahomu/Talkie&quot;&gt;Talkie&lt;/a&gt; をお借りしました。いつもありがとうございます。&lt;/p&gt;
&lt;p&gt;Talkie はソースを丸っと落として index.html を編集する必要があるため、 Markdown だけ記述すればコマンド一発で起動できる &lt;a href=&quot;https://github.com/hori-ryota/talkiego&quot;&gt;talkiego&lt;/a&gt; を作りました。ペライチ資料作るのにも便利。今度ブログ書きます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/hori-ryota/talkiego&quot;&gt;hori-ryota/talkiego: talkiego is wrapper for Talkie.&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;お礼&lt;/h2&gt;
&lt;p&gt;今回は主催兼、司会兼、第一登壇者ということでとても緊張していたのですが、会場の雰囲気が優しくて助けられました。ありがとうございます。&lt;/p&gt;
&lt;p&gt;当日のお昼が記録的な荒天でキャンセルが相次ぐ中、足を運んでいただき本当に感謝しております。&lt;/p&gt;
&lt;p&gt;次回は8月中には開催できたらいいなーと思っているので、またよろしくお願いします。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Neovim で日本語入力の確定時に文字化けする症状の直し方]]></title><description><![CDATA[Neovim を使用していて日本語入力時の文字化けに長いこと苦しんでいたのですが、解決の目処が立ったのでブログに残しておきます。 日本語が普通に打てるって幸せ…！]]></description><link>https://hori-ryota.com/blog/2017-07-08-neovim-fix-input-broken-ttimeout/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-07-08-neovim-fix-input-broken-ttimeout/</guid><pubDate>Sat, 08 Jul 2017 07:10:00 GMT</pubDate><content:encoded>&lt;p&gt;Neovim を使用していて日本語入力時の文字化けに長いこと苦しんでいたのですが、解決の目処が立ったのでブログに残しておきます。&lt;/p&gt;
&lt;p&gt;日本語が普通に打てるって幸せ…！&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;そもそものバグ&lt;/h2&gt;
&lt;p&gt;Neovim で IME （ Google 日本語入力を使用しています）からの入力時を確定したタイミングでバーンっと文字化けするという症状がありました。&lt;/p&gt;
&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;Neovimで日本語入力文字化けする。入れ直せば入るが結構な高頻度で困ってる。&lt;br&gt;SKKとの相性かなんかかと思ったけど、Googleでも発生。&lt;br&gt;pluginも設定ファイルも全部無効でも発生(頻度はすげー下がるけど)するし、iTermとかtmuxとか関係ありそうなの切ってもダメ。 &lt;a href=&quot;https://t.co/1vtFNlFeSH&quot;&gt;pic.twitter.com/1vtFNlFeSH&lt;/a&gt;&lt;/p&gt;&amp;mdash; ゆーいち@イカX (@u1tnk) &lt;a href=&quot;https://twitter.com/u1tnk/status/879360193942896640?ref_src=twsrc%5Etfw&quot;&gt;June 26, 2017&lt;/a&gt;&lt;/blockquote&gt;


&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;NeoVimで「使ってみたかったので」の入力を確定（Enterキー）したらこのぶっ壊れである。&lt;br&gt;改行が入ったりコピペっぽい動きをするのだけど全然わからぬ…！ &lt;a href=&quot;https://t.co/ls4dye2FRC&quot;&gt;pic.twitter.com/ls4dye2FRC&lt;/a&gt;&lt;/p&gt;&amp;mdash; hori (@hori_ryota) &lt;a href=&quot;https://twitter.com/hori_ryota/status/873898431051255812?ref_src=twsrc%5Etfw&quot;&gt;June 11, 2017&lt;/a&gt;&lt;/blockquote&gt;

&lt;h2&gt;直し方&lt;/h2&gt;
&lt;p&gt;詳細は後述しますが、 &lt;code class=&quot;language-text&quot;&gt;ttmeout&lt;/code&gt; と &lt;code class=&quot;language-text&quot;&gt;ttimeoutlen&lt;/code&gt; が適切に設定されていないと生じる症状でした。&lt;/p&gt;
&lt;p&gt;init.nvim に以下を追記すれば直ります。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;init.nvim&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;vim&quot;&gt;&lt;pre class=&quot;language-vim&quot;&gt;&lt;code class=&quot;language-vim&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;ttimeout&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;ttimeoutlen&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;原因&lt;/h2&gt;
&lt;p&gt;Neovim に issue があります。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/neovim/neovim/issues/3094&quot;&gt;Arbitrarily invoke insert mysterious words when Japanese(or not english lauguege) input · Issue #3094 · neovim/neovim&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;2015 年の古い closed issue ですが、実はまだ直っていなかったという。&lt;/p&gt;
&lt;p&gt;下の方に私の（拙い）英語コメントが新しく追加されていますが、概要をブログにも記しておきます。&lt;/p&gt;
&lt;p&gt;Neovim の input の挙動ですが、 Neovim ではキー入力（ input ）を受け取った際、一定の処理量ごとにバッファリングして処理します。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/neovim/neovim/blob/685ca180f7c96f77a79c78d3b26bd003f8cd834c/src/nvim/tui/input.c#L385-L399&quot;&gt;neovim/input.c at 685ca180f7c96f77a79c78d3b26bd003f8cd834c · neovim/neovim&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;一回のループでは&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;input.c&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;size_t consumed &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;termkey_push_bytes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;tk&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ptr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;MIN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;count&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;で input 用のバッファから &lt;code class=&quot;language-text&quot;&gt;input-&amp;gt;tk&lt;/code&gt; のサイズ分だけ抽出して処理を行います。&lt;/p&gt;
&lt;p&gt;抽出した &lt;code class=&quot;language-text&quot;&gt;input-&amp;gt;tk&lt;/code&gt; のバッファを&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;input.c&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;tk_getkeys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; false&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;で処理するのですが、先ほどの &lt;code class=&quot;language-text&quot;&gt;termkey_push_bytes&lt;/code&gt; で取得したバッファはバイト数で切り取っただけなのでマルチバイト文字を考慮できていません。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;tk_getkeys&lt;/code&gt; はタイムアウトした場合、もしくはタイムアウトが設定されていない場合に、第二引数を &lt;code class=&quot;language-text&quot;&gt;true&lt;/code&gt; で呼び直し、すぐに解釈できない（確定できない）バイト列でも確定する、という挙動をします。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/neovim/neovim/blob/685ca180f7c96f77a79c78d3b26bd003f8cd834c/src/nvim/tui/input.c#L266-L272&quot;&gt;neovim/input.c at 685ca180f7c96f77a79c78d3b26bd003f8cd834c · neovim/neovim&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;よってマルチバイト文字を入力した際、分割されてしまったマルチバイトが上手く解釈できず悪さをし、文字化けする場合があるというのが主旨です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;tk_getkeys&lt;/code&gt; のタイムアウトの設定が先述のオプション &lt;code class=&quot;language-text&quot;&gt;ttimeout&lt;/code&gt; と &lt;code class=&quot;language-text&quot;&gt;ttimeoutlen&lt;/code&gt; なので、これらを適切に設定すると直りますが、デフォルト値が無効とする設定だったため文字化けに遭遇した日本ユーザーが続出したという経緯でした。&lt;/p&gt;
&lt;p&gt;なお、 2017-07-06 にデフォルト値を設定するプルリクがマージされたため、現在の master ブランチでは直っています。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/neovim/neovim/pull/6969&quot;&gt;options: Default to ‘ttimeout’ and ‘ttimeoutlen=50’ by jamessan · Pull Request #6969 · neovim/neovim&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;日本語以外でもマルチバイトな入力を行うと症状が出るため、カーソルキーの連打などで変な文字が入ってしまう症状もおなじ原因と考えています。今のところ私の環境では併せて改善しました。&lt;/p&gt;
&lt;p&gt;ちなみに、 &lt;code class=&quot;language-text&quot;&gt;ttimeout&lt;/code&gt; と &lt;code class=&quot;language-text&quot;&gt;timeout&lt;/code&gt; の違いが混乱しがちなのですが、以下の区別です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ttimeout&lt;/code&gt; : キーコードのタイムアウト&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;入力文字の確定に対するタイムアウト&lt;/li&gt;
&lt;li&gt;流れ込んでくるバイト列を文字として判定するときに使われるタイムアウトなので、本来はとくに体感するようなタイムアウトではない&lt;/li&gt;
&lt;li&gt;Esc キーのような、後ろにバイト列が付くと別のキーになるキーの入力時に、確定するまでの待ちとして体感する&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;timeout&lt;/code&gt; : マッピングのタイムアウト&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;たとえばキーマッピングで &lt;code class=&quot;language-text&quot;&gt;gg&lt;/code&gt; と &lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt; を設定したとき、 &lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt; だけ入力してもマッピングは確定しない。マッピングを確定するまでのタイムアウト&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;Neovim のコードは C なので、初めて &lt;code class=&quot;language-text&quot;&gt;gdb&lt;/code&gt; を使ってがっつりデバッグしてみました。&lt;/p&gt;
&lt;p&gt;デバッガは IDE でしかやったことなかったのですが、意外となんとかなるもんですね。&lt;/p&gt;
&lt;p&gt;文字化けを言い訳にブログを滞らせていたので、更新再開します。なおってよかった。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[AWS の AI 系 API を生放送に取り入れようとしてみた]]></title><description><![CDATA[AWS Summit Tokyo 2017（2017年5月30日～6月2日） に参加させていただいたので、得たものをアウトプットです。 時間が経ってしまったので、行ってきましたブログではなく、盛り上がっていた AI 系の API を生放送で上手いこと使えないか調べてみました。]]></description><link>https://hori-ryota.com/blog/2017-07-05-aws-ai-api-for-broadcast/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-07-05-aws-ai-api-for-broadcast/</guid><pubDate>Wed, 05 Jul 2017 12:20:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;http://www.awssummit.tokyo/&quot;&gt;AWS Summit Tokyo 2017（2017年5月30日～6月2日）&lt;/a&gt; に参加させていただいたので、得たものをアウトプットです。&lt;/p&gt;
&lt;p&gt;時間が経ってしまったので、行ってきましたブログではなく、盛り上がっていた AI 系の API を生放送で上手いこと使えないか調べてみました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;今回調査する API のリスト&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/jp/lex/&quot;&gt;Amazon Lex (音声やテキストを使用した会話型インターフェイスを構築） | AWS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/jp/polly/&quot;&gt;Amazon Polly (文章をリアルな音声に変換) | AWS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/jp/rekognition/&quot;&gt;Amazon Rekognition (深層学習に基づく画像認識サービス) | AWS&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;自分でモデルを構築する機械学習サービスではなく、 AWS が提供してくれている API を使う実験です。&lt;/p&gt;
&lt;h2&gt;Amazon Lex&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://aws.amazon.com/jp/lex/&quot;&gt;Amazon Lex (音声やテキストを使用した会話型インターフェイスを構築） | AWS&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;音声やテキストを使用して、任意のアプリケーションに対話型インターフェイスを構築するサービスです。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;とのことなので、チャット Bot で自動応答システムを作れそうなやつですね。 Alexa で使用されている技術を利用できるとのことです。&lt;/p&gt;
&lt;h3&gt;雑感&lt;/h3&gt;
&lt;p&gt;Lex は雑談系 API ではなく予め定義したヒアリング項目を会話インターフェースで埋めていく API です。ざっくりいうと入力フォームを会話インターフェースで代替できる API です。&lt;/p&gt;
&lt;p&gt;データ構造としては以下があります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Intent&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;データのカテゴリみたいなやつ&lt;/li&gt;
&lt;li&gt;花情報、お届け先情報みたいな感じで情報のまとまりの単位&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Slot&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;詳細なデータ項目&lt;/li&gt;
&lt;li&gt;花情報なら、花の種類や色、本数などの詳細項目の単位&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;なんとなくの動きはこんな感じです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;お花を注文したいです&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;どんな花？&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;バラで&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;何本？&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;3本ほしい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;どこに届ければいいの？&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;東京都渋谷区〜〜〜&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;バラを3本、東京都渋谷区〜〜〜に届ければいいのね？&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;はい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;了解！&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;みたいな。 Lex の担当範囲は文章として投げられた問い合わせをパースして、必要なデータを抽出するところ。&lt;/p&gt;
&lt;p&gt;例えば最初の注文でバラを3本、と投稿されれば、本数の確認は済んだものとして次の項目（届け先）に移ってくれます。&lt;/p&gt;
&lt;p&gt;テキストチャットだけでなく音声入力にも対応しているのでハンズフリーで使えます。&lt;/p&gt;
&lt;p&gt;Lex のバックエンドには Lambda が使えて、 Lambda には現在の Intent や Slot に入った項目、どのインターフェースをユーザーが使っているのかなどが渡ります。&lt;/p&gt;
&lt;h3&gt;生放送では&lt;/h3&gt;
&lt;p&gt;残念ながら日本語対応がまだなので、既存の生放送に組み込むのは諦めました。&lt;/p&gt;
&lt;p&gt;音声入力が可能なので、たとえばゲーム配信をしながら配信の操作を行うのに使えそうです。&lt;/p&gt;
&lt;p&gt;視聴ユーザー側への提供では EC 機能などの入力ツールとしての仕様でしょうか。フォームの代替としての使い方が基本になりそうなので、よくある全員が書き込むチャットでの使用はアイデアが必要そうです。&lt;/p&gt;
&lt;p&gt;配信プラットフォーム側としてはお問い合わせ窓にぜひ使ってみたい API でした。&lt;/p&gt;
&lt;h2&gt;Amazon Polly&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://aws.amazon.com/jp/polly/&quot;&gt;Amazon Polly (文章をリアルな音声に変換) | AWS&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Amazon Polly は、文章をリアルな音声に変換するサービスです。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;テキストの読み上げです。コメントの読み上げ機能に使えますね。&lt;/p&gt;
&lt;h3&gt;雑感&lt;/h3&gt;
&lt;p&gt;Polly は日本語に対応しています。ただし、今のところ声は一種類（ &lt;code class=&quot;language-text&quot;&gt;Mizuki, Female&lt;/code&gt; ）だけでした。&lt;/p&gt;
&lt;p&gt;とりあえず以下のテキストを読み上げてみました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;こんにちは、ミズキです。読みたいテキストをここに入力してください。

HTML

ふれーっす

ちょwwwwおまwwwwww

88888888888888888888888888&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;結果がこちらの音声ファイル（MP3）です。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/sounds/aws-ai-api-for-broadcast/speech_20170701120832865.mp3&quot;&gt;音声1&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;1行目の日本語は自然に読み上げられている気がします。3行目以降のスラングについては、 &lt;code class=&quot;language-text&quot;&gt;ふれーっす&lt;/code&gt; は違和感が強くでているように思います。 &lt;code class=&quot;language-text&quot;&gt;ちょwwwwおまwwwwww&lt;/code&gt; のような記号がはいるものは素直に読み上げてしまっています。&lt;/p&gt;
&lt;p&gt;素直な日本語の文章であれば聞き取るのに不自由はないですが、まだまだ機械読み上げとバレてしまうなーという感想です。&lt;/p&gt;
&lt;p&gt;Polly の良いところですが、レキシコンという読み上げのカスタム辞書を定義することができるのでスラングもある程度は対応することができます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://docs.aws.amazon.com/ja_jp/polly/latest/dg/managing-lexicons.html&quot;&gt;レキシコンの管理 - Amazon Polly&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;今回はこのような設定をしてみました。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;lexicons.xml&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;xml&quot;&gt;&lt;pre class=&quot;language-xml&quot;&gt;&lt;code class=&quot;language-xml&quot;&gt;&lt;span class=&quot;token prolog&quot;&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;lexicon&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;1.0&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; 
      &lt;span class=&quot;token attr-name&quot;&gt;xmlns&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;http://www.w3.org/2005/01/pronunciation-lexicon&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token attr-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;xmlns:&lt;/span&gt;xsi&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;http://www.w3.org/2001/XMLSchema-instance&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; 
      &lt;span class=&quot;token attr-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;xsi:&lt;/span&gt;schemaLocation&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;http://www.w3.org/2005/01/pronunciation-lexicon 
        http://www.w3.org/TR/2007/CR-pronunciation-lexicon-20071212/pls.xsd&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token attr-name&quot;&gt;alphabet&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;ipa&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;xml:&lt;/span&gt;lang&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;ja-JP&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;lexeme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;grapheme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;HTML&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;grapheme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;alias&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;Hypertext Markup Language&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;alias&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;lexeme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;lexeme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;grapheme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;ちょwwwwおまwwwwww&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;grapheme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;alias&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;ちょワラワラワラワラおまワラワラワラワラワラワラ&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;alias&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;lexeme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;lexeme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;grapheme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;88888888888888888888888888&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;grapheme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;alias&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;パチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチパチ&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;alias&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;lexeme&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;lexicon&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;結果の音声ファイルがこちらです。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/sounds/aws-ai-api-for-broadcast/speech_20170701124004317.mp3&quot;&gt;音声2&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;日本語読み上げで英語を読ませると発音が微妙ですね。スラングはとりあえず読み上げることはできました。&lt;/p&gt;
&lt;p&gt;今回は省略しましたが、 &lt;code class=&quot;language-text&quot;&gt;phoneme&lt;/code&gt; というタグもありまして、発音記号を指定できるので発音も調整することが可能です。&lt;/p&gt;
&lt;p&gt;レキシコン以外にも &lt;code class=&quot;language-text&quot;&gt;SSML&lt;/code&gt; による発音やボリュームの指定ができます。&lt;/p&gt;
&lt;p&gt;また、音声出力をさせる以外にもスピーチマークというメタデータを取得することができます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://docs.aws.amazon.com/ja_jp/polly/latest/dg/speechmarks.html&quot;&gt;スピーチマーク - Amazon Polly&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;スピーチマークに &lt;code class=&quot;language-text&quot;&gt;viseme&lt;/code&gt; という項目があるのですが、こちらは各音素に対応する顔と口の動きを表すそうです。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://docs.aws.amazon.com/ja_jp/polly/latest/dg/viseme.html&quot;&gt;ビゼーム と Amazon Polly - Amazon Polly&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;発声の動きが取得できるので、キャラクターに喋らせるような視覚的表現に使えそうです。&lt;/p&gt;
&lt;h3&gt;生放送では&lt;/h3&gt;
&lt;p&gt;とりあえず読み上げるだけならさくっと導入できそうでした。読み上げ精度は、まぁ機械読み上げだよなーというレベル。&lt;/p&gt;
&lt;p&gt;Polly の責務ではなさそうですが、レキシコンによる指定が単語単位の指定のため、スラングの指定で &lt;code class=&quot;language-text&quot;&gt;w&lt;/code&gt; や &lt;code class=&quot;language-text&quot;&gt;8&lt;/code&gt; の数を完全一致で定義しないと反応しなかったです。正規表現などで上手いこと指定したい。&lt;/p&gt;
&lt;p&gt;英語のみの読み上げはとてもスムーズに読み上げられているように聞こえました。&lt;/p&gt;
&lt;p&gt;スピーチマークを使えば、キャラクターが出演者として生放送するようなコンテンツが作れたりするのでしょうか。&lt;/p&gt;
&lt;h2&gt;Amazon Rekognition&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://aws.amazon.com/jp/rekognition/&quot;&gt;Amazon Rekognition (深層学習に基づく画像認識サービス) | AWS&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Amazon Rekognition は、画像の分析をアプリケーションに簡単に追加できるようにするサービスです。Rekognition では、画像内の物体、シーン、顔の検出、有名人の認識、および不適切なコンテンツの識別ができます。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;とのことで、いろいろな画像解析ができます。&lt;/p&gt;
&lt;h3&gt;雑感&lt;/h3&gt;
&lt;p&gt;とりあえず順番に使ってみます。本当は生放送の動画から FFmpeg などで切り出したサムネイルを用いて〜とやりたいのですが、権利の問題のためフリー素材の画像で試します。&lt;/p&gt;
&lt;p&gt;今回は &lt;a href=&quot;https://www.pakutaso.com/&quot;&gt;ぱくたそ-フリー写真素材・無料ダウンロード&lt;/a&gt; さんにお世話になります。いつもありがとうございます。&lt;/p&gt;
&lt;h4&gt;Object and scene detection&lt;/h4&gt;
&lt;p&gt;物体とシーンの検出です。写っている物体の検出と、全体としてどういうシーンか（夕焼けとか）を検出してくれるとのこと。&lt;/p&gt;
&lt;p&gt;まずは人物から。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a364d6e279d9569da73340929817e251/4b39a/person.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 43.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAACDklEQVQoz22R309SYRjH+Vvqrn+gdZV3XnTjWrZwddW8qPVDXS6WrYxmsZXFSiCyYhi2zGQw1DVdS2CM2Q+XYqYoMBB/HTDgJOjOgfPpnLN05nq27/a8z/Z+3u/3eQ2JpTiZTIZUMslKdpnNfB5BEMjncuRyAjm131hfU88ClUplT+WtLcplTeV/5gZ39x1GPDa+TIwS+TBIyN/HJ6+LgMeOz23D32cjOGAnFQ0gSxK1mqKqRu6XyIpQQJJkFEXRVa1WMTwzt+HruU3s4wBL0xGyMxMU4lEWJseYjowRi47zMxzg6/h7isUisiyjVVUFy1VlD6bNdeA7xz3ePjQx6XuOkJ5jNR1nMfaZOVXLyXnW0otkl2ZZiH3TY2oXdYjqUlFqeq851uLqQKf5CsPOu3wPjlDKZ/H23GdiyEWpsEFNltgpi0g7ZcTipu5QUmNrpUFqf91pvSiKu8A2XluuEeq34rFbcXa0EFV3mJqPkZiZIv5jlnQiwbr6YaVSSXei1W7U/UDNvaH/wS2cNy/id3TRff0CL7tMDFpMjA+4mQoHiYTCjHq9uKzdlMTfSPv2dhCqO3zSYuRR61kV1E5jfR1HDh3m0ql6HJ3tDL2wM9zXyxvbY6ydHayvrVLZ3t6LfBCqA592XKbX3Moryw1az5+j6WQDzU1GrhobOH38KMa6Y+oDJ2g+0/jfuAeBfwB4ImmE6YRxKgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;人物の結果&quot;
        title=&quot;人物の結果&quot;
        src=&quot;/static/a364d6e279d9569da73340929817e251/fcda8/person.png&quot;
        srcset=&quot;/static/a364d6e279d9569da73340929817e251/12f09/person.png 148w,
/static/a364d6e279d9569da73340929817e251/e4a3f/person.png 295w,
/static/a364d6e279d9569da73340929817e251/fcda8/person.png 590w,
/static/a364d6e279d9569da73340929817e251/efc66/person.png 885w,
/static/a364d6e279d9569da73340929817e251/c83ae/person.png 1180w,
/static/a364d6e279d9569da73340929817e251/4b39a/person.png 3104w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;きちんと人物と検出できており、背景の本棚も認識できているようです。&lt;/p&gt;
&lt;p&gt;続いて桜。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8a795b54a78340d863951b5712b6cc45/3a7f3/cherryblossom.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 44.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAACP0lEQVQoz2WSXUiTURzG36uugqAugqCLuu2iFAkirIuKuqsbKeiiD1CkDzMv5irxK8UCbWKmljgTRWcrl6XT0DRzTrL5Ae4mSzdmK7S5d5ubqdv7/jrvC86LzuHhf86B85znef5H8vv9+HyLeBa8LCx4+OX/TXBFFgghy2FWAkGWl5ZFXSEky6ytrSURi0aJxTTEkmfST0+Asf5ZOpv66BCwv3bSXNdFS30Prc976W4fxVxro7aigZZnbaz/XUcVU1EU/gQj+JdDxONxVFXVIc2Of2Ooewpb2xDWlkEaqzspMpjIzS7CcLtYf+Rl/RtemQfosYwI1TIbGxtoI6GoxBU1Sba5uakRzvPRNsEHqwPzUyumsiZKjSYqHzZSeu8Jxtxi7ueV0GkexG4dZ3U1SiKxpUjRoanV9rrlH+4lJoe/M9LjwvLCTlNNFwV5FeRkGcnJzCf/bhlZ13LIzsylvKxazzGRSOgEGpGibiuMRCJIPi8M9y4Ku1O8t4zTaGrm+uUHnE6/wNWL5yjJr8Fw8zGnjp/BcKeAYDBIOBxOkmxBI9fOpcB8IXNfbzDRfwn38FFc9j201R2hvPAArc37sVsOUf3oJBkZx6isuiIurepN0NUp23a1qlsOuPfh+iThdUn4pyWcozuYE+u+gd3Y+3fR8W4nxoa9nC84yK2qE+KrhITl7ey2CLUYouIbST53BjPOFLzTKbgnU3A60pj5chjHSCquMVE/p9HelY7tbSqOobMiJ1l0My56/L9lLcN/9oFNeTaIeFsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;桜の結果&quot;
        title=&quot;桜の結果&quot;
        src=&quot;/static/8a795b54a78340d863951b5712b6cc45/fcda8/cherryblossom.png&quot;
        srcset=&quot;/static/8a795b54a78340d863951b5712b6cc45/12f09/cherryblossom.png 148w,
/static/8a795b54a78340d863951b5712b6cc45/e4a3f/cherryblossom.png 295w,
/static/8a795b54a78340d863951b5712b6cc45/fcda8/cherryblossom.png 590w,
/static/8a795b54a78340d863951b5712b6cc45/efc66/cherryblossom.png 885w,
/static/8a795b54a78340d863951b5712b6cc45/c83ae/cherryblossom.png 1180w,
/static/8a795b54a78340d863951b5712b6cc45/3a7f3/cherryblossom.png 3076w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;とりあえず花とは認識できているようです。確率は下がってしまっていますが、 &lt;code class=&quot;language-text&quot;&gt;77.6%&lt;/code&gt; で桜と認識もできました。&lt;/p&gt;
&lt;p&gt;手前の菜の花は上がってきませんでした。&lt;/p&gt;
&lt;p&gt;最後に牛人間。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/da19352e7a02afd76eb719db832da8c7/6715e/cow.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 43.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAACJklEQVQoz22SX0hTARTG70vPEvQY1GNgUEFPaZBW1IhlohWmhv0xwtJKnTVZmumWbtO6s23NSOdK027+GZqKZAVWbz4UUWtLEQLbRApic7q5/bq75IjYgR98HDgf3+EcYXZuDq/Xy7fZWbw+H/Pz8wQWFwkEAgr+BH4/CwsLCsFgkHA4zPLyMqFQSCYo61CyJzi6+zG2d/GoZ5De4UmksTcMTkwzMD5N/8hrXM/H6Hg8SKvVxW2jjR/+RRIVj8f49TvId/9Pwiurf3txBHtbG/oWG5auYVofOGltt8lYaDQ30dRcj2jtpPnufbQNejS6Ony+r6ytxZThtVicqExCJ4hGowh3dBcpLVGj0ZaTm5NJyfEsTuft5uqVs7x/+5LyisOUlG5HnbsVlXobXzyflDSxmGyaQE6qaNlQWflkQTYZGRspLkwnR5XO0awdlBUdoq+3h/y8AjZv2UDWwTT2q9LI3LeJDx9nWF2JJFP9SyQSQdDVnuNM4QEuX8in8tIJrlcUMPq0HadopqxQTe6xbIqL9qI6sos9GTvxeD4ridZT/Y9guWeiuqock7EBUdQzNNCN990Q445GekUDDoeI2WRAq62kpuaacvnkyqkM6+trOV96ilsN1egNtTzsEBm1G+gzVOE01mFuM2IytaC7eUM21SgvtH7lVCW4XC7sdjvSMwm3e4SpqVfMTE8yITlx9z9h9MUYkiTR2dmFzWplaWkp+SKp+AOdITT5qoUIDQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;牛人間の結果&quot;
        title=&quot;牛人間の結果&quot;
        src=&quot;/static/da19352e7a02afd76eb719db832da8c7/fcda8/cow.png&quot;
        srcset=&quot;/static/da19352e7a02afd76eb719db832da8c7/12f09/cow.png 148w,
/static/da19352e7a02afd76eb719db832da8c7/e4a3f/cow.png 295w,
/static/da19352e7a02afd76eb719db832da8c7/fcda8/cow.png 590w,
/static/da19352e7a02afd76eb719db832da8c7/efc66/cow.png 885w,
/static/da19352e7a02afd76eb719db832da8c7/c83ae/cow.png 1180w,
/static/da19352e7a02afd76eb719db832da8c7/6715e/cow.png 3094w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これは人間として判定されるようです。&lt;/p&gt;
&lt;p&gt;検出の得意不得意は学習時の教師データに依りますが、ざっくり試した感じだと人物や風景写真に何があるかの検出精度が高そうな雰囲気でした。&lt;/p&gt;
&lt;p&gt;生放送ではスタジオ配信なのか屋外での撮影なのかなど、配信ジャンルの分類に使えそうですね。ダイジェスト作成時のシーン転換の検出にも使えそうです。&lt;/p&gt;
&lt;h4&gt;Image moderation&lt;/h4&gt;
&lt;p&gt;“画像の節度” とのことですが、こちらはアダルト画像などの判別ですね。下着と水着の判別のような精度を確認したいですが、精度に言及するほどの見せちゃいけない画像ストックがないので割愛します。&lt;/p&gt;
&lt;p&gt;言うまでもなく、生放送においては映像の監視は必須なのでありがたい機能です。とはいえ精度が 100% とはいかないはずなので、人力検知が必要になるのか悩ましいところ。&lt;/p&gt;
&lt;h4&gt;Facial analysis&lt;/h4&gt;
&lt;p&gt;顔分析とのことで、顔の検知と表情の分析をしてくれます。また、検出された顔の位置情報も出力してくれます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/26bcb58562f5b55aa44bf4053fcc82a6/ad989/doctor.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACf0lEQVQoz2WSTUgUcRjGhw5duohGdrAgC+kLYokOSVAZQR4SgqhbXTp26RCReKhLeEisIAwMxSzJVWn9wCUrtKIg00Xd9SPUdHfdddb9/p6d2Zlf/1k/sHrhmeH/n+F5n/d5XsntdiPLMkouh6pqZDJZorEYMYF4PFE4a/k8yVQKRVFIp9PiLkPGfG/CPG9A8sXzhFV43txGzdXrfHFMIq7wx3PISZWo+Fb/+CkWy0lGPn/FrLxokMkqeOUIoVgSw9DR9XVI/jT8Xktz6uxpjlSU8qC+jrAO7pBCRJANfXNQsqcUSdpBY+MTZJ+PnJhGNwxyWl6o1wWhsQXJnzLwJ/I0vWxg8OE9Bm1t+DXwrGUJiGY/HbPUXLjIrqJiHtXe5/2LpoK69TLWnxtkZkm+lE4gC4vhGEPWZvo/DeNN6qzGNDxi3lgKxvvtVJ45R7e1CyUaET5m/iLaRDabRQrmYGYlw9xSipZ2KwMfPUzOK6yIeaNCaViIsXb1UXXpMp09NlRNLZj/L1lKhBaJRAShYiCLsX0LbgY7ehj+7mPgwwIrYQP7yCjXbtyirOIwO4tKaHnVXlCWU9VCANsJVXFnboAUyoqV0HSmf0zQZxun0z7PW/sSrmWVquorFO0to/zYCYr3HaDtTQe6SDgYDG6luklsJl8gTGzYOzMrU9urcbNV5U6DE9vIIpXnqyk/auHgcQu79x+i9XUHivDJHG27us1VMndXmpuewLu8hHc1Su9EgrGFOBGvh3AowvTsLyannEw6XbhcTgKBAIlEouChSWCSbVdo+ih1P7nLs7rbTDlGeTe2xqwnbPYTPxpsL1mkHUurJBPxghJN0/4jNBv9AV0p/9Zzm6MOAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;サラリーマンに笑顔で診断結果を話す医者&quot;
        title=&quot;サラリーマンに笑顔で診断結果を話す医者&quot;
        src=&quot;/static/26bcb58562f5b55aa44bf4053fcc82a6/fcda8/doctor.png&quot;
        srcset=&quot;/static/26bcb58562f5b55aa44bf4053fcc82a6/12f09/doctor.png 148w,
/static/26bcb58562f5b55aa44bf4053fcc82a6/e4a3f/doctor.png 295w,
/static/26bcb58562f5b55aa44bf4053fcc82a6/fcda8/doctor.png 590w,
/static/26bcb58562f5b55aa44bf4053fcc82a6/efc66/doctor.png 885w,
/static/26bcb58562f5b55aa44bf4053fcc82a6/c83ae/doctor.png 1180w,
/static/26bcb58562f5b55aa44bf4053fcc82a6/ad989/doctor.png 3108w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;笑顔の男性として認識されました。年齢も表示されますが、妥当そうに見えます。&lt;/p&gt;
&lt;p&gt;出力される詳細情報が以下。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;result.json&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;FaceDetails&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;AgeRange&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;High&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;38&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Low&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;23&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Beard&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;99.88099670410156&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Value&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;BoundingBox&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Height&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.26210349798202515&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Left&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.28777778148651123&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Top&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.16026711463928223&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Width&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.17444443702697754&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;99.99989318847656&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Emotions&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;98.49005126953125&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;HAPPY&quot;&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2.324265241622925&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;SAD&quot;&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.7605314254760742&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;CALM&quot;&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Eyeglasses&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;99.9989242553711&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Value&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;EyesOpen&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;99.84434509277344&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Value&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Gender&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;99.92849731445312&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Value&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Male&quot;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Landmarks&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;eyeLeft&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3512860834598541&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.24727152287960052&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;eyeRight&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.4091435670852661&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.232853502035141&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;nose&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3978043496608734&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.30854734778404236&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;mouthLeft&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3508286476135254&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.34180906414985657&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;mouthRight&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.41227075457572937&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.32580694556236267&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;leftPupil&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3533526659011841&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2476949244737625&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rightPupil&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.4097452759742737&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2350766956806183&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;leftEyeBrowLeft&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3241878151893616&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.23118382692337036&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;leftEyeBrowRight&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3419976234436035&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.21752969920635223&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;leftEyeBrowUp&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3636026978492737&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.21767348051071167&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rightEyeBrowLeft&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.4005296528339386&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2100147008895874&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rightEyeBrowRight&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.41270801424980164&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2012871354818344&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rightEyeBrowUp&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.42687031626701355&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.19848868250846863&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;leftEyeLeft&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3391617238521576&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.24942179024219513&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;leftEyeRight&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.36388713121414185&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.24654965102672577&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;leftEyeUp&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3507053852081299&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.24253292381763458&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;leftEyeDown&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3516284227371216&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.25129595398902893&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rightEyeLeft&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3978275656700134&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2385561168193817&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rightEyeRight&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.4200177788734436&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2298586219549179&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rightEyeUp&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.40832263231277466&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.22751648724079132&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rightEyeDown&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.4101853370666504&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.23683662712574005&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;noseLeft&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.37390583753585815&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.31888213753700256&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;noseRight&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.40490350127220154&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3160232901573181&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;mouthUp&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3874001204967499&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3356427550315857&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;mouthDown&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3873828053474426&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;Y&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3668783903121948&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;MouthOpen&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;59.87575149536133&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Value&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Mustache&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;96.07781219482422&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Value&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Pose&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Pitch&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;-20.56659698486328&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Roll&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;-11.389120101928711&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Yaw&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;23.49652862548828&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Quality&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Brightness&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;55.80268096923828&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Sharpness&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;99.9305191040039&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Smile&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;86.74140930175781&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Value&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;Sunglasses&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Confidence&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;98.07421112060547&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;Value&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;OrientationCorrection&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ROTATE_0&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;座標が表示されるので切り取って加工もできそうです。&lt;/p&gt;
&lt;p&gt;感情の検知や目が開いているかを検知できるので、生放送ではこれらの分析と組み合わせた新しいコンテンツを考えるのが良さそうな気がしています。&lt;/p&gt;
&lt;p&gt;口が開いている人を検知してカメラを向けて〜とかもできるのでしょうか。&lt;/p&gt;
&lt;p&gt;後述の人検知と組み合わせれば、誰々が笑っている番組！のように検索できそうです。&lt;/p&gt;
&lt;p&gt;個人的にはどちらかといえば出演者の検知をするよりも見ている方々の表情分析でリアクションを数値化するのに興味があります。&lt;/p&gt;
&lt;h4&gt;Celebrity rekognition&lt;/h4&gt;
&lt;p&gt;有名人の認識です。まずは日本一有名なフリー素材こと大川さん。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9169d98146ad9c3307957a29eb9d07ce/4b39a/okawa.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 44.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABsklEQVQoz22Sy2oUQRSG+51c+QpZ5QUCust+XDoEVy4km1yEICS7IOIm5iIGkkB2Cmp0khACijpDMj2X7q57dU93/55TPeqIFv1Th0PXd079p6JerwdWt9tFHMdwzoGXtRZZlkEIEWSNhTEm5Fkca61hWDP5KBmkEImCFAqFn6Dz+RytVgudTx1UJQLIWU/K4YxHWU6AuqavwnAsEI8Eav4RdchH2VhCZRqKgJw72t/D3N07ONh5FTr1LkeRT5C7IsSpos4JrKm4yqsgUzSypEgSTEu6Av3Ixa8/fMS7l9sBnjPolwiY+wJ96qqfSCTKQfkSegplcRwpQR4QkA8M+yOsPVnHwfMd9H/0qEBFkAboGUhi34qiCN3ztRvVv/dICjJXmlD9+5cuHj5o4+nyBrZWV4EKwTuGed7JywaEKaSexn9ykUxpIHRtPnR1+RXrS228ePwIb09OUVU8FBdgVrsQ/wuZERULU07iDBNb4vD1CRbm5/GsvYRvZxdhquytIb/YZ1ZzbLbDvxUNboYY3Y5hpcOb3UPcv7eIzZVNvD8+RToY0zvz9AIMVKqDZoH/Wz8Bb4qkGjYlfBAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;ぱくたその大川竜弥さん&quot;
        title=&quot;ぱくたその大川竜弥さん&quot;
        src=&quot;/static/9169d98146ad9c3307957a29eb9d07ce/fcda8/okawa.png&quot;
        srcset=&quot;/static/9169d98146ad9c3307957a29eb9d07ce/12f09/okawa.png 148w,
/static/9169d98146ad9c3307957a29eb9d07ce/e4a3f/okawa.png 295w,
/static/9169d98146ad9c3307957a29eb9d07ce/fcda8/okawa.png 590w,
/static/9169d98146ad9c3307957a29eb9d07ce/efc66/okawa.png 885w,
/static/9169d98146ad9c3307957a29eb9d07ce/c83ae/okawa.png 1180w,
/static/9169d98146ad9c3307957a29eb9d07ce/4b39a/okawa.png 3104w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;日本人の検知はまだ弱いようです。大川さんでダメなのでフリー素材では限界そうです。&lt;/p&gt;
&lt;p&gt;権利問題で引っかかるとアレなので載せませんが、海外のモデルやスポーツ選手、日本人でもグローバルに活躍している方は検知できました。&lt;/p&gt;
&lt;p&gt;色んな表情の写真で検証してみましたが、登録されている人については検知精度は高く感じました。精度は高いですが日本人データはまだ教師データに追加してもらえていないようですね。&lt;/p&gt;
&lt;p&gt;対応されればサムネイルから出演者を検知できるので待ち遠しい機能です。&lt;/p&gt;
&lt;h3&gt;Face comparison&lt;/h3&gt;
&lt;p&gt;最後に顔認識です。同じ人の顔を検出できます。&lt;/p&gt;
&lt;p&gt;マネジメントコンソールで試す場合は、左側に探したい人の顔画像をアップロードし、右側に複数人が写っている画像をアップロードします。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f73967ddee21b9030a34bdf3f465f25b/b5666/compare-1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 39.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB9klEQVQoz1WSz2sTURDH998RvPg3ePGg6CUIYm8KehQPHrxa6FEU/FWDFKGYpq0aQYq1SGvT/Gx+tZvNJrv51bSmQW2S3U2y2W0/vrxi0YHhzcyb+b6Z+T6l0+nQbreZnLZt4zjOmfb7fSzLZjwe/6fD4fCfPFvqYDCQvmKaJqqqYhiG1Eqlgq7r0lbVXUolDUPEJn5V5Op6iW63y0Rcd0yr0+VX1+avKPv7B9TrdZrNJlqpRMUoC79Ga6/FrqqR3ylimlX0snhAK1Mx6xgCNBfd4Nj38P1jCeSNhqjZLIrnn5yhry4toK1FsNtN6ZcKKitLH6TdO+oRmQ+R2kpSF11vvA3Sc8ZYA7ECgfmzdUhycR7FcUayYGN1lduB60zfucfi42UZe/38FZcvXiIjukx/+srMlSkisy+o1hrEtjV+9Hza1gmHYuKDI5eypqMMh64szsZj3LgW4P7VB7x5+E7G1r5tcv7cBT5+/kLk6RyPAncFSY7oUCU69wzfc/HHpw39rjdZCb5EsSxLMjRheSeXoxDPYBYbOAMHvVLj5tQtwuFl1tcTzEw/IRSOUMzn2Xy/wEiQ4nkek6V1DEFYLIYyYTgmjFQ6TU4AZvM50ttpMpkM8XicVCpFMpGQ9wlhf49uoeezFCIhXPGFXPd0wv5eg9BskD+i3jG0sI8mzgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;検知成功&quot;
        title=&quot;検知成功&quot;
        src=&quot;/static/f73967ddee21b9030a34bdf3f465f25b/fcda8/compare-1.png&quot;
        srcset=&quot;/static/f73967ddee21b9030a34bdf3f465f25b/12f09/compare-1.png 148w,
/static/f73967ddee21b9030a34bdf3f465f25b/e4a3f/compare-1.png 295w,
/static/f73967ddee21b9030a34bdf3f465f25b/fcda8/compare-1.png 590w,
/static/f73967ddee21b9030a34bdf3f465f25b/efc66/compare-1.png 885w,
/static/f73967ddee21b9030a34bdf3f465f25b/c83ae/compare-1.png 1180w,
/static/f73967ddee21b9030a34bdf3f465f25b/b5666/compare-1.png 3118w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;複数人の画像を使いましたが、問題なく大川さんの顔が検出できました。&lt;/p&gt;
&lt;p&gt;一方で、メガネや髪型など何が寄与するのか確かめるためにメガネの大川さんで比較すると上手く行きませんでした。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0aee86d814c922fa91ba851ea7160c78/45736/compare-2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 40.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB5ElEQVQozzVRy27TUBD17yBW/AMb1D8AViz4BxbsWAGqqJBYsqiEhIKoVCg4BZo2RahtHravHb/q1FZiO44NCsGJ7cQNOYxvxEhH597R3DNz5whJnCCKIsRxjNlshizLMJ/POdI05VyWJcdyueGiKHhdTsiyOec8z3lOuHJd2LaFwWAA3x/CcRyOfr8PXe/BsszNnXBFuaq2alJFViwQJFNM0wz/Q+ipGloXHTSOTlB7twfDtMCYCtf1oOkmR3W2L6mBdQlv4ENXVWiyxAUW5TXndDKBR02F4dCHJGtofPmG3Z2nCMIIQRChXK3BWh18/fCJPxj7IfbfvIXSkeH2FJjn33l+uSg4/6x+cXYKIaYdtrsa+rqOyGD8q543RDrL8HL7BbZu34FDUx2/ruHJ1l0cv6/BZBK6zcZmwmIjOJC6sNsdCKNRhDZN4lkOojDBKBzTzjwyKIMoHuHmjVto/jjH7uNt7Dx8hHyxoFoDriphTULXZFIVkWPjokkTVksXD/agMY2MCckEB4ZhkUEB1J6Je/cfoC7WIdabeP7sFfY/HqJ1eoKzwwMuVJC7VbgSQ6v+GYJpmpAkCYqiQJZlfq6gaRpnxhgUyjMyQiJutdsYhwGKP1OsacS/qxUXnCW/kP+e4B8fEjbpK8YByAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;検知失敗&quot;
        title=&quot;検知失敗&quot;
        src=&quot;/static/0aee86d814c922fa91ba851ea7160c78/fcda8/compare-2.png&quot;
        srcset=&quot;/static/0aee86d814c922fa91ba851ea7160c78/12f09/compare-2.png 148w,
/static/0aee86d814c922fa91ba851ea7160c78/e4a3f/compare-2.png 295w,
/static/0aee86d814c922fa91ba851ea7160c78/fcda8/compare-2.png 590w,
/static/0aee86d814c922fa91ba851ea7160c78/efc66/compare-2.png 885w,
/static/0aee86d814c922fa91ba851ea7160c78/c83ae/compare-2.png 1180w,
/static/0aee86d814c922fa91ba851ea7160c78/45736/compare-2.png 3122w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;得意不得意はあると思いますが、精度が気になるところですね。同一人物が映っている映像を検知するのは非常にやりたいことの1つなので、今後に期待したいです。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;駆け足ですが、現状の AWS にある AI 系の API について触れてみました。とりあえず触るだけならマネジメントコンソールからポチポチできるので超簡単です。&lt;/p&gt;
&lt;p&gt;まだまだ求めたい精度に達していない感触でしたが、補助的に使うなら使い所は多そうです。&lt;/p&gt;
&lt;p&gt;完全自動化に使おうとすると、2015年に Google Photo で生じたような問題のあるカテゴライズ（黒人をゴリラと誤認識する）が生じる可能性が残るので、責任の所在が難しいところ。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.theguardian.com/technology/2015/jul/01/google-sorry-racist-auto-tag-photo-app&quot;&gt;Google says sorry for racist auto-tag in photo app | Technology | The Guardian&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;この件は単なる誤認識なのか教師データに悪意ある分類データが混入していたのかは知りませんが、このようなトラブルを完全に防ぐのは深層学習だと難しそうですね。&lt;/p&gt;
&lt;p&gt;認識精度は教師データに左右されるので、プラットフォームを運営するなら API だけでやろうとせず自プラットフォームのデータを教師データに使うことで類似データの精度は上がるかと思います。&lt;/p&gt;
&lt;p&gt;とはいえプラットフォームに使えるデータとタグ付けが溜まっていないからこそ API を使いたいので悩ましい。&lt;/p&gt;
&lt;p&gt;それはそれとして、 &lt;a href=&quot;http://www.awssummit.tokyo/&quot;&gt;AWS Summit Tokyo 2017（2017年5月30日～6月2日）&lt;/a&gt; はとても楽しいイベントでした（会場間が遠くてちょっと移動が辛かったですが）。&lt;/p&gt;
&lt;p&gt;ブース出展でも S3 の代替手段を狙うサービスが展示されていたり、 VR の体験スペースがあったり、何より Amazon の倉庫ロボが展示されていたのが個人的にはテンションが上りました。&lt;/p&gt;
&lt;p&gt;またぜひ次もお邪魔したいです。ありがとうございました。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[TypeScript で Google Apps Script を書く環境を整備する]]></title><description><![CDATA[無料で自動化環境を整備できることで有名な Google Apps Script ですが、以前はブラウザで JavaScript を用いて開発する必要があったため辛い部分もありました（人による）。 現在は公式からローカル開発をするための公式 CLI ツールが提供されているので、静的型付けの恩恵を受けるべく TypeScript を用いて開発できるようにしてみました。]]></description><link>https://hori-ryota.com/blog/2017-03-19-googleappsscript-by-typescript/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-03-19-googleappsscript-by-typescript/</guid><pubDate>Sun, 19 Mar 2017 08:15:30 GMT</pubDate><content:encoded>&lt;p&gt;無料で自動化環境を整備できることで有名な Google Apps Script ですが、以前はブラウザで JavaScript を用いて開発する必要があったため辛い部分もありました（人による）。&lt;/p&gt;
&lt;p&gt;現在は公式からローカル開発をするための公式 CLI ツールが提供されているので、静的型付けの恩恵を受けるべく TypeScript を用いて開発できるようにしてみました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;公式の CLI ツール&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://gsuite-developers.googleblog.com/2015/12/advanced-development-process-with-apps.html&quot;&gt;G Suite Developers Blog: Advanced Development Process with Apps Script&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/danthareja/node-google-apps-script#11-default-apps-script-developer-console-project&quot;&gt;danthareja/node-google-apps-script: The easiest way to develop Google Apps Script projects&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;インストール自体は Node.js が入っている環境であれば &lt;code class=&quot;language-text&quot;&gt;npm install&lt;/code&gt; で入れられます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; -g node-google-apps-script&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;初期設定として認証キーの発行などが必要です。GitHub の README.md に全て載っていますが、日本語情報ですと以下のブログが詳しかったのでご参照ください。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://tech.speee.jp/entry/2016/04/28/190236&quot;&gt;Google Apps Scriptの開発をモダンに行う方法 - Speee DEVELOPER BLOG&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;ディレクトリ構成&lt;/h2&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;directory-structure&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;dev/
node_modules/
src/
.gitignore
gapps.config.json
package.json
README.md
tsconfig.json&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こんな感じです。 CLI がデフォルトで &lt;code class=&quot;language-text&quot;&gt;src/&lt;/code&gt; ディレクトリのものをアップロードするため、 &lt;code class=&quot;language-text&quot;&gt;dev/&lt;/code&gt; を開発用のディレクトリとし、コンパイルした生成ファイルを &lt;code class=&quot;language-text&quot;&gt;src/&lt;/code&gt; に置くようにします。（ &lt;code class=&quot;language-text&quot;&gt;gapps.config.json&lt;/code&gt; で設定できそうなので気持ち悪ければ変更すればよさそうですね。）&lt;/p&gt;
&lt;p&gt;ローカル開発なので Git でバージョン管理できるの最高ですね！テストは今回は省略しています。&lt;/p&gt;
&lt;h2&gt;node_modules&lt;/h2&gt;
&lt;p&gt;TypeScript で開発するために Google Apps Script 用の型定義ファイルを取得します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; --save-dev @types/google-apps-script&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;TypeScript 2.0 から tsd や typings は不要になったようですね。&lt;/p&gt;
&lt;h2&gt;tsconfig.json&lt;/h2&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;tsconfig.json&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;compilerOptions&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;commonjs&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;outDir&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./src&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;rootDir&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./dev&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

    &lt;span class=&quot;token property&quot;&gt;&quot;alwaysStrict&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;inlineSourceMap&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;noEmitOnError&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;noImplicitAny&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;noImplicitReturns&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;noImplicitThis&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;pretty&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;strictNullChecks&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;オプションは適当です。開発用ディレクトリを &lt;code class=&quot;language-text&quot;&gt;dev/&lt;/code&gt; 、出力ディレクトリを &lt;code class=&quot;language-text&quot;&gt;src/&lt;/code&gt; としたのでそれぞれ設定しています。&lt;/p&gt;
&lt;p&gt;これで &lt;code class=&quot;language-text&quot;&gt;tsc&lt;/code&gt;とコンパイルを実行すれば &lt;code class=&quot;language-text&quot;&gt;src/&lt;/code&gt; ディレクトリに js ファイルが出力されるので、 Google Apps Script にアップロードすればOKです。&lt;/p&gt;
&lt;h2&gt;npm scripts&lt;/h2&gt;
&lt;p&gt;そんなに複雑なコマンドは使いませんが、 npm scripts 化しておきます。&lt;/p&gt;
&lt;p&gt;package.json に以下を定義。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;package.json&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;  &lt;span class=&quot;token property&quot;&gt;&quot;scripts&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;publish&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;npm run build &amp;amp;&amp;amp; npm run upload&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;build&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;npm run tsc&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;tsc&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;tsc&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;upload&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;gapps upload&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで簡単にコンパイルとアップロードができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; run publish&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;サンプル&lt;/h2&gt;
&lt;p&gt;サンプルとして POST リクエストでカレンダーの予定を作成するスクリプトを作ってみました。 Google Apps Script 独自の Service などは型定義ファイルに global 定義されているのでそのまま使えます。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;gas-sample.ts&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; calendarId &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;sample@group.calendar.google.com&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// replace to your calendar id&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;PostEvent&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  queryString&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  parameter&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;index&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  parameters&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;index&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  contentLenth&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  postData&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    length&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    contents&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; e &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;PostEvent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;postData &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    length&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    contents&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;{&quot;title&quot;:&quot;sample title&quot;, &quot;startTime&quot;: &quot;2017-03-19T09:00:00.000Z&quot;, &quot;endTime&quot;: &quot;2017-03-19T12:00:00.000Z&quot;}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;doPost&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CalendarEvent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  title&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  startTime&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Date&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  endTime&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Date&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;doPost&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; PostEvent&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;GoogleAppsScript&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Content&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TextOutput &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; calendarEvent &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CalendarEvent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; contents &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;postData&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contents&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  calendarEvent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;title &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; contents&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;title
  calendarEvent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;startTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Date&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;contents&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;startTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  calendarEvent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;endTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Date&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;contents&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;endTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;stringify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;calendarEvent&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ContentService&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createTextOutput&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createEvent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; CalendarEvent&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  CalendarApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getCalendarById&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;calendarId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createEvent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;title&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;startTime&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;endTime&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;以前は &lt;code class=&quot;language-text&quot;&gt;Logger.log&lt;/code&gt; などで頑張ってデバッグしていたのですが、コンパイル時点でタイプミスなどを検知できてとても管理しやすいです。&lt;/p&gt;
&lt;p&gt;Google Apps Script は業務効率化と非常に相性がいい反面、管理が属人化しがちなのが悩みだったのですが、 ローカル開発によって Git 管理やテストが可能になるだけでなく、 TypeScript で静的型付けの恩恵まで受けられるようになったので更に便利になりました。&lt;/p&gt;
&lt;p&gt;SpreadSheet や手動スクレイピング芸などで疲弊している方々はたくさんいると思いますので、ちょろっとスクリプトを書いて自動化できるところはガンガンやっていきたい所存です。&lt;/p&gt;
&lt;p&gt;今回のサンプルは GitHub に置いてあるので、雛形としてお使いください。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/hori-ryota/gas-typescript&quot;&gt;hori-ryota/gas-typescript&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</content:encoded></item><item><title><![CDATA[S3 の Lifecycle をコードベースで管理できる環境を整備した]]></title><description><![CDATA[S3のLifecycleをポチポチしているのが辛くなったので、カッとなって作りました。 awscliとjqがあれば動くので、簡易的なコードベース管理の雛形としてお使いください。]]></description><link>https://hori-ryota.com/blog/2017-03-11-create-s3-lifecycle-manager/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-03-11-create-s3-lifecycle-manager/</guid><pubDate>Sat, 11 Mar 2017 12:52:55 GMT</pubDate><content:encoded>&lt;p&gt;S3のLifecycleをポチポチしているのが辛くなったので、カッとなって作りました。&lt;/p&gt;
&lt;p&gt;awscliとjqがあれば動くので、簡易的なコードベース管理の雛形としてお使いください。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;&lt;a href=&quot;https://github.com/hori-ryota/s3-lifecycle-manager&quot;&gt;hori-ryota/s3-lifecycle-manager&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;あくまで個人使用のために作成したので、細かいアレコレはご容赦ください。&lt;/p&gt;
&lt;p&gt;お約束ですが、 &lt;strong&gt;使用は自己責任でお願いします。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;以下、記事公開時点のREADME.mdと同内容のものに補足を加えたものです。&lt;/p&gt;
&lt;h2&gt;README.md&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/hori-ryota/cloudfront-manager&quot;&gt;hori-ryota/cloudfront-manager: Scripts for CloudFront&lt;/a&gt; から派生して作りました。&lt;/p&gt;
&lt;p&gt;S3のlifecycleをポチポチ運用するのが辛いのでawscliを用いたjson管理にするやつです。&lt;/p&gt;
&lt;h3&gt;（基礎知識）主要なawsコマンド&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;http://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/set-lifecycle-cli.html&quot;&gt;AWS CLI を使用したライフサイクル設定の設定 - Amazon Simple Storage Service&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;ディレクトリ構成&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;targetBuckets.txt # 管理対象とするbucketリスト
json/             # apiから取得したjson置き場&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;更新はjsonディレクトリ内のファイルを更新してS3に反映してください。&lt;/p&gt;
&lt;h3&gt;スクリプト&lt;/h3&gt;
&lt;p&gt;vim の quickrun で叩きやすくするため、dirname などでのパス解決はしていないです。 &lt;code class=&quot;language-text&quot;&gt;s3-lifecycle-manager/&lt;/code&gt; ディレクトリ直下で実行してください。&lt;/p&gt;
&lt;h4&gt;&lt;a href=&quot;fetchall.sh&quot;&gt;fetchall.sh&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;初期化用。 &lt;code class=&quot;language-text&quot;&gt;targetBuckets.txt&lt;/code&gt; に記載されているbucketのlifecycleを取ってきてjsonディレクトリに反映。&lt;/p&gt;
&lt;p&gt;削除済みのjson削除は行わないので、削除も必要ならjsonディレクトリを削除後に実行してください。&lt;/p&gt;
&lt;h4&gt;&lt;a href=&quot;update.sh&quot;&gt;update.sh&lt;/a&gt;&lt;/h4&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;./update.sh &lt;span class=&quot;token variable&quot;&gt;${targetCName}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;更新用。&lt;code class=&quot;language-text&quot;&gt;get-bucket-lifecycle-configuration&lt;/code&gt; のjsonと &lt;code class=&quot;language-text&quot;&gt;put-bucket-lifecycle-configuration&lt;/code&gt; の形式は若干違うので、&lt;code class=&quot;language-text&quot;&gt;jq&lt;/code&gt; コマンドで整形したものを入力へ。&lt;/p&gt;
&lt;h4&gt;全bucketを targetBuckets.txt に入れたい場合&lt;/h4&gt;
&lt;p&gt;このコマンドで入るかと思います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws s3api list-buckets &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; jq -r &lt;span class=&quot;token string&quot;&gt;&apos;.Buckets[].Name&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; targetBuckets.txt&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;補足&lt;/h2&gt;
&lt;p&gt;lifecycle が未設定な bucket に fetch をかけるとエラーになるので、以下のようなスクリプトで初期化するのも良いと思います。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;apply-cleaning-multipart-upload.sh&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -eu

&lt;span class=&quot;token assign-left variable&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;json&apos;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; -p &lt;span class=&quot;token variable&quot;&gt;$dir&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; ./targetBuckets.txt&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;{
  &quot;Rules&quot;: [
    {
      &quot;Filter&quot;: {
        &quot;Prefix&quot;: &quot;&quot;
      },
      &quot;Status&quot;: &quot;Enabled&quot;,
      &quot;ID&quot;: &quot;incomplete-multipart&quot;,
      &quot;AbortIncompleteMultipartUpload&quot;: {
        &quot;DaysAfterInitiation&quot;: 1
      }
    }
  ]
}&apos;&lt;/span&gt;


&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;bucket&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$buckets&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;fetch &lt;span class=&quot;token variable&quot;&gt;$bucket&lt;/span&gt;&quot;&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$json&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; jq &lt;span class=&quot;token string&quot;&gt;&apos;.&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dir&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;$bucket&lt;/span&gt;.json&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のスクリプトは &lt;code class=&quot;language-text&quot;&gt;targetBuckets.txt&lt;/code&gt; の全ての bucket の json に対し、不完全な Mupltipart Upload の残骸を1日で削除する lifecycle を設定指定しています。&lt;/p&gt;
&lt;p&gt;その上で &lt;code class=&quot;language-text&quot;&gt;fetchall.sh&lt;/code&gt; を以下のように書き換えて実行すると、既存のもののみ上書きされるので初期化に良いです。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;fetchall.sh&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -u

&lt;span class=&quot;token assign-left variable&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;json&apos;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; -p &lt;span class=&quot;token variable&quot;&gt;$dir&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; ./targetBuckets.txt&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;bucket&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$buckets&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;fetch &lt;span class=&quot;token variable&quot;&gt;$bucket&lt;/span&gt;&quot;&lt;/span&gt;
  &lt;span class=&quot;token assign-left variable&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;aws s3api get-bucket-lifecycle-configuration --bucket &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$bucket&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$?&lt;/span&gt; -ne &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
    &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;not initialized&quot;&lt;/span&gt;
    &lt;span class=&quot;token builtin class-name&quot;&gt;continue&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$target&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; jq &lt;span class=&quot;token string&quot;&gt;&apos;.&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dir&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;$bucket&lt;/span&gt;.json&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;書き換えた部分は &lt;code class=&quot;language-text&quot;&gt;set -eu&lt;/code&gt; の &lt;code class=&quot;language-text&quot;&gt;e&lt;/code&gt; フラグを外してエラーが生じても落ちないようにしたのと、 &lt;code class=&quot;language-text&quot;&gt;if [ $? -ne 0 ]&lt;/code&gt; によって fetch の成否で後続処理を分岐させているところです。&lt;/p&gt;
&lt;p&gt;とりあえず Multipart Upload のゴミ掃除はどの bucket でも設定しておきたいものだとは思うので初期化としては妥当ではないでしょうか。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;やっぱりコードベースでインフラ管理をできるのは設定の手間もミスも無くせる上にバージョン管理やレビューも導入できて幸福度が高いですね。どんどん推し進めていきたいと思います。&lt;/p&gt;
&lt;p&gt;lifecycle はそれなりの数（試したところ200は少なくとも設定できた）が設定できるので、大量のオブジェクトを削除する際に prefix で絞れる場合は lifecycle を 1d で設定して待つとリクエスト数も節約できる上に楽なので、コードベースで気軽にベタベタ変更できるのはとても嬉しいです。&lt;/p&gt;
&lt;p&gt;ちなみに Terraform でも lifecycle の管理はできるようなので、 bucket を Terraform で管理している場合はそちらを使用するのが良いかもしれません。今のところ私の使い方では影響範囲を絞ってフランクに管理したかったのでスクリプトでの json 管理が捗っています。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Amazon Aurora 事例祭り（20170307）に行ってきたメモ]]></title><description><![CDATA[Amazon Aurora 事例祭り に行ってきたので、メモを公開します。]]></description><link>https://hori-ryota.com/blog/2017-03-07-aurora-matsuri20170307/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-03-07-aurora-matsuri20170307/</guid><pubDate>Tue, 07 Mar 2017 09:07:40 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://aws.amazon.com/jp/about-aws/events/2017/aurora-20170307/&quot;&gt;Amazon Aurora 事例祭り&lt;/a&gt; に行ってきたので、メモを公開します。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;社内共有で Slack に貼ろうと思っていたメモなのですが、長くなったのでブログに公開します。&lt;/p&gt;
&lt;h2&gt;概要&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://aws.amazon.com/jp/about-aws/events/2017/aurora-20170307/&quot;&gt;Amazon Aurora 事例祭り （2017 年 3 月 7 日開催） | AWS&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;セッション内容&lt;/h2&gt;
&lt;h3&gt;Amazon Auroraを使いこなすためのベストプラクティスと最新アップデート&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://twitter.com/con_mame&quot;&gt;@con_mame&lt;/a&gt; さん&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;データベースソリューションアーキテクト&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;登壇資料: &lt;a href=&quot;https://www.slideshare.net/AmazonWebServicesJapan/auroraamazon-aurora&quot;&gt;[Aurora事例祭り]Amazon Aurora を使いこなすためのベストプラクティス&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;開発サイドからの知見と今後の展望&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;PostgreSQL For Aurora でるよ！&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;9.6.4&lt;/code&gt; と互換&lt;/li&gt;
&lt;li&gt;MySQL 版と同等の機能ができるようにする予定（まだ開発中なので確約はできない）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/jp/rds/aurora/details/&quot;&gt;製品の詳細 - Amazon Aurora | AWS&lt;/a&gt; の再紹介&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Aurora は障害時のフェイルオーバーでは DNS レベルで master を切り替える&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DNS の TTL は 5s&lt;/li&gt;
&lt;li&gt;アプリケーション側で DNS キャッシュしていると切り替えが遅れるので注意&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;master か否かは read only の変数を見ると分かる（ &lt;em&gt;パラメータ名は聞き漏らしました&lt;/em&gt; ）&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;JDBC Driver&lt;/code&gt; を使っている人は &lt;code class=&quot;language-text&quot;&gt;MariaDB Connector/J 1.2.0&lt;/code&gt; が Aurora 対応したのでオススメ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;master 判定が組み込まれており、フェイルオーバー時の切り替えが速い&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Aurora のパフォーマンスを引き出すために&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;クエリ並列度が高い、データサイズが大きいケースで効果を発揮&lt;/li&gt;
&lt;li&gt;ロック機構や Query Cache 、スレッドプールなどに改善を入れて性能向上を行っている&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;CPU / Memory の利用率が MySQL より高いがスループットが出ている&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;分散ロック機構で CPU リソースを使い切ってスループットを出している&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;MySQL 互換ではあるが、マシンリソースの使い方が根本的に違う&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使い切ってスループットを出す設計なので、ベンチなどをとる際はスループットに着目してもらえると嬉しい&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;チューニング指針&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;まずはデフォルトのパラメータグループをベースに&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;適切なインスタンスタイプを選択することが大切&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;それでもダメならパラメータグループを設定&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;1トランザクションで大量の更新や削除を行ったり、大量のシーケンシャルリードを行う場合&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;range に区切って実行すると並列度が上がって良い（ Prallel Read Ahead ）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;移行オススメな方々&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;スループットを向上させたい&lt;/li&gt;
&lt;li&gt;ディスク容量が気になる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;最近のリリース&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Reader Endpoint の追加&lt;/li&gt;
&lt;li&gt;クロスリージョンレプリケーション対応&lt;/li&gt;
&lt;li&gt;フェイルオーバー順の指定&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Cluster View&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;インスタンス状況の一覧など&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;今後の展望（ re:Invent で発表されたやつ）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;RDS MySQL DB インスタンスから Aurora Read Replica が作成可能に&lt;/li&gt;
&lt;li&gt;Advanced Auditing&lt;/li&gt;
&lt;li&gt;Zero downtime patch&lt;/li&gt;
&lt;li&gt;etc. （色々とご紹介頂きましたが、既出の内容なので省略）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;AWS Database Migration Service と Schema Conversion Tool の使いドコロ&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/jp/dms/&quot;&gt;AWS Database Migration Service（データベースを簡単かつ安全に AWS へ移行） | AWS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://docs.aws.amazon.com/ja_jp/SchemaConversionTool/latest/userguide/Welcome.html&quot;&gt;AWS Schema Conversion Tool とは - AWS Schema Conversion Tool&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;適用できる組み合わせが広い&lt;/li&gt;
&lt;li&gt;自動変換できないところをレポートにまとめてくれるの便利&lt;/li&gt;
&lt;li&gt;詳細なパターン、フローをご紹介いただいた。メモが追いつかないのでスライドが公開されることを期待 -&gt; 公開していただきました！&lt;/li&gt;
&lt;li&gt;登壇資料: &lt;a href=&quot;https://www.slideshare.net/AmazonWebServicesJapan/auroraaws-database-migration-service-schema-conversion-tool&quot;&gt;[Aurora事例祭り]AWS Database Migration Service と Schema Conversion Tool の使いドコロ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Oracle RAC から Aurora MySQL へ移行したお話&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://twitter.com/darshuheider&quot;&gt;@darshuheider&lt;/a&gt; さん&lt;/li&gt;
&lt;li&gt;登壇資料: &lt;a href=&quot;https://techblog.recochoku.jp/1576&quot;&gt;Amazon Aurora 事例祭りに登壇させていただきました！ | レコチョクのエンジニアブログ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;レコチョクとは&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;デジタル音源配信サービス&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://recochoku.jp/&quot;&gt;音楽ダウンロードアプリ、音楽ダウンロードサイト、曲のランキング・歌詞は【レコチョク】iPhone/Android対応&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;機能やサービスごとにシステムを構築（マイクロサービス？）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;クラブレコチョクとは&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;レコチョクが展開するサービスへ会員機能を提供&lt;/li&gt;
&lt;li&gt;有効会員数は約1000万&lt;/li&gt;
&lt;li&gt;アクセス数は多いと秒間250リクエストを超える&lt;/li&gt;
&lt;li&gt;サービス横断で使われるので可用性が重要&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Aurora を選択した理由&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;会社全体としての課題&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;データ総量の予測が困難になってきた&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;コスト最適化&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;短期間でのサービス立ち上げ&lt;/li&gt;
&lt;li&gt;急激なアクセス増に対する対応のためインフラを多めに確保していた&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;コストの明確化&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;既存構成&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Oracle で RAC 構成&lt;/li&gt;
&lt;li&gt;DBA がインフラを運用&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Aurora へのモチベーション&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;可用性の担保&lt;/li&gt;
&lt;li&gt;運用工数を抑えたい&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;どのように Aurora へ移行したか&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DMS などの移行ツールが一般公開される前だったので、全て自前のスクリプト&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;テーブルを再作成&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DDL の作成&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;パラメータグループの作成&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;デフォルトのトランザクション分離レベルが Oracle と違うところがやらかしポイント&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;SQL の修正&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MySQL の構文に移植。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;データの移行&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;更新日を見ながら過去数年分を一気に移行&lt;/li&gt;
&lt;li&gt;移行後、差分を適用&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;性能試験&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;本番相当のデータを使って運用テスト、負荷テストを実施&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;スロークエリをチェック&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;実行計画を取ってフルスキャンしているものを確認&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;問題があったものを対応&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SQL の最適化&lt;/li&gt;
&lt;li&gt;インデックス追加&lt;/li&gt;
&lt;li&gt;サブクエリ排除&lt;/li&gt;
&lt;li&gt;検索専用のテーブルを追加（後方一致検索が重かった）&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;パラメータの修正は一切行わず&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Aurora のデフォルト値を信用&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;どのように Aurora を運用しているか&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;何を見ればいいかわからないところからスタート&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;標準的に見る項目や閾値を策定、ダッシュボード作成&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Aurora に合わせた監視内容に変更&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;CPU 使用率が高い&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;リソースをフル活用するため&lt;/li&gt;
&lt;li&gt;リソースの監視を止め、スループットやレイテンシーの監視のみにした&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;結果&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Aurora による障害はこれまで 0&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;メンテナンスによる停止はあったが、ゼロダウンタイムパッチにより解消&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;DB サーバ運用に工数をほとんど割かなくてよくなった&lt;/li&gt;
&lt;li&gt;性能は問題なし（むしろ早くなった）&lt;/li&gt;
&lt;li&gt;ライセンス費用が 0&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;今後への期待&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;PostgreSQL 互換&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;暗号化されたスナップショットの別リージョンへのコピー&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;バックアップを別リージョンに置きたかった&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;MySQL on Fusion IO から Amazon Aurora への移設による費用削減効果&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://mynet.co.jp/service/sangoku.html&quot;&gt;三国INFINITY（三国インフィニティ） | Mynet Inc. ( 株式会社マイネット )&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;旧 DB 構成&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;12 Core 3ペア&lt;/li&gt;
&lt;li&gt;32 Core （ &lt;em&gt;メモ取り切れなかった&lt;/em&gt; ）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;サーバ費用&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;全体: 185万円 / 月&lt;/li&gt;
&lt;li&gt;内、DB の費用: 92.5万円 / 月&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;AWS 移設計画&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;マスター DB 全て Aurora 化&lt;/li&gt;
&lt;li&gt;スレーブは Aurora のパフォーマンス最大5倍を信じて捨てる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;新構成の費用&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DBの費用が約16万円 / 月 に（82%減）&lt;/li&gt;
&lt;li&gt;リザーブドインスタンス（年間で購入、月額で割った値）&lt;/li&gt;
&lt;li&gt;オンプレサーバを見守る人が不要になり、人件費も大幅に削減&lt;/li&gt;
&lt;li&gt;順調に稼働中&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;質疑応答&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;メンテナンスは減ったか&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;移行では流石にメンテナンスした&lt;/li&gt;
&lt;li&gt;メンテナンス回数は減った&lt;/li&gt;
&lt;li&gt;そんなに止めることはない&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;どのくらいのデータ量をどのくらいの期間で移行したか&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;メンテナンス自体は2日間という長期（ゲームとしてはかなり長期）&lt;/li&gt;
&lt;li&gt;数10GB&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;毎日新聞ニュースサイトをクラウド化 ～Amazon Aurora 導入事例紹介～&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://mainichi.jp/&quot;&gt;毎日新聞のニュース・情報サイト&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;CMS 機能&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Aurora 採用理由&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;高パフォーマンス&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;高スループット&lt;/li&gt;
&lt;li&gt;低レイテンシーのリードレプリカ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;メンテナンスビリティ&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;コスト&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ストレージが特にメリットと感じられた&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;MySQL 互換&lt;/li&gt;
&lt;li&gt;移行の簡単さ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;採用による効果&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;メンテンナンスレス&lt;/li&gt;
&lt;li&gt;トラブルレス&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;技術者、社内利用者の意識改革&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;背中を気にしなくてよくなり、様々な好循環があった&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;MySQLからAuroraへ - 劇的な性能向上に止まらない、Aurora移行によるメリット -&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.fate-go.jp/&quot;&gt;スマホでフェイト！｜Fate/Grand Order 公式サイト&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;リリース時は MySQL 、途中で Aurora に移行&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Aurora 移行方針、準備&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;モチベーション&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ユーザー増を考えるととりあえず移行すればメリットありそう&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MySQL5.6 との互換性&lt;/li&gt;
&lt;li&gt;5倍のパフォーマンス&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Aurora だけで処理を捌ききれなくなったらどうするの&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;参照クエリを slave に振り分けることを考えていた&lt;/li&gt;
&lt;li&gt;MySQL ではレプリ遅延が10秒を上回ってくるのであかん&lt;/li&gt;
&lt;li&gt;Auroraなら10ms - 20msくらいなのでいけそう&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;DBデータ量が急増するゲーム施策のインフラ対応コストを削減したい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ストレージ容量を増やそうとするとメンテだった&lt;/li&gt;
&lt;li&gt;Aurora の自動スケール嬉しい！&lt;/li&gt;
&lt;li&gt;検討時のデータ容量は 600GB 程度だったので 64TB あれば余裕そう&lt;/li&gt;
&lt;li&gt;とはいえデータを減らす努力は忘れずに&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;インフラ費用を削減したい&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;検討当時は 200GB のデータサイズに対して 1TB 以上のストレージ容量を確保していた&lt;/li&gt;
&lt;li&gt;ユーザー数が増加していたので、余裕を持たせる必要&lt;/li&gt;
&lt;li&gt;Aurora 移行ならインフラ構成に手を入れずに対応できるので嬉しい&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;方針&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;移行前後のデータ不整合はダメ&lt;/li&gt;
&lt;li&gt;移行後のAurora 障害を考慮し、切り戻しできるように移行&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;手順&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;スナップショット作成（メンテ1h）&lt;/li&gt;
&lt;li&gt;スナップショットからAurora作成（5h）&lt;/li&gt;
&lt;li&gt;---&lt;em&gt;メモ取りきれなかった&lt;/em&gt;---&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;失敗&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;移行後48時間後にサーバの応答速度が不安定に&lt;/li&gt;
&lt;li&gt;slow query で &lt;code class=&quot;language-text&quot;&gt;init DB&lt;/code&gt; が重い&lt;/li&gt;
&lt;li&gt;binlogのパージっぽい&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;原因&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;init DB 時にパフォーマンスが劣化する Aurora v1.6 のバグ&lt;/li&gt;
&lt;li&gt;v1.6.5 でfix&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;MySQL に切り戻した後、v1.7 で再移行した&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;成果&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;オートスケール上手いこといっている&lt;/li&gt;
&lt;li&gt;30%の費用減&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;まとめ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;互換性のため移行の難易度は高くない&lt;/li&gt;
&lt;li&gt;パフォーマンスいい感じ&lt;/li&gt;
&lt;li&gt;とはいえ移行失敗時の切り戻しはしっかりね&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;小ネタ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;スナップショット作成が爆速&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MySQLで15分だったのが1分で終わる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;アップグレード管理&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ダウンタイムなしのアップグレードがリリースされたが、実行時のパフォーマンスは劣化するようなので注意&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;質疑応答&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;init DB&lt;/code&gt; の地雷は他社でも踏んだ気配？&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;事後に調べたらあったご様子&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;init DB&lt;/code&gt; のバグは事前に伝えてもらえなかったの？&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;AWS 側としてはここまでの影響が生じるとは予測できなかったため、事前にお伝えすることができなかった&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;運営、登壇の皆様、ありがとうございました。&lt;/p&gt;
&lt;p&gt;メモに何か間違いなどありましたらご指摘いただければ幸いです。&lt;/p&gt;
&lt;p&gt;今回のお話を伺った限りでは既存 DB からの移行もスムーズに行なえ、ゼロダウンタイムアップグレードもリリースされて機が熟してきたなーという雰囲気でした。&lt;/p&gt;
&lt;p&gt;担当サービスでも既に Aurora が導入されているので、上手く行かないパターンの知見も溜めていきたいところです。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[FFmpeg と ImageMagick によるサムネイルを用いた動画のシーン検出]]></title><description><![CDATA[FFmpeg のみで動画からシーン検出するスクリプトはちらほらと見かけるのですが、軽量でシンプルなシーン検出が欲しかったのでサムネイルと ImageMagick で整備してみました。]]></description><link>https://hori-ryota.com/blog/2017-02-28-ffmpeg-imagemagick-scene-detection/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-02-28-ffmpeg-imagemagick-scene-detection/</guid><pubDate>Mon, 27 Feb 2017 16:00:14 GMT</pubDate><content:encoded>&lt;p&gt;FFmpeg のみで動画からシーン検出するスクリプトはちらほらと見かけるのですが、軽量でシンプルなシーン検出が欲しかったのでサムネイルと ImageMagick で整備してみました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;やりたいこと&lt;/h2&gt;
&lt;p&gt;動画の要らない部分をカットしたかったのですが、落ちていた FFmpeg のシーン検出スクリプトが古い FFmpeg に依存していたり環境が限定されたり、ちょっと扱いづらそうだったので自作しようと思ったのがきっかけです。&lt;/p&gt;
&lt;p&gt;FFmpeg のみで試行錯誤するのも良かったのですが、別の用途で一定時間ごとのサムネイルを生成する必要があったため、サムネイルを使いまわして映像のみでのシーン検出をやってみました。&lt;/p&gt;
&lt;p&gt;動画を元データに検出しようとするとそれなりに負荷も時間もかかりますが、サムネイル比較であれば高速で軽量なのでお得です。&lt;/p&gt;
&lt;h2&gt;準備&lt;/h2&gt;
&lt;p&gt;FFmpeg と ImageMagick を用意します。&lt;/p&gt;
&lt;p&gt;Docker でインストールする場合は Alpine の apk で取れる FFmpeg のバージョンは古いので注意が必要です。&lt;/p&gt;
&lt;p&gt;動作確認したのは&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;FFmpeg : &lt;code class=&quot;language-text&quot;&gt;3.2.2&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;ImageMagick : &lt;code class=&quot;language-text&quot;&gt;6.9.6-8&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;7.0.5-0&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;です。 ImageMagick は apk でとれる &lt;code class=&quot;language-text&quot;&gt;6.9.6-8&lt;/code&gt; でも動きました。&lt;/p&gt;
&lt;h2&gt;サムネイル生成&lt;/h2&gt;
&lt;p&gt;FFmpeg によるサムネイル生成は色々とやり方があるのですが、方法によっては取得されるサムネイルの時間が不正確な場合があります。&lt;/p&gt;
&lt;p&gt;試した中で最もズレが少なかったのが以下。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;ffmpeg -i &lt;span class=&quot;token string&quot;&gt;&apos;src.mp4&apos;&lt;/span&gt; -filter:v &lt;span class=&quot;token assign-left variable&quot;&gt;fps&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;fps&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;/5&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;down output/%04d.jpg&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;fps&lt;/code&gt; の &lt;code class=&quot;language-text&quot;&gt;1/5&lt;/code&gt; は5秒に1枚のペースで出力するという意味です。10秒ごとなら &lt;code class=&quot;language-text&quot;&gt;1/10&lt;/code&gt; です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;output/&lt;/code&gt; ディレクトリを出力先にしているので、事前にディレクトリは作っておきます。&lt;/p&gt;
&lt;h2&gt;シーン検出&lt;/h2&gt;
&lt;p&gt;1つ前のサムネイルとの差分がどの程度あるかによってシーン変化を検出します。&lt;/p&gt;
&lt;p&gt;ImageMagick には &lt;code class=&quot;language-text&quot;&gt;compare&lt;/code&gt; というコマンドがあり、差分画像を出力することができます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.imagemagick.org/script/compare.php&quot;&gt;Command-line Tools: Compare @ ImageMagick&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;使い方はこんな感じ。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;compare -metric AE output/0000.jpg output/0001.jpg diff.jpg&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;差分画像が diff.jpg に出力されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/431d3eb2292318276f65d5342e38d8e2/eea4a/src1.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIFAwb/xAAWAQEBAQAAAAAAAAAAAAAAAAABAAL/2gAMAwEAAhADEAAAAX059grkg1f/xAAbEAABBAMAAAAAAAAAAAAAAAAAAQMRFAIQE//aAAgBAQABBQKy2d24sYiak//EABYRAAMAAAAAAAAAAAAAAAAAAAABEf/aAAgBAwEBPwGIiP/EABcRAQADAAAAAAAAAAAAAAAAAAABESH/2gAIAQIBAT8BuWv/xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAaEAACAgMAAAAAAAAAAAAAAAAAARExECFh/9oACAEBAAE/IVRDOActYN6Gx//aAAwDAQACAAMAAAAQuM//xAAVEQEBAAAAAAAAAAAAAAAAAAAAYf/aAAgBAwEBPxCCD//EABcRAAMBAAAAAAAAAAAAAAAAAAABURH/2gAIAQIBAT8QdDaP/8QAGxABAAICAwAAAAAAAAAAAAAAAQARIVFBodH/2gAIAQEAAT8QaYTuoni3eWW3iJUvcQuLcAtPU//Z&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;src1.jpg&quot;
        title=&quot;src1.jpg&quot;
        src=&quot;/static/431d3eb2292318276f65d5342e38d8e2/1c72d/src1.jpg&quot;
        srcset=&quot;/static/431d3eb2292318276f65d5342e38d8e2/a80bd/src1.jpg 148w,
/static/431d3eb2292318276f65d5342e38d8e2/1c91a/src1.jpg 295w,
/static/431d3eb2292318276f65d5342e38d8e2/1c72d/src1.jpg 590w,
/static/431d3eb2292318276f65d5342e38d8e2/a8a14/src1.jpg 885w,
/static/431d3eb2292318276f65d5342e38d8e2/fbd2c/src1.jpg 1180w,
/static/431d3eb2292318276f65d5342e38d8e2/eea4a/src1.jpg 1280w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3eddf0280062418e72797067befdf3ab/eea4a/src2.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUBAgP/xAAVAQEBAAAAAAAAAAAAAAAAAAABAP/aAAwDAQACEAMQAAABvogkG4qG/8QAGhAAAQUBAAAAAAAAAAAAAAAAAwACERMUIP/aAAgBAQABBQLQNXjjQ3j/xAAWEQADAAAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8BiIj/xAAXEQEAAwAAAAAAAAAAAAAAAAAAAREh/9oACAECAQE/Ablr/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGhAAAgIDAAAAAAAAAAAAAAAAAAERMRAhYf/aAAgBAQABPyFVQzgHLWG2PR//2gAMAwEAAgADAAAAEKvv/8QAFREBAQAAAAAAAAAAAAAAAAAAAGH/2gAIAQMBAT8Qgk//xAAXEQADAQAAAAAAAAAAAAAAAAAAAVFh/9oACAECAQE/ENBOj//EABwQAQACAgMBAAAAAAAAAAAAAAEAESFBEDFRsf/aAAgBAQABPxB5hPtRPFu7e5ZfFcGaHUdgKMeT/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;src2.jpg&quot;
        title=&quot;src2.jpg&quot;
        src=&quot;/static/3eddf0280062418e72797067befdf3ab/1c72d/src2.jpg&quot;
        srcset=&quot;/static/3eddf0280062418e72797067befdf3ab/a80bd/src2.jpg 148w,
/static/3eddf0280062418e72797067befdf3ab/1c91a/src2.jpg 295w,
/static/3eddf0280062418e72797067befdf3ab/1c72d/src2.jpg 590w,
/static/3eddf0280062418e72797067befdf3ab/a8a14/src2.jpg 885w,
/static/3eddf0280062418e72797067befdf3ab/fbd2c/src2.jpg 1180w,
/static/3eddf0280062418e72797067befdf3ab/eea4a/src2.jpg 1280w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/126b54ab330f30a91ff3da6c414a6edb/eea4a/diff-AE.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAf/EABYBAQEBAAAAAAAAAAAAAAAAAAADBf/aAAwDAQACEAMQAAABnJ9lquEh/8QAFxAAAwEAAAAAAAAAAAAAAAAAAAESIP/aAAgBAQABBQKyilj/xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAwEBPwGH/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBAAAgMAAAAAAAAAAAAAAAAAAFERICH/2gAIAQEAAT8hEXoyn//aAAwDAQACAAMAAAAQZD//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQMBAT8QhMf/xAAWEQADAAAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QpX//xAAaEAEBAAIDAAAAAAAAAAAAAAABABFxEDFR/9oACAEBAAE/EAeu7scoo5Cu44Vv/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;diff-AE.jpg&quot;
        title=&quot;diff-AE.jpg&quot;
        src=&quot;/static/126b54ab330f30a91ff3da6c414a6edb/1c72d/diff-AE.jpg&quot;
        srcset=&quot;/static/126b54ab330f30a91ff3da6c414a6edb/a80bd/diff-AE.jpg 148w,
/static/126b54ab330f30a91ff3da6c414a6edb/1c91a/diff-AE.jpg 295w,
/static/126b54ab330f30a91ff3da6c414a6edb/1c72d/diff-AE.jpg 590w,
/static/126b54ab330f30a91ff3da6c414a6edb/a8a14/diff-AE.jpg 885w,
/static/126b54ab330f30a91ff3da6c414a6edb/fbd2c/diff-AE.jpg 1180w,
/static/126b54ab330f30a91ff3da6c414a6edb/eea4a/diff-AE.jpg 1280w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;赤いのが全部差分です。ほぼ差分となってしまっていますが、動画の場合はノイズが乗るので単純比較だと上手くいきませんでした。&lt;/p&gt;
&lt;p&gt;オプションを指定することで解決できます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;compare&lt;/code&gt; コマンドでは &lt;code class=&quot;language-text&quot;&gt;-metrics&lt;/code&gt; オプションで差分のロジックを指定できます。&lt;/p&gt;
&lt;p&gt;一覧はこちら。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.imagemagick.org/script/command-line-options.php#metric&quot;&gt;Command-line Options @ ImageMagick&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;それぞれ向き不向きはあると思いますが、単純な差分抽出であれば上記サンプルで使用している、変化のあったピクセルをチェックする &lt;code class=&quot;language-text&quot;&gt;AE&lt;/code&gt; がお手軽かと思います。&lt;/p&gt;
&lt;p&gt;なお、動画の場合はどうしてもノイズが生じるため、厳密な画像比較をするとほとんど全面が差分として出力されてしまいます。対処としては &lt;code class=&quot;language-text&quot;&gt;AE&lt;/code&gt; を使用する場合は &lt;code class=&quot;language-text&quot;&gt;-fuzz&lt;/code&gt; オプションを併用すると微量の色変化では反応しなくなるため使いやすいです。&lt;/p&gt;
&lt;p&gt;10% で指定したのがこちら。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;compare -metric AE -fuzz &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;% output/0000.jpg output/0001.jpg diff.jpg&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b14758bd83ca17d45382fba12b68ad05/eea4a/diff-AE-FUZZ10.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQFAf/EABcBAAMBAAAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAamqrzrSJ4z/xAAbEAEAAgIDAAAAAAAAAAAAAAABAAIREwMSIf/aAAgBAQABBQI5TG0mwllwr2p6f//EABcRAAMBAAAAAAAAAAAAAAAAAAABAhH/2gAIAQMBAT8BUaOEf//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAECAQE/Aaf/xAAXEAADAQAAAAAAAAAAAAAAAAAAATEg/9oACAEBAAY/AoyMjx//xAAcEAABBAMBAAAAAAAAAAAAAAAAAREhMRBRcfH/2gAIAQEAAT8htHOYTyBNYjXhiyuz/9oADAMBAAIAAwAAABBcD//EABcRAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQMBAT8QRuCLh//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAgEBPxBRa3//xAAbEAEAAwEAAwAAAAAAAAAAAAABABEhMUFRYf/aAAgBAQABPxDZru8RMxH1WwcuK2lO+Pkeey6UTdq2J//Z&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;diff-AE-FUZZ10.jpg&quot;
        title=&quot;diff-AE-FUZZ10.jpg&quot;
        src=&quot;/static/b14758bd83ca17d45382fba12b68ad05/1c72d/diff-AE-FUZZ10.jpg&quot;
        srcset=&quot;/static/b14758bd83ca17d45382fba12b68ad05/a80bd/diff-AE-FUZZ10.jpg 148w,
/static/b14758bd83ca17d45382fba12b68ad05/1c91a/diff-AE-FUZZ10.jpg 295w,
/static/b14758bd83ca17d45382fba12b68ad05/1c72d/diff-AE-FUZZ10.jpg 590w,
/static/b14758bd83ca17d45382fba12b68ad05/a8a14/diff-AE-FUZZ10.jpg 885w,
/static/b14758bd83ca17d45382fba12b68ad05/fbd2c/diff-AE-FUZZ10.jpg 1180w,
/static/b14758bd83ca17d45382fba12b68ad05/eea4a/diff-AE-FUZZ10.jpg 1280w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;30% で指定したものがこちら。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;compare -metric AE -fuzz &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;% output/0000.jpg output/0001.jpg diff.jpg&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4b8ef4023c25efb969e842a402405ac4/eea4a/diff-AE-FUZZ30.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAezsRRIf/8QAFhABAQEAAAAAAAAAAAAAAAAAEgAg/9oACAEBAAEFAlKWP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAMAAwAAAAAAAAAAAAAAAAABESAxUf/aAAgBAQABPyFJNMiEceH/2gAMAwEAAgADAAAAEDPf/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAERIf/aAAgBAwEBPxDFQ//EABURAQEAAAAAAAAAAAAAAAAAAAAh/9oACAECAQE/EKr/xAAcEAEAAgEFAAAAAAAAAAAAAAABABEQITFxkfH/2gAIAQEAAT8Qdqs4iOx6nkYVqC1P/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;diff-AE-FUZZ30.jpg&quot;
        title=&quot;diff-AE-FUZZ30.jpg&quot;
        src=&quot;/static/4b8ef4023c25efb969e842a402405ac4/1c72d/diff-AE-FUZZ30.jpg&quot;
        srcset=&quot;/static/4b8ef4023c25efb969e842a402405ac4/a80bd/diff-AE-FUZZ30.jpg 148w,
/static/4b8ef4023c25efb969e842a402405ac4/1c91a/diff-AE-FUZZ30.jpg 295w,
/static/4b8ef4023c25efb969e842a402405ac4/1c72d/diff-AE-FUZZ30.jpg 590w,
/static/4b8ef4023c25efb969e842a402405ac4/a8a14/diff-AE-FUZZ30.jpg 885w,
/static/4b8ef4023c25efb969e842a402405ac4/fbd2c/diff-AE-FUZZ30.jpg 1180w,
/static/4b8ef4023c25efb969e842a402405ac4/eea4a/diff-AE-FUZZ30.jpg 1280w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;用途によって適切な設定は異なると思いますが、ものの移動や場所の切り替えについては検出できていそうな画像が出力されていることが分かるかと思います。&lt;/p&gt;
&lt;p&gt;試しに同じ動画内でシーンが切り替わった画像を 10% で比較してみると&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/17f1a740893546a997fc01185689c7e4/eea4a/src3.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUDBAb/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAY7CQNKJTN//xAAcEAABBAMBAAAAAAAAAAAAAAABAAIDIQQRFDL/2gAIAQEAAQUC6NJmXZntD1M0Nk//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPwFH/8QAHRAAAgEEAwAAAAAAAAAAAAAAAAECEDEykTNhof/aAAgBAQAGPwLD041stHdIrsaR/8QAGRABAQEBAQEAAAAAAAAAAAAAAREAIXGR/9oACAEBAAE/IZFPvOQQ9nSi3mi5rRzCNgb/2gAMAwEAAgADAAAAEBM//8QAFhEBAQEAAAAAAAAAAAAAAAAAAAEh/9oACAEDAQE/EIx//8QAFhEBAQEAAAAAAAAAAAAAAAAAAREA/9oACAECAQE/EExRbv/EAB0QAQACAwADAQAAAAAAAAAAAAEAESExQYGRscH/2gAIAQEAAT8Q5YN0fkyGXSA9pqEuF6KfJQq4gEsFeSB1dgOT/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;src3.jpg&quot;
        title=&quot;src3.jpg&quot;
        src=&quot;/static/17f1a740893546a997fc01185689c7e4/1c72d/src3.jpg&quot;
        srcset=&quot;/static/17f1a740893546a997fc01185689c7e4/a80bd/src3.jpg 148w,
/static/17f1a740893546a997fc01185689c7e4/1c91a/src3.jpg 295w,
/static/17f1a740893546a997fc01185689c7e4/1c72d/src3.jpg 590w,
/static/17f1a740893546a997fc01185689c7e4/a8a14/src3.jpg 885w,
/static/17f1a740893546a997fc01185689c7e4/fbd2c/src3.jpg 1180w,
/static/17f1a740893546a997fc01185689c7e4/eea4a/src3.jpg 1280w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5d3b8b4356c711faa5dcdf40518d646f/eea4a/diff-AE-FUZZ10-changed.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAv/EABYBAQEBAAAAAAAAAAAAAAAAAAIBBP/aAAwDAQACEAMQAAABRu1I3RDiP//EABkQAAIDAQAAAAAAAAAAAAAAAAACAREhMf/aAAgBAQABBQIvLGiIG6ur/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAEDERL/2gAIAQMBAT8BUtmz/8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bh//EABkQAAEFAAAAAAAAAAAAAAAAABAAARESMf/aAAgBAQAGPwLFFS4//8QAGhAAAwADAQAAAAAAAAAAAAAAAAEREEFRIf/aAAgBAQABPyFeiLRb3eDypKnHodop/9oADAMBAAIAAwAAABAz3//EABcRAQEBAQAAAAAAAAAAAAAAABEAATH/2gAIAQMBAT8Q6S0aF//EABYRAQEBAAAAAAAAAAAAAAAAAAARIf/aAAgBAgEBPxDCP//EABwQAQEAAgIDAAAAAAAAAAAAAAERACExUWGBkf/aAAgBAQABPxBVBL1l4Rdux6yOn5kjwdIcYBRFHueHHB144z//2Q==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;diff-AE-FUZZ10-changed.jpg&quot;
        title=&quot;diff-AE-FUZZ10-changed.jpg&quot;
        src=&quot;/static/5d3b8b4356c711faa5dcdf40518d646f/1c72d/diff-AE-FUZZ10-changed.jpg&quot;
        srcset=&quot;/static/5d3b8b4356c711faa5dcdf40518d646f/a80bd/diff-AE-FUZZ10-changed.jpg 148w,
/static/5d3b8b4356c711faa5dcdf40518d646f/1c91a/diff-AE-FUZZ10-changed.jpg 295w,
/static/5d3b8b4356c711faa5dcdf40518d646f/1c72d/diff-AE-FUZZ10-changed.jpg 590w,
/static/5d3b8b4356c711faa5dcdf40518d646f/a8a14/diff-AE-FUZZ10-changed.jpg 885w,
/static/5d3b8b4356c711faa5dcdf40518d646f/fbd2c/diff-AE-FUZZ10-changed.jpg 1180w,
/static/5d3b8b4356c711faa5dcdf40518d646f/eea4a/diff-AE-FUZZ10-changed.jpg 1280w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このように大きく変化していることがわかります。&lt;/p&gt;
&lt;h2&gt;変化率の抽出&lt;/h2&gt;
&lt;p&gt;差分画像が出力されるので画像から解析しても良いのですが、 &lt;code class=&quot;language-text&quot;&gt;compare&lt;/code&gt; コマンドでは差分が生じる場合には標準エラー出力に差分を示す数値が出力されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;AE&lt;/code&gt; の場合は変化したピクセル数が出力されるので、全体の解像度と比較してどのくらいの割合が変化したかを算出することができます。&lt;/p&gt;
&lt;p&gt;先ほどの &lt;code class=&quot;language-text&quot;&gt;-fuzz 30%&lt;/code&gt; 指定の場合では&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell-session&quot;&gt;&lt;pre class=&quot;language-shell-session&quot;&gt;&lt;code class=&quot;language-shell-session&quot;&gt;&lt;span class=&quot;token command&quot;&gt;&lt;span class=&quot;token shell-symbol important&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;token bash language-bash&quot;&gt;compare -metric AE -fuzz &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;% output/0000.jpg output/0001.jpg /dev/null&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token output&quot;&gt;18743&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;サムネイルサイズが &lt;code class=&quot;language-text&quot;&gt;1280x720&lt;/code&gt; だったので&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;18743 / (1280*720) = 0.020337457&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;で 2% くらいの変化率ですね。&lt;/p&gt;
&lt;p&gt;このサムネイルの変化率が設定した閾値を超えた場合にシーン変更として扱うことでシーン検出を実現できるかと思います。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;ImageMagick も FFmpeg もオプションが豊富すぎてとっつきにくい印象がどうしてもありますが、コマンドで一括処理できるのが非常に捗るので熟達していきたいものです。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Docker in Docker で Go 製のバイナリを持った軽量な Docker イメージを作る]]></title><description><![CDATA[go getで取得したcliツールのバイナリを持った軽量なDockerイメージをつくる - tehepero note(・ω<) を読んで、別解として Docker in Docker で作れないかなーと思ってやってみました。]]></description><link>https://hori-ryota.com/blog/2017-02-24-create-docker-image-with-gobin-in-alpine/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-02-24-create-docker-image-with-gobin-in-alpine/</guid><pubDate>Fri, 24 Feb 2017 14:30:55 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;http://blog.stormcat.io/post/entry/go-binary-alpine&quot;&gt;go getで取得したcliツールのバイナリを持った軽量なDockerイメージをつくる - tehepero note(・ω&amp;#x3C;)&lt;/a&gt; を読んで、別解として Docker in Docker で作れないかなーと思ってやってみました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;やりたいこと&lt;/h2&gt;
&lt;p&gt;根本的な動機は元記事をご参照ください。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://blog.stormcat.io/post/entry/go-binary-alpine&quot;&gt;go getで取得したcliツールのバイナリを持った軽量なDockerイメージをつくる - tehepero note(・ω&amp;#x3C;)&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;元記事では Alpine ベースの golang イメージで &lt;code class=&quot;language-text&quot;&gt;go get&lt;/code&gt; したバイナリを &lt;code class=&quot;language-text&quot;&gt;docker cp&lt;/code&gt; で取得し、実行用のイメージを作成するフローを CircleCI で実行しています。&lt;/p&gt;
&lt;p&gt;この記事では CI を用いずに Docker in Docker なビルド用のイメージを用いることでコンテナ内で &lt;code class=&quot;language-text&quot;&gt;go get&lt;/code&gt; から &lt;code class=&quot;language-text&quot;&gt;docker build&lt;/code&gt; まで済ませてみようかと思います。&lt;/p&gt;
&lt;p&gt;なお、 &lt;code class=&quot;language-text&quot;&gt;docker push&lt;/code&gt; せずに成果物のイメージを取り出したかったので、今回は Docker のデーモンを起動せずにホストの &lt;code class=&quot;language-text&quot;&gt;/var/run/docker.sock&lt;/code&gt; をコンテナと共有します。&lt;/p&gt;
&lt;h2&gt;実行用のイメージ&lt;/h2&gt;
&lt;p&gt;先に実行用イメージ作成の構成を説明したほうがわかりやすいので、ビルド用イメージの解説の前にぺろっと紹介。&lt;/p&gt;
&lt;p&gt;ディレクトリ構成はこんな感じです。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;directory-structure&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Dockerfile
pre.sh*&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;pre.sh&lt;/code&gt; で下準備をして、 &lt;code class=&quot;language-text&quot;&gt;Dockerfile&lt;/code&gt; を &lt;code class=&quot;language-text&quot;&gt;docker build&lt;/code&gt; する想定です。&lt;/p&gt;
&lt;p&gt;今回は &lt;code class=&quot;language-text&quot;&gt;goose&lt;/code&gt; のバイナリを入れたいので、下準備は &lt;code class=&quot;language-text&quot;&gt;go get&lt;/code&gt; です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;pre.sh&lt;/code&gt; は以下。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;pre.sh&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;#/bin/bash&lt;/span&gt;

go get -v bitbucket.org/liamstask/goose/cmd/goose
&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$GOPATH&lt;/span&gt;/bin/goose ./goose&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;goose&lt;/code&gt; のバイナリがカレントディレクトリに配置されます。&lt;/p&gt;
&lt;p&gt;Dockerfile はバイナリをコピーするだけ。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;Dockerfile&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; alpine&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;3.5

&lt;span class=&quot;token keyword&quot;&gt;COPY&lt;/span&gt; ./goose /usr/local/bin/

&lt;span class=&quot;token keyword&quot;&gt;ENTRYPOINT&lt;/span&gt; goose&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この実行用のイメージのビルドを Alpine ベースの Docker コンテナ内で実行するのが目標です。&lt;/p&gt;
&lt;h2&gt;ビルド用のイメージ&lt;/h2&gt;
&lt;p&gt;Docker のイメージ作成は依存系の解決と実行用のアレコレ配置を別イメージにするのが好きなので、二段階でやります。&lt;/p&gt;
&lt;p&gt;（ CI 等、キャッシュがない環境で依存系のビルドが何度も走るとしんどいという理由）&lt;/p&gt;
&lt;h3&gt;Docker in Docker with golang のイメージ&lt;/h3&gt;
&lt;p&gt;下準備で Docker と golang の入った Docker イメージを用意します。&lt;/p&gt;
&lt;p&gt;今回はバージョンにこだわらずに Docker のベースイメージに &lt;code class=&quot;language-text&quot;&gt;apk&lt;/code&gt; で取れる &lt;code class=&quot;language-text&quot;&gt;go&lt;/code&gt; を入れます。（記事作成時点では &lt;code class=&quot;language-text&quot;&gt;1.7.3&lt;/code&gt; でした）&lt;/p&gt;
&lt;p&gt;もし最新バージョンの golang を入れたい場合は golang の公式イメージの Dockerfile を参考にするのがいいかと。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;Dockerfile&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; docker

&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; \
      apk &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;no&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;update add \
      build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;base \
      git \
      go \
      &amp;amp;&amp;amp; \
      mkdir /go

&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; GOPATH /go
&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; PATH $PATH&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;$GOPATH/bin&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こちらを&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;docker build -t horiryota/docker-golang &lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;として下準備。&lt;/p&gt;
&lt;h3&gt;ビルド用のイメージ&lt;/h3&gt;
&lt;p&gt;本題です。&lt;/p&gt;
&lt;p&gt;ビルド用イメージ作成用のディレクトリはこんな感じです。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;directory-structure-for-build-image&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;build.sh*
Dockerfile
usage.sh*&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;核となる &lt;code class=&quot;language-text&quot;&gt;build.sh&lt;/code&gt; は&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;build.sh&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;#/bin/bash&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;srcDir&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;/srcDir&apos;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; -z &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$IMAGE_NAME&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&lt;span class=&quot;token variable&quot;&gt;$IMAGE_NAME&lt;/span&gt; unbound&apos;&lt;/span&gt;
  usage.sh
  &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; -d &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${srcDir}&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;srcDir not found&apos;&lt;/span&gt;
  usage.sh
  &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; -r &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${srcDir}&lt;/span&gt;/Dockerfile&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Dockerfile not found&apos;&lt;/span&gt;
  usage.sh
  &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; -r &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${srcDir}&lt;/span&gt;/pre.sh&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pre.sh not found&apos;&lt;/span&gt;
  usage.sh
  &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; -R /srcDir/* ./

./pre.sh &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  docker build -t &lt;span class=&quot;token variable&quot;&gt;$IMAGE_NAME&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;です。&lt;/p&gt;
&lt;p&gt;つらつら書いている &lt;code class=&quot;language-text&quot;&gt;if&lt;/code&gt; 文は必要なものが存在するかのチェックです。&lt;/p&gt;
&lt;p&gt;最終的にはビルド用イメージを &lt;code class=&quot;language-text&quot;&gt;doker run&lt;/code&gt; する際に &lt;code class=&quot;language-text&quot;&gt;/srcDir&lt;/code&gt; に &lt;code class=&quot;language-text&quot;&gt;Dockerfile&lt;/code&gt; と &lt;code class=&quot;language-text&quot;&gt;pre.sh&lt;/code&gt; の入ったディレクトリをマウントすることで、 &lt;code class=&quot;language-text&quot;&gt;pre.sh&lt;/code&gt; を実行した後に &lt;code class=&quot;language-text&quot;&gt;docker build&lt;/code&gt; する構成です。&lt;/p&gt;
&lt;p&gt;mount する &lt;code class=&quot;language-text&quot;&gt;/srcDir&lt;/code&gt; を荒らさないよう、ファイルは &lt;code class=&quot;language-text&quot;&gt;./&lt;/code&gt; にコピーしています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;usage.sh&lt;/code&gt; はイメージの使い方が出力されるだけのスクリプトなので割愛。&lt;/p&gt;
&lt;p&gt;Dockerfile は以下です。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;Dockerfile&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; horiryota/docker&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;golang

&lt;span class=&quot;token keyword&quot;&gt;WORKDIR&lt;/span&gt; /workdir

&lt;span class=&quot;token keyword&quot;&gt;COPY&lt;/span&gt; usage.sh /usr/local/bin/
&lt;span class=&quot;token keyword&quot;&gt;COPY&lt;/span&gt; build.sh /usr/local/bin/

&lt;span class=&quot;token keyword&quot;&gt;ENTRYPOINT&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;build.sh&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;build.sh&lt;/code&gt; を発火するだけです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;WORKDIR /workdir&lt;/code&gt; にしているのは &lt;code class=&quot;language-text&quot;&gt;/&lt;/code&gt; ディレクトリにある Dockerfile で &lt;code class=&quot;language-text&quot;&gt;docker build&lt;/code&gt; をしようとすると権限問題で失敗するためです。&lt;/p&gt;
&lt;p&gt;ビルド用イメージのビルドをして準備完了です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;docker build -t horiryota/docker-golang-builder &lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;作成実行&lt;/h2&gt;
&lt;p&gt;実行コマンドはこんな感じ。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;docker run --privileged -v /var/run/docker.sock:/var/run/docker.sock -v &lt;span class=&quot;token variable&quot;&gt;$DOCKERFILE_DIR&lt;/span&gt;:/srcDir:ro -e &lt;span class=&quot;token assign-left variable&quot;&gt;IMAGE_NAME&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$IMAGE_NAME&lt;/span&gt; horiryota/docker-golang-builder&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回は &lt;code class=&quot;language-text&quot;&gt;/var/run/docker.sock&lt;/code&gt; を mount したのでホストの docker にイメージが生成されます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;$DOCKERFILE_DIR&lt;/code&gt; 実行用イメージ作成用のファイルがあるディレクトリ。カレントディレクトリであれば &lt;code class=&quot;language-text&quot;&gt;$(pwd)&lt;/code&gt; でできるかなと&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;$IMAGE_NAME&lt;/code&gt; 作成したいイメージ名。 &lt;code class=&quot;language-text&quot;&gt;build.sh&lt;/code&gt; の &lt;code class=&quot;language-text&quot;&gt;docker build -t $IMAGE_NAME&lt;/code&gt; で使うのでお好きに。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ちなみに &lt;code class=&quot;language-text&quot;&gt;/srcDir&lt;/code&gt; の mount で後ろについている &lt;code class=&quot;language-text&quot;&gt;:ro&lt;/code&gt; は read only の意味です。ホストのディレクトリを不用意に荒らさないで済むので付けておくことを推奨します。&lt;/p&gt;
&lt;p&gt;ということで、カレントディレクトリで &lt;code class=&quot;language-text&quot;&gt;horiryota/docker-goose&lt;/code&gt; のイメージを作成するならこんな感じでしょうか。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;docker run --privileged -v /var/run/docker.sock:/var/run/docker.sock -v &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;:/srcDir:ro -e &lt;span class=&quot;token assign-left variable&quot;&gt;IMAGE_NAME&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;horiryota/docker-goose horiryota/docker-golang-builder&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;生成イメージの確認&lt;/h2&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;REPOSITORY              TAG     IMAGE ID      CREATED            SIZE
horiryota/docker-goose  latest  fa633023a994  About an hour ago  17.4 MB&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;諸々のバージョンが違うので同じにはなりませんでしたが、およそ元記事と同じくらいのイメージサイズになったことが確認できました。&lt;/p&gt;
&lt;h2&gt;今回のコード&lt;/h2&gt;
&lt;p&gt;使ったコードを公開しておきます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/hori-ryota/docker-golang&quot;&gt;hori-ryota/docker-golang&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/hori-ryota/docker-golang-bulider&quot;&gt;hori-ryota/docker-golang-bulider&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/hori-ryota/goose-docker&quot;&gt;hori-ryota/goose-docker&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;Docker のコンテナ内で &lt;code class=&quot;language-text&quot;&gt;docker build&lt;/code&gt; することで &lt;code class=&quot;language-text&quot;&gt;Alpine&lt;/code&gt; ベースの軽量イメージが作成できました。&lt;/p&gt;
&lt;p&gt;Docker in Docker で準備用のスクリプトと Dockerfile を実行するのが主旨なので、 golang のバイナリ用以外にも汎用的にビルドに使えるようにできたんじゃないかなーと思っています。&lt;/p&gt;
&lt;p&gt;ちなみに Docker ベースのイメージを使わなくともホストの &lt;code class=&quot;language-text&quot;&gt;/usr/bin/docker&lt;/code&gt; をコンテナに mount するという手もあるようですが荒業感が強すぎるので止めました（ Docker for Mac だと &lt;code class=&quot;language-text&quot;&gt;/usr&lt;/code&gt; 以下を mount しようとすると怒られる模様）。&lt;/p&gt;
&lt;p&gt;コンテナ内で Docker のデーモンを立ち上げれば &lt;code class=&quot;language-text&quot;&gt;/var/run/docker.sock&lt;/code&gt; を mount しなくても &lt;code class=&quot;language-text&quot;&gt;docker push&lt;/code&gt; までコンテナ内で完結できるはずなので、必要にかられたら試してみます。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[golang で汎用的な任意数のオプションを取るメソッドの作り方]]></title><description><![CDATA[grpc の DialOption のオプション設定方法が上手いなーと感心したのですが、初見で理解するのが難しかったので備忘録がてら解説してみます。]]></description><link>https://hori-ryota.com/blog/2017-02-21-golang-highly-versatile-method-with-arbitary-options/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-02-21-golang-highly-versatile-method-with-arbitary-options/</guid><pubDate>Tue, 21 Feb 2017 12:35:47 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://godoc.org/google.golang.org/grpc#DialOption&quot;&gt;grpc の DialOption&lt;/a&gt; のオプション設定方法が上手いなーと感心したのですが、初見で理解するのが難しかったので備忘録がてら解説してみます。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;やりたいこと&lt;/h2&gt;
&lt;p&gt;golang にはオーバーロード（同名メソッドでも引数によって呼び出されるメソッドが変わるやつ）がないので、任意のオプションを取るメソッドを作るのに工夫が必要です。&lt;/p&gt;
&lt;p&gt;可変引数の仕組みはあるので任意数の値をメソッドに渡したり、オプション用の struct を引数に取ることで実装できなくはないのですがデメリットがあります（後述）。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://godoc.org/google.golang.org/grpc#DialOption&quot;&gt;DialOption&lt;/a&gt; がそのへんの葛藤を上手いこと解決していたのでご紹介。&lt;/p&gt;
&lt;h2&gt;ダメだった例&lt;/h2&gt;
&lt;p&gt;はじめに検討したのですがよろしく無かった例です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;可変引数でオプションを渡す&lt;/li&gt;
&lt;li&gt;オプション用の struct を渡す&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;可変引数でオプションを渡す&lt;/h3&gt;
&lt;p&gt;golang では可変引数の仕組みがあるので、任意数のオプションを渡すこと自体はできます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://golang.org/ref/spec#Passing_arguments_to_..._parameters&quot;&gt;The Go Programming Language Specification - The Go Programming Language&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ただ、この場合はオプションとして取れる型が一種類になってしまうので &lt;code class=&quot;language-text&quot;&gt;interface{}&lt;/code&gt; 型を使うことになるかと思います。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arg1 &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; options &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この場合、各 option が何を意味しているか判定するには型判定が必要になります。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; TimeoutOpt time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Duration
&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; BarOpt     &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; fooOptions &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    timeout time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Duration
    bar     &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arg1 &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; opts &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    opt &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; fooOptions&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; options &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; TimeoutOpt&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
                opt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timeout &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; BarOpt&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
                opt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bar &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;token comment&quot;&gt;// unknown option&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// use opt&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;baz&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;TimeoutOpt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Second&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;BarOpt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;qux&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;気になる点は以下です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;interface{}&lt;/code&gt; を使っているので未知の値が入ってくる可能性がある&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;case&lt;/code&gt; に全オプションの処理を書くので漏れが生じそう&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;どちらのデメリットも option 用に interface を定義したり、テストを書くことによって防げないこともないのはもちろんですが、 DialOption のほうが綺麗に書けました。&lt;/p&gt;
&lt;h3&gt;オプション用の struct を渡す&lt;/h3&gt;
&lt;p&gt;引数に struct を取るパターンです。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; FooOptions &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    Timeout time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Duration
    Bar     &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arg1 &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; opt fooOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// use opt&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;baz&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FooOptions&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        Timeout&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Second&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        BarOpt&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;  &lt;span class=&quot;token string&quot;&gt;&quot;qux&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンプルでいいのですが、 option が不要な場合に空の struct （ポインタなら &lt;code class=&quot;language-text&quot;&gt;nil&lt;/code&gt; ）を渡すことになります。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;baz&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FooOptions&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちょっとダサい。&lt;/p&gt;
&lt;h2&gt;DialOption の実装&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://godoc.org/google.golang.org/grpc#DialOption&quot;&gt;DialOption&lt;/a&gt; を参考に実装すると以下のようになります。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; fooOptions &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    timeout time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Duration
    bar     &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; FooOption &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;fooOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;WithTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timeout time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Duration&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; FooOption &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ops &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;fooOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        ops&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timeout &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timeout
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;WithBar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bar &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; FooOption &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ops &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;fooOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        ops&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bar &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; bar
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arg1 &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; options &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;FooOption&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    opt &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; fooOptions&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; options &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;opt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// use opt&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;baz&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;WithTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Second&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;WithBar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;qux&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;WithXXX&lt;/code&gt; らへんが独自定義の struct を引数をとるメソッドを返しているのでちょっとわかりづらいですが、 &lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt; を見ると型安全に任意数のオプションが取れているのが分かるかと思います。&lt;/p&gt;
&lt;p&gt;また、 &lt;code class=&quot;language-text&quot;&gt;Foo&lt;/code&gt; メソッド内も &lt;code class=&quot;language-text&quot;&gt;for&lt;/code&gt; 文で回すだけのシンプルな実装です。&lt;/p&gt;
&lt;h3&gt;オプションの型はメソッド型&lt;/h3&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; FooOption &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;fooOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この &lt;code class=&quot;language-text&quot;&gt;FooOption&lt;/code&gt; は&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ops &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;fooOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    ops&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timeout &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timeout
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;のように struct の &lt;code class=&quot;language-text&quot;&gt;fooOptions&lt;/code&gt; をポインタで受けて書き換えるメソッドの型です。メソッドなので&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arg1 &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; options &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;FooOption&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    opt &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; fooOptions&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;range&lt;/span&gt; options &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;opt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// use opt&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;の &lt;code class=&quot;language-text&quot;&gt;o(&amp;amp;opt)&lt;/code&gt; のように &lt;code class=&quot;language-text&quot;&gt;fooOptions&lt;/code&gt; のポインタを引数に取れば値を設定することができます。&lt;/p&gt;
&lt;p&gt;メソッドとして定義したオプションを可変引数としてとることで、オプションの中身が何であるかを気にせずに単純な &lt;code class=&quot;language-text&quot;&gt;for&lt;/code&gt; 文によって適用できる仕組みです。&lt;/p&gt;
&lt;h3&gt;WithXXX はクロージャを利用して関数リテラルを返す&lt;/h3&gt;
&lt;p&gt;そして肝となる &lt;code class=&quot;language-text&quot;&gt;WithXXX&lt;/code&gt; ですが、&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;WithTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timeout time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Duration&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; FooOption &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ops &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;fooOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        ops&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timeout &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timeout
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こちらは JavaScript などでよく見かけるクロージャの仕組みを利用しています。&lt;/p&gt;
&lt;p&gt;関数リテラルのスコープにある変数は関数内から参照することができるため、 &lt;code class=&quot;language-text&quot;&gt;WithTimeout(timeout time.Duration)&lt;/code&gt; の引数である &lt;code class=&quot;language-text&quot;&gt;timeout&lt;/code&gt; 値を、返却した &lt;code class=&quot;language-text&quot;&gt;FooOption&lt;/code&gt; 関数から参照することができます。&lt;/p&gt;
&lt;p&gt;つまり、&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token function&quot;&gt;WithTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Second&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;とすることで&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;main.go&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;go&quot;&gt;&lt;pre class=&quot;language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ops &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;fooOptions&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    ops&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timeout &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Second
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;と等価な関数リテラルが返却され、 &lt;code class=&quot;language-text&quot;&gt;WithTimeout(time.Second)&lt;/code&gt; の引数で渡された値を &lt;code class=&quot;language-text&quot;&gt;fooOptions&lt;/code&gt; struct に設定する &lt;code class=&quot;language-text&quot;&gt;FooOption&lt;/code&gt; メソッドが取得できます。&lt;/p&gt;
&lt;p&gt;オプションとして渡す値を関数リテラルで統一し、設定の詳細と設定値は関数リテラル内に閉じ込めることで、型安全で汎用的なオプション設定が実現できました。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;クロージャを利用した関数リテラルを返却することでオプション設定とする、という発想がなかったので非常に勉強になりました。&lt;/p&gt;
&lt;p&gt;使い所としては任意オプションが欲しくなるところ全般ですが、 &lt;a href=&quot;https://golang.org/pkg/os/exec/#Command&quot;&gt;exec.Command&lt;/a&gt; を使った外部コマンド実行のオプション設定時などに使うと便利ですね。&lt;/p&gt;
&lt;p&gt;業務で go 1.5 時代からの試行錯誤コードをリファクタリングしているところなので、また色々と気づいたことをメモしていきたいと思います。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[デジタル時計を載せた生放送を FFmpeg だけで実現する]]></title><description><![CDATA[生放送の遅延確認で現在時刻を載せた配信が欲しかったので作成。ついでに Docker Image 化もしてみました。]]></description><link>https://hori-ryota.com/blog/2017-02-19-ffmpeg-broadcast-with-clock/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-02-19-ffmpeg-broadcast-with-clock/</guid><pubDate>Sun, 19 Feb 2017 08:14:27 GMT</pubDate><content:encoded>&lt;p&gt;生放送の遅延確認で現在時刻を載せた配信が欲しかったので作成。ついでに Docker Image 化もしてみました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;経緯&lt;/h2&gt;
&lt;p&gt;担当している某生放送サービスにて、遅延の確認や開発のために流しっぱなしの時刻つき配信が欲しかったので整備してみました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://obsproject.com/&quot;&gt;OBS&lt;/a&gt; に時計を表示させれば簡単だったのですが、パブリックドメインで軽量な時計ツールが意外と無かったのと、実 PC での配信だとスケールしづらい上に何かとめんどくさいので Docker 化して自動配信にしたかったのが動機です。&lt;/p&gt;
&lt;p&gt;最終的にはこんな感じで動画上に時計を表示させることに成功。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0fbf24a2369cb746988443e44ee9d863/e38a4/result.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAADIUlEQVQozx2Qb0zUdRzHf0/dbBp25/3uuPvd7+53v/tHSGG1lFwPfNDaanPLntQDhz5wJTXbOS2mUiyKjP6otSKmI0zQ8Ai0c5xwHKcCcUiHiJBcgOQZKmR/SC3z++orD95777PP9n6/9lY2fBwV68o/5+XI+yJS8SnbPqrnxco61ld8yQuRaja9VU3VB/s5frSRZPw4nxw5Se2pfhqS56hL/EjjmWFafhgVscFLJIayQinbc5ANkUpRunUnkXdqeKNqL1u2v01ZpJzK8u0c2PcezQdqGOppJX22nROd3fQPDXHl8hjpn6ZIjUzSf2mazMRVcXHqV5SqaErsboyz61BM7GpqZ3dTnOq6w9TXfUFH82f0xg8ykDxENnOC0Qu9jGRSDA6nOX9hgMvZQXIzU+RmZ8WV2Tmu3/xNKPXxTho6u2hMdNGUTBFNddN6NkV7V4xUxxEG+loZHelkPNvHWLaf8Ylz/JK7yPTMBDPXJ/n71jVu/XOT+Tu/c/vfv1C6u5o5nYrSczpKureFzEALw5k2SfM942MxJrNxpqcSXM2lmLvRx59/nGd+fow7t3/m7n857t6b4Z64huAGMIfyaulGXtlYymubNxEp28yOrVvYua2Mijdf58OqHezdU07tvgq+/updvv2mhrZj+4m11XLqZD2JjgZSycP0nDlKuu+YhPkORXeYOBwGqtNA04J4PGH8vgIMI0QwVEg4XMSKFcWsfPRxHit+gtVPrmJNSQklq6RWP8XTJWt4Zu1a1j33LC+tfx7FYnVjUd3k2TQesutYHDqq5mWZw4PF6cbq8qC6DekG+V4fLp9fegDNF5IK4/Y9jD9YJIuLKQqtRFFVTdjtbuxOt3C43Bg+L6GAiab7sElqu34/3M1Su0e6znJZ4JTBmmHiMvxoZlAGB4XXLKAw8IhQdJdOgc8vQrLZb3oJB00KwwF88ra5TJbZNaxOjeWSdonVxWKLc0FLbS6s+br8ebHaDHQ9KDx6GCWkBUSxKbENUximJHLq2PJliEPjAauTRXkOFj1oR3Xdn0RjiZxmsVW6/OUt+IKEqnpRVZ/4HzWBA57OwFTbAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;result&quot;
        title=&quot;result&quot;
        src=&quot;/static/0fbf24a2369cb746988443e44ee9d863/fcda8/result.png&quot;
        srcset=&quot;/static/0fbf24a2369cb746988443e44ee9d863/12f09/result.png 148w,
/static/0fbf24a2369cb746988443e44ee9d863/e4a3f/result.png 295w,
/static/0fbf24a2369cb746988443e44ee9d863/fcda8/result.png 590w,
/static/0fbf24a2369cb746988443e44ee9d863/efc66/result.png 885w,
/static/0fbf24a2369cb746988443e44ee9d863/c83ae/result.png 1180w,
/static/0fbf24a2369cb746988443e44ee9d863/e38a4/result.png 3642w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;時計部分は FFmpeg のフィルタで合成しているので、見た目やフォントは好きなようにカスタマイズできます。&lt;/p&gt;
&lt;h2&gt;構成&lt;/h2&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;file-list&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Dockerfile
NotoSans-Bold.ttf
src.mp4
start.sh*&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Font と MP4 はライセンス的に問題ないものを拝借。&lt;/p&gt;
&lt;h2&gt;スクリプト&lt;/h2&gt;
&lt;h3&gt;start.sh&lt;/h3&gt;
&lt;p&gt;Dockerfile の &lt;code class=&quot;language-text&quot;&gt;ENTRYPOINT&lt;/code&gt; に直接コマンドを書くとややこしくなるのと、スクリプトを直接叩いてデバッグしたかったので実行コマンドを別スクリプトにしました。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;start.sh&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;

ffmpeg -re -stream_loop -1 -i &lt;span class=&quot;token string&quot;&gt;&apos;src.mp4&apos;&lt;/span&gt; -vf &lt;span class=&quot;token string&quot;&gt;&quot;drawtext=fontfile=./NotoSans-Bold.ttf: text=&apos;%{localtime\:%F%n%n%T}&apos;: fontcolor=black@0.8:fontsize=64: x=32: y=32&quot;&lt;/span&gt; -vcodec libx264 -x264-params &lt;span class=&quot;token assign-left variable&quot;&gt;keyint&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt; -acodec aac -f flv &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${TARGET_RTMP_URL}&lt;/span&gt;&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;FFmpeg での配信コマンドについては以下の記事でも紹介してあります。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.cyberagent.co.jp/blog/archives/1689/&quot;&gt;テスト用の自動配信環境をDockerとFFmpegで構築してみる | CyberAgent Developers Blog | サイバーエージェント デベロッパーズブログ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ざっくりオプションの説明をすると、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-re&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;入力動画のフレームレート速度でファイルを読み込むオプション&lt;/li&gt;
&lt;li&gt;つけない場合はエンコードで処理できるスピードをそのまま出力スピードに使ってしまうので、たとえば2倍速でエンコードできる場合、配信が2倍速の動画になってしまう&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-stream_loop 1&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;入力ソースを無限ループさせるオプション&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-i &amp;#39;src.mp4&amp;#39;&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;入力ソースの指定&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-vf&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ビデオフィルタ&lt;/li&gt;
&lt;li&gt;複数のフィルタを &lt;code class=&quot;language-text&quot;&gt;:&lt;/code&gt; 区切りで指定できる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;drawtext=fontfile=./NotoSans-Bold.ttf&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;フォントファイルの指定&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;text=&amp;#39;%{localtime\:%F%n%n%T}&amp;#39;&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;今回の肝になる時計部分。&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;strtime&lt;/code&gt; のフォーマットで指定できる。&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;%F&lt;/code&gt; : ハイフン区切りの年月日&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;%n&lt;/code&gt; : 改行&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;%T&lt;/code&gt; : &lt;code class=&quot;language-text&quot;&gt;:&lt;/code&gt; 区切りの時分秒&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;fontcolor=black@0.8&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;字の色&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;@0.8&lt;/code&gt; はアルファ値（透過）。 1 が透過なし。 0 が透明。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;fontsize=64&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;フォントサイズ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;x=32&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;表示位置（横）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;y=32&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;表示位置（縦）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-vcodec libx264 -x264-params keyint=30&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ビデオコーデックの指定&lt;/li&gt;
&lt;li&gt;今回は配信サービスの都合上、 &lt;code class=&quot;language-text&quot;&gt;H264&lt;/code&gt; で &lt;code class=&quot;language-text&quot;&gt;Keyframe Interval&lt;/code&gt; を &lt;code class=&quot;language-text&quot;&gt;30&lt;/code&gt; にした。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-acodec aac&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;音声コーデックを &lt;code class=&quot;language-text&quot;&gt;AAC&lt;/code&gt; にした&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-f flv&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;出力フォーマットの指定&lt;/li&gt;
&lt;li&gt;今回は &lt;code class=&quot;language-text&quot;&gt;RTMP&lt;/code&gt; での配信をするため &lt;code class=&quot;language-text&quot;&gt;flv&lt;/code&gt; 指定&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;&amp;quot;${TARGET_RTMP_URL}&amp;quot;&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;出力先の指定&lt;/li&gt;
&lt;li&gt;今回は変数にしたので、配信サービスの &lt;code class=&quot;language-text&quot;&gt;RTMP&lt;/code&gt; 出力先 URL を指定する&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;rtmp://hogehoge.com/hogehoge:1935&lt;/code&gt; みたいな&lt;/li&gt;
&lt;li&gt;Docker 化した場合は &lt;code class=&quot;language-text&quot;&gt;-e&lt;/code&gt; オプションで &lt;code class=&quot;language-text&quot;&gt;-e &amp;#39;TARGET_RTMP_URL=rtmp://hogehoge.com/hogehoge:1935&amp;#39;&lt;/code&gt; で指定できる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Dockerfile&lt;/h3&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;Dockerfile&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; horiryota/ffmpeg

&lt;span class=&quot;token keyword&quot;&gt;COPY&lt;/span&gt; src.mp4 ./
&lt;span class=&quot;token keyword&quot;&gt;COPY&lt;/span&gt; start.sh ./
&lt;span class=&quot;token keyword&quot;&gt;COPY&lt;/span&gt; NotoSans&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Bold.ttf ./

&lt;span class=&quot;token keyword&quot;&gt;ENTRYPOINT&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/bin/sh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./start.sh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Dockerfile は COPY して &lt;code class=&quot;language-text&quot;&gt;start.sh&lt;/code&gt; を叩くだけです。&lt;/p&gt;
&lt;p&gt;ちなみに FFmpeg の Docker Image は &lt;a href=&quot;https://hub.docker.com/r/jrottenberg/ffmpeg/&quot;&gt;jrottenberg/ffmpeg&lt;/a&gt; をお借りしようと思いましたが、時計を表示するための &lt;code class=&quot;language-text&quot;&gt;drawtext&lt;/code&gt; フィルタを使うのに必要なビルドオプション &lt;code class=&quot;language-text&quot;&gt;--enable-libfreetype&lt;/code&gt; が設定されていなかったので自分で用意。&lt;/p&gt;
&lt;p&gt;FFmpeg の Dockerfile は以下。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;Dockerfile&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; gliderlabs/alpine&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;3.4

&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; TZ=&lt;span class=&quot;token string&quot;&gt;&quot;JST-9&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; FFMPEG_VERSION=3.2.4

&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; \ 
      apk update &amp;amp;&amp;amp; \

      apk add &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;no&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache \
      freetype&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;dev \
      openssl&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;dev \
      rtmpdump&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;dev \
      x264&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;dev \
      yasm&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;dev \
      zlib&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;dev \
      &amp;amp;&amp;amp; \

      apk add &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;no&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;virtual=build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;dependencies \
      build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;base \
      curl \
      nasm \
      tar \
      bzip2 \
      &amp;amp;&amp;amp; \

      DIR=$(mktemp &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;d) &amp;amp;&amp;amp; cd $&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;DIR&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &amp;amp;&amp;amp; \

      wget http&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//ffmpeg.org/releases/ffmpeg&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;FFMPEG_VERSION&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;.tar.gz &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;O &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt; tar zxvf &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;C . &amp;amp;&amp;amp; \
      cd ffmpeg&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;FFMPEG_VERSION&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &amp;amp;&amp;amp; \
      ./configure \

      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;enable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;gpl \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;enable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;version3 \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;enable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;nonfree \

      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;enable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;small \

      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;disable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ffplay \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;disable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ffserver \

      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;disable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;doc \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;disable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;htmlpages \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;disable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;manpages \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;disable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;podpages \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;disable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;txtpages \

      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;enable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;libx264 \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;enable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;postproc \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;enable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;avresample \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;enable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;libfreetype \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;enable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;openssl \
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;disable&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;debug \
      &amp;amp;&amp;amp; \

      make &amp;amp;&amp;amp; \
      make install &amp;amp;&amp;amp; \
      make distclean &amp;amp;&amp;amp; \

      rm &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;rf $&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;DIR&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &amp;amp;&amp;amp; \
      apk del build&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;dependencies &amp;amp;&amp;amp; \
      rm &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;rf /var/cache/apk/*&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;使い方&lt;/h2&gt;
&lt;p&gt;Doker Image なので以下のようなコマンドで配信できるはず。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;docker run -e &lt;span class=&quot;token string&quot;&gt;&apos;TARGET_RTMP_URL=rtmp://hogehoge.com/hogehoge:1935&apos;&lt;/span&gt; horiryota/auto-broadcast&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;とりあえず配信しっぱなしにはできたので、 CPU などのリソース表示や fps 、 bitrate などの配信状態表示にも挑戦してみたいところ。&lt;/p&gt;
&lt;p&gt;FFmpeg はオプションが多くて全然把握しきれないので、覚えたものからメモっていきたい。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CSV を SQL で扱える 'q' を使って数値データのランク分け芸]]></title><description><![CDATA[大量の CSV ファイルを処理する必要にかられて見つけた q が便利すぎたので SQL の CASE 文と合わせてランク分類をして遊んでみました。]]></description><link>https://hori-ryota.com/blog/2017-02-03-qulassification-csv-with-q/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-02-03-qulassification-csv-with-q/</guid><pubDate>Fri, 03 Feb 2017 14:44:34 GMT</pubDate><content:encoded>&lt;p&gt;大量の CSV ファイルを処理する必要にかられて見つけた &lt;a href=&quot;http://harelba.github.io/q/&quot;&gt;q&lt;/a&gt; が便利すぎたので SQL の CASE 文と合わせてランク分類をして遊んでみました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;q とは&lt;/h2&gt;
&lt;p&gt;CSV を SQL で処理できるコマンドラインツールです。 CSV だけでなくタブ区切りの TSV にも対応しているとのこと。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://harelba.github.io/q/&quot;&gt;Run SQL directly on CSV files | Text as Data | q&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;使い方&lt;/h3&gt;
&lt;p&gt;公式のヘルプに書いてあるとおりではありますが、引数に SQL とファイルを取れば結果が標準出力に出力できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;q &lt;span class=&quot;token string&quot;&gt;&quot;SELECT * FROM file.csv&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-H&lt;/code&gt; オプションでヘッダの有無を選べたり、 &lt;code class=&quot;language-text&quot;&gt;-d&lt;/code&gt; オプションで区切り文字を選べたり、割りと小回りがきく印象。&lt;/p&gt;
&lt;p&gt;ヘルプも各オプションの説明が丁寧に書いてあって使いやすい。&lt;/p&gt;
&lt;h2&gt;今回やったこと&lt;/h2&gt;
&lt;p&gt;某プロジェクトにて、とあるところから出力された独自形式の （エクセルの）xlsxファイルにあるデータを条件によってランク分けをしたいとのこと。&lt;/p&gt;
&lt;p&gt;q は SQL の CASE 文にも対応しているので楽勝です。&lt;/p&gt;
&lt;h3&gt;xlsx を CSV に変換&lt;/h3&gt;
&lt;p&gt;エクセルで作業する用に出力されているデータなので、元データは独自形式の xlsx ファイルでした。&lt;/p&gt;
&lt;p&gt;とりあえず xlsx を CSV に変換します。&lt;/p&gt;
&lt;p&gt;いろいろ試してまともに動かせたのはこちらのツール。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/dilshod/xlsx2csv&quot;&gt;dilshod/xlsx2csv: Convert xslx to csv, it is fast, and works for huge xlsx files&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;xlsx2csv &lt;span class=&quot;token variable&quot;&gt;$xlsx&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$csv&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;元データは扱いやすいように見た目が成形され、8行目から CSV のデータが貼り付けられている形式だったので、7行削るなど。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sed&lt;/span&gt; -i &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt; -e &lt;span class=&quot;token string&quot;&gt;&apos;1,7d&apos;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$csv&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;SQL どばー&lt;/h3&gt;
&lt;p&gt;q を使ってランク分け。 CASE が使えるの幸せですね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;q -H -d&lt;span class=&quot;token string&quot;&gt;&apos;,&apos;&lt;/span&gt; -O &lt;span class=&quot;token string&quot;&gt;&quot;select id, foo, bar, baz, 
CASE
WHEN foo &gt;= 9 AND bar &gt;= 0.8 THEN &apos;A&apos;
WHEN foo &gt;= 3 AND bar &gt;= 0.6 THEN &apos;B&apos;
WHEN foo &gt;= 1 AND bar &gt;= 0.1 THEN &apos;C&apos;
ELSE &apos;D&apos;
END as rank
from &lt;span class=&quot;token variable&quot;&gt;$csv&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$dst&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;$dst&lt;/code&gt; に出力される各行の末尾に &lt;code class=&quot;language-text&quot;&gt;rank&lt;/code&gt; が追加されます。&lt;/p&gt;
&lt;p&gt;もちろん &lt;code class=&quot;language-text&quot;&gt;SUM&lt;/code&gt; も使えるのでランクごとの集計もこんな感じで。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;q -H -d&lt;span class=&quot;token string&quot;&gt;&apos;,&apos;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;select 
SUM(CASE rank WHEN &apos;A&apos; THEN 1 ELSE 0 END) AS A,
SUM(CASE rank WHEN &apos;B&apos; THEN 1 ELSE 0 END) AS B,
SUM(CASE rank WHEN &apos;C&apos; THEN 1 ELSE 0 END) AS C,
SUM(CASE rank WHEN &apos;D&apos; THEN 1 ELSE 0 END) AS D
from &lt;span class=&quot;token variable&quot;&gt;$dst&lt;/span&gt;&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;シェル芸で大量ファイルを一括処理&lt;/h3&gt;
&lt;p&gt;各処理をコマンド化できたので、あとはスクリプト化してファイルをループ処理。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -e
&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -u

&lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; -p csv
&lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; -p dst
&lt;span class=&quot;token assign-left variable&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;result.csv
:&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$result&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;ids&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ls&lt;/span&gt; xlsx/*.xlsx &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;s;^.*/;;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;s;.xlsx;;&apos;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;${ids&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;@&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$id&lt;/span&gt;
  &lt;span class=&quot;token assign-left variable&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xlsx/&lt;span class=&quot;token variable&quot;&gt;$id&lt;/span&gt;.xlsx
  &lt;span class=&quot;token assign-left variable&quot;&gt;csv&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;csv/&lt;span class=&quot;token variable&quot;&gt;$id&lt;/span&gt;.csv
  &lt;span class=&quot;token assign-left variable&quot;&gt;dst&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;dst/&lt;span class=&quot;token variable&quot;&gt;$id&lt;/span&gt;.csv

  xlsx2csv &lt;span class=&quot;token variable&quot;&gt;$src&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$csv&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;sed&lt;/span&gt; -i &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt; -e &lt;span class=&quot;token string&quot;&gt;&apos;1,5d&apos;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$csv&lt;/span&gt;

  q -H -d&lt;span class=&quot;token string&quot;&gt;&apos;,&apos;&lt;/span&gt; -O &lt;span class=&quot;token string&quot;&gt;&quot;select id, foo, bar, baz, 
  CASE
  WHEN foo &gt;= 9 AND bar &gt;= 0.8 THEN &apos;A&apos;
  WHEN foo &gt;= 3 AND bar &gt;= 0.6 THEN &apos;B&apos;
  WHEN foo &gt;= 1 AND bar &gt;= 0.1 THEN &apos;C&apos;
  ELSE &apos;D&apos;
  END as rank
  from &lt;span class=&quot;token variable&quot;&gt;$csv&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$dst&lt;/span&gt;

  &lt;span class=&quot;token assign-left variable&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;q -H -d&lt;span class=&quot;token string&quot;&gt;&apos;,&apos;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;select 
  SUM(CASE rank WHEN &apos;A&apos; THEN 1 ELSE 0 END) AS A,
  SUM(CASE rank WHEN &apos;B&apos; THEN 1 ELSE 0 END) AS B,
  SUM(CASE rank WHEN &apos;C&apos; THEN 1 ELSE 0 END) AS C,
  SUM(CASE rank WHEN &apos;D&apos; THEN 1 ELSE 0 END) AS D
  from &lt;span class=&quot;token variable&quot;&gt;$dst&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$sum&lt;/span&gt;

  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; -n &lt;span class=&quot;token variable&quot;&gt;${id&lt;span class=&quot;token operator&quot;&gt;##&lt;/span&gt;*_}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;tr&lt;/span&gt; -d &lt;span class=&quot;token string&quot;&gt;&apos;&lt;span class=&quot;token entity&quot; title=&quot;\n&quot;&gt;\n&lt;/span&gt;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$result&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; -n &lt;span class=&quot;token string&quot;&gt;&apos;,&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$result&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; -n &lt;span class=&quot;token variable&quot;&gt;$sum&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$result&lt;/span&gt;

  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$result&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;元データを CSV で持っていなかったり、条件を指定したデータの出力が叶わなかったりするなど、社会は厳しいことが多いので雑シェル力は大事ですね。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Hugo のサムネ作成、画像追加、画像最適化を自動化するシェル芸]]></title><description><![CDATA[CMS ではなく Markdown で記事を作成していると画像周りがどうにもダルいのでスクリプト化しました。 自分用のオレオレ処理ですが、貼っておけば何かの役に立つかもしれないので残しておきます。]]></description><link>https://hori-ryota.com/blog/2017-01-31-create-shellscript-for-hugo-images/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-01-31-create-shellscript-for-hugo-images/</guid><pubDate>Tue, 31 Jan 2017 14:17:04 GMT</pubDate><content:encoded>&lt;p&gt;CMS ではなく Markdown で記事を作成していると画像周りがどうにもダルいのでスクリプト化しました。&lt;/p&gt;
&lt;p&gt;自分用のオレオレ処理ですが、貼っておけば何かの役に立つかもしれないので残しておきます。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;準備&lt;/h2&gt;
&lt;p&gt;画像の編集をするのに &lt;a href=&quot;https://www.imagemagick.org/script/index.php&quot;&gt;ImageMagick&lt;/a&gt; が必要です。&lt;/p&gt;
&lt;p&gt;また、画像の最適化では&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/tjko/jpegoptim&quot;&gt;tjko/jpegoptim&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://pngquant.org/&quot;&gt;pngquant&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;を使っています。それぞれ Mac であれば Homebrew で入れられるかと思います。&lt;/p&gt;
&lt;h2&gt;構成&lt;/h2&gt;
&lt;p&gt;build 用のファイルなどを除くとざっくりこんな感じのディレクトリ構成で Hugo を使っています。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;hugo-files&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;▸ content/post/
▸ data/
▸ layouts/
▸ static/images/
▸ static_src/images/
▸ themes/
  addImage.sh*
  config.toml
  createBanner.sh*
  createImageWithText.sh*
  imageOptim.sh*&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;static/images/&lt;/code&gt; 以下に post の slug と同じディレクトリを作成し、その中に記事の画像をまとめて入れています。&lt;/p&gt;
&lt;p&gt;画像は圧縮などの最適化を行ってから使用するので、元データは &lt;code class=&quot;language-text&quot;&gt;static_src/images/&lt;/code&gt; にバックアップしています。&lt;/p&gt;
&lt;h2&gt;スクリプト&lt;/h2&gt;
&lt;p&gt;スクリプトは以下の4つを使用しています。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;scripts&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;addImage.sh
createBanner.sh
createImageWithText.sh
imageOptim.sh&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;&lt;code class=&quot;language-text&quot;&gt;createImageWithText.sh&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;createImageWithText.sh&lt;/code&gt; は以前作った画像の上に黒帯背景で白文字を描画するためのスクリプトです。&lt;/p&gt;
&lt;p&gt;サムネイルで楽をするために使っています。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/create-blackband-image&quot;&gt;ImageMagick で黒帯背景に白文字を載せた画像を生成するシェル芸&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;&lt;code class=&quot;language-text&quot;&gt;addImage.sh&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;addImage.sh&lt;/code&gt; は画像を Hugo の構成内に追加するときに叩くスクリプトです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;addImage.sh src title name&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;のフォーマットで、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;src&lt;/code&gt; : 元画像&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;title&lt;/code&gt; : Hugo の slug&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;name&lt;/code&gt; : 画像の名前（拡張子は不要）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;src&lt;/code&gt; に指定した画像を &lt;code class=&quot;language-text&quot;&gt;static/images/&lt;/code&gt; &lt;code class=&quot;language-text&quot;&gt;static_src/images/&lt;/code&gt; に入れた上で、 &lt;code class=&quot;language-text&quot;&gt;static/images/&lt;/code&gt; の方には最適化を行います。&lt;/p&gt;
&lt;p&gt;なお、 blog に吐いたデータだけでなく作成用のリポジトリ自体も GitHub に上げているので、 &lt;code class=&quot;language-text&quot;&gt;static_src/images/&lt;/code&gt; に入れるバックアップ用の画像も &lt;code class=&quot;language-text&quot;&gt;convert&lt;/code&gt; の &lt;code class=&quot;language-text&quot;&gt;-strip&lt;/code&gt; オプションで Exif 情報を削っています。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;addImage.sh&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -e
&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -u

&lt;span class=&quot;token assign-left variable&quot;&gt;usage&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Usage: addImage.sh src title name&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$#&lt;/span&gt; -eq &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$usage&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$2&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$3&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;ext&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${src&lt;span class=&quot;token operator&quot;&gt;##&lt;/span&gt;*.}&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;dstDir&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;static/images/&lt;span class=&quot;token variable&quot;&gt;${title}&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;dst&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${dstDir}&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;${name}&lt;/span&gt;.&lt;span class=&quot;token variable&quot;&gt;${ext}&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;backupDir&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;static_src/images/&lt;span class=&quot;token variable&quot;&gt;${title}&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;backup&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${backupDir}&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;${name}&lt;/span&gt;.&lt;span class=&quot;token variable&quot;&gt;${ext}&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; -p &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dstDir&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; -p &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$backupDir&lt;/span&gt;&quot;&lt;/span&gt;

convert &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$src&lt;/span&gt;&quot;&lt;/span&gt; -strip &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$backup&lt;/span&gt;&quot;&lt;/span&gt;
convert &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$src&lt;/span&gt;&quot;&lt;/span&gt; -strip &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dst&lt;/span&gt;&quot;&lt;/span&gt;

./imageOptim.sh &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dst&lt;/span&gt;&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;本当は引数ではなくオプションを取るようにしたほうが汎用性が高いのですが、自分でゴリゴリ使う用なので及第点としています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cp&lt;/code&gt; ではなく &lt;code class=&quot;language-text&quot;&gt;-strip&lt;/code&gt; 付きの &lt;code class=&quot;language-text&quot;&gt;convert&lt;/code&gt; で &lt;code class=&quot;language-text&quot;&gt;src&lt;/code&gt; から画像を複製しているので、 &lt;code class=&quot;language-text&quot;&gt;src&lt;/code&gt; はファイルパスだけでなく URL でも取れるようになっています。&lt;/p&gt;
&lt;h3&gt;&lt;code class=&quot;language-text&quot;&gt;imageOptim.sh&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;imageOptim.sh&lt;/code&gt; は画像の最適化を行うスクリプトです。&lt;/p&gt;
&lt;p&gt;拡張子をファイル名から判別して&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/tjko/jpegoptim&quot;&gt;tjko/jpegoptim&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://pngquant.org/&quot;&gt;pngquant&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;で圧縮しています。対応しているのは &lt;code class=&quot;language-text&quot;&gt;jpg&lt;/code&gt; &lt;code class=&quot;language-text&quot;&gt;png&lt;/code&gt; です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;mogrify -resize &amp;#39;2560x1440&amp;gt;&amp;#39; &amp;quot;$1&amp;quot;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;で &lt;code class=&quot;language-text&quot;&gt;2560x1440&lt;/code&gt; から縦横のどちらかでもはみ出たら、アスペクト比を保ちつつ収まるサイズに縮小しています。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;imageOptim.sh&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -e
&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -u

&lt;span class=&quot;token assign-left variable&quot;&gt;usage&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Usage: imageOptim.sh src&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function-name function&quot;&gt;resize&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$#&lt;/span&gt; -eq &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
    &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;resize() needs 1 args&quot;&lt;/span&gt;
    &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;
  mogrify -resize &lt;span class=&quot;token string&quot;&gt;&apos;2560x1440&gt;&apos;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$#&lt;/span&gt; -eq &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$usage&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;ext&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${src&lt;span class=&quot;token operator&quot;&gt;##&lt;/span&gt;*.}&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;beforeSize&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;wc&lt;/span&gt; -c &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$src&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;optimize image: &lt;span class=&quot;token variable&quot;&gt;$src&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$ext&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;jpg&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  resize &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$src&lt;/span&gt;&quot;&lt;/span&gt;
  jpegoptim --strip-all --max&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;90&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$src&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$ext&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;png&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  resize &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$src&lt;/span&gt;&quot;&lt;/span&gt;
  pngquant --ext &lt;span class=&quot;token string&quot;&gt;&quot;.&lt;span class=&quot;token variable&quot;&gt;${ext}&lt;/span&gt;&quot;&lt;/span&gt; --force --speed &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$src&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;unknown filetype &lt;span class=&quot;token variable&quot;&gt;$ext&lt;/span&gt;&quot;&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;afterSize&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;wc&lt;/span&gt; -c &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$src&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;optimize image: optimized &lt;span class=&quot;token variable&quot;&gt;${beforeSize}&lt;/span&gt; to &lt;span class=&quot;token variable&quot;&gt;${afterSize}&lt;/span&gt; (&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* $afterSize / $beforeSize&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;%)&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;&lt;code class=&quot;language-text&quot;&gt;createBanner.sh&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;createBanner.sh&lt;/code&gt; は src 画像からサムネイルを作って画像追加までを行う、最もオレオレなスクリプトです。&lt;/p&gt;
&lt;p&gt;一時ファイルの処理が甘いのですが、使い方の参考にはなると思うので気にせず載せます。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;createBanner.sh&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -e
&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -u

&lt;span class=&quot;token assign-left variable&quot;&gt;usage&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;createBanner.sh src.jpg &apos;title&apos; &apos;text&apos;&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$#&lt;/span&gt; -eq &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$usage&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;srcImage&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$2&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$3&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;ext&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${srcImage&lt;span class=&quot;token operator&quot;&gt;##&lt;/span&gt;*.}&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# conf&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;aspectX&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;aspectY&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;banner&quot;&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;identify -format &lt;span class=&quot;token string&quot;&gt;&quot;%w %h&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$srcImage&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;srcW&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;${size&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;}&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;srcH&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;${size&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;}&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;tmp1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;mktemp &lt;span class=&quot;token string&quot;&gt;&quot;/tmp/&lt;span class=&quot;token variable&quot;&gt;${0&lt;span class=&quot;token operator&quot;&gt;##&lt;/span&gt;*&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;}&lt;/span&gt;.&lt;span class=&quot;token variable&quot;&gt;${srcImage&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;\&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;_}&lt;/span&gt;.&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.tmp1.tmp.&lt;span class=&quot;token variable&quot;&gt;${ext}&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# TODO trap rm&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $srcH &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* $aspectX&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -gt &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $srcW &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* $aspectY&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# crop height&lt;/span&gt;
  &lt;span class=&quot;token assign-left variable&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $srcW - $srcW % $aspectX&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token assign-left variable&quot;&gt;h&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $w / &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* &lt;span class=&quot;token number&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$w&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$h&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$tmp1&lt;/span&gt;
  convert &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$srcImage&lt;/span&gt;&quot;&lt;/span&gt; -gravity center -crop &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${w}&lt;/span&gt;x&lt;span class=&quot;token variable&quot;&gt;${h}&lt;/span&gt;+0+0&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$tmp1&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $srcH &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* $aspectX&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -lt &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $srcW &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* $aspectY&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# crop width&lt;/span&gt;
  &lt;span class=&quot;token assign-left variable&quot;&gt;h&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $srcH - $srcH % $aspectY&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token assign-left variable&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $h / &lt;span class=&quot;token number&quot;&gt;9&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$w&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$h&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$tmp1&lt;/span&gt;
  convert &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$srcImage&lt;/span&gt;&quot;&lt;/span&gt; -gravity center -crop &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${w}&lt;/span&gt;x&lt;span class=&quot;token variable&quot;&gt;${h}&lt;/span&gt;+0+0&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$tmp1&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;tmp2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;mktemp &lt;span class=&quot;token string&quot;&gt;&quot;/tmp/&lt;span class=&quot;token variable&quot;&gt;${0&lt;span class=&quot;token operator&quot;&gt;##&lt;/span&gt;*&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;}&lt;/span&gt;.&lt;span class=&quot;token variable&quot;&gt;${srcImage&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;\&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;_}&lt;/span&gt;.&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.tmp2.tmp.&lt;span class=&quot;token variable&quot;&gt;${ext}&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# TODO trap rm&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;srcImage = &lt;span class=&quot;token variable&quot;&gt;$srcImage&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;text = &lt;span class=&quot;token variable&quot;&gt;$text&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;tmp1 = &lt;span class=&quot;token variable&quot;&gt;$tmp1&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;tmp2 = &lt;span class=&quot;token variable&quot;&gt;$tmp2&lt;/span&gt;&quot;&lt;/span&gt;

./createImageWithText.sh &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$tmp1&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$text&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$tmp2&lt;/span&gt;&quot;&lt;/span&gt;
./addImage.sh &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$tmp2&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$title&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$name&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; -f &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$tmp1&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; -f &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$tmp2&lt;/span&gt;&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;中央らへんのごちゃごちゃと計算しているところがややこしいですね。&lt;/p&gt;
&lt;p&gt;アスペクト比を &lt;code class=&quot;language-text&quot;&gt;16:9&lt;/code&gt; にするためにどちらが長いかを計算してはみ出たところを中央から &lt;code class=&quot;language-text&quot;&gt;crop&lt;/code&gt; しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;16:9&lt;/code&gt; にしたものを &lt;code class=&quot;language-text&quot;&gt;$tmp1&lt;/code&gt; に保存し、 &lt;code class=&quot;language-text&quot;&gt;createImageWithText.sh&lt;/code&gt; で文字を入れてサムネ化したものを &lt;code class=&quot;language-text&quot;&gt;$tmp2&lt;/code&gt; に保存。&lt;/p&gt;
&lt;p&gt;生成された文字入り画像 &lt;code class=&quot;language-text&quot;&gt;$tmp2&lt;/code&gt; を元画像として &lt;code class=&quot;language-text&quot;&gt;addImage.sh&lt;/code&gt; で画像を追加しています。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;CMS ではアップロードするだけでいいのに Hugo では色々と自分で作業しなければいけない画像の追加が自動化できたので、とりあえず満足です。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/Shougo/deoplete.nvim&quot;&gt;Shougo/deoplete.nvim&lt;/a&gt; や &lt;a href=&quot;https://github.com/Shougo/denite.nvim&quot;&gt;Shougo/denite.nvim&lt;/a&gt; のソースとして画像を取得できるようにすると便利そうな気配がするので、気が向いたらやります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;addImage.sh&lt;/code&gt; の出力を image の path にして &lt;code class=&quot;language-text&quot;&gt;pbcopy&lt;/code&gt; するくらいでも良いかもしれないですね。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[ImageMagick で黒帯背景に白文字を載せた画像を生成するシェル芸]]></title><description><![CDATA[よくタイトル画像やアイキャッチ画像で見かける “半透明な黒帯背景に白文字でタイトルが書いてあるあの画像” （なんて呼ぶのだろう？）を生成するシェル芸です。]]></description><link>https://hori-ryota.com/blog/2017-01-29-create-blackband-image/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2017-01-29-create-blackband-image/</guid><pubDate>Sun, 29 Jan 2017 10:13:09 GMT</pubDate><content:encoded>&lt;p&gt;よくタイトル画像やアイキャッチ画像で見かける “半透明な黒帯背景に白文字でタイトルが書いてあるあの画像” （なんて呼ぶのだろう？）を生成するシェル芸です。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;できること&lt;/h2&gt;
&lt;p&gt;これが&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/648c3cedb61deacfc18bff376c18296c/768c6/samplesrc.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEBf/EABYBAQEBAAAAAAAAAAAAAAAAAAMCBP/aAAwDAQACEAMQAAABnUxZatAtJL//xAAdEAABAgcAAAAAAAAAAAAAAAACAAEDBBIhMTNB/9oACAEBAAEFAjYRfoDApOxYUvq//8QAFhEAAwAAAAAAAAAAAAAAAAAAAAEx/9oACAEDAQE/AYh0/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAgIDAAAAAAAAAAAAAAAAAAEQETJBYf/aAAgBAQAGPwKk76aZiOf/xAAaEAEAAgMBAAAAAAAAAAAAAAABABEhMVFB/9oACAEBAAE/IbkkYdbgiBIuyQ8q5qJtZ7MRXZ//2gAMAwEAAgADAAAAEAT/AP/EABcRAQEBAQAAAAAAAAAAAAAAAAEAEWH/2gAIAQMBAT8QM4TBBf/EABYRAQEBAAAAAAAAAAAAAAAAAAABMf/aAAgBAgEBPxCYr//EAB4QAQACAgIDAQAAAAAAAAAAAAEAESExYXFBUYHR/9oACAEBAAE/ELtTt1ZwG+1lIkPMP15pWD7+wlOFOMckAoAdsbnplpe5/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;元画像&quot;
        title=&quot;元画像&quot;
        src=&quot;/static/648c3cedb61deacfc18bff376c18296c/1c72d/samplesrc.jpg&quot;
        srcset=&quot;/static/648c3cedb61deacfc18bff376c18296c/a80bd/samplesrc.jpg 148w,
/static/648c3cedb61deacfc18bff376c18296c/1c91a/samplesrc.jpg 295w,
/static/648c3cedb61deacfc18bff376c18296c/1c72d/samplesrc.jpg 590w,
/static/648c3cedb61deacfc18bff376c18296c/a8a14/samplesrc.jpg 885w,
/static/648c3cedb61deacfc18bff376c18296c/fbd2c/samplesrc.jpg 1180w,
/static/648c3cedb61deacfc18bff376c18296c/768c6/samplesrc.jpg 3264w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ ./createImageWithText.sh tmp/src.jpg &lt;span class=&quot;token string&quot;&gt;&quot;ドラム式洗濯機はいいぞ&lt;span class=&quot;token entity&quot; title=&quot;\n&quot;&gt;\n&lt;/span&gt;めっちゃいいぞ&lt;span class=&quot;token entity&quot; title=&quot;\n&quot;&gt;\n&lt;/span&gt;m9(^Д^)ﾌﾟｷﾞｬｰ&quot;&lt;/span&gt; tmp/dst.jpg&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こう！&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bdb6df9f266b7f5524f4a2d56672de96/768c6/sampledst.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUCAwT/xAAWAQEBAQAAAAAAAAAAAAAAAAADAgT/2gAMAwEAAhADEAAAAVxorPRMdEn/AP/EABsQAAICAwEAAAAAAAAAAAAAAAACAREEEiEz/9oACAEBAAEFApajYWUp+MY/l//EABcRAQADAAAAAAAAAAAAAAAAAAABESH/2gAIAQMBAT8BrEv/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPwFX/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAEQMkHB/9oACAEBAAY/AumMohz/AP/EABwQAAICAgMAAAAAAAAAAAAAAAABETEhQVGB0f/aAAgBAQABPyGZCvYealdJ49JUFOVsxSOT/9oADAMBAAIAAwAAABCH3//EABgRAQADAQAAAAAAAAAAAAAAAAEAESEx/9oACAEDAQE/ELHWSwoT/8QAGBEBAQADAAAAAAAAAAAAAAAAAQARMVH/2gAIAQIBAT8QExqRy//EAB4QAQACAgMAAwAAAAAAAAAAAAEAESExQWFxgZHh/9oACAEBAAE/EBxSWqQX636wSxg5/UrDVwqnzCU4U4x2QCoB2xuDvEvs/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;出力画像&quot;
        title=&quot;出力画像&quot;
        src=&quot;/static/bdb6df9f266b7f5524f4a2d56672de96/1c72d/sampledst.jpg&quot;
        srcset=&quot;/static/bdb6df9f266b7f5524f4a2d56672de96/a80bd/sampledst.jpg 148w,
/static/bdb6df9f266b7f5524f4a2d56672de96/1c91a/sampledst.jpg 295w,
/static/bdb6df9f266b7f5524f4a2d56672de96/1c72d/sampledst.jpg 590w,
/static/bdb6df9f266b7f5524f4a2d56672de96/a8a14/sampledst.jpg 885w,
/static/bdb6df9f266b7f5524f4a2d56672de96/fbd2c/sampledst.jpg 1180w,
/static/bdb6df9f266b7f5524f4a2d56672de96/768c6/sampledst.jpg 3264w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ブログのアイキャッチ画像を簡単に生成するために作りました。&lt;/p&gt;
&lt;h2&gt;script&lt;/h2&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;createImageWithText.sh&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -e

&lt;span class=&quot;token assign-left variable&quot;&gt;usage&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;createImageWithText.sh src.jpg &apos;text&apos; dst.jpg&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$#&lt;/span&gt; -eq &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$usage&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;srcImage&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$2&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;dst&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$3&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;bgcolor&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;#0008&apos;&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;srcImage = &lt;span class=&quot;token variable&quot;&gt;$srcImage&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;text = &lt;span class=&quot;token variable&quot;&gt;$text&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;dst = &lt;span class=&quot;token variable&quot;&gt;$dst&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;identify -format &lt;span class=&quot;token string&quot;&gt;&quot;%w %h&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$srcImage&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;srcW&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;${size&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;}&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;srcH&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;${size&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;}&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;srcWidth = &lt;span class=&quot;token variable&quot;&gt;$srcW&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;srcHeight = &lt;span class=&quot;token variable&quot;&gt;$srcH&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;bandW&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$srcW&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;bandH&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $srcH &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; / &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;padW&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $bandW / &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;padH&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $bandH / &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;textW&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $bandW - $padW &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;textH&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $bandH - $padH &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

convert &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$srcImage&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -gravity center &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -size &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${textW}&lt;/span&gt;x&lt;span class=&quot;token variable&quot;&gt;${textH}&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -fill white &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -font ~/Library/Fonts/NotoSansCJKjp-Regular.otf &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -background &lt;span class=&quot;token variable&quot;&gt;$bgcolor&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  label:&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$text&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -bordercolor &lt;span class=&quot;token variable&quot;&gt;$bgcolor&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -compose copy &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -border &lt;span class=&quot;token variable&quot;&gt;${padW}&lt;/span&gt;x&lt;span class=&quot;token variable&quot;&gt;${padH}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -gravity center &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -compose over &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -composite &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dst&lt;/span&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;open&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dst&lt;/span&gt;&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;ざっくり解説&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://www.imagemagick.org/script/index.php&quot;&gt;ImageMagick&lt;/a&gt; を使用しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;convert &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$srcImage&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -gravity center &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -size &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${textW}&lt;/span&gt;x&lt;span class=&quot;token variable&quot;&gt;${textH}&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -fill white &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -font ~/Library/Fonts/NotoSansCJKjp-Regular.otf &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -background &lt;span class=&quot;token variable&quot;&gt;$bgcolor&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  label:&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$text&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -bordercolor &lt;span class=&quot;token variable&quot;&gt;$bgcolor&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -compose copy &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -border &lt;span class=&quot;token variable&quot;&gt;${padW}&lt;/span&gt;x&lt;span class=&quot;token variable&quot;&gt;${padH}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -gravity center &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -compose over &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -composite &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dst&lt;/span&gt;&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;composite&lt;/code&gt; オプションで &lt;code class=&quot;language-text&quot;&gt;$srcImage&lt;/code&gt; と括弧内で錬成している “帯と文字部分” を重ねて &lt;code class=&quot;language-text&quot;&gt;$dst&lt;/code&gt; に出力しています。&lt;/p&gt;
&lt;p&gt;括弧内ですが、&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;  -gravity center &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -size &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${textW}&lt;/span&gt;x&lt;span class=&quot;token variable&quot;&gt;${textH}&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -fill white &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -font ~/Library/Fonts/NotoSansCJKjp-Regular.otf &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -background &lt;span class=&quot;token variable&quot;&gt;$bgcolor&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  label:&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$text&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;の部分で黒背景の文を作成し、&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;  -bordercolor &lt;span class=&quot;token variable&quot;&gt;$bgcolor&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -compose copy &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
  -border &lt;span class=&quot;token variable&quot;&gt;${padW}&lt;/span&gt;x&lt;span class=&quot;token variable&quot;&gt;${padH}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;で padding 分を埋めています。&lt;/p&gt;
&lt;p&gt;ImageMagick には &lt;code class=&quot;language-text&quot;&gt;extent&lt;/code&gt; という領域を拡大するオプションがあるのですが、透過の background と組み合わせるとなぜか label で描画した部分の背景が &lt;code class=&quot;language-text&quot;&gt;extent&lt;/code&gt; した部分に比べ濃くなってしまうため、背景色と同じ色の &lt;code class=&quot;language-text&quot;&gt;border&lt;/code&gt; で囲って padding としました。&lt;/p&gt;
&lt;p&gt;帯部分のサイズ計算がこちらです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;bandW&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$srcW&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;bandH&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $srcH &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; / &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;padW&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $bandW / &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;padH&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $bandH / &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;textW&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $bandW - $padW &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;textH&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; $bandH - $padH &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;* &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;計算内容は見ての通りなので解説は省略しますが、もし見ためが気に入らなければここを調節していただければサイズが変わります。&lt;/p&gt;
&lt;p&gt;テキストの行数や長さに応じて可変にしてもよさそうですね。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;とりあえずのアイキャッチ画像としては及第点ではないでしょうか。&lt;/p&gt;
&lt;p&gt;次は&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Hugo 向けに画像を最適化しつつ記事用ディレクトリに突っ込むスクリプト&lt;/li&gt;
&lt;li&gt;リサイズしてアイキャッチ画像を生成する wrapper スクリプト&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;を用意して Hugo でも画像周りでストレスの溜まらない環境を整備する予定です。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;追記：&lt;/p&gt;
&lt;p&gt;書きました&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/create-shellscript-for-hugo-images&quot;&gt;Hugo のサムネ作成、画像追加、画像最適化を自動化するシェル芸&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;</content:encoded></item><item><title><![CDATA[aws-sdk-go で S3 の Prefix (Directory) 一覧を取得する方法]]></title><description><![CDATA[aws-sdk-go で S3 の  をしたとき、 Prefix (Directory) の一覧は  に入ってくる。]]></description><link>https://hori-ryota.com/blog/2016-11-13-aws-s3-commonprefixes/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-11-13-aws-s3-commonprefixes/</guid><pubDate>Sun, 13 Nov 2016 08:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://github.com/aws/aws-sdk-go&quot;&gt;aws-sdk-go&lt;/a&gt; で S3 の &lt;code class=&quot;language-text&quot;&gt;ListObjects&lt;/code&gt; をしたとき、 Prefix (Directory) の一覧は &lt;code class=&quot;language-text&quot;&gt;CommonPrefixes&lt;/code&gt; に入ってくる。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;ちょっとハマったので備忘録です。&lt;/p&gt;
&lt;p&gt;shell コマンドの AWS CLI だと &lt;code class=&quot;language-text&quot;&gt;aws s3 list s3://bucketname/prefix/&lt;/code&gt; で prefix 直下の Prefix (Directory) 一覧も取れていたので気にならなかったのですが、 aws-sdk-go だと &lt;code class=&quot;language-text&quot;&gt;ListObjectsOutputs.Contents&lt;/code&gt; から Prefix の一覧が取得できません。&lt;/p&gt;
&lt;p&gt;で、どこに入っているかというと &lt;code class=&quot;language-text&quot;&gt;Contents&lt;/code&gt; と同階層にある &lt;code class=&quot;language-text&quot;&gt;CommonPrefixes&lt;/code&gt; の方にありました。&lt;/p&gt;
&lt;p&gt;なので、 &lt;code class=&quot;language-text&quot;&gt;aws-sdk-go&lt;/code&gt; の Wrapper を用意するときは &lt;code class=&quot;language-text&quot;&gt;Contents&lt;/code&gt; だけを返すのではなく &lt;code class=&quot;language-text&quot;&gt;ListObjectsOutputs&lt;/code&gt; ごと返すか、 &lt;code class=&quot;language-text&quot;&gt;CommonPrefixes&lt;/code&gt; を返すメソッドを別途用意できるような構造にしといたほうが良さそうですね。&lt;/p&gt;
&lt;p&gt;以上、備忘録でした。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[GitHub Enterprise でも hub コマンド を快適に使う alias設定]]></title><description><![CDATA[git コマンドを拡張して GitHub の Pull Request もコマンドラインから行える hub という Wrapper コマンドツールがあるのですが、 GitHub Enterprise で快適に使うには別途 alias を指定したほうが良かったので備忘録です。]]></description><link>https://hori-ryota.com/blog/2016-11-07-hub-with-ghe-alias/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-11-07-hub-with-ghe-alias/</guid><pubDate>Mon, 07 Nov 2016 09:00:00 GMT</pubDate><content:encoded>&lt;p&gt;git コマンドを拡張して GitHub の Pull Request もコマンドラインから行える &lt;a href=&quot;https://hub.github.com/&quot;&gt;hub&lt;/a&gt; という Wrapper コマンドツールがあるのですが、 GitHub Enterprise で快適に使うには別途 alias を指定したほうが良かったので備忘録です。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;hub コマンド&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://hub.github.com/&quot;&gt;hub の公式ページ&lt;/a&gt; を見ていただくのが一番早いですが、ざっくりいうと&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;alias&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;git&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;hub&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;のように設定することで&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; browse&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;で今いるリポジトリの GitHub リポジトリをブラウザで開いたり、&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; pull-request&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;でコマンドラインからプルリクを送れたりします。&lt;/p&gt;
&lt;h2&gt;hub + GitHub Enterprise&lt;/h2&gt;
&lt;p&gt;hub コマンドを GitHub Enterprise で使うには&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; config --global --add hub.host ghe.my.org&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;で GitHub Enterprise の host を指定すればいいのですが、これだと全 hub コマンドが GitHub Enterprise を見てしまうので実行時に&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;GITHUB_HOST&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;ghe.my.org &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; pull-request&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;のようにパラメータを指定してあげると一時的に GitHub Enterprise へのリクエストにすることができます。&lt;/p&gt;
&lt;p&gt;毎回パラメータを設定するのは手間なので、 alias を設定するのがおすすめです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;alias&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;ghe&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;GITHUB_HOST=ghe.my.org git&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.zshrc&lt;/code&gt; に直接設定すると &lt;code class=&quot;language-text&quot;&gt;dotfiles&lt;/code&gt; を GitHub 管理している人は GitHub Enterprise の host が見えてしまうので &lt;code class=&quot;language-text&quot;&gt;dotfiles&lt;/code&gt; 管理外に &lt;code class=&quot;language-text&quot;&gt;.zshrc_local&lt;/code&gt; を用意して &lt;code class=&quot;language-text&quot;&gt;.zshrc&lt;/code&gt; から &lt;code class=&quot;language-text&quot;&gt;source .zshrc_local&lt;/code&gt; する方がいいかと思います。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;コマンドラインからプルリクを送れるようになるとライブラリの更新などをシェルスクリプトでぶん回せるようになるので捗りますね。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Chrome を Vim ライクにする Vimium を使うなら「戻る」「次へ」の設定はしといたほうが良い]]></title><description><![CDATA[Chrome を Vim ライクにする Vimium なのですが、デフォルトだと日本語のページ遷移に対応できないのでカスタム設定をした方がいいという話。]]></description><link>https://hori-ryota.com/blog/2016-11-06-vimium-pre-next-patterns-jp/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-11-06-vimium-pre-next-patterns-jp/</guid><pubDate>Sat, 05 Nov 2016 18:30:00 GMT</pubDate><content:encoded>&lt;p&gt;Chrome を Vim ライクにする &lt;a href=&quot;https://chrome.google.com/webstore/detail/vimium/dbepggeogbaibhgnhhndojpepiihcmeb&quot;&gt;Vimium&lt;/a&gt; なのですが、デフォルトだと日本語のページ遷移に対応できないのでカスタム設定をした方がいいという話。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;Vimium には &lt;code class=&quot;language-text&quot;&gt;[[&lt;/code&gt; , &lt;code class=&quot;language-text&quot;&gt;]]&lt;/code&gt; で前のページ、次のページに遷移できる、これだけで Vimium を使いたくなる便利機能があるのですがデフォルトだと Google の検索結果ですら遷移できません。&lt;/p&gt;
&lt;p&gt;というのも Vimium では前のページ、次のページを探すのに特定のパターンにマッチするリンク文字列を探すのですが&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8259d8c477f2053ad11eca566101144e/73caa/before.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 22.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAnUlEQVQY032P2wrDMAxD+/9/2YcuzXW0pLm3mu2+jLEtIAwKOpYnHwKcv6WNRa0VgTxrLbxzMMZg2zYcx4F939FawxgDvXeZ72JvKqUi5UyBhEihSgFD4FVraG3wUAqWwM57pJRwnudPMfQGpizQ67rAj9vEGFFKkcaZZu9D/v8BWVMIT2qxQq1awmwuy4J5nqWhc17O5gXfzvw8+QXJQDZAq1JcIwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;設定前&quot;
        title=&quot;設定前&quot;
        src=&quot;/static/8259d8c477f2053ad11eca566101144e/fcda8/before.png&quot;
        srcset=&quot;/static/8259d8c477f2053ad11eca566101144e/12f09/before.png 148w,
/static/8259d8c477f2053ad11eca566101144e/e4a3f/before.png 295w,
/static/8259d8c477f2053ad11eca566101144e/fcda8/before.png 590w,
/static/8259d8c477f2053ad11eca566101144e/efc66/before.png 885w,
/static/8259d8c477f2053ad11eca566101144e/73caa/before.png 1110w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;のようにデフォルトだと日本語のラベルが設定されていません。&lt;/p&gt;
&lt;p&gt;なので&lt;/p&gt;
&lt;p&gt;Previous patterns&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;prev,previous,back,&amp;lt;,←,«,≪,&amp;lt;&amp;lt;,前へ,戻る,前のページ&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next Patterns&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;next,more,&amp;gt;,→,»,≫,&amp;gt;&amp;gt;,次へ,進む,もっと見る,もっとみる,次のページ&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;のように日本語でよくあるページ遷移ラベルを追加してあげることで遷移できるようになります。&lt;/p&gt;
&lt;p&gt;以上、備忘録でした。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[AbemaTV Developer Conference 2016 で HLS と生放送について喋りました #abematv_dev]]></title><description><![CDATA[1ヶ月ほど前になってしまいましたが、 AbemaTV Developer Conference 2016 にてHLSと生放送についての話をしました。]]></description><link>https://hori-ryota.com/blog/2016-11-05-abematvdev20161015/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-11-05-abematvdev20161015/</guid><pubDate>Sat, 05 Nov 2016 12:00:00 GMT</pubDate><content:encoded>&lt;p&gt;1ヶ月ほど前になってしまいましたが、 &lt;a href=&quot;http://developer.abema.io/&quot;&gt;AbemaTV Developer Conference 2016&lt;/a&gt; にてHLSと生放送についての話をしました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;登壇内容&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://speakerdeck.com/horiryota/yantiyana-http-live-streaming-toraburusiyuteinguji&quot;&gt;やんちゃな HTTP Live Streaming トラブルシューティング集&lt;/a&gt; と題し、運用で培ったノウハウを紹介いたしました。&lt;/p&gt;
&lt;div
          style=&quot;position: relative; width:100%; height:0; padding-top:74.92957746478874%;&quot;
          &gt;
          &lt;iframe id=&quot;talk_frame_363673&quot; src=&quot;//speakerdeck.com/player/023a18226d6144d4af41a44c58d49060&quot; width=100% height=&quot;100%&quot; style=&quot;position:absolute;top:0;left:0;border:0; padding:0; margin:0; background:transparent;&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen=&quot;allowfullscreen&quot; mozallowfullscreen=&quot;true&quot; webkitallowfullscreen=&quot;true&quot;&gt;&lt;/iframe&gt;

          &lt;/div&gt;
&lt;p&gt;注力事業のカンファレンスで長尺を頂いたのでガクブルしていたのですが、それなりに楽しんでいただけたようで良かったです。&lt;/p&gt;
&lt;p&gt;HLS こと HTTP Live Streaming は Apple のガイドラインにもある通り iOS で動画ストリーミングを行う際には必須となるので、積極的な知見共有を行っていきたいですね。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;2.5.7 Video streaming content over a cellular network longer than 10 minutes must use HTTP Live Streaming and include a baseline 192 kbps HTTP Live stream.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.apple.com/app-store/review/guidelines/#software-requirements&quot;&gt;App Store Review Guidelines - Apple Developer&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;
&lt;h2&gt;スライド制作&lt;/h2&gt;
&lt;p&gt;デザインセンスが皆無なため、今回のスライドは同じく登壇した &lt;a href=&quot;https://twitter.com/ahomu&quot;&gt;@ahomu&lt;/a&gt; さん製の &lt;a href=&quot;https://github.com/ahomu/Talkie&quot;&gt;Talkie.js&lt;/a&gt; をお借りしました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/ahomu/Talkie&quot;&gt;ahomu/Talkie: Simple slide presentation library. Responsive scaling &amp;#x26; markdown ready.&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;普段は &lt;a href=&quot;http://www.decksetapp.com/&quot;&gt;Deckset&lt;/a&gt; を使用していたのですが、日本語対応が壊滅的なのでカンファレンスには厳しいなと。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://lab.hakim.se/reveal-js/&quot;&gt;reveal.js&lt;/a&gt; も検討したのですが、行間スペースが小さくて日本語だと中央にギュッとしがちだったので、今回はそのままで使いやすそうな &lt;a href=&quot;https://github.com/ahomu/Talkie&quot;&gt;Talkie.js&lt;/a&gt; にしました。&lt;/p&gt;
&lt;p&gt;結果、目の前に製作者がいるメリットも享受できたので非常に捗りました。&lt;/p&gt;
&lt;p&gt;一点注意だったのは PC にfont が入っていないとイマイチな見た目になるので、 font-family にある font は事前に入れておいたほうがいいかと思います。&lt;/p&gt;
&lt;p&gt;Markdown でのスライド制作は、ツールを変更したくなっても簡単に置換できますし、見た目を変えたければ CSS 書いちゃえばいいし、下書き（構成たたき台）として使用して最終的には Keynote で作り直してもいいし、とりあえずアウトラインを書けばサクッとスライドになるのでとても気に入っております。&lt;/p&gt;
&lt;p&gt;図の作成は &lt;a href=&quot;http://www.graphviz.org/&quot;&gt;Graphviz&lt;/a&gt; で完結させたかったけど実力不足で断念。すべてテキストで書いてみたい。&lt;/p&gt;
&lt;h2&gt;お礼&lt;/h2&gt;
&lt;p&gt;慣れない登壇で時間調整が甘かったり、色々と至らないところも多かったと思うのですが会場がとても暖かくて嬉しかったです。ご覧いただいた皆様、ありがとうございました！&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CloudFrontのawscliでjson管理できる環境を整備した]]></title><description><![CDATA[CloudFrontをマネジメントコンソールでぽちぽち管理するのつらい！！ ということで、awscliとjqを使用してjson管理できる環境を整備してGitHubに公開しました。]]></description><link>https://hori-ryota.com/blog/2016-11-04-create-cloudfront-manager/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-11-04-create-cloudfront-manager/</guid><pubDate>Thu, 03 Nov 2016 15:00:00 GMT</pubDate><content:encoded>&lt;p&gt;CloudFrontをマネジメントコンソールでぽちぽち管理するのつらい！！&lt;/p&gt;
&lt;p&gt;ということで、awscliとjqを使用してjson管理できる環境を整備してGitHubに公開しました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;&lt;a href=&quot;https://github.com/hori-ryota/cloudfront-manager&quot;&gt;CloudFront Manager&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;個人使用のために作成したので、細かいアレコレはご容赦ください。レビューは大歓迎です。&lt;/p&gt;
&lt;p&gt;以下、記事公開時点のREADME.mdと同内容です。&lt;/p&gt;
&lt;p&gt;コマンドによってjsonのプロパティ順が違うようなので、作業後は &lt;code class=&quot;language-text&quot;&gt;fetchall.sh&lt;/code&gt; でお掃除することを推奨。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CloudFrontの設定は失敗するとサービスにとって致命傷となるので、使用は自己責任でお願いします。&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;下準備&lt;/h2&gt;
&lt;h3&gt;依存ツール&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/jp/cli/&quot;&gt;awscli&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://stedolan.github.io/jq/&quot;&gt;jq&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;cloudfrontコマンドはpreview版なので有効にする&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws configure &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; preview.cloudfront &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;（基礎知識）主要なawsコマンド&lt;/h2&gt;
&lt;h3&gt;distribution一覧取得&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws cloudfront list-distributions&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;distribution個別取得&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws cloudfront get-distribution --id &lt;span class=&quot;token variable&quot;&gt;${distributionId}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;distribution更新&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws cloudfront update-distribution --cli-input-json file://&lt;span class=&quot;token variable&quot;&gt;${jsonFileName}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;updateの対象distributionIdはjson内に記述されているのでコマンドで指定はしない&lt;/p&gt;
&lt;h3&gt;distribution作成&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws cloudfront create-distribution --cli-input-json file://&lt;span class=&quot;token variable&quot;&gt;${jsonFileName}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;ディレクトリ構成&lt;/h2&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;backup/ # 更新時に旧jsonを退避 # gitignore対象
draft/  # 作成用の下書き置き場 # gitignore対象
json/   # cloudfrontから取得したjson置き場&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;backupディレクトリはdiffを取りやすくするため配置。git管理なので本来は不要ですが、実行時の保険として。&lt;/p&gt;
&lt;p&gt;作成はマネジメントコンソールでポチって作るか、後述のコマンドで既存からコピーするのがいいかと思います。&lt;/p&gt;
&lt;p&gt;更新はjsonディレクトリ内のファイルを更新してcloudfrontに反映、返ってきたresultでjsonを上書きします。&lt;/p&gt;
&lt;p&gt;jsonディレクトリをGitHubにpushすると構成が見えてしまうので、必要に応じてgitignoreしてください（pull-requestでレビューできなくなりますが）。&lt;/p&gt;
&lt;h2&gt;スクリプト&lt;/h2&gt;
&lt;p&gt;vim の quickrun で叩きやすくするため、dirname などでのパス解決はしていないです。 &lt;code class=&quot;language-text&quot;&gt;cloudfront-manager/&lt;/code&gt; ディレクトリ直下で実行してください。&lt;/p&gt;
&lt;h3&gt;fetchall.sh&lt;/h3&gt;
&lt;p&gt;初期化用。cloudfrontからEnabled状態のdistributionsを取ってきてjsonディレクトリに反映。&lt;/p&gt;
&lt;p&gt;削除済みdistributionのjson削除は行わないので、削除も必要ならjsonディレクトリを削除後に実行してください。&lt;/p&gt;
&lt;h3&gt;update.sh&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;./update.sh &lt;span class=&quot;token variable&quot;&gt;${targetCName}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;更新用。&lt;code class=&quot;language-text&quot;&gt;get-distribution&lt;/code&gt; のjsonと &lt;code class=&quot;language-text&quot;&gt;update-distribution&lt;/code&gt; の形式は若干違うので、&lt;code class=&quot;language-text&quot;&gt;jq&lt;/code&gt; コマンドで整形したものを入力へ。&lt;/p&gt;
&lt;p&gt;結果を元にjsonディレクトリ内の該当jsonを上書きします。&lt;/p&gt;
&lt;h3&gt;createDraft.sh&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;./createDraft.sh &lt;span class=&quot;token variable&quot;&gt;${targetName}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;${srcJsonFile}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;新規作成用に下書きを &lt;code class=&quot;language-text&quot;&gt;draft/&lt;/code&gt; 下に作成。 &lt;code class=&quot;language-text&quot;&gt;srcJsonFile&lt;/code&gt; を指定すればコピーしてcreate用Jsonに整形。指定がなければ skeleton 作成。&lt;/p&gt;
&lt;p&gt;CallerReferenceの値は&lt;code class=&quot;language-text&quot;&gt;date +%s&lt;/code&gt; コマンドでタイムスタンプを使用していますが、distribution間でuniqueにする必要があるようなので必要に応じて調整。&lt;/p&gt;
&lt;h3&gt;create.sh&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;./create.sh &lt;span class=&quot;token variable&quot;&gt;${targetName}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;draft/&lt;/code&gt; 下の下書きから新規作成。結果をjsonディレクトリ内に保存。&lt;/p&gt;
&lt;p&gt;Locationプロパティは邪魔なので削除。&lt;/p&gt;
&lt;h2&gt;補足&lt;/h2&gt;
&lt;p&gt;スクリプトは基礎的なコマンドとして、for文で実行するスクリプトを別途用意すると便利。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; -eu

&lt;span class=&quot;token assign-left variable&quot;&gt;targets&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
&lt;span class=&quot;token string&quot;&gt;&quot;DISTRIBUTION_ID_1&quot;&lt;/span&gt;
&lt;span class=&quot;token string&quot;&gt;&quot;DISTRIBUTION_ID_2&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;customErrorResponses&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;
      {
        &quot;Items&quot;: [
          {
            &quot;ErrorCode&quot;: 400,
            &quot;ResponsePagePath&quot;: &quot;&quot;,
            &quot;ResponseCode&quot;: &quot;&quot;,
            &quot;ErrorCachingMinTTL&quot;: 1
          }
        ],
        &quot;Quantity&quot;: 1
      }
&apos;&lt;/span&gt;

&lt;span class=&quot;token assign-left variable&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;json&apos;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;((&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; ${#targets[@]}&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;))&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token assign-left variable&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;${targets&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;$i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;}&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;target = &lt;span class=&quot;token variable&quot;&gt;$target&lt;/span&gt;&quot;&lt;/span&gt;

  &lt;span class=&quot;token assign-left variable&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dir&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;$target&lt;/span&gt;.json&quot;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; -e &lt;span class=&quot;token variable&quot;&gt;$jsonPath&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
    &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;json file not found [&lt;span class=&quot;token variable&quot;&gt;$jsonPath&lt;/span&gt;]&quot;&lt;/span&gt;
    &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

  &lt;span class=&quot;token assign-left variable&quot;&gt;srcJson&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; $jsonPath&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;

  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$srcJson&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; jq &lt;span class=&quot;token string&quot;&gt;&quot;.Distribution.DistributionConfig.CustomErrorResponses=&lt;span class=&quot;token variable&quot;&gt;$customErrorResponses&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$jsonPath&lt;/span&gt;

  ./update.sh &lt;span class=&quot;token variable&quot;&gt;$target&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;みたいな。&lt;/p&gt;
&lt;h2&gt;TODO&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;distributionId管理だと視認性が悪いのでaliasをつけたい。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;cnameがわかりやすいけど複数cnameを使用するときに困るので悩み中。&lt;/li&gt;
&lt;li&gt;tag機能もあるけどawscli経由だと情報が取得できていなさそうなので様子見。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;ということで、一括でdistributionのjsonを取得し、編集して更新をかけられる環境が構築できました。&lt;/p&gt;
&lt;p&gt;json管理にすることで差分のレビューもできるので、個人的には非常に捗っております。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/update-cloudfront-with-awscli&quot;&gt;CloudFrontの設定をコマンドラインから更新する&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/create-cloudfront-with-awscli&quot;&gt;CloudFrontの設定をコマンドラインから作成する&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;の集大成でした。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CloudFrontの設定をコマンドラインから作成する]]></title><description><![CDATA[CloudFrontの設定をコマンドラインから更新する の続き。前回は更新で今回は作成です。]]></description><link>https://hori-ryota.com/blog/2016-11-03-create-cloudfront-with-awscli/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-11-03-create-cloudfront-with-awscli/</guid><pubDate>Thu, 03 Nov 2016 09:00:00 GMT</pubDate><content:encoded>&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/update-cloudfront-with-awscli&quot;&gt;CloudFrontの設定をコマンドラインから更新する&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;の続き。前回は更新で今回は作成です。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;準備&lt;/h2&gt;
&lt;p&gt;ツールの設定周りは&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/update-cloudfront-with-awscli&quot;&gt;CloudFrontの設定をコマンドラインから更新する&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;と同じなので参照してください。&lt;/p&gt;
&lt;h2&gt;Distribution設定ファイルを新規作成する&lt;/h2&gt;
&lt;p&gt;新規作成するか、既存からコピーするかの2択になるかと思います。&lt;/p&gt;
&lt;h3&gt;新規作成&lt;/h3&gt;
&lt;p&gt;AWS CLIにskeleton（雛形）作成オプションがあるので叩きます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws cloudfront create-distribution --generate-cli-skeleton &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$jsonPath&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;既存からコピー&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/update-cloudfront-with-awscli&quot;&gt;CloudFrontの設定をコマンドラインから更新する&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;の “Distribution設定ファイルを取得する” で取得したものから作成します。&lt;/p&gt;
&lt;p&gt;取得用jsonと作成用jsonはフォーマットが違うので編集します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws cloudfront get-distribution --id &lt;span class=&quot;token variable&quot;&gt;${SRC_DISTRIBUTION_ID}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
    jq -r &lt;span class=&quot;token string&quot;&gt;&quot;.Distribution
            | { DistributionConfig: .DistributionConfig }
            | .DistributionConfig.CallerReference = &lt;span class=&quot;token entity&quot; title=&quot;\&amp;quot;&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;${callerReference}&lt;/span&gt;&lt;span class=&quot;token entity&quot; title=&quot;\&amp;quot;&quot;&gt;\&quot;&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$jsonPath&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;$callerReference&lt;/code&gt; の値ですが、distribution間で一意にする必要があります。ミリ秒のタイムスタンプを入れつつ、被る場合は調整するのがオススメ。&lt;/p&gt;
&lt;h2&gt;CloudFrontに設定ファイルを反映する&lt;/h2&gt;
&lt;p&gt;コマンド一発です。ミスってもエラーが出るだけなので怖くない。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws cloudfront create-distribution --cli-input-json file://&lt;span class=&quot;token variable&quot;&gt;$jsonPath&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;新環境作成時に使いまわせるので非常に便利。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;追記：&lt;/p&gt;
&lt;p&gt;一連のコマンドをスクリプト化して管理ツールっぽくしました&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/create-cloudfront-manager&quot;&gt;CloudFrontのawscliでjson管理できる環境を整備した&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;</content:encoded></item><item><title><![CDATA[log4j.xmlでデフォルト値を設定する方法]]></title><description><![CDATA[log4j.xmlでデフォルト値を設定する備忘録です。]]></description><link>https://hori-ryota.com/blog/2016-07-10-log4j-default-value/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-07-10-log4j-default-value/</guid><pubDate>Sat, 09 Jul 2016 16:00:00 GMT</pubDate><content:encoded>&lt;p&gt;log4j.xmlでデフォルト値を設定する備忘録です。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;log4j&lt;/code&gt; では &lt;code class=&quot;language-text&quot;&gt;log4j.xml&lt;/code&gt; で変数を使用することができ、javaアプリの起動時に &lt;code class=&quot;language-text&quot;&gt;-Dkey=value&lt;/code&gt; のように &lt;code class=&quot;language-text&quot;&gt;-D&lt;/code&gt; オプションで指定すると値が入ります。&lt;/p&gt;
&lt;p&gt;設定プロパティ内では以下のように記述します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;xml&quot;&gt;&lt;pre class=&quot;language-xml&quot;&gt;&lt;code class=&quot;language-xml&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;param&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;enabled&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;${key}&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このparam設定にはデフォルト設定用のパラメータがないようなのですが、以下の記述でデフォルト値を設定できました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;xml&quot;&gt;&lt;pre class=&quot;language-xml&quot;&gt;&lt;code class=&quot;language-xml&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;param&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;enabled&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;false&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;param&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;enabled&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;${key}&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この場合は &lt;code class=&quot;language-text&quot;&gt;false&lt;/code&gt; がデフォルト値になります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;log4j.xml&lt;/code&gt; では &lt;code class=&quot;language-text&quot;&gt;value&lt;/code&gt; が空の場合は設定されず、 &lt;code class=&quot;language-text&quot;&gt;name&lt;/code&gt; が競合した場合は後勝ちになるため、後に設定したものが反映され上記の記述でデフォルト設定が実現できます。&lt;/p&gt;
&lt;p&gt;以上、今さら &lt;code class=&quot;language-text&quot;&gt;log4j&lt;/code&gt; 感はありますがデフォルト値設定の備忘録でした。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CloudFrontの設定をコマンドラインから更新する]]></title><description><![CDATA[CloudFrontの設定をGUIでポチポチしていると大体ミスってうまく動かなかったりするんですよね。 実はCloudFrontもAWS CLIを使ってコマンドラインから更新できるので、やり方をまとめました。]]></description><link>https://hori-ryota.com/blog/2016-06-25-update-cloudfront-with-awscli/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-06-25-update-cloudfront-with-awscli/</guid><pubDate>Sat, 25 Jun 2016 14:50:00 GMT</pubDate><content:encoded>&lt;p&gt;CloudFrontの設定をGUIでポチポチしていると大体ミスってうまく動かなかったりするんですよね。&lt;/p&gt;
&lt;p&gt;実はCloudFrontもAWS CLIを使ってコマンドラインから更新できるので、やり方をまとめました。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;使うツール&lt;/h2&gt;
&lt;p&gt;インストールは以下のリンクから。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/jp/cli/&quot;&gt;AWS コマンドラインインターフェイス | AWS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://stedolan.github.io/jq/&quot;&gt;jq&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;下準備（Previewを有効に）&lt;/h2&gt;
&lt;p&gt;AWS的にはAWS CLIのCloudFront設定はまだPreview版のようなのですが、とりあえず使えます。&lt;/p&gt;
&lt;p&gt;ただし、Preview版なので有効にするにはconfigを設定する必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws configure &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; preview.cloudfront &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のコマンドを実行することでAWS CLIでCloudFrontが有効になります。&lt;/p&gt;
&lt;h2&gt;Distribution設定ファイルを取得する&lt;/h2&gt;
&lt;p&gt;AWS CLIのCloudFrontでは各設定項目を個別に更新することはできず、Distributionの設定すべてを丸ごと更新します。&lt;/p&gt;
&lt;p&gt;まずは以下のコマンドでDistributionの設定をjsonで取得できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws cloudfront get-distribution --id &lt;span class=&quot;token variable&quot;&gt;${DISTRIBUTION_ID}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; src.json&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;${DISTRIBUTION_ID}&lt;/code&gt; には更新したいCloudFrontのDistributionIdを入れてください。&lt;/p&gt;
&lt;h2&gt;Distribution設定ファイルのフォーマットを変換する&lt;/h2&gt;
&lt;p&gt;残念なことに、取得用のjsonと更新用のjsonはフォーマットが少し違います。&lt;/p&gt;
&lt;p&gt;なので &lt;code class=&quot;language-text&quot;&gt;jq&lt;/code&gt; コマンドを使ってフォーマットを変換します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;jq -r &lt;span class=&quot;token string&quot;&gt;&apos;{ DistributionConfig: .Distribution.DistributionConfig, Id: .Distribution.Id, IfMatch: .ETag }&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
    src.json &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; dst.json&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Distribution設定ファイルを編集する&lt;/h2&gt;
&lt;p&gt;変換された &lt;code class=&quot;language-text&quot;&gt;dst.json&lt;/code&gt; を編集してください。&lt;/p&gt;
&lt;p&gt;一点注意ですが、 &lt;code class=&quot;language-text&quot;&gt;Quantity&lt;/code&gt; というプロパティは配列の要素数を示しています。配列の要素数が変わった際には併せて編集してください。&lt;/p&gt;
&lt;p&gt;update時にエラーが出るので怒られたら直すでもOKです。&lt;/p&gt;
&lt;h2&gt;CloudFrontに設定ファイルを反映する&lt;/h2&gt;
&lt;p&gt;コマンド一発です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;aws cloudfront update-distribution --cli-input-json file://dst.json&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このコマンドでDistributionの更新が走るので、GUIでの更新と同じく反映を待ってください。&lt;/p&gt;
&lt;h2&gt;以上&lt;/h2&gt;
&lt;p&gt;shellで設定を変更できるので、shell scriptでもぶん回せます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;aws cloudfront list-distributions&lt;/code&gt; と組み合わせて一括で更新するようにすれば、数十個のDistributionの更新も恐くない！&lt;/p&gt;
&lt;p&gt;GUIだとどうしても漏れが発生して、最悪の場合はサービスが全くアクセスできなくなるので、CUIで更新できるのは助かりますね。&lt;/p&gt;
&lt;p&gt;ほとんど同じ操作にはなるのですが、既存のDistribution設定を元に別Distributionを作成（複製）することもできるので、別記事で書きます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;追記：&lt;/p&gt;
&lt;p&gt;書きました&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/create-cloudfront-with-awscli&quot;&gt;CloudFrontの設定をコマンドラインから作成する&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;追記2：&lt;/p&gt;
&lt;p&gt;一連のコマンドをスクリプト化して管理ツールっぽくしました&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/create-cloudfront-manager&quot;&gt;CloudFrontのawscliでjson管理できる環境を整備した&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;</content:encoded></item><item><title><![CDATA[FFmpegで動画の一部を無音にするときは音声を削除せずに無音データで埋めないとダメ]]></title><description><![CDATA[FFmpegに限らずですが、動画の一部を無音にするとき”音声データの削除”と”無音データに置き換え”の区別がついていないと爆死する。]]></description><link>https://hori-ryota.com/blog/2016-06-19-ffmpeg-mp4-part-to-silence-nosound-missing/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-06-19-ffmpeg-mp4-part-to-silence-nosound-missing/</guid><pubDate>Sun, 19 Jun 2016 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;FFmpegに限らずですが、動画の一部を無音にするとき”音声データの削除”と”無音データに置き換え”の区別がついていないと爆死する。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;作業手順&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;動画を切り分ける（音声を抜く部分、その前後、の3つに）&lt;/li&gt;
&lt;li&gt;音声を無音に変換する&lt;/li&gt;
&lt;li&gt;1で分けた動画を結合する&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;音を消すだけじゃダメ&lt;/h2&gt;
&lt;p&gt;無音音声の動画と音声データがない動画は別のものです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d5ccabb46ea9f698e44838a354f2f993/99072/figure1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 35.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAAqElEQVQY06WQzQqDMBCEff/H6rXHQvEPWhBjtRRNNUkTsztNoGCrBw8dPvaQZZjNJNgXwY0gB/jVIonDeSgLYrh5zexJK3svoTvbt59HosXsr7fX4cSTRl6jWDNnla5TDJkqc2QCaQWpopU5wR+K5krSUTA/dYwqxS+NyyrZS8sYLuGQhguBUS/JD0XnznP4+WS20GhqSa2CNxYhYDShiK/C9uQodrrVG0gHl/nwMXTNAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;無音音声の動画と音声データがない動画の違い&quot;
        title=&quot;無音音声の動画と音声データがない動画の違い&quot;
        src=&quot;/static/d5ccabb46ea9f698e44838a354f2f993/fcda8/figure1.png&quot;
        srcset=&quot;/static/d5ccabb46ea9f698e44838a354f2f993/12f09/figure1.png 148w,
/static/d5ccabb46ea9f698e44838a354f2f993/e4a3f/figure1.png 295w,
/static/d5ccabb46ea9f698e44838a354f2f993/fcda8/figure1.png 590w,
/static/d5ccabb46ea9f698e44838a354f2f993/99072/figure1.png 842w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;音声データがない動画を音声データのある動画と結合した場合、図のように部分的に音声データが欠落している動画となるのですが、 プレーヤーが上手いこと補ったりスルーしてくれるわけでもなく、再生時に不具合となります。&lt;/p&gt;
&lt;p&gt;なので、代わりの音声データ（無音）をきちんと入れてあげましょう、という話。&lt;/p&gt;
&lt;p&gt;以下、正しい作業手順を貼っておきます&lt;/p&gt;
&lt;h2&gt;具体的な手順&lt;/h2&gt;
&lt;h3&gt;1. 動画を切り分ける&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/ffmpeg-mp4-cut&quot;&gt;FFmpegで秒数を指定して動画を切り出すワンライナー&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;上記は切り出すコマンドなので、3回叩きます。切り分けるコマンドもあるのかな？&lt;/p&gt;
&lt;p&gt;50秒-60秒を無音にしたいのであれば&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;ffmpeg -i src.mp4 -t &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt; before.mp4
ffmpeg -ss &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt; -i src.mp4 -t &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt; target.mp4
ffmpeg -ss &lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt; -i src.mp4 after.mp4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ですね。 &lt;code class=&quot;language-text&quot;&gt;-c copy&lt;/code&gt; オプションは速いですが時間がズレるので、つけずにトランスコードしたほうが良いかと思います。&lt;/p&gt;
&lt;h3&gt;2. 音声を無音に変換する&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;ffmpeg -i target.mp4 -f lavfi -i &lt;span class=&quot;token assign-left variable&quot;&gt;aevalsrc&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; -c:v copy -map &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;:0 -map &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;:0 -shortest -ac &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; -strict -2 silence.mp4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;軽く解説すると、ffmpegは &lt;code class=&quot;language-text&quot;&gt;-i&lt;/code&gt; オプションで指定されるデータ元を0からの連番で数えているので&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;0番目のデータ&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;-i target.mp4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;1番目のデータ&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;-f lavfi -i &lt;span class=&quot;token assign-left variable&quot;&gt;aevalsrc&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;となります。この1番目のデータはFFmpegのフィルタで無音データを生成しています。&lt;/p&gt;
&lt;p&gt;出力部ですが、&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;-map &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;n番目の入力データの&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;:&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;n番目のストリーム&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;という書式です。なので&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;-map &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;:0 -map &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;:0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;は &lt;code class=&quot;language-text&quot;&gt;0番目の入力データの0番目のストリーム&lt;/code&gt; と &lt;code class=&quot;language-text&quot;&gt;1番目の入力データの0番目のストリーム&lt;/code&gt; を使うという意味になります。&lt;/p&gt;
&lt;p&gt;他のオプションは&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;-c:v copy&lt;/code&gt; : 映像データをトランスコードせずにそのまま使う&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;-shortest&lt;/code&gt; : 入力データのうち最も短いものに長さを合わせる。今回は1番目の入力がフィルタで無限なので、つけないと終わらない&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;-ac 2&lt;/code&gt; : &lt;code class=&quot;language-text&quot;&gt;1&lt;/code&gt; はモノラル、 &lt;code class=&quot;language-text&quot;&gt;2&lt;/code&gt; はステレオ。元動画に合わせるといいかと&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;-strict -2&lt;/code&gt; : 音声コーデックがaacの場合に必要なもの。今回は明示的に &lt;code class=&quot;language-text&quot;&gt;-c:a&lt;/code&gt; でコーデックを指定していないが、aacなので。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;です。&lt;/p&gt;
&lt;h3&gt;3. 動画を結合する&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/ffmpeg-mp4-concatenate&quot;&gt;FFmpegでMP4を結合（concat）するワンライナー&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/blog/mp4box-mp4-concatenate&quot;&gt;MP4BoxでMP4を結合（concat）するワンライナー&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;らへんを参考にして結合。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;ffmpeg -i &lt;span class=&quot;token string&quot;&gt;&quot;concat:before.mp4|silence.mp4|after.mp4&quot;&lt;/span&gt; -c copy dst.mp4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;以上。&lt;/h2&gt;
&lt;p&gt;動画のfpsが途中で変わっているとか、音声の周波数が〜とか、細かい条件がなければこんな感じで5コマンドくらいですね。&lt;/p&gt;
&lt;p&gt;無音ではなくピー音で置き換える場合は工程2の入力データをピー音に差し替えてあげてください。拾ってきてもいいし、 &lt;code class=&quot;language-text&quot;&gt;aevalsrc&lt;/code&gt; を&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;aevalsrc&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;sin(880*2*PI*t)&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;のように指定して音声を作ってあげてもいいかと。 &lt;code class=&quot;language-text&quot;&gt;880&lt;/code&gt; が周波数なので大きくすれば高音に、小さくすれば低音になります。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[FFmpegで秒数を指定して動画を切り出すワンライナー]]></title><description><![CDATA[FFmpegで秒数を指定して動画の好きなところを切り出すワンライナー]]></description><link>https://hori-ryota.com/blog/2016-06-18-ffmpeg-mp4-cut/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-06-18-ffmpeg-mp4-cut/</guid><pubDate>Sat, 18 Jun 2016 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;FFmpegで秒数を指定して動画の好きなところを切り出すワンライナー&lt;/p&gt;
&lt;!--more--&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;ffmpeg -ss 120 -i src.mp4 -t 30 -c copy dst.mp4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記の例だと &lt;code class=&quot;language-text&quot;&gt;120&lt;/code&gt; 秒から &lt;code class=&quot;language-text&quot;&gt;30&lt;/code&gt; 秒だけ切り出します。&lt;/p&gt;
&lt;p&gt;つまり&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;ffmpeg -ss [スタート秒数] -i [元ファイル] -t [長さ] -c copy [出力ファイル]&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-c copy&lt;/code&gt; によりトランスコードせずに出力しているため爆速です。&lt;/p&gt;
&lt;p&gt;もし開始タイミングや動画の長さがズレる場合は &lt;code class=&quot;language-text&quot;&gt;-c copy&lt;/code&gt; オプションを外してトランスコードすると良くなるかと思います。&lt;/p&gt;
&lt;p&gt;スタート秒数、長さは指定しなければ冒頭、末尾になります。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[MP4BoxでMP4を結合（concat）するワンライナー]]></title><description><![CDATA[MP4BoxでMP4を結合（concat）するワンライナー。]]></description><link>https://hori-ryota.com/blog/2016-06-17-mp4box-mp4-concatenate/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-06-17-mp4box-mp4-concatenate/</guid><pubDate>Fri, 17 Jun 2016 14:00:00 GMT</pubDate><content:encoded>&lt;p&gt;MP4BoxでMP4を結合（concat）するワンライナー。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;&lt;a href=&quot;ffmpeg-mp4-concatenate&quot;&gt;FFmpegでMP4を結合（concat）するワンライナー&lt;/a&gt; の &lt;a href=&quot;http://www.videohelp.com/software/mp4box&quot;&gt;MP4Box&lt;/a&gt; 版です。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://www.videohelp.com/software/mp4box&quot;&gt;MP4Box&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;mp4box -add src1.mp4 -cat src2.mp4 -cat src3.mp4 -new dst.mp4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;1ファイル目だけ &lt;code class=&quot;language-text&quot;&gt;-add&lt;/code&gt; オプションで、残りは &lt;code class=&quot;language-text&quot;&gt;-cat&lt;/code&gt; で指定。ワンライナーと書いたけど、どちらかと言えばAppサーバーなどから外部コマンドとして実行するときにコマンドが組み立て易くて便利。&lt;/p&gt;
&lt;p&gt;concatするだけならインストールもFFmpegより軽いしとりあえず使える。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[FFmpegでMP4を結合（concat）するワンライナー]]></title><description><![CDATA[FFmpegでMP4を結合（concat）するワンライナー。]]></description><link>https://hori-ryota.com/blog/2016-06-16-ffmpeg-mp4-concatenate/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2016-06-16-ffmpeg-mp4-concatenate/</guid><pubDate>Thu, 16 Jun 2016 14:00:00 GMT</pubDate><content:encoded>&lt;p&gt;FFmpegでMP4を結合（concat）するワンライナー。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;少ない元ファイルのFFmpeg concat&lt;/h2&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;ffmpeg -i &lt;span class=&quot;token string&quot;&gt;&quot;concat:1.mp4|2.mp4|3.mp4&quot;&lt;/span&gt; -c copy dst.mp4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;大量の元ファイルのFFmpeg concat&lt;/h2&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;ffmpeg -f concat -safe &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; -i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; src/*.mp4&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;file &apos;&lt;span class=&quot;token environment constant&quot;&gt;$PWD&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;$f&lt;/span&gt;&apos;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; -codec copy dst.mp4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;src/&lt;/code&gt; 以下に結合したいMP4ファイルを置いて、 &lt;code class=&quot;language-text&quot;&gt;dst.mp4&lt;/code&gt; として出力。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-codec copy&lt;/code&gt; の指定でトランスコードせずにそのまま出力しているので、出力をMP4以外にする時や、コーデックを変更するときは外して別オプションを指定。&lt;/p&gt;
&lt;p&gt;この書き方だと &lt;code class=&quot;language-text&quot;&gt;src/**/*.mp4&lt;/code&gt; みたいに入れ子をまとめられないので、必要なら &lt;code class=&quot;language-text&quot;&gt;ls src/**/*.mp4 | xargs -I{} mv {} src/&lt;/code&gt; でまとめると楽。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Homebrew caskの古いバージョンを削除するワンライナー]]></title><description><![CDATA[Homebrew caskで古いバージョンのファイルを削除するワンライナーを作りました。 公式では非推奨として実装されていない機能なので、利用に関しては自己責任でお願いします。]]></description><link>https://hori-ryota.com/blog/2015-07-11-remove-outdated-files-of-brew-cask/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2015-07-11-remove-outdated-files-of-brew-cask/</guid><pubDate>Sat, 11 Jul 2015 10:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Homebrew caskで古いバージョンのファイルを削除するワンライナーを作りました。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;公式では非推奨として実装されていない機能なので、利用に関しては自己責任でお願いします。&lt;/strong&gt;&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;とりあえずコード&lt;/h2&gt;
&lt;p&gt;これ。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; /opt/homebrew-cask/Caskroom/*&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;vl&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ls&lt;/span&gt; -t $c&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${vl&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;@&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;1}&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; -rf &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$c&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;$v&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;aliasとか設定しておくと便利そう。こんな感じ。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;alias&lt;/span&gt; brew-cask-clean-outdated&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;for c in /opt/homebrew-cask/Caskroom/*; do vl=(&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ls&lt;/span&gt; -t $c&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;) &amp;amp;&amp;amp; for v in &quot;&lt;span class=&quot;token variable&quot;&gt;${vl&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;@&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;1}&lt;/span&gt;&quot;; do rm -rf &quot;&lt;span class=&quot;token variable&quot;&gt;$c&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;$v&lt;/span&gt;&quot;; done; done&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;説明&lt;/h2&gt;
&lt;p&gt;Homebrew caskは&lt;code class=&quot;language-text&quot;&gt;brew cask install application-name&lt;/code&gt;みたいなコマンドでアプリがインストールできる便利なツールです。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://caskroom.io/&quot;&gt;Homebrew Cask&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;とまぁ便利なのですが、installしてあるアプリのアップデート周りが諸々の事情で難しく…。&lt;/p&gt;
&lt;p&gt;自分は以下のワンライナーをalias登録して、updateコマンドとして使っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;alias&lt;/span&gt; brew-cask-update&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;for c in &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;brew cask list&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;; do ! brew cask info &lt;span class=&quot;token variable&quot;&gt;$c&lt;/span&gt; | grep -qF &quot;Not installed&quot; || brew cask install &lt;span class=&quot;token variable&quot;&gt;$c&lt;/span&gt;; done&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/caskroom/homebrew-cask/issues/309#issuecomment-36743989&quot;&gt;brew cask upgrade · Issue #309 · caskroom/homebrew-cask&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;このスクリプトで新しいバージョンがCaskに登録されていればインストールされるのですが、古いバージョンの削除まではやってくれません。（不具合生じる可能性があるから組み込んでないとかなんとか）&lt;/p&gt;
&lt;p&gt;困るのがAlfredなどを使用している場合で、&lt;code class=&quot;language-text&quot;&gt;/opt/homebrew-cask/Caskroom/&lt;/code&gt;下にあるアプリを見に行くので古いバージョンも拾ってしまうのです。&lt;/p&gt;
&lt;p&gt;ので、あくまで自己責任の範囲で作成したのが冒頭のスクリプト。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; /opt/homebrew-cask/Caskroom/*&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;vl&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ls&lt;/span&gt; -t $c&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${vl&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;@&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;1}&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; -rf &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$c&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;$v&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Caskroomディレクトリ下のアプリ全てに対し、バージョンごとのディレクトリを日時情報で降順ソート→2つ目から削除って感じです。&lt;/p&gt;
&lt;p&gt;updateコマンド時に削除しようとするとこんな感じ？&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;alias&lt;/span&gt; brew-cask-update&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;for c in &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;brew cask list&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;; do ! brew cask info &lt;span class=&quot;token variable&quot;&gt;$c&lt;/span&gt; | grep -qF &quot;Not installed&quot; || brew cask install &lt;span class=&quot;token variable&quot;&gt;$c&lt;/span&gt;; done &amp;amp;&amp;amp; brew-cask-clean-outdated&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;アップデート時に削除するだけでいいならこれでいいかも。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;alias&lt;/span&gt; brew-cask-update&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;for c in &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;brew cask list&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;; do ! brew cask info &lt;span class=&quot;token variable&quot;&gt;$c&lt;/span&gt; | grep -qF &quot;Not installed&quot; || brew cask uninstall &lt;span class=&quot;token variable&quot;&gt;$c&lt;/span&gt; --force &amp;amp;&amp;amp; brew cask install &lt;span class=&quot;token variable&quot;&gt;$c&lt;/span&gt;; done&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;新しいバージョンに切り替える前にアンインストールしちゃうのが気持ち悪いので、私はとりあえず前者の方を使ってみてます。&lt;/p&gt;
&lt;p&gt;もしこうしたほうがいいよ！とかあれば教えて下さい〜&lt;/p&gt;</content:encoded></item><item><title><![CDATA[AWAの音楽をPC（Mac）で聴く方法]]></title><description><![CDATA[大盛況な音楽アプリ『AWA』ですが、基本的にはPCを使用しているので作業中はMacにイヤホン挿しておきたいのです。ということで、AWAの音楽をMacで聴く方法をご紹介。]]></description><link>https://hori-ryota.com/blog/2015-06-05-listen-to-music-on-awa-with-mac/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2015-06-05-listen-to-music-on-awa-with-mac/</guid><pubDate>Thu, 04 Jun 2015 15:35:00 GMT</pubDate><content:encoded>&lt;p&gt;大盛況な音楽アプリ『AWA』ですが、基本的にはPCを使用しているので作業中はMacにイヤホン挿しておきたいのです。ということで、AWAの音楽をMacで聴く方法をご紹介。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;&lt;strong&gt;Yosemite以降のOS限定です。ごめんなさい。&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://awa.fm/&quot;&gt;AWA - 音楽配信アプリ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;方針&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;同じWi-Fiに接続して〜というのは私の作業環境的に却下。&lt;/li&gt;
&lt;li&gt;AWAの音楽だけ飛ばすのは難しそうなので、iPhoneの音声をまるっと飛ばす。&lt;/li&gt;
&lt;li&gt;無線は妥協。USB（Lightningケーブル）で。&lt;/li&gt;
&lt;li&gt;OSはYosemiteで動けばOK&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;使うもの&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;QuickTime Player（最初からMacに入っている）&lt;/li&gt;
&lt;li&gt;Lightningケーブル（iPhoneの充電ケーブルです）&lt;/li&gt;
&lt;li&gt;OS X Yosemite&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;やり方&lt;/h2&gt;
&lt;h3&gt;1. LightningケーブルでiPhoneをMacに接続&lt;/h3&gt;
&lt;h3&gt;2. QuickTime Playerを起動&lt;/h3&gt;
&lt;p&gt;これ。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 358px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/39d71c55a6c6627b062188c4bc19d9ac/39185/quick-time-player.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 119.59459459459461%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAAsSAAALEgHS3X78AAACwElEQVQ4y5WUS08TURiG+Q0IhXY6dNrOTNuZ6fRiIfQCDZReaAulQghMQqWNoaUXpEaTgiZEq6IBLyxMIOrCjWsXxmhwZ2JiTNy5kZ2/wJiYGBfiy4y0gLTgu5icy/ec9ztzvnNaBg9oQNbBdnO11MhgMBgKhcLhcEjW8CnUUvOJx+O5XG5KliRJIyMjoyep7hyLxQCnUql8Pl+pVKLRaCKROBUM50gkEpWFFJLJZLyxYvuqO/f39/v25fV6fY3l9/vrPywQCKBvMBhIkuzaF0VROp2uS7cntGvjWq3WarUODQ0B/AvDFhEKjGhEqFTthEatJYjODlVnRwdGazDP80dhvV4PGCRBaGiGmZDSV6+v3rhzr1Be8vQNatTq2rrHw3sLE4TZwl+sVO8/erJ083F55Wl1fXP1wWZkdBKJNIPhrNWSk6n58vItn/Rck/yiSn5lzr2fyq2Xl6uObg+SQszxMNYW7K4LhUsD6a3W7Hfy8g/DlW9ti7+p859m88vx8WmCIBo5GzQatavXJ82kzeV3ZzZ2o9U3CysPbWs7rXd/hTO3x8YnKL0BfANnghAdZ0OBAH3tddvLXc/G2/nZ1Mx8mV372DO56O/zNoOREs2ael1OYbzUvv2z7fOuY+tVIjE2OJywd7sFq3DCUWGaMZmsZhMzvdD57IPqxY4gFXtsVsEqGmn6ZBiiaVpg9IKF40QHDHmeA8xxfLOjwn5qZUTqKJpFsdA0Y8QJoUZphiW7yIZ7NpvNlCyj0YgC3stTtrLZbAzDqNVqpYSPhwuFAq50Op2em5vDxc5kMujiVmez2WKxiHteKpVw4ViWxbNzCEa2HMc5HA5BwCZ5mJhMJrQtFgvcMOXxeJACto0E687KY+ByuURRRLaiLLvdjlCl7XQ68cVC+GLQ7XbDrw5DWEx5A4P/6MiUQh6CB/5HCvIHGyVj1GamSl0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;QuickTime Player&quot;
        title=&quot;QuickTime Player&quot;
        src=&quot;/static/39d71c55a6c6627b062188c4bc19d9ac/39185/quick-time-player.png&quot;
        srcset=&quot;/static/39d71c55a6c6627b062188c4bc19d9ac/12f09/quick-time-player.png 148w,
/static/39d71c55a6c6627b062188c4bc19d9ac/e4a3f/quick-time-player.png 295w,
/static/39d71c55a6c6627b062188c4bc19d9ac/39185/quick-time-player.png 358w&quot;
        sizes=&quot;(max-width: 358px) 100vw, 358px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;3. 音声録音モードを起動&lt;/h3&gt;
&lt;p&gt;メニューのFileから新規音声録音を起動&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/63a91fbc59513907cb4ca4963fddd3f1/4ef49/new-audio-record.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 79.05405405405406%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/ElEQVQoz4WTbWvaYBSG/Sn7T/tQu6FRmeKwwvplY9/mylZGhWp0Vg3mpWkW0LhoTGM08aV5T7QJlK6yf7ODASmbZjeHmwTO9ZzznMMTcxxnOBxqmtbtdgf8QBCEPs/LIv+B8l98fDrnfG9tBJunuak//N4sLUNezPxfj7rnLGwzlslkUqlUOp1OJpPgCIKAHx3HL8/K41Z/VL+WG4SKMbe1jtKkpy161RX16964jrPf0FgikQAs9FBIIvky+ZrOvn88LcunX8Ynn5V3X6VCCWJSPNuU6XXpSnz7SXtTiiH/CBo5enX8/fzCveHlK0pukBDjBinVceESsxj+npPU1g17Ud8Px+PxSg1d2uZPSRQVeWbq3kNg+2sI635lrNzb2RSjiINwDa1NxjKJk0N+wDI/RGHk2o7nOCvXM3W93+sRHTwCRhVFYRiG4ziapieTibsVbAfcMAwMww63XamsPG+5XNq2vcNCWZYFTpLkQbharQIwnU538E4Aa3d3BEH8B4bOF4sFZD+H9a0oioqCPc9VVXU2n/9VHM4KggAGEQVDkiRJcO1wSDvBbxD4UZVRFAUSx/HRSAwnFCrsAt5Cs9mMqgwXE0URlgSpz6cdNtLpdKJWNVNVlmXhCMg2TdPaKvyAPbfb7T0wCJ5HNpstnhTz+XyhUCjuUy6X+wNZLiO6cgdaLQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;音声録音モード&quot;
        title=&quot;音声録音モード&quot;
        src=&quot;/static/63a91fbc59513907cb4ca4963fddd3f1/fcda8/new-audio-record.png&quot;
        srcset=&quot;/static/63a91fbc59513907cb4ca4963fddd3f1/12f09/new-audio-record.png 148w,
/static/63a91fbc59513907cb4ca4963fddd3f1/e4a3f/new-audio-record.png 295w,
/static/63a91fbc59513907cb4ca4963fddd3f1/fcda8/new-audio-record.png 590w,
/static/63a91fbc59513907cb4ca4963fddd3f1/efc66/new-audio-record.png 885w,
/static/63a91fbc59513907cb4ca4963fddd3f1/4ef49/new-audio-record.png 890w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;4. 入力元をiPhoneに&lt;/h3&gt;
&lt;p&gt;名前は設定によって違うと思いますが、iTunesとかで表示される端末名があるはず&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d1bb6a82cff2ed59043afa8545c5e5c7/078fe/change-source-to-iphone.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 57.432432432432435%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACOElEQVQoz1WS2W7TQBSG/S5IzeI9tuPx2KntOM6KFDt2bMf1kqRNG0BVui+kqBuNyk1zQUGIVjwBd1xU3MED8E5MgnrBr0+a0ZF+nf+cGSxOkth148B2Op122+o+y/M827bbzwp7vcGg30/7SOhElzRNMTcIukAMarQgcCRJaaqmazrCrJjFYjGTz1E0nclkVU0LorUloR/2wjhemh2HZNhsjsLzBM/xBbZA0wyOkwzNCJygFkRVlINWe399/Pl89u3i9uvVhy+Xtzd7J2EcYSgbRZL5XI7ACcRKJltT1el4nGOY45x+kTfEDKGLcBxENztHl5OD6fbu+eRgd+t1kiSYZVksywq8gFpRJIXjhCKCas3MkITECUyhkGWpFTyPszSvQKCtymVNLquSWrL87qKzBKSyXkaZaYpmGPYFTfgrwoQxjnTrzHBPV619qXkovzxV7aneeWe4qHgoNi9rAeb7fr1Wh7KsKAosKU2ozoX2Ndc84+rzVvrgvblrxFcle1psHbPVU76OOBEaZ1xjXl3DoihC/rWg1wuCyPP3rHDH6rWaraq8GtmuZ3W8th063ValWioCHSr/UAF0HAcb9gf3b69+zj79unv8fff4NLv/fj1/ev/xz+zhx8WcByKQJAAlKENJhhClWwIg7CAzeq6N4fqr0ebWxmh9MBwNhtujsddx6hUzjWPTNEVR5Hm+uJS4FAAAVdCyFma09CiJ4wXJgjR1XBf9FBQs8P1Go2EYRuV/oQoa9i8gj8rpwf6FsQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;入力元をiPhoneに&quot;
        title=&quot;入力元をiPhoneに&quot;
        src=&quot;/static/d1bb6a82cff2ed59043afa8545c5e5c7/fcda8/change-source-to-iphone.png&quot;
        srcset=&quot;/static/d1bb6a82cff2ed59043afa8545c5e5c7/12f09/change-source-to-iphone.png 148w,
/static/d1bb6a82cff2ed59043afa8545c5e5c7/e4a3f/change-source-to-iphone.png 295w,
/static/d1bb6a82cff2ed59043afa8545c5e5c7/fcda8/change-source-to-iphone.png 590w,
/static/d1bb6a82cff2ed59043afa8545c5e5c7/efc66/change-source-to-iphone.png 885w,
/static/d1bb6a82cff2ed59043afa8545c5e5c7/078fe/change-source-to-iphone.png 934w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;以上。&lt;/h2&gt;
&lt;p&gt;簡単ですね。iPhoneの音声をまるっと転送しているので、AWA以外のアプリでももちろん使えます。&lt;/p&gt;
&lt;p&gt;Yosemiteじゃない人は、同じWi-Fi環境下なら&lt;a href=&quot;http://www.airserver.com/&quot;&gt;AirServer&lt;/a&gt;などのソフトを使ってAirPlay経由で聴くのが妥当でしょうか。&lt;/p&gt;
&lt;p&gt;Bluetooth経由ではダメそーだったのですが、もしできるようでしたら教えて下さい。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[初心者でも簡単にゲーム実況ができるように手順をまとめてみた（Mac版）]]></title><description><![CDATA[ゲーム実況をしようと思ったのですが意外とやらなきゃいけないこと、設定しなきゃいけないことが多かったのでまとめてみました。Windowsのニコ生専用ツールとかなら簡単なのですが、他はなかなか大変ですねぇ。今回はMac版。]]></description><link>https://hori-ryota.com/blog/2015-05-10-live-broadcasting-with-mac/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2015-05-10-live-broadcasting-with-mac/</guid><pubDate>Sun, 10 May 2015 10:30:00 GMT</pubDate><content:encoded>&lt;p&gt;ゲーム実況をしようと思ったのですが意外とやらなきゃいけないこと、設定しなきゃいけないことが多かったのでまとめてみました。Windowsのニコ生専用ツールとかなら簡単なのですが、他はなかなか大変ですねぇ。今回はMac版。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2&gt;やらなきゃいけないこと&lt;/h2&gt;
&lt;p&gt;ざっくりと、ゲーム実況でやらなきゃいけないことを一覧に。MacもWindowsもやりたいことは一緒です。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ゲーム画面のPCへの取り込み&lt;/li&gt;
&lt;li&gt;画面を合成して仮想映像入力の作成&lt;/li&gt;
&lt;li&gt;PCの音声出力を仮想音声入力に&lt;/li&gt;
&lt;li&gt;マイクとPCの音声を合成して、1つの仮想音声入力を作成&lt;/li&gt;
&lt;li&gt;作成した仮想入力を入力デバイスとして配信ツールに設定&lt;/li&gt;
&lt;li&gt;配信ツールに配信先を指定して、配信&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;以上。仮想なんとかっていうのが多くてややこしいですね。&lt;/p&gt;
&lt;h2&gt;仮想なんとかって&lt;/h2&gt;
&lt;p&gt;配信ツールは基本的に、マイクやカメラのような入力機器からの入力を配信します。仮想映像入力というのはキャプチャとカメラを合成したり加工したりしたものを、カメラの入力として偽装（仮想化）して扱えるようにしたものです。&lt;/p&gt;
&lt;p&gt;仮想音声入力も同じで、合成したり加工した音声をマイクの入力に偽装（仮想化）して扱えるようにしたものです。&lt;/p&gt;
&lt;p&gt;配信ツールによってはこのへんも担ってくれることもあります。楽。&lt;/p&gt;
&lt;h2&gt;1. ゲーム画面のPCへの取り込み&lt;/h2&gt;
&lt;h3&gt;iPhoneのゲーム&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://www.airserver.com/&quot;&gt;AirServer - AirPlay, Mirroring and Miracast receiver for Mac OS X and Windows PC&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;AirServerとやらを使います。iPhoneにはApple TVに画面を映すAirPlayという機能があるのですが、AirServerはPCでAirPlayの配信を受けられるようにするツールです。&lt;/p&gt;
&lt;p&gt;$14.99の有料ツールですが、7日間の試用期間があります。とても簡単なので、課金しても損はないかと。&lt;/p&gt;
&lt;h3&gt;PS3など&lt;/h3&gt;
&lt;p&gt;キャプチャーボードと呼ばれる、ゲーム機の画面をPCに表示する道具を使います。種類が豊富なので、口コミを見て動きそうなものを。&lt;/p&gt;
&lt;h3&gt;Androidのゲーム&lt;/h3&gt;
&lt;p&gt;Mobizenが良さそう。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://play.google.com/store/apps/details?id=jp.co.nttdocomo.sdlmobizen&amp;#x26;hl=ja&quot;&gt;スマートデータリンク Mobizen - Google Play の Android アプリ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;2. 画面を合成して仮想映像入力の作成&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://camtwiststudio.com/&quot;&gt;CamTwist&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;CamTwistというソフトを使って仮想映像入力を作ります。高機能なのに無料。ありがたい。&lt;/p&gt;
&lt;p&gt;ちょっと取っ付きづらいので、簡単に必須の設定を。&lt;/p&gt;
&lt;h3&gt;とりあえずプレビュー画面を表示&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Command + P&lt;/code&gt; でプレビュー画面が出ます。出さなくても仮想入力は作成されているのですが、わかりづらいので出しておいたほうがいいです。&lt;/p&gt;
&lt;h3&gt;解像度の設定&lt;/h3&gt;
&lt;p&gt;そのままだと解像度が低くて汚くなるので、解像度を上げておきます。以下の設定を。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 496px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/395a37a692a4af8c7179ef367d66c5f3/bb630/camtwist-videodevice-preference.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 101.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAEEklEQVQ4y62Uy08bVxjFbaWKSjd9pF22qsS/wF8AQkIs2IFYd59KlbrpopWgUoDuumilCikJi9ASgt2SUsA2YDDjGXvs8czY43kY2/gFxm87DoF44tNvDIHSbBqpIx3dOx7fn8797vmuzfY/PQMDAxcTfH23Nxp/rn+bYhc3NpXVlYNUypm6lBELOwV2xykGdp1RWXKm04fOZDJJSjkTiYSD5uuqqk5bjGq1arNVImE7zd/Vo9EAXrZRqhdRqVRQLlfQbNTBps6wHm1jUznFUamBWqXc+16rVtFsNmGaJgzDEInx3sLCgt12kMtZwA9VXd+rN5ooHhfPNVXtKEq8kzowOsvcs87DnXbn4e5pJ57Id/S4QlI7MUXtZHOF80q5bAE5YtyZmpqy28qlkgW8E4/HmXK5BI5lTUEQIITD4INBZJI60ocG0tkEtKSBYr2GM/M5/OlT7GlFs/msBtpyiBifzMzO2G1k3wJ+RD8yFdoOz/NmiA8RMARrDAR5iJ49yKtuZPYFHHESjgIS8jTm9wWzns5BM3QL+PHsvXvXQMthtVqBJEqmLEexJeUhZFqIqTpy8xuIPN5H0rGJhMMDY8WN1FMvjh0+83SVhZo66Dn84ZvvCFguXwOp2GI4YgrkjBPiCEk6qJbQHduIP9qAsbQO7TdLf8F44kJx1We2QirUg0QPODv1PdWw1bjYsqYxJ40qXLte0+XdwZ5/H26vBx6fF25mFzs+H7x+BltuN/a2dyBFRFCszColQdO0yxrO2m0NOXEBJId1QQV3f9mUltYgP16H8OtTKCsb0JxuKE/WoP7ughgMQRQlxKgshm6YtWrtGjhDh4IvfuwBDS/HvHD4rOKb6h9bKHh5pF0MSoyIczkJnyeDowceVEQVudIJCvkCcrmcSWG+CXyxuN0D6hGZabmCCP70yAz/soToAyfk+yuIzC/DWFyDf34N0Z+XEWU48IIVKR6yJJu12r8clp63rmpYphpygYAZoPz5ORY8ZXGfZcGwfgQ4BlyIh/WN9fvhZ/zQNf1NYKV0ccpKTGFa1EqGpplhPoyoKEMUIuRCQpQkSTHEYwqy+WPkC8coFArIZrNvbrl8GRtFURirN5VYrMNxXJdC3Q0EAt1wiO+GBaGbSGW6h4eHN5ROp02rrwnIW8HuARuNxuvWY9vtNugGeUVdA3qnDCpQ4wpyhSK5OkI+nyPlr0QOX9F66LoethzOzc3ZbZSlnkNZlr3k1vrTGZ3eSxp76s0zmav3fyqTyZydnJwgFov5LYfT09N228jIiHWVvT88PDwyOjp6d3Bw8KuhoaH/LFr/Ja0dJcYH/f399t7l2tfXd9tySfqU9Plb6jOrZLfpuXGFj4+P35qcnHxnbGzsrWStmZiYuPWa8zdght8Fxli7EAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;CamTwist VideoDevice Preference&quot;
        title=&quot;CamTwist VideoDevice Preference&quot;
        src=&quot;/static/395a37a692a4af8c7179ef367d66c5f3/bb630/camtwist-videodevice-preference.png&quot;
        srcset=&quot;/static/395a37a692a4af8c7179ef367d66c5f3/12f09/camtwist-videodevice-preference.png 148w,
/static/395a37a692a4af8c7179ef367d66c5f3/e4a3f/camtwist-videodevice-preference.png 295w,
/static/395a37a692a4af8c7179ef367d66c5f3/bb630/camtwist-videodevice-preference.png 496w&quot;
        sizes=&quot;(max-width: 496px) 100vw, 496px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;配信したい解像度と合わせておくのがおすすめです。&lt;/p&gt;
&lt;p&gt;また、Keep cameras warmをチェックしておくと、ドライバがリロードされないのでチェックしておいたほうがいいです。&lt;/p&gt;
&lt;p&gt;この設定をいじったあとは、CamTwistの再起動が必要です。&lt;/p&gt;
&lt;h3&gt;画面を組み合わせる&lt;/h3&gt;
&lt;p&gt;ここからが本番。項目が取っ付きづらいので軽く説明を。&lt;/p&gt;
&lt;h4&gt;Step 1&lt;/h4&gt;
&lt;p&gt;Step 1に表示されているのが入力元です。Webcamはカメラ、Desktop+は画面のキャプチャです。&lt;/p&gt;
&lt;p&gt;選択して左下のSelectもしくはPIPボタンを押すと、Previewに表示されるかと思います。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Select: 画面いっぱいに表示（1つの入力元のみ可能）&lt;/li&gt;
&lt;li&gt;PIP: パーツとして画面を追加。左下にカメラの映像を入れたい！などという場合はこちら。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ゲーム実況では背景画像をSelectにして、iPhoneの画面やカメラ映像などをPIPで好きなように配置するのが良さそう。&lt;/p&gt;
&lt;h4&gt;Step 2&lt;/h4&gt;
&lt;p&gt;エフェクトが追加できます。基本的には不要なのですが、たくさんあるので楽しい。&lt;/p&gt;
&lt;h4&gt;Step 3&lt;/h4&gt;
&lt;p&gt;画面やエフェクトの順番を設定します。下に行くほど手前に表示されます。エフェクトは自分より上の画面群に対して効きます。&lt;/p&gt;
&lt;h4&gt;Setting&lt;/h4&gt;
&lt;p&gt;こちらで各入力元の設定を行います。Desktop+のPIPをよく使うと思うので、そちらの設定だけ説明しておきます。&lt;/p&gt;
&lt;p&gt;PIP SettingsとDesktop+ Settingsがありますが、先にDesktop+ Settingsから。&lt;/p&gt;
&lt;h5&gt;Desktop+ Settings&lt;/h5&gt;
&lt;p&gt;ざっくり必要なとこだけ。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Screen: 表示したい画面の表示されているディスプレイを選択&lt;/li&gt;
&lt;li&gt;Full Screen: フルスクリーンにするかフラグ。外す。&lt;/li&gt;
&lt;li&gt;Confine to Application Window: 対象のApplicationの画面だけを抽出する設定。これをチェックしておくと他の画面と被っていてもちゃんと対象の画面だけを表示してくれる…のだけど、AirServerだと上手く行かなかった。Chromeなどではチェックしておいたほうが良さそう。&lt;/li&gt;
&lt;li&gt;Select capture area: 任意の画面範囲を切り取れる。自動で表示してくれる画面が気に入らない場合に。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5&gt;PIP Setting&lt;/h5&gt;
&lt;p&gt;ざっくり必要なとこだけ。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Clear background: 背景を透かすかどうか。チェックしておくのがおすすめ。&lt;/li&gt;
&lt;li&gt;Scale: サイズ。&lt;/li&gt;
&lt;li&gt;Position: 表示位置。画面のどの辺に画面パーツを配置するか決められます。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;CamTwistは以上。こんな感じ。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3f2739f9f6e6473659ee0d0ee87d07b5/38af3/camtwist.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABxklEQVQoz21Ry5LaMBDk/38mlxxyzCEPlkfKsOC3JVs2smTZkrBsA/YCO+DsBqrSh6muqWlNT2vyup69+uswxJ7vB0EQRRHC+EbC0PNcQHQHQtBGSYxIjGIUEUKm0+nEdew4cFXFPMfebrbQVVKGYbhc/kmSRGtNKWWMARFCBJlyiPYz3XbtdrudzFbxl+/pt5m2bIJCv6qkqeuilDihCUZa70FWCZFTWvBiRfqv1tHC7fD25jjOxPWiKOZ1d80oE4W4Xq+Xy2Xoh+sHuq5L0iyOCWdMlXnbNP2hGYbhJqa77HTsYEgUN4zivu+BnM9n4MfjIc0FjiI/Sj20g6OMafv+LgZX44aCc0rzkZdliTHmnO+ynZSyMbVWSpRSabPf70+nE8w8iUHAeQHLgBtjoA9DYA84y1meM0IgbAQvVlUF5m3H/ieGFkkSSAKMj7bBM9S6rhfz+XK+WLzMXn5Pgfz68RMj9LxZlClJYRVwEF/uGMVra71Zb1aW5TluGASu7cCNtm0/2c7z/DGwz7ThTngCqmmarju0bfs37YfACiHK/4phuvsA8Kb5/CpKpVQAzjgEU5vaNEYpLceuUreFDwAlVHgdxO+pA5dR3mF1pgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;CamTwist&quot;
        title=&quot;CamTwist&quot;
        src=&quot;/static/3f2739f9f6e6473659ee0d0ee87d07b5/fcda8/camtwist.png&quot;
        srcset=&quot;/static/3f2739f9f6e6473659ee0d0ee87d07b5/12f09/camtwist.png 148w,
/static/3f2739f9f6e6473659ee0d0ee87d07b5/e4a3f/camtwist.png 295w,
/static/3f2739f9f6e6473659ee0d0ee87d07b5/fcda8/camtwist.png 590w,
/static/3f2739f9f6e6473659ee0d0ee87d07b5/efc66/camtwist.png 885w,
/static/3f2739f9f6e6473659ee0d0ee87d07b5/38af3/camtwist.png 894w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;3. PCの音声出力を仮想音声入力に&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://code.google.com/p/soundflower/&quot;&gt;soundflower - Soundflower system extension for interapplication audio routing. - Google Project Hosting&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;仮想音声デバイスを作るやつ。音声の出力先としてSoundflowerを指定すると、その音声を仮想の音声入力デバイスに流してくれます。&lt;/p&gt;
&lt;p&gt;設定はこちら。Macのシステム環境設定のサウンドにて、音声の出力先をSoundFlower(2ch)にするだけです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5c50f4fcbb2dc53466edf26e48129aa7/a1792/soundflower-2ch.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAADCUlEQVQ4y6WTS28jRRDHDVzgGCcRisMJwY0brAVfgPDx9sDuEs9GWvgCSByQEERgsyHxxuPxY8bjebjn6bFnJh5Pko1X60lXUT1LIsMeaemn6uqu/nd3dXWlQs1o/fGR8eL3r8Zj44Hv+nVd0+sjdVRXB2qJ3OnWX7Tlujp8M6YNtLrL3LrDnPrEnjyYhtMvPcf7rHLXes3mwyyw0ff912mS8sAPOJuwEgrktmlxU9e5xxgnEU4iPJ7HPEkSPp/Pi5ubG/RcTyepD0rBTrcrrde3GEWzIooinEUzpAUYBCHapomG7eH3p1f4Y2eBgeeJOAxpjk4mLM8WGbLJhJFUtRRU+r1GskhQU5W1aWpgWxqYpgrGeADTkEGaRuDPYmIGaRJCtpgTM1gQZG+vXi7RdtjkXnBw1pbiMwuf/zwoOsc6nB8bcHZsYvvYBLnJoNtycPDcgfZvYzz5RUflTxflpoPdJsPzlsvZCUNX7rPKxx++EdRPTqTJTyo2vm0Xzx6d4bNGH4+ejvBI0lA6HGLjcAjSoYrfPenjk0cKSA2V/CE8pbnHhxr/9YcBhn91WOXzT6r3OVzlGUaGWiSOCa/SKazpOjxPAW+WWLLK4XYZw+uLSPQRrxcCwJcZx9UVWra9kUOlK11kGcq9QTHURtDtD+G8qxA90MYmEjAyLNRNgQ0C23EFaDGXR3GMk81H6XQ60oqePgyCgsDpdIo+vaamajgcDkFVVdB1HTVNE9BjGRD4PlCZiVLjaZL8W1CWZen6+hodxyk8z4M7wjAUUPkEAviH0qd5LONcl8fJxVuCjdVqhbR4TXCxKy0qLZ32Le7mBeQXi2yJjG2UTb/fP0JqeZ7DknIpTiAKXBBTfuhHlIj+5eUl0u/AizS99zm/FYfx7gVbrdZDui6aprmwLCu/wzCMXFGUvNfr57Qp2V45Ztt2vhGX0XVfUa4VktoSeu9sbW19uru7+/X29vbBJjs7Owe1/dpBrVY72NvbK60Yq1ar/437hviCtN6vnJ6elqLEe/+Td/f39yt/A8dCOrK4MO47AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Soundflower(2ch)&quot;
        title=&quot;Soundflower(2ch)&quot;
        src=&quot;/static/5c50f4fcbb2dc53466edf26e48129aa7/fcda8/soundflower-2ch.png&quot;
        srcset=&quot;/static/5c50f4fcbb2dc53466edf26e48129aa7/12f09/soundflower-2ch.png 148w,
/static/5c50f4fcbb2dc53466edf26e48129aa7/e4a3f/soundflower-2ch.png 295w,
/static/5c50f4fcbb2dc53466edf26e48129aa7/fcda8/soundflower-2ch.png 590w,
/static/5c50f4fcbb2dc53466edf26e48129aa7/a1792/soundflower-2ch.png 780w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで、マイクと同じように仮想音声入力デバイスとしてSoundflower(2ch)が使えるようになりました。&lt;/p&gt;
&lt;h2&gt;4. マイクとPCの音声を合成して、1つの仮想音声入力を作成&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://blog.kawauso.com/ladiocast&quot;&gt;Category Archive for “LadioCast” | Kawauso’s Blog&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Soundflowerで作成した仮想音声入力と、マイクの入力を合成して、1つの仮想音声入力にします。&lt;/p&gt;
&lt;p&gt;設定は簡単。こんな感じ。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/756aebca456e4963aeb6c44155573254/0c1c2/ladiocast.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 79.05405405405406%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAADlElEQVQ4y6WUy3PbVBjFY1ZsWELZZ8ireBhTnIawZhGXPauuWfBfsGKGDeXhadoJDUlIOwkzlCFhhgYDSfzWw5ItW2/JtixZfqVNKUxTSzpcyUmHxxLN/OY+zr1H3/k0o6kp8nB7O6/ySiFZMtRESZciipqUoEyZoCV+EWuJ36Rqgu+YibIuE01MlIheNohO7uQ15QolVOc+euf9WOg3JR08+OR3ioGVZZ/a+Yo3gfPI2nPIvHNY9tSDnNc8pj0r1Iq8Zxd4r0POdPKVZydsHTpXF1IfXH8pMuTuH6T/yNdh86LnVhpwGAHtMo8nko6W4kK5l8fo631oFAenXEXnnIeCiqFoBWLWgLN/qM9+eP2VieFRPv2QbuC7G7ee3f/sdvD9F2sBmQc/3doIjCwXdI74wM4Ugwd37gZ76TsRPxB+vLkemMeM59AKjHJFfeO9dyeGNFdJP/bOIGjyuK4rAd+oQVAl1HUVgiKh1e+iPeiB4lgUGAollkaRjGWybtqW3xsNIOua9vaV5MSQyRyl/2QVdHOVca/AB9ZBDtavJViHFIyfc3APaViSBo7jUOV51Ko11PgqhFoNTdP0XceGoija0tLSeeSd/fTjLA+1wIz1LBUoxxTULE16JMOsOxD2OXSKDFihBkmUYDsOut0u3K4Du3fiV8xTmJqixd+8MCyU0ydVFTuf3hzv3lgNvv38NsiIvdV16FkGXVaCqajYvncXX62tYX19/TmSrPhufwRVVbS3kosTQ4ph0k/OnkJtmmO1ZQai1IBsaFCaBmqyGPYpqso0TRiGEaHrOprNJizL8sNK/xGZpqj06aNHcGx73HPdoEMuWK0WOpYFXdNhtS202+3IKIza6/Xgum40tomh7XRJhaq2uHj1/KOQCgf9PorF4pjMA1lRSBQZTUOFbJ2govXRNjVkszmUSiWIogiZ6Iosod0d+uy/e8iy7JfhGzc2Ns62trb8b7a3/XDc3d31yUXfcWyfVBetNzc3I+0ConthMSSymkwmnxuuep4Hx3GCPhFt0quubUexSJQo5nA4jCKG+gUXe6PRKOxpc3l5+VJkmMlkPm40Gmc8z7t8tTpgSqUBQ1EDhmUHLMMMqmRPEIQB0aP53yF7fcIpTdPFeDz+cugXm56efm1+fn5lZmYmRViZfz2eWrh8OUX2UgsLC6nZ2dnUufYfiLZCzlybm5u7GovFXpwiUSNTwgv/k+jX9RfMimuO1X64iAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;LadioCast&quot;
        title=&quot;LadioCast&quot;
        src=&quot;/static/756aebca456e4963aeb6c44155573254/fcda8/ladiocast.png&quot;
        srcset=&quot;/static/756aebca456e4963aeb6c44155573254/12f09/ladiocast.png 148w,
/static/756aebca456e4963aeb6c44155573254/e4a3f/ladiocast.png 295w,
/static/756aebca456e4963aeb6c44155573254/fcda8/ladiocast.png 590w,
/static/756aebca456e4963aeb6c44155573254/efc66/ladiocast.png 885w,
/static/756aebca456e4963aeb6c44155573254/c83ae/ladiocast.png 1180w,
/static/756aebca456e4963aeb6c44155573254/0c1c2/ladiocast.png 1542w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;仮想入力（Soundflower(2ch)）と、マイク入力を合成して、仮想入力（Soundflower(64ch)）を作っています。&lt;/p&gt;
&lt;p&gt;こうして作成したSoundflower(64ch)の仮想入力デバイスを、配信ソフトの音声入力元として使えばOKです。&lt;/p&gt;
&lt;h2&gt;5. 作成した仮想入力を入力デバイスとして配信ツールに設定&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://www.adobe.com/jp/products/flash-media-encoder.html&quot;&gt;メディアエンコーダー、ビデオキャプチャソフトウェア、オーディオキャプチャソフトウェア | Adobe Flash Media Live Encoder&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;配信ツールは何でもいいのですが、MacではFMEと呼ばれるこちらのソフトがよく使われるようです。&lt;/p&gt;
&lt;p&gt;こちらのように、Videoの入力元としてCamTwistを、Audioの入力元としてSoundflower(64ch)を使用します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/82aca39eacf9ae8bd6ffc8d8e1e725f9/0d98f/fme-device-settings.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 16.216216216216214%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAp0lEQVQI1x3OawuCMBiGYX9gEM5N5953m5mHDlqUh2GoCQVF2IegH9wIrq/3w+NEnI2QGapqFxqCNcHmr/ZkSzD3sYrSA8OCipJhycAqGBwpxix0Co9++K5X+aS3A2bG11ZLVcv0EMSPhfzy/VOlcxTPq+Sl1/cQR5+/KdyW4GhOLyIZZH5Vm47HJohsdnLFmYB9kfmig2SSeQ+JYcqO1gQqAsaFDRU/E2VGeZE6KsoAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;device settings&quot;
        title=&quot;device settings&quot;
        src=&quot;/static/82aca39eacf9ae8bd6ffc8d8e1e725f9/fcda8/fme-device-settings.png&quot;
        srcset=&quot;/static/82aca39eacf9ae8bd6ffc8d8e1e725f9/12f09/fme-device-settings.png 148w,
/static/82aca39eacf9ae8bd6ffc8d8e1e725f9/e4a3f/fme-device-settings.png 295w,
/static/82aca39eacf9ae8bd6ffc8d8e1e725f9/fcda8/fme-device-settings.png 590w,
/static/82aca39eacf9ae8bd6ffc8d8e1e725f9/efc66/fme-device-settings.png 885w,
/static/82aca39eacf9ae8bd6ffc8d8e1e725f9/c83ae/fme-device-settings.png 1180w,
/static/82aca39eacf9ae8bd6ffc8d8e1e725f9/0d98f/fme-device-settings.png 1276w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;6. 配信ツールに配信先を指定して、配信&lt;/h2&gt;
&lt;p&gt;配信先を入力します。この設定は配信先ごとで異なるので、配信先のヘルプなどを参照してください。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ef1cc551b27cb71a8e29fd4948c3de5d/d67fd/fme-stream-settings.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAA+UlEQVQoz3WR63KDIBCF85CJMaJFhOWiiTfI2B8+fA9ip3acfDPiAnvYw3LJ87yqqrrmnH8BzmvQCMG3CCuPz1wglkr1r77rWmNMC5wbxtE5h5BI38D1iuH+nyjGTwjR90PbdUI00zh676dpWjaC9yEEBPM8GaPNL0RUFEWsXJallEpKCe9a66226+Bk+6zFzGG9OYB6UayI3iE8n69hGHAeVkntYEppjOgj2I1iWGeMQYP2oHPIstYiNR1/JlVG8m4bejjEPTVp7+d1XZflG9btCdRMHv7uDHFqIOIsy24b9xPYReHUMHjcn+r4dMVnkFnXIl2fMUwfP7GCzc9wxttQAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Stream settings&quot;
        title=&quot;Stream settings&quot;
        src=&quot;/static/ef1cc551b27cb71a8e29fd4948c3de5d/fcda8/fme-stream-settings.png&quot;
        srcset=&quot;/static/ef1cc551b27cb71a8e29fd4948c3de5d/12f09/fme-stream-settings.png 148w,
/static/ef1cc551b27cb71a8e29fd4948c3de5d/e4a3f/fme-stream-settings.png 295w,
/static/ef1cc551b27cb71a8e29fd4948c3de5d/fcda8/fme-stream-settings.png 590w,
/static/ef1cc551b27cb71a8e29fd4948c3de5d/d67fd/fme-stream-settings.png 670w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;設定は以上です。Startボタンを押すと配信されるはずです。Bit Rateや解像度の設定は各配信先ごとに最適設定があると思うので、先人たちの設定を参考に。Windows用ソフトでもやっていることは変わらないので、数値は真似するといいと思います。&lt;/p&gt;
&lt;h2&gt;おわりに&lt;/h2&gt;
&lt;p&gt;Windowsでニコ生だと&lt;a href=&quot;http://live.nicovideo.jp/s/encoder/&quot;&gt;Niconico Live Encoder - ニコニコ生放送&lt;/a&gt;のような専用ソフトがあって手軽なのですが（画面の合成とかもこのソフトだけでできる）、Macだったり、いろんな配信先を想定したりすると難しいですね。&lt;/p&gt;
&lt;p&gt;配信先ごとに最適な設定値がことなるので、プリセットとして主要な配信先用の設定が組み込まれていないと非常にめんどくさい…。&lt;/p&gt;
&lt;p&gt;何やっているのかわかってしまえばそんなに難しくはないのですが、初心者が手軽に、と考えるとまだまだハードルが高い印象でした。特にMacは。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[HugoとCircleCIでGitHub PagesにBlogを公開してみた]]></title><description><![CDATA[みたいな、GitHubドメインの技術ブログかっこいいよね〜と思ったので流行りのHugoとCircleCIを組み合わせて作ってみました。無料。 それぞれのツールを軽く紹介した上で、実際に設定した手順をのせておきます。Mac用。]]></description><link>https://hori-ryota.com/blog/2015-04-17-create-blog-with-hugo-and-circleci/</link><guid isPermaLink="false">https://hori-ryota.com/blog/2015-04-17-create-blog-with-hugo-and-circleci/</guid><pubDate>Fri, 17 Apr 2015 00:30:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;hori-ryota.github.io&lt;/code&gt; みたいな、GitHubドメインの技術ブログかっこいいよね〜と思ったので流行りのHugoとCircleCIを組み合わせて作ってみました。無料。&lt;/p&gt;
&lt;p&gt;それぞれのツールを軽く紹介した上で、実際に設定した手順をのせておきます。Mac用。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;まだ作ったばかりなので設定漏れしているところとか画像の最適化がまだだったりとか色々ありますが、とりあえず公開まではこじつけられるかと思います。&lt;/p&gt;
&lt;h2&gt;完成後の記事作成フロー&lt;/h2&gt;
&lt;p&gt;記事の作成フローはこんな感じになります。お気に召さなければ違うツールのほうがいいかもです。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;hugo new post/aritcle-title.md&lt;/code&gt;で記事の作成&lt;/li&gt;
&lt;li&gt;Markdown形式で記事を書く&lt;/li&gt;
&lt;li&gt;gitでpushする&lt;/li&gt;
&lt;li&gt;CircleCIがpushを検知して自動公開&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;CircleCIを使うことでpush ≒ 公開になるので楽。&lt;/p&gt;
&lt;h2&gt;HugoとかCircleCIとかGitHub Pagesとかって何&lt;/h2&gt;
&lt;p&gt;まずはざっくり説明。&lt;/p&gt;
&lt;h3&gt;Hugo&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://gohugo.io/&quot;&gt;Hugo :: A fast and modern static website engine&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Go言語で書かれた静的サイトジェネレーター。静的サイトジェネレーターというのはテンプレや記事のテキストデータからhtmlなどなど、公開用のデータを静的に吐き出してくれるやつ。&lt;/p&gt;
&lt;p&gt;ブログといえばWordPressというイメージがありますが、アクセス集中すると重いし、セキュリティも面倒だし…というのでなんか重宝されてきているらしい。&lt;/p&gt;
&lt;p&gt;GitHub Pagesに投げとけば無料だし、エンジニアっぽい（小並感）し。&lt;/p&gt;
&lt;p&gt;Markdownで書いておけば、他のツールを使いたくなった時の移行コストも少ないと思われるので、始める心理的な障壁が低いのも良い。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://octopress.org/&quot;&gt;Octopress&lt;/a&gt;とか&lt;a href=&quot;https://hexo.io/&quot;&gt;Hexo&lt;/a&gt;とかもありますが、Hugoの方が変換が爆速らしいっていうのと、Go言語っていうのにミーハー心を刺激され、Hugoにしてみました。&lt;/p&gt;
&lt;h3&gt;CircleCI&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://circleci.com/&quot;&gt;CircleCI&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;いわゆるCIツール。JenkinsとかTravisCIとか。&lt;/p&gt;
&lt;p&gt;基本的にはGitHubにPushされたコードを何か色々処理してくれるという感じのやつ。&lt;/p&gt;
&lt;p&gt;Hugoは変換までしかやらずにデプロイとかは人任せなので、CircleCIで公開は行うようにします。なんか聞きなれないと難しそうだけど、やったら簡単でした。&lt;/p&gt;
&lt;p&gt;Jenkinsは自分で用意するのが面倒で、TravisCIはPrivateリポジトリが有料。&lt;/p&gt;
&lt;p&gt;CircleCIは並列性に課金する料金システムなので、並列性0の順次ビルドであればPrivateリポジトリでも無料。すごい。&lt;/p&gt;
&lt;h3&gt;GitHub Pages&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://pages.github.com/&quot;&gt;GitHub Pages&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;GitHubに静的WebコンテンツをあげておくとWebページとして見られるようにしてくれるGitHubのすばらしい機能。無料。ありがたい。&lt;/p&gt;
&lt;p&gt;実は2種類あって&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;ユーザー名.github.io&lt;/code&gt; で公開されるGitHub Pages&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;ユーザー名.github.io/リポジトリ名&lt;/code&gt; で公開されるGitHub Pages&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;の2種で、Hugoのドキュメント（&lt;a href=&quot;http://gohugo.io/tutorials/github-pages-blog/&quot;&gt;Hosting on GitHub Pages&lt;/a&gt;）に書いてあるのは後者。&lt;/p&gt;
&lt;p&gt;今回は前者の &lt;code class=&quot;language-text&quot;&gt;ユーザー名.github.io&lt;/code&gt; で公開したかったので、そちらの手順をまとめます。&lt;/p&gt;
&lt;h2&gt;Hugoのインストール&lt;/h2&gt;
&lt;p&gt;選択肢は2つ。Goを使って&lt;code class=&quot;language-text&quot;&gt;go get github.com/spf13/hugo&lt;/code&gt;するか、Homebrewで&lt;code class=&quot;language-text&quot;&gt;brew install hugo&lt;/code&gt;か。&lt;/p&gt;
&lt;p&gt;GoとHomebrewの入れ方はそれぞれのドキュメントを参照。&lt;/p&gt;
&lt;h2&gt;ベースのファイルの作成&lt;/h2&gt;
&lt;p&gt;好きな場所で&lt;code class=&quot;language-text&quot;&gt;hugo new site サイト名&lt;/code&gt;をすると、サイト名のディレクトリが作成され、その中に色々入ってきます。&lt;code class=&quot;language-text&quot;&gt;hugo new site horiblog&lt;/code&gt;みたいな。&lt;/p&gt;
&lt;p&gt;こんな感じになります。ざっくり。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;▸ archetypes/ # categoriesとかtagsとかのメタデータを設定するところ
▸ content/    # 記事データとか、コンテンツデータを置くところ
▸ data/
▸ layouts/
▸ static/     # 静的ファイルを置くところ
  config.toml # 設定ファイル&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;hugo&lt;/code&gt;って叩くと変換が始まりますが、まだなにもない状態。&lt;/p&gt;
&lt;h2&gt;テーマのインストール&lt;/h2&gt;
&lt;p&gt;テーマ ≒ 見た目ですね。自作してももちろんいいですが、取り急ぎ拾って使ってみました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/spf13/hugoThemes/&quot;&gt;spf13/hugoThemes&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;このへんから&lt;code class=&quot;language-text&quot;&gt;git submodule add git@github.com:spf13/hugoThemes.git themes&lt;/code&gt;してもいいし、&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/zyro/hyde-x&quot;&gt;zyro/hyde-x&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;このへんから&lt;code class=&quot;language-text&quot;&gt;git submodule add git@github.com:zyro/hyde-x.git themes/hyde-x&lt;/code&gt;してもOK。&lt;/p&gt;
&lt;p&gt;後者のほうがビルドが早くなるので良さそう。そんなにしょっちゅう変えるものでもないので。&lt;/p&gt;
&lt;p&gt;テーマの使い方は実行時に指定してもいいですが、config.tomlに&lt;code class=&quot;language-text&quot;&gt;theme = &amp;quot;テーマ名&amp;quot;&lt;/code&gt;を指定するのが便利かと思います。&lt;/p&gt;
&lt;p&gt;他にも、テーマによって独自の設定パラメータが用意されてたりするので、使うテーマの &lt;code class=&quot;language-text&quot;&gt;README.md&lt;/code&gt; を参照。&lt;/p&gt;
&lt;p&gt;submoduleで入れているので、適宜 &lt;code class=&quot;language-text&quot;&gt;git submodule update --init --recursive&lt;/code&gt; とかやってください。&lt;/p&gt;
&lt;p&gt;わからなければsubmoduleじゃなくてファイルぶっこんでもいいと思います。&lt;/p&gt;
&lt;h2&gt;リポジトリの作成&lt;/h2&gt;
&lt;p&gt;GitHubにリポジトリを作る。今回は作成用と公開用で2つリポジトリを作ります。&lt;/p&gt;
&lt;p&gt;公開用は&lt;code class=&quot;language-text&quot;&gt;ユーザー名.github.io&lt;/code&gt;で作成。作成用のリポジトリ名はなんでもいいです。私は&lt;code class=&quot;language-text&quot;&gt;horiblog&lt;/code&gt;で作成。&lt;/p&gt;
&lt;p&gt;作成用はプライベートリポジトリにしておくと下書きとか構成とか見られなくていいけど、まぁ別に公開されちゃってても気にならないならおk。&lt;/p&gt;
&lt;p&gt;プライベートリポジトリは課金なので、お財布とご相談してください。&lt;/p&gt;
&lt;h2&gt;.gitignoreの設置&lt;/h2&gt;
&lt;p&gt;.gitignoreに&lt;code class=&quot;language-text&quot;&gt;public/&lt;/code&gt;を追加。&lt;/p&gt;
&lt;h2&gt;gitの設定&lt;/h2&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell-session&quot;&gt;&lt;pre class=&quot;language-shell-session&quot;&gt;&lt;code class=&quot;language-shell-session&quot;&gt;&lt;span class=&quot;token command&quot;&gt;&lt;span class=&quot;token shell-symbol important&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;token bash language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; init&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token command&quot;&gt;&lt;span class=&quot;token shell-symbol important&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;token bash language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; remote &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt; origin &lt;span class=&quot;token variable&quot;&gt;${自分のgithubの作成用リポジトリ}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;で設定。&lt;/p&gt;
&lt;h2&gt;CircleCIの設定&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://circleci.com/add-projects&quot;&gt;Add projects - CircleCI&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ここから。作った作成用リポジトリをBuild Projectボタンで有効化。&lt;/p&gt;
&lt;p&gt;で、このままだとCircleCIは作成用のリポジトリにしかアクセスできず、公開用のリポジトリにデータを投げられない（&lt;a href=&quot;https://circleci.com/docs/github-security-ssh-keys&quot;&gt;GitHub security and SSH keys - CircleCI&lt;/a&gt;）ので、以下の設定を。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;CircleCIの作成用リポジトリのやつから&lt;code class=&quot;language-text&quot;&gt;Project Settings&lt;/code&gt;で設定画面を開く&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Permissons&lt;/code&gt;にある&lt;code class=&quot;language-text&quot;&gt;Checkout SSH keys&lt;/code&gt;を開く&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Authorize w/ GitHub&lt;/code&gt;みたいなそれっぽいボタンがあるので、ぽちっと押してGitHub認証。&lt;/li&gt;
&lt;li&gt;認証が終わるとCircleCIの画面に帰ってくるので、今度は&lt;code class=&quot;language-text&quot;&gt;Create and add ユーザー名 user key&lt;/code&gt;みたいなボタンがあるのでぽちっと。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;これで他のリポジトリにアクセスできるようになります。簡単でとても良い。&lt;/p&gt;
&lt;h2&gt;circle.ymlの設置&lt;/h2&gt;
&lt;p&gt;CircleCIのビルド用にcircle.ymlを設置。この設定ファイルをみてCircleCIがいい感じにビルドしてくれる。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://circleci.com/docs/configuration&quot;&gt;Configuring CircleCI - CircleCI&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ファイルを見たほうが雰囲気をつかみやすいと思うので、貼っておきます。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;circleci.yaml&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;checkout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;post&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; git submodule sync
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; git submodule update &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;init &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;recursive

&lt;span class=&quot;token key atrule&quot;&gt;machine&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;timezone&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Asia/Tokyo

&lt;span class=&quot;token key atrule&quot;&gt;dependencies&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;pre&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; go get &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;v github.com/spf13/hugo
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; git config &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;global user.name &quot;CircleCI&quot;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; git config &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;global user.email &quot;circleci@example.com&quot;

&lt;span class=&quot;token key atrule&quot;&gt;deployment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;master&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;branch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; master
    &lt;span class=&quot;token key atrule&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; git clone git@github.com&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;hori&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ryota/hori&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ryota.github.io.git public
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; hugo
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; cd public &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; git add .
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; cd public &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; git commit &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;m &quot;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ci skip&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; publish&quot;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; cd public &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; git push origin master&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;公開用リポジトリのバージョン管理なんてどーでもいいので、git周りの設定は割と適当です。&lt;/p&gt;
&lt;p&gt;ちなみに、これ作っていきなりpushしてもcontentの中身が空っぽだとcontentディレクトリがgitで管理されないため、CircleCIさんがファイル足らねーよ！って怒ってきます。&lt;/p&gt;
&lt;p&gt;まぁ、CircleCIでログも表示されるのでエラーが出たらよしなに。&lt;/p&gt;
&lt;h2&gt;記事の作成&lt;/h2&gt;
&lt;p&gt;CircleCIの設定まででひと通りの設定は完了。config.tomlをテーマに合わせていい感じに設定する必要はあるけど、後述。&lt;/p&gt;
&lt;p&gt;とりあえず記事を作ってみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell-session&quot;&gt;&lt;pre class=&quot;language-shell-session&quot;&gt;&lt;code class=&quot;language-shell-session&quot;&gt;&lt;span class=&quot;token command&quot;&gt;&lt;span class=&quot;token shell-symbol important&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;token bash language-bash&quot;&gt;hugo new post/article-title.md&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;を叩くと、 &lt;code class=&quot;language-text&quot;&gt;content/post/article-title.md&lt;/code&gt; が作成されているはず。これをMarkdownで編集すれば記事になる。&lt;/p&gt;
&lt;p&gt;上部にメタタグっぽいcategoriesとかがあるのだけど、詳しくはこちら。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://gohugo.io/content/front-matter/&quot;&gt;Front Matter&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;デフォルトで入るやつは、テーマもしくは自分の&lt;a href=&quot;http://gohugo.io/content/archetypes/&quot;&gt;Archetypes&lt;/a&gt;の設定に依存します。&lt;/p&gt;
&lt;p&gt;この記事だとこんな感じです。&lt;/p&gt;
&lt;p&gt;あくまで、hyde-xテーマの場合です。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;article-title.md&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;toml&quot;&gt;&lt;pre class=&quot;language-toml&quot;&gt;&lt;code class=&quot;language-toml&quot;&gt;+++
&lt;span class=&quot;token key property&quot;&gt;categories&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Development&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Hugo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;CircleCI&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;GitHub Pages&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token key property&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;2015-04-17T09:00:00+09:00&quot;&lt;/span&gt;
&lt;span class=&quot;token key property&quot;&gt;description&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;hori-ryota.github.ioみたいな、GitHubドメインの技術ブログかっこいいよね〜と思ったので流行りのHugoとCircleCIを組み合わせて作ってみたら超お手軽だったので手順をまとめてみた。無料。&quot;&lt;/span&gt;
&lt;span class=&quot;token key property&quot;&gt;keywords&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Hugo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;CircleCI&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;GitHub Pages&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token key property&quot;&gt;title&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;HugoとCircleCIでGitHub PagesにBlog公開してみた&quot;&lt;/span&gt;
&lt;span class=&quot;token key property&quot;&gt;slug&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;create-blog-with-hugo-and-circleci&quot;&lt;/span&gt;

+++&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;設定項目はテーマにもよるし、困ったら後で置換すればいいや〜って思っていますが、一応以下の様な方針。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;categories、tagsについて&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;普通はcategoryとtagsな気がするよね…tagsがデフォルトじゃない…？&lt;/li&gt;
&lt;li&gt;categoryってディレクトリみたいに記事ごとに一つなイメージあるけど、categories？複数…？&lt;/li&gt;
&lt;li&gt;そもそもcategoryみたいな区分って、SEOが云々って理由以外でブログでは要らないかも…？&lt;/li&gt;
&lt;li&gt;categoriesをtagsとして使おう！&lt;/li&gt;
&lt;li&gt;ただし、後でcategoryが欲しくなるかもしれないので、categoriesの一つ目はcategory的なやつにするルールにしておく。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;slugについて&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;URLはtitleからスペースをハイフンに変換したりしてくれるけど、日本語つらい&lt;/li&gt;
&lt;li&gt;ので、urlとして使われるslugは明示的に指定。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;keywordsについて&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;適当。categoriesでいいなぁ…tagsの代わりとしてとりあえず入れてみた。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;dateについて&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ファイルの作成日時が入るけど、公開するタイミングで手動で書き換え。ちょっとめんどくさい。スクリプト書こうかな…&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;基本的にはデフォルト項目からいじらないほうが後で楽だと思ってこんな感じの設定に。&lt;/p&gt;
&lt;p&gt;といいつつ、tagsがなかったりdraftがデフォルトじゃなかったりでちょっと気持ち悪いので、テーマごと書き換えるかも。&lt;/p&gt;
&lt;h2&gt;config.tomlの設定&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://gohugo.io/overview/configuration/&quot;&gt;Configuring Hugo&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;デフォルトで入っている基本項目に加えて、テーマごとで指定できるパラメータを突っ込めばOK。&lt;/p&gt;
&lt;p&gt;とはいえ何か詰まることもあると思うので、参考までに自分のやつを晒しておきます。&lt;/p&gt;
&lt;p&gt;アカウント関係はhogehogeに書き換えたので、よしなに置き換えてください。&lt;/p&gt;

        &lt;div class=&quot;gatsby-code-title&quot;&gt;
          &lt;span&gt;config.toml&lt;/span&gt;
        &lt;/div&gt;
       
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;toml&quot;&gt;&lt;pre class=&quot;language-toml&quot;&gt;&lt;code class=&quot;language-toml&quot;&gt;&lt;span class=&quot;token key property&quot;&gt;baseurl&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;http://hori-ryota.github.io&quot;&lt;/span&gt;
&lt;span class=&quot;token key property&quot;&gt;languageCode&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ja&quot;&lt;/span&gt;
&lt;span class=&quot;token key property&quot;&gt;title&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Hori Blog&quot;&lt;/span&gt;
&lt;span class=&quot;token key property&quot;&gt;theme&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;hyde-x&quot;&lt;/span&gt;
&lt;span class=&quot;token key property&quot;&gt;MetaDataFormat&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;toml&quot;&lt;/span&gt;
&lt;span class=&quot;token key property&quot;&gt;disqusShortname&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;hogehoge&quot;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token table class-name&quot;&gt;author&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token key property&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Hori Ryota&quot;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token table class-name&quot;&gt;permalinks&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token key property&quot;&gt;post&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/blog/:slug/&quot;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token table class-name&quot;&gt;indexes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token key property&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;categories&quot;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token table class-name&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token key property&quot;&gt;theme&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;theme-base-0d&quot;&lt;/span&gt;
  &lt;span class=&quot;token key property&quot;&gt;highlight&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;sunburst&quot;&lt;/span&gt;
  &lt;span class=&quot;token key property&quot;&gt;googleAnalytics&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;UA-00000000-1&quot;&lt;/span&gt;

  &lt;span class=&quot;token key property&quot;&gt;facebook&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;https://www.facebook.com/hogehoge&quot;&lt;/span&gt;
  &lt;span class=&quot;token key property&quot;&gt;twitter&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;https://twitter.com/hogehoge&quot;&lt;/span&gt;
  &lt;span class=&quot;token key property&quot;&gt;github&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;https://github.com/hogehoge&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;baseurl&lt;/code&gt; の末尾に &lt;code class=&quot;language-text&quot;&gt;/&lt;/code&gt; を入れるか入れないかで迷ったのですが、テンプレートによって個性があるようで…。hyde-xだと &lt;code class=&quot;language-text&quot;&gt;baseurl&lt;/code&gt; のあとに &lt;code class=&quot;language-text&quot;&gt;/&lt;/code&gt; から始まるpathをくっつける仕様になっているようなので、今回は &lt;code class=&quot;language-text&quot;&gt;/&lt;/code&gt; 無し。&lt;/p&gt;
&lt;h2&gt;記事プレビュー&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;hugo server&lt;/code&gt; ってやるとデフォルトでは &lt;code class=&quot;language-text&quot;&gt;http://localhost:1313/&lt;/code&gt; でサイトが見られるようになっているはず。&lt;/p&gt;
&lt;p&gt;記事を書くときは &lt;code class=&quot;language-text&quot;&gt;hugo server -w&lt;/code&gt; ってやっておくと保存の度に更新してくれるから楽です。 &lt;code class=&quot;language-text&quot;&gt;-d&lt;/code&gt; もつけると下書きも含めてくれます。&lt;/p&gt;
&lt;h2&gt;記事公開&lt;/h2&gt;
&lt;p&gt;今回の設定では、gitのmasterブランチにpushすればCircleCIが動いて更新されてくれる…はず！&lt;/p&gt;
&lt;h2&gt;おわりに&lt;/h2&gt;
&lt;p&gt;思ったより簡単に作れたなーという印象。とはいえ画像の最適化とかは自動化できていないので、そのへんも組み込もうか検討中。&lt;/p&gt;
&lt;p&gt;Hugoはさくっと作れる使用感は良いのだけど、テーマ周りがちょっとまだ微妙だなーと…。記事のメタ情報も統一されていなくてテーマごとに個性が出ちゃったりとか、なんかそのへんが嫌。&lt;/p&gt;
&lt;p&gt;もっと流行って、同じ記事データでさくっと見た目を変えられるようになってくるといいなぁという気持ち。&lt;/p&gt;
&lt;p&gt;テーマを自分で作れば解決しますがそこまでは頑張らない。&lt;/p&gt;
&lt;p&gt;以上、HugoとCircleCIでGitHub PagesにBlogを公開する手順のまとめでした。&lt;/p&gt;</content:encoded></item></channel></rss>