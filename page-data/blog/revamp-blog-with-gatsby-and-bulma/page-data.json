{"componentChunkName":"component---src-templates-blog-jsx","path":"/blog/revamp-blog-with-gatsby-and-bulma/","result":{"data":{"markdownRemark":{"fields":{"urlPath":"/blog/revamp-blog-with-gatsby-and-bulma/","jstDate":"2020-09-22"},"html":"<p>全然ブログを更新していなかったので久々に書こうと思い、勢いでリニューアルしました。これまではHugoを使っていたのですが、今回はGatsby.jsとBulmaを組み合わせてみました。</p>\n<p>乗り換えにあたって検討したことと、Gatsby.jsとBulmaで苦労したこと、調整したことなどを残しておきます。</p>\n<!--more-->\n<h2>HugoからGatsby.jsに乗り換えた理由</h2>\n<p>HugoはGo製の静的サイトジェネレータで、登場時には既存ツールに比べてとにかく爆速で話題でした。</p>\n<blockquote>\n<p><a href=\"https://gohugo.io/\">The world’s fastest framework for building websites | Hugo</a></p>\n</blockquote>\n<p>とりあえずMarkdownで記事を書いておけば移植性も高いと思い軽いノリで導入したのですが、たしかに爆速で移植性も高くいい感じでした。</p>\n<p>一方でどうしても使いこなせなかった点がいくつかありました。</p>\n<p>Hugoを導入したのは2015年なので今では改善されている問題も多いですが、Hugoを調整するよりもGatsby.jsに乗り換える方がベターと判断して乗り換えました。</p>\n<blockquote>\n<p><a href=\"https://www.gatsbyjs.com/\">Gatsby</a></p>\n</blockquote>\n<p>以下、乗り換えの動機です。</p>\n<h3>Goのtemplateがつらかった</h3>\n<p>HugoはGo製なので、themeのテンプレートはGoのtemplateです。詳細は省きますがあまりHTMLの出力に適しているとはいい難く、自作テーマを作成する気にはならず既存のテーマを拝借していました。</p>\n<p>Gatsby.jsはReactベースなのでHTML出力に適しているだけでなく、各種の最適化もいい感じに行ってくれるので自作テーマの作りやすさが段違いでした。</p>\n<h3>Hugoでは画像の扱いが面倒</h3>\n<p>Markdownの画像記法だけでは <code class=\"language-text\">width</code> や <code class=\"language-text\">height</code> のパラメータが入るわけでもなく、また画像の最適化も自動ではやってくれません。Exif情報などのメタデータも削除してくれないので単体では使い勝手が満足できませんでした。</p>\n<p><a href=\"https://gohugo.io/content-management/shortcodes/\">HugoにはShortcodeと呼ばれる独自記法</a>があり、これを用いることで対処はできるのですが求めていたのはシンプルなMarkdownでの記事作成だったので欲求に合わず。</p>\n<p>最終的には自作ツールで画像の変換をかけつつ、パラメータ指定は気にせずに大きな画像をそのまま提供している状態でした。</p>\n<blockquote>\n<p><a href=\"/blog/create-shellscript-for-hugo-images/\">Hugo のサムネ作成、画像追加、画像最適化を自動化するシェル芸 | Hori Blog</a></p>\n</blockquote>\n<p>なお、今ではHugoも <a href=\"https://gohugo.io/content-management/image-processing/\">Image Processing</a> という名で画像周りの前処理は挟めるようですが、表示側の調整は今でもshortcodeを用いるようです。</p>\n<p>Gatsby.jsでは（pluginを入れれば）shortcodeを用いずに画像の事前処理も表示分けもできる上、テーマ側でも難しい条件分岐をせずにシンプルな記載で適用できるのでとても楽でした。</p>\n<h3>Hugoのテーマの移植性の低さ</h3>\n<p>これはGatsby.jsで解決されているわけではないですが、Gatsby.jsでは自作テーマを用いるので気にならなかった点です。</p>\n<p>HugoにはMarkdownで記載することによるテーマ間の移植性の高さを期待していたのですが、試したテーマの範囲では互換性の低さが目立ちました。全体設定ファイルのパラメータ名だけでなく、パラメータの書式（camelCaseとか）も異なり、また記事ファイルに記載するfrontmatter（メタデータ）の記法もバラバラだったため、テーマ変更の手間は大きかったです。</p>\n<h3>最速である必要はない</h3>\n<p>Hugoは確かに爆速ではあるのですが、最終的にはテキスト処理の爆速については自分のユースケースでは以下の理由でメリットが薄くなりました。</p>\n<ul>\n<li>\n<p>ボトルネックは画像の最適化処理であり、記事生成の速度はあまり差別化にならなかった</p>\n<ul>\n<li>記事数がとっても多くなったらまた考えればいい</li>\n<li>画像の最適化処理がHugoで高速な可能性もあるが、必要があれば自前で処理を切り出せばいい</li>\n</ul>\n</li>\n<li>速度が欲しくなるのは全ファイルの生成ではなくlive reload時の速度であり、これはGatsby.jsも十分に速かった</li>\n</ul>\n<h3>各種の最適化の恩恵を受けたかった</h3>\n<blockquote>\n<p><a href=\"https://www.gatsbyjs.com/#gatsby-is-fast\">gatsby-is-fast | Gatsby</a></p>\n</blockquote>\n<p>表示が爆速。フロント周りの知識は弱いのですが、そんなに苦労せずいい感じに作れて満足。</p>\n<h2>Bulmaの使用</h2>\n<p>見た目へのこだわりは薄く「それっぽくいい感じ」であれば満足だったのですが、既存のテーマで丁度いいものがなかったので自作しました。</p>\n<p>デザインは<a href=\"https://www.gatsbyjs.com/docs/bulma/\">Gatsby.jsのドキュメントで紹介されていた</a>こともありCSSフレームワークのBulmaを使用しました。</p>\n<blockquote>\n<p><a href=\"https://bulma.io/\">Bulma: Free, open source, and modern CSS framework based on Flexbox</a></p>\n</blockquote>\n<p>さくさくそれっぽく作れていい感じだったのですが、クラス名のスコープがグローバルなのでCode Highlightのライブラリなどと競合して思ったより辛かったです。</p>\n<blockquote>\n<p><a href=\"https://github.com/jgthms/bulma/issues/302\">please namespace all classes · Issue #302 · jgthms/bulma</a></p>\n</blockquote>\n<h2>作る際に工夫＆調整したあれこれ</h2>\n<p>Gatsby.jsとBulmaでいくつか工夫や調整が必要だったところがあったので参考になるかと思い残しておきます。</p>\n<h3>BulmaとPrism.jsの競合</h3>\n<p>Bulmaはシンプルなclass名を使用させたいようなのですが、めっちゃ競合しました。仕方ないので <code class=\"language-text\">inherit</code> を当てまくって対処。うーむ…</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>layout.scss</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"scss\"><pre class=\"language-scss\"><code class=\"language-scss\"><span class=\"token selector\">article .content </span><span class=\"token punctuation\">{</span>\n  <span class=\"token selector\">.tag, .number, .table, .title </span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> inline<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span> inherit<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">font-size</span><span class=\"token punctuation\">:</span> inherit<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">line-height</span><span class=\"token punctuation\">:</span> inherit<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">text-align</span><span class=\"token punctuation\">:</span> inherit<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">vertical-align</span><span class=\"token punctuation\">:</span> inherit<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">border-radius</span><span class=\"token punctuation\">:</span> inherit<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">font-weight</span><span class=\"token punctuation\">:</span> inherit<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">white-space</span><span class=\"token punctuation\">:</span> inherit<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">background</span><span class=\"token punctuation\">:</span> inherit<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">margin</span><span class=\"token punctuation\">:</span> inherit<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Gatsby.jsでremarkすると <code class=\"language-text\">li</code> 要素の入れ子が崩れる</h3>\n\n        <div class=\"gatsby-code-title\">\n          <span>article.md</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token list punctuation\">-</span> foo\n    <span class=\"token list punctuation\">-</span> bar\n    <span class=\"token list punctuation\">-</span> baz</code></pre></div>\n<p>みたいな要素があると</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>article.html</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span>foo<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">></span></span>bar<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">></span></span>baz<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>のように <code class=\"language-text\">&lt;p&gt;</code> タグが入るためmarginなどが適用されズレました。</p>\n<blockquote>\n<p><a href=\"https://github.com/gatsbyjs/gatsby/issues/10870\">[gatsby-transformer-remark] Nested lists inserting rogue paragraphs · Issue #10870 · gatsbyjs/gatsby</a></p>\n</blockquote>\n<p>これはmdastのListItem要素でtextがparagraph要素として入ってくることによる挙動だと思います。出力を調整して <code class=\"language-text\">&lt;p&gt;</code> タグが入らなくしてもいいのですが、意識が低いのでCSSだけで対処。ついでに <code class=\"language-text\">&lt;ul&gt;</code> <code class=\"language-text\">&lt;ol&gt;</code> のmarginも気に入らなかったので <code class=\"language-text\">&lt;li&gt;</code> と同じに調整。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>layout.scss</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"scss\"><pre class=\"language-scss\"><code class=\"language-scss\"><span class=\"token selector\">article .content li </span><span class=\"token punctuation\">{</span>\n  <span class=\"token selector\"><span class=\"token parent important\">&amp;</span> > p </span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">margin-bottom</span><span class=\"token punctuation\">:</span> 0 <span class=\"token important\">!important</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token selector\"><span class=\"token parent important\">&amp;</span> > ul, <span class=\"token parent important\">&amp;</span> > ol </span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">margin-top</span><span class=\"token punctuation\">:</span> 0.25em <span class=\"token important\">!important</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>日付表示がUTCになる</h3>\n<p>見かけるサンプルだと以下のような感じで表示したいformatでfrontmatterのdateを取得して、</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>graphql</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\">node <span class=\"token punctuation\">{</span>\n  ~~~\n  ~~~\n  frontmatter <span class=\"token punctuation\">{</span>\n    date<span class=\"token punctuation\">(</span><span class=\"token attr-name\">formatString</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"YYYY-MM-DD\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>使用側では以下のように使っていたりします。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>template</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>time</span> <span class=\"token attr-name\">dateTime</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>node<span class=\"token punctuation\">.</span>frontmatter<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>node<span class=\"token punctuation\">.</span>frontmatter<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>time</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>これだとUTCでの日付が入ってしまいズレることがあります。</p>\n<p>issueもありました。</p>\n<blockquote>\n<p><a href=\"https://github.com/gatsbyjs/gatsby/issues/11832\">Add option to get date in local or specified time zone · Issue #11832 · gatsbyjs/gatsby</a></p>\n</blockquote>\n<p>issueでは以下のように表示側で <a href=\"https://momentjs.com/\">Moment.js</a> を使って調整する解決策が紹介されています。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>template</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> moment <span class=\"token keyword\">from</span> <span class=\"token string\">'moment'</span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>small</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span><span class=\"token function\">moment</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>frontmatter<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">local</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">MMMM DD, YYYY</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>small</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>これでもいいのですが表示側で考えることを減らしたかったので、 <code class=\"language-text\">gatsby-node.js</code> の <code class=\"language-text\">onCreateNode</code> で <code class=\"language-text\">fields</code> に <code class=\"language-text\">jstDate</code> を入れておくようにしてみました。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>gatsby-node.js</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> moment <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'moment'</span><span class=\"token punctuation\">)</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onCreateNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> node<span class=\"token punctuation\">,</span> actions<span class=\"token punctuation\">,</span> getNode <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createNodeField <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> actions\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">MarkdownRemark</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>frontmatter<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        name<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">jstDate</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        node<span class=\"token punctuation\">,</span>\n        value<span class=\"token operator\">:</span> <span class=\"token function\">moment</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>frontmatter<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">utcOffset</span><span class=\"token punctuation\">(</span><span class=\"token string\">'+0900'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">'YYYY-MM-DD'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n\n        <div class=\"gatsby-code-title\">\n          <span>graphql</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\">node <span class=\"token punctuation\">{</span>\n  ~~~\n  ~~~\n  fields <span class=\"token punctuation\">{</span>\n    jstDate\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n\n        <div class=\"gatsby-code-title\">\n          <span>template</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>time</span> <span class=\"token attr-name\">dateTime</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>node<span class=\"token punctuation\">.</span>fields<span class=\"token punctuation\">.</span>jstDate<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>node<span class=\"token punctuation\">.</span>fields<span class=\"token punctuation\">.</span>jstDate<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>time</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>動くのは確認できたので最終的には <a href=\"https://day.js.org/\">Day.js</a> に。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>gatsby-node.js</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> dayjs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dayjs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> utc <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dayjs/plugin/utc'</span><span class=\"token punctuation\">)</span>\ndayjs<span class=\"token punctuation\">.</span><span class=\"token function\">extend</span><span class=\"token punctuation\">(</span>utc<span class=\"token punctuation\">)</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onCreateNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> node<span class=\"token punctuation\">,</span> actions<span class=\"token punctuation\">,</span> getNode <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createNodeField <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> actions\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">MarkdownRemark</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>frontmatter<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        name<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">jstDate</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        node<span class=\"token punctuation\">,</span>\n        value<span class=\"token operator\">:</span> <span class=\"token function\">dayjs</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>frontmatter<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">utcOffset</span><span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">'YYYY-MM-DD'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>別解だと <code class=\"language-text\">JSTDate</code> みたいなcomponentを作って使うのもいいかもしれませんが、JSTじゃないDateを使うタイミングはないので横断的に適用しやすいfields要素の活用にしてみました。</p>\n<p>基本的に表示要素はfrontmatterなどをそのまま使わないでfieldsを使うようにしておいたほうがちょっとした前処理をはさみやすくていいのかもな〜と思うなど。</p>\n<h3>embed系の埋め込み</h3>\n<p>HugoではSpeakerdeckはshortcodeで、Twitterはembed用HTMLを直書きしていたのですがGatsbyではプラグインでembed用のHTMLを差し込むようにしました。</p>\n<p>まず前提として、このブログでは（今のところ）参考リンク系は以下のような書式で書いています。</p>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token blockquote punctuation\">></span> <span class=\"token url\">[<span class=\"token content\">title</span>](url)</span></code></pre></div>\n<p>この形式で該当のURLが貼られたときにembed用のHTMLと差し替える処理を入れていきます。</p>\n<p>remarkでの処理差し込みは公式ドキュメントに記載があるので、こちらのやり方で実施しました。</p>\n<blockquote>\n<p><a href=\"https://www.gatsbyjs.com/tutorial/remark-plugin-tutorial/\">Creating a Remark Transformer Plugin | Gatsby</a></p>\n</blockquote>\n\n        <div class=\"gatsby-code-title\">\n          <span>./plugins/remark-custom/package.json</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"private\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"remark-custom\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"main\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"index.jsx\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n\n        <div class=\"gatsby-code-title\">\n          <span>./plugins/remark-custom/index.jsx</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> visit <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'unist-util-visit'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fetch <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node-fetch'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isOuterUrl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span>url<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/^https?:\\/\\//</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> markdownAST <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> oembedTarget <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// link to iframely</span>\n  <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span>markdownAST<span class=\"token punctuation\">,</span> <span class=\"token string\">'blockquote'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">blockquote</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>blockquote<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>blockquote<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>type <span class=\"token operator\">!=</span> <span class=\"token string\">'paragraph'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> paragraph <span class=\"token operator\">=</span> blockquote<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>paragraph<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>paragraph<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>type <span class=\"token operator\">!=</span> <span class=\"token string\">'link'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> paragraph<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isOuterUrl</span><span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    oembedTarget<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>blockquote<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n    oembedTarget<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">target</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://speakerdeck.com/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://speakerdeck.com/oembed.json?url='</span> <span class=\"token operator\">+</span> link<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> json <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        target<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">'html'</span><span class=\"token punctuation\">;</span>\n        target<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n        target<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;div\n          style=\"position: relative; width:100%; height:0; padding-top:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>height <span class=\"token operator\">/</span> json<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">%;\"\n          >\n          </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>json<span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/width=\"\\d+\"/</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'width=100%'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/height=\"\\d+\"/</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">height=\"100%\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'style=\"'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'style=\"position:absolute;top:0;left:0;'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n          &lt;/div></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://twitter.com/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://publish.twitter.com/oembed?omit_script=true&amp;url='</span> <span class=\"token operator\">+</span> link<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> json <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        target<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">'html'</span><span class=\"token punctuation\">;</span>\n        target<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n        target<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> markdownAST<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n\n        <div class=\"gatsby-code-title\">\n          <span>gatsby-config.js</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">module.exports = <span class=\"token punctuation\">{</span>\n~~~\n~~~\n  plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n~~~\n~~~\n    <span class=\"token punctuation\">{</span>\n      resolve<span class=\"token operator\">:</span> `gatsby-transformer-remark`<span class=\"token punctuation\">,</span>\n      options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n~~~\n~~~\n        plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n~~~\n~~~\n          `remark-custom`<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n~~~\n~~~</code></pre></div>\n<p>いったん動けばいいやのオレオレで作っているので汚いのはご容赦ください。後にリファクタの上、キャッシュを入れてリクエスト頻度を減らしたりsleep処理を入れる予定です。</p>\n<p>いくつかの対応が混在しているので分解して紹介します。</p>\n<h4>該当する書式の取得</h4>\n\n        <div class=\"gatsby-code-title\">\n          <span>./plugins/remark-custom/index.jsx</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">visit</span><span class=\"token punctuation\">(</span>markdownAST<span class=\"token punctuation\">,</span> <span class=\"token string\">'blockquote'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">blockquote</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>blockquote<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>blockquote<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>type <span class=\"token operator\">!=</span> <span class=\"token string\">'paragraph'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> paragraph <span class=\"token operator\">=</span> blockquote<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>paragraph<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>paragraph<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>type <span class=\"token operator\">!=</span> <span class=\"token string\">'link'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> paragraph<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isOuterUrl</span><span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  oembedTarget<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>blockquote<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>blockquote（<code class=\"language-text\">&gt;</code>）内にlink（<code class=\"language-text\">[]()</code>）が1つしかない要素を拾っています。また、内部リンクは処理しないので <code class=\"language-text\">isOuterUrl(link.url)</code> でフィルタリングしています。</p>\n<p>外部リクエストが生じるので一旦 <code class=\"language-text\">push</code> して保持した上で以下の処理で回しています。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>./plugins/remark-custom/index.jsx</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n  oembedTarget<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">target</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span>\n    <span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>oEmbedからembed用のHTMLを取得</h4>\n<p>SpeakerdeckもTwitterもoEmbed機能に対応しているため、Getリクエストでデータを取得します。以下はTwitterの処理。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>./plugins/remark-custom/index.jsx</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://twitter.com/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://publish.twitter.com/oembed?omit_script=true&amp;url='</span> <span class=\"token operator\">+</span> link<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> json <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  target<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">'html'</span><span class=\"token punctuation\">;</span>\n  target<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n  target<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ASTを編集するのではなく、 <code class=\"language-text\">target.type</code> を <code class=\"language-text\">html</code> にすれば <code class=\"language-text\">target.value</code> にHTMLを入れるだけで差し替えが可能です。</p>\n<p>Twitterの場合は <code class=\"language-text\">omit_script=true</code> をつけてwidget用のscriptを読み込まないようにしています。</p>\n<blockquote>\n<p><a href=\"https://developer.twitter.com/en/docs/twitter-api/v1/tweets/post-and-engage/api-reference/get-statuses-oembed\">GET statuses/oembed | Docs | Twitter Developer</a></p>\n</blockquote>\n<p>その上でpluginを入れて横断的にscriptを読み込んでいます。</p>\n<blockquote>\n<p><a href=\"https://www.gatsbyjs.com/plugins/gatsby-plugin-twitter/\">gatsby-plugin-twitter | Gatsby</a></p>\n</blockquote>\n<h4>Speakerdeckの表示を調整</h4>\n<p>現在（2020-09-21）取れるSpeakerdeckのEmbed用HTMLではwidth, heightが固定値でスマートフォンなどでの閲覧時にはみ出ます。これを防ぐためHTMLを置換しています。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>./plugins/remark-custom/index.jsx</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">target<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;div\n  style=\"position: relative; width:100%; height:0; padding-top:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>height <span class=\"token operator\">/</span> json<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">%;\"\n  >\n  </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>json<span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/width=\"\\d+\"/</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'width=100%'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/height=\"\\d+\"/</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">height=\"100%\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'style=\"'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'style=\"position:absolute;top:0;left:0;'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n  &lt;/div></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>汚い対応ですが、パーツへの対応が凝集されているのでヨシとしています。</p>\n<h2>その他やったこと</h2>\n<h3>Cloudflareを挟んでいたのをやめた</h3>\n<p>Cloudflare + GitHub Pagesの構成だったのですが、GitHub PagesがカスタムドメインのHTTPSに対応したのでお役御免となりました。</p>\n<blockquote>\n<p><a href=\"https://github.blog/2018-05-01-github-pages-custom-domains-https/\">Custom domains on GitHub Pages gain support for HTTPS - The GitHub Blog</a></p>\n</blockquote>\n<h3>CIでの更新を止めた</h3>\n<p>masterブランチにpushしたらCircleCIで更新するようにしていたのですが、ブログの更新作業とは合わないのでやめました。</p>\n<ul>\n<li><code class=\"language-text\">編集 → 更新 → 確認</code> までが1サイクルであり、確認がCIで自動化できていない場合に中間の <code class=\"language-text\">更新</code> を非同期的にやる利点はない</li>\n<li>逆に <code class=\"language-text\">更新</code> を非同期的にCIで行うために生じるオーバーヘッドが大きい</li>\n<li>\n<p>更新処理の冪等性はGatsby.jsにより十分に保たれており、また <code class=\"language-text\">gatsby clean</code> による掃除もできるので「綺麗な環境」で処理する必要はない</p>\n<ul>\n<li>もし必要ならDockerとかでいい</li>\n</ul>\n</li>\n<li>\n<p>自分のプライベートPCでしか作業しないので環境差分を考慮する必要も薄い</p>\n<ul>\n<li>スマートフォンなどから更新したくなったらgit push起点じゃない明示実行でなにか用意することはあるかも</li>\n</ul>\n</li>\n</ul>\n<p>という感じで、今はpublish用のShell Scriptを用意して使っています。</p>\n<h2>おわり</h2>\n<p>Gatsby.jsいいですね。フロント周りの知識は全然追えてないのですが、それでもいい感じのレイアウトとLighthouseでぼちぼちのスコアを手に入れました。爆速です。</p>\n<p>Twitterのwidgetを入れるとスコアが下がるのが悲しいところ。</p>\n<p>SEOのスコアが <code class=\"language-text\">Links do not have descriptive text</code> で上がりきっていないですが <code class=\"language-text\">more</code> ボタンはともかくtagの <code class=\"language-text\">Go</code> が引っかかってしまっているのはどうするのがいいのやら。</p>\n<p>それはそれとして、これ。</p>\n<blockquote class=\"twitter-tweet\"><p lang=\"ja\" dir=\"ltr\">blogを更新しようと思う度にリニューアルに手を付けてしまうので一生書けない（今回はgatsbyとbulmaで作ってみる予定）</p>&mdash; hori (@hori_ryota) <a href=\"https://twitter.com/hori_ryota/status/1304743938444521472?ref_src=twsrc%5Etfw\">September 12, 2020</a></blockquote>\n\n<p>サムネイルも必須じゃない形式にしたので更新のハードルは下がったはず。きっとこれからは書く。はず。</p>","excerpt":"全然ブログを更新していなかったので久々に書こうと思い、勢いでリニューアルしました。これまではHugoを使っていたのですが、今回はGatsby.jsとBulmaを組み合わせてみました。 乗り換えにあたって検討したことと、Gatsby.jsとBulmaで苦労したこと、調整したことなどを残しておきます。","frontmatter":{"date":"2020-09-22T12:00:00+09:00","title":"Gatsby.jsとBulmaでブログをリニューアルした","tags":["Development","Gatsby.js","Bulma"],"eyecatch":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAByklEQVQoz2WRSW8aQRCF52yHLTBBgM0ifodzcC6ODTNBsq9OhNn3ZQCJXewg+M0v/Qo3Isrhm66qrn79usaw0mm8PD/jx+Mjfj49wbYssGapVeIr7E9SqRTSCllVL7FtG5lMBsaXmxu4bm/hdbnhcbnOuN3wuj3wejzw+XyIhMOIRaMwAya+qtzv9yMQCMA0zcuqMb6pQlAFoWAQkVBIDt+FI7iLnIne34tYIh5HLBaTmLW4ypPJpJBIJBBVde4ZhUIBQj6P/CfZbFbI5XKXGuPrnP3vv//g7e0VxUIexWJRMBzHQa/XQ61WQ6VSQbVaxWg0wmq1wuFwwG6/x2azkfh4PMq6V7XtdoucMvL94QHlUgn9fh/dbhdGu90GabVaaDab6HQ6WCwWIrJer+XgbDYTmPMiMplMlIEqUtYvZD8+4Dhd0RBBKtPlcDjE6XTCbre7uJnP5yKwXC4xHo9FlA4ZT6dTMVMul0WMZkSQAUU1HAPROS8jOufzKMDZn2dXQqPROAvyQ3gLKal5cOXzeYg5Z8uewWAgYoT7nDeFyH8O+VN0g65p51qE0ClX9vAM0f/hH8F6vX7ZZM4bdeP1OLhHUTrkS7Q7fe4v9+LOX/w0pNEAAAAASUVORK5CYII=","aspectRatio":1.7777777777777777,"src":"/static/ee3a906c35a7a835d572efe4c3fc25a1/5707d/eyecatch.png","srcSet":"/static/ee3a906c35a7a835d572efe4c3fc25a1/497c6/eyecatch.png 400w,\n/static/ee3a906c35a7a835d572efe4c3fc25a1/ee604/eyecatch.png 800w,\n/static/ee3a906c35a7a835d572efe4c3fc25a1/5707d/eyecatch.png 1600w","srcWebp":"/static/ee3a906c35a7a835d572efe4c3fc25a1/7c22d/eyecatch.webp","srcSetWebp":"/static/ee3a906c35a7a835d572efe4c3fc25a1/1f5c5/eyecatch.webp 400w,\n/static/ee3a906c35a7a835d572efe4c3fc25a1/58556/eyecatch.webp 800w,\n/static/ee3a906c35a7a835d572efe4c3fc25a1/7c22d/eyecatch.webp 1600w","sizes":"(max-width: 1600px) 100vw, 1600px"},"original":{"src":"/static/eyecatch-ee3a906c35a7a835d572efe4c3fc25a1.png","width":1600,"height":900}}}}}},"pageContext":{"urlPath":"/blog/revamp-blog-with-gatsby-and-bulma/","previous":{"fields":{"urlPath":"/blog/ddd-in-2019/","jstDate":"2019-12-24"},"frontmatter":{"title":"DDDの個人的な現状 in 2019","date":"2019-12-24"}},"next":{"fields":{"urlPath":"/blog/revamp-dotfiles-20200923/","jstDate":"2020-09-23"},"frontmatter":{"title":"dotfilesを刷新した（2020-09）","date":"2020-09-22"}}}},"staticQueryHashes":["1862978031","277821901","4270455655"]}