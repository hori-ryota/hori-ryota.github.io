{"componentChunkName":"component---src-templates-blog-jsx","path":"/blog/ffmpeg-mp4-part-to-silence-nosound-missing/","result":{"data":{"markdownRemark":{"fields":{"urlPath":"/blog/ffmpeg-mp4-part-to-silence-nosound-missing/"},"html":"<p>FFmpegに限らずですが、動画の一部を無音にするとき”音声データの削除”と”無音データに置き換え”の区別がついていないと爆死する。</p>\n<!--more-->\n<h2>作業手順</h2>\n<ol>\n<li>動画を切り分ける（音声を抜く部分、その前後、の3つに）</li>\n<li>音声を無音に変換する</li>\n<li>1で分けた動画を結合する</li>\n</ol>\n<h2>音を消すだけじゃダメ</h2>\n<p>無音音声の動画と音声データがない動画は別のものです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d5ccabb46ea9f698e44838a354f2f993/99072/figure1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAAqElEQVQY06WQzQqDMBCEff/H6rXHQvEPWhBjtRRNNUkTsztNoGCrBw8dPvaQZZjNJNgXwY0gB/jVIonDeSgLYrh5zexJK3svoTvbt59HosXsr7fX4cSTRl6jWDNnla5TDJkqc2QCaQWpopU5wR+K5krSUTA/dYwqxS+NyyrZS8sYLuGQhguBUS/JD0XnznP4+WS20GhqSa2CNxYhYDShiK/C9uQodrrVG0gHl/nwMXTNAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"無音音声の動画と音声データがない動画の違い\"\n        title=\"無音音声の動画と音声データがない動画の違い\"\n        src=\"/static/d5ccabb46ea9f698e44838a354f2f993/fcda8/figure1.png\"\n        srcset=\"/static/d5ccabb46ea9f698e44838a354f2f993/12f09/figure1.png 148w,\n/static/d5ccabb46ea9f698e44838a354f2f993/e4a3f/figure1.png 295w,\n/static/d5ccabb46ea9f698e44838a354f2f993/fcda8/figure1.png 590w,\n/static/d5ccabb46ea9f698e44838a354f2f993/99072/figure1.png 842w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>音声データがない動画を音声データのある動画と結合した場合、図のように部分的に音声データが欠落している動画となるのですが、 プレーヤーが上手いこと補ったりスルーしてくれるわけでもなく、再生時に不具合となります。</p>\n<p>なので、代わりの音声データ（無音）をきちんと入れてあげましょう、という話。</p>\n<p>以下、正しい作業手順を貼っておきます</p>\n<h2>具体的な手順</h2>\n<h3>1. 動画を切り分ける</h3>\n<blockquote>\n<p><a href=\"/blog/ffmpeg-mp4-cut\">FFmpegで秒数を指定して動画を切り出すワンライナー</a></p>\n</blockquote>\n<p>上記は切り出すコマンドなので、3回叩きます。切り分けるコマンドもあるのかな？</p>\n<p>50秒-60秒を無音にしたいのであれば</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">ffmpeg -i src.mp4 -t <span class=\"token number\">50</span> before.mp4\nffmpeg -ss <span class=\"token number\">50</span> -i src.mp4 -t <span class=\"token number\">10</span> target.mp4\nffmpeg -ss <span class=\"token number\">60</span> -i src.mp4 after.mp4</code></pre></div>\n<p>ですね。 <code class=\"language-text\">-c copy</code> オプションは速いですが時間がズレるので、つけずにトランスコードしたほうが良いかと思います。</p>\n<h3>2. 音声を無音に変換する</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">ffmpeg -i target.mp4 -f lavfi -i <span class=\"token assign-left variable\">aevalsrc</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> -c:v copy -map <span class=\"token number\">0</span>:0 -map <span class=\"token number\">1</span>:0 -shortest -ac <span class=\"token number\">2</span> -strict -2 silence.mp4</code></pre></div>\n<p>軽く解説すると、ffmpegは <code class=\"language-text\">-i</code> オプションで指定されるデータ元を0からの連番で数えているので</p>\n<ul>\n<li>0番目のデータ</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">-i target.mp4</code></pre></div>\n<ul>\n<li>1番目のデータ</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">-f lavfi -i <span class=\"token assign-left variable\">aevalsrc</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> </code></pre></div>\n<p>となります。この1番目のデータはFFmpegのフィルタで無音データを生成しています。</p>\n<p>出力部ですが、</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">-map <span class=\"token punctuation\">[</span>n番目の入力データの<span class=\"token punctuation\">]</span>:<span class=\"token punctuation\">[</span>n番目のストリーム<span class=\"token punctuation\">]</span></code></pre></div>\n<p>という書式です。なので</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">-map <span class=\"token number\">0</span>:0 -map <span class=\"token number\">1</span>:0</code></pre></div>\n<p>は <code class=\"language-text\">0番目の入力データの0番目のストリーム</code> と <code class=\"language-text\">1番目の入力データの0番目のストリーム</code> を使うという意味になります。</p>\n<p>他のオプションは</p>\n<ul>\n<li><code class=\"language-text\">-c:v copy</code> : 映像データをトランスコードせずにそのまま使う</li>\n<li><code class=\"language-text\">-shortest</code> : 入力データのうち最も短いものに長さを合わせる。今回は1番目の入力がフィルタで無限なので、つけないと終わらない</li>\n<li><code class=\"language-text\">-ac 2</code> : <code class=\"language-text\">1</code> はモノラル、 <code class=\"language-text\">2</code> はステレオ。元動画に合わせるといいかと</li>\n<li><code class=\"language-text\">-strict -2</code> : 音声コーデックがaacの場合に必要なもの。今回は明示的に <code class=\"language-text\">-c:a</code> でコーデックを指定していないが、aacなので。</li>\n</ul>\n<p>です。</p>\n<h3>3. 動画を結合する</h3>\n<blockquote>\n<p><a href=\"/blog/ffmpeg-mp4-concatenate\">FFmpegでMP4を結合（concat）するワンライナー</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"/blog/mp4box-mp4-concatenate\">MP4BoxでMP4を結合（concat）するワンライナー</a></p>\n</blockquote>\n<p>らへんを参考にして結合。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">ffmpeg -i <span class=\"token string\">\"concat:before.mp4|silence.mp4|after.mp4\"</span> -c copy dst.mp4</code></pre></div>\n<h2>以上。</h2>\n<p>動画のfpsが途中で変わっているとか、音声の周波数が〜とか、細かい条件がなければこんな感じで5コマンドくらいですね。</p>\n<p>無音ではなくピー音で置き換える場合は工程2の入力データをピー音に差し替えてあげてください。拾ってきてもいいし、 <code class=\"language-text\">aevalsrc</code> を</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">aevalsrc</span><span class=\"token operator\">=</span><span class=\"token string\">\"sin(880*2*PI*t)\"</span></code></pre></div>\n<p>のように指定して音声を作ってあげてもいいかと。 <code class=\"language-text\">880</code> が周波数なので大きくすれば高音に、小さくすれば低音になります。</p>","excerpt":"FFmpegに限らずですが、動画の一部を無音にするとき”音声データの削除”と”無音データに置き換え”の区別がついていないと爆死する。","frontmatter":{"date":"2016-06-19","title":"FFmpegで動画の一部を無音にするときは音声を削除せずに無音データで埋めないとダメ","tags":["Development","Shell","Video Editing","FFmpeg"],"eyecatch":null}}},"pageContext":{"urlPath":"/blog/ffmpeg-mp4-part-to-silence-nosound-missing/","previous":{"fields":{"urlPath":"/blog/ffmpeg-mp4-cut/"},"frontmatter":{"title":"FFmpegで秒数を指定して動画を切り出すワンライナー","date":"2016-06-18"}},"next":{"fields":{"urlPath":"/blog/update-cloudfront-with-awscli/"},"frontmatter":{"title":"CloudFrontの設定をコマンドラインから更新する","date":"2016-06-25"}}}},"staticQueryHashes":["2432199166","277821901","3202776293"]}