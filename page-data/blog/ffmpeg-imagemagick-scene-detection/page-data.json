{"componentChunkName":"component---src-templates-blog-jsx","path":"/blog/ffmpeg-imagemagick-scene-detection/","result":{"data":{"markdownRemark":{"fields":{"urlPath":"/blog/ffmpeg-imagemagick-scene-detection/","jstDate":"2017-02-28"},"html":"<p>FFmpeg のみで動画からシーン検出するスクリプトはちらほらと見かけるのですが、軽量でシンプルなシーン検出が欲しかったのでサムネイルと ImageMagick で整備してみました。</p>\n<!--more-->\n<h2>やりたいこと</h2>\n<p>動画の要らない部分をカットしたかったのですが、落ちていた FFmpeg のシーン検出スクリプトが古い FFmpeg に依存していたり環境が限定されたり、ちょっと扱いづらそうだったので自作しようと思ったのがきっかけです。</p>\n<p>FFmpeg のみで試行錯誤するのも良かったのですが、別の用途で一定時間ごとのサムネイルを生成する必要があったため、サムネイルを使いまわして映像のみでのシーン検出をやってみました。</p>\n<p>動画を元データに検出しようとするとそれなりに負荷も時間もかかりますが、サムネイル比較であれば高速で軽量なのでお得です。</p>\n<h2>準備</h2>\n<p>FFmpeg と ImageMagick を用意します。</p>\n<p>Docker でインストールする場合は Alpine の apk で取れる FFmpeg のバージョンは古いので注意が必要です。</p>\n<p>動作確認したのは</p>\n<ul>\n<li>FFmpeg : <code class=\"language-text\">3.2.2</code></li>\n<li>ImageMagick : <code class=\"language-text\">6.9.6-8</code>, <code class=\"language-text\">7.0.5-0</code></li>\n</ul>\n<p>です。 ImageMagick は apk でとれる <code class=\"language-text\">6.9.6-8</code> でも動きました。</p>\n<h2>サムネイル生成</h2>\n<p>FFmpeg によるサムネイル生成は色々とやり方があるのですが、方法によっては取得されるサムネイルの時間が不正確な場合があります。</p>\n<p>試した中で最もズレが少なかったのが以下。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">ffmpeg -i <span class=\"token string\">'src.mp4'</span> -filter:v <span class=\"token assign-left variable\">fps</span><span class=\"token operator\">=</span>fps<span class=\"token operator\">=</span><span class=\"token number\">1</span>/5<span class=\"token operator\">=</span>down output/%04d.jpg</code></pre></div>\n<p><code class=\"language-text\">fps</code> の <code class=\"language-text\">1/5</code> は5秒に1枚のペースで出力するという意味です。10秒ごとなら <code class=\"language-text\">1/10</code> です。</p>\n<p><code class=\"language-text\">output/</code> ディレクトリを出力先にしているので、事前にディレクトリは作っておきます。</p>\n<h2>シーン検出</h2>\n<p>1つ前のサムネイルとの差分がどの程度あるかによってシーン変化を検出します。</p>\n<p>ImageMagick には <code class=\"language-text\">compare</code> というコマンドがあり、差分画像を出力することができます。</p>\n<blockquote>\n<p><a href=\"https://www.imagemagick.org/script/compare.php\">Command-line Tools: Compare @ ImageMagick</a></p>\n</blockquote>\n<p>使い方はこんな感じ。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">compare -metric AE output/0000.jpg output/0001.jpg diff.jpg</code></pre></div>\n<p>差分画像が diff.jpg に出力されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/431d3eb2292318276f65d5342e38d8e2/eea4a/src1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIFAwb/xAAWAQEBAQAAAAAAAAAAAAAAAAABAAL/2gAMAwEAAhADEAAAAX059grkg1f/xAAbEAABBAMAAAAAAAAAAAAAAAAAAQMRFAIQE//aAAgBAQABBQKy2d24sYiak//EABYRAAMAAAAAAAAAAAAAAAAAAAABEf/aAAgBAwEBPwGIiP/EABcRAQADAAAAAAAAAAAAAAAAAAABESH/2gAIAQIBAT8BuWv/xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAaEAACAgMAAAAAAAAAAAAAAAAAARExECFh/9oACAEBAAE/IVRDOActYN6Gx//aAAwDAQACAAMAAAAQuM//xAAVEQEBAAAAAAAAAAAAAAAAAAAAYf/aAAgBAwEBPxCCD//EABcRAAMBAAAAAAAAAAAAAAAAAAABURH/2gAIAQIBAT8QdDaP/8QAGxABAAICAwAAAAAAAAAAAAAAAQARIVFBodH/2gAIAQEAAT8QaYTuoni3eWW3iJUvcQuLcAtPU//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"src1.jpg\"\n        title=\"src1.jpg\"\n        src=\"/static/431d3eb2292318276f65d5342e38d8e2/1c72d/src1.jpg\"\n        srcset=\"/static/431d3eb2292318276f65d5342e38d8e2/a80bd/src1.jpg 148w,\n/static/431d3eb2292318276f65d5342e38d8e2/1c91a/src1.jpg 295w,\n/static/431d3eb2292318276f65d5342e38d8e2/1c72d/src1.jpg 590w,\n/static/431d3eb2292318276f65d5342e38d8e2/a8a14/src1.jpg 885w,\n/static/431d3eb2292318276f65d5342e38d8e2/fbd2c/src1.jpg 1180w,\n/static/431d3eb2292318276f65d5342e38d8e2/eea4a/src1.jpg 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3eddf0280062418e72797067befdf3ab/eea4a/src2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUBAgP/xAAVAQEBAAAAAAAAAAAAAAAAAAABAP/aAAwDAQACEAMQAAABvogkG4qG/8QAGhAAAQUBAAAAAAAAAAAAAAAAAwACERMUIP/aAAgBAQABBQLQNXjjQ3j/xAAWEQADAAAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8BiIj/xAAXEQEAAwAAAAAAAAAAAAAAAAAAAREh/9oACAECAQE/Ablr/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGhAAAgIDAAAAAAAAAAAAAAAAAAERMRAhYf/aAAgBAQABPyFVQzgHLWG2PR//2gAMAwEAAgADAAAAEKvv/8QAFREBAQAAAAAAAAAAAAAAAAAAAGH/2gAIAQMBAT8Qgk//xAAXEQADAQAAAAAAAAAAAAAAAAAAAVFh/9oACAECAQE/ENBOj//EABwQAQACAgMBAAAAAAAAAAAAAAEAESFBEDFRsf/aAAgBAQABPxB5hPtRPFu7e5ZfFcGaHUdgKMeT/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"src2.jpg\"\n        title=\"src2.jpg\"\n        src=\"/static/3eddf0280062418e72797067befdf3ab/1c72d/src2.jpg\"\n        srcset=\"/static/3eddf0280062418e72797067befdf3ab/a80bd/src2.jpg 148w,\n/static/3eddf0280062418e72797067befdf3ab/1c91a/src2.jpg 295w,\n/static/3eddf0280062418e72797067befdf3ab/1c72d/src2.jpg 590w,\n/static/3eddf0280062418e72797067befdf3ab/a8a14/src2.jpg 885w,\n/static/3eddf0280062418e72797067befdf3ab/fbd2c/src2.jpg 1180w,\n/static/3eddf0280062418e72797067befdf3ab/eea4a/src2.jpg 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/126b54ab330f30a91ff3da6c414a6edb/eea4a/diff-AE.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAf/EABYBAQEBAAAAAAAAAAAAAAAAAAADBf/aAAwDAQACEAMQAAABnJ9lquEh/8QAFxAAAwEAAAAAAAAAAAAAAAAAAAESIP/aAAgBAQABBQKyilj/xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAwEBPwGH/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBAAAgMAAAAAAAAAAAAAAAAAAFERICH/2gAIAQEAAT8hEXoyn//aAAwDAQACAAMAAAAQZD//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQMBAT8QhMf/xAAWEQADAAAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QpX//xAAaEAEBAAIDAAAAAAAAAAAAAAABABFxEDFR/9oACAEBAAE/EAeu7scoo5Cu44Vv/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"diff-AE.jpg\"\n        title=\"diff-AE.jpg\"\n        src=\"/static/126b54ab330f30a91ff3da6c414a6edb/1c72d/diff-AE.jpg\"\n        srcset=\"/static/126b54ab330f30a91ff3da6c414a6edb/a80bd/diff-AE.jpg 148w,\n/static/126b54ab330f30a91ff3da6c414a6edb/1c91a/diff-AE.jpg 295w,\n/static/126b54ab330f30a91ff3da6c414a6edb/1c72d/diff-AE.jpg 590w,\n/static/126b54ab330f30a91ff3da6c414a6edb/a8a14/diff-AE.jpg 885w,\n/static/126b54ab330f30a91ff3da6c414a6edb/fbd2c/diff-AE.jpg 1180w,\n/static/126b54ab330f30a91ff3da6c414a6edb/eea4a/diff-AE.jpg 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>赤いのが全部差分です。ほぼ差分となってしまっていますが、動画の場合はノイズが乗るので単純比較だと上手くいきませんでした。</p>\n<p>オプションを指定することで解決できます。</p>\n<p><code class=\"language-text\">compare</code> コマンドでは <code class=\"language-text\">-metrics</code> オプションで差分のロジックを指定できます。</p>\n<p>一覧はこちら。</p>\n<blockquote>\n<p><a href=\"https://www.imagemagick.org/script/command-line-options.php#metric\">Command-line Options @ ImageMagick</a></p>\n</blockquote>\n<p>それぞれ向き不向きはあると思いますが、単純な差分抽出であれば上記サンプルで使用している、変化のあったピクセルをチェックする <code class=\"language-text\">AE</code> がお手軽かと思います。</p>\n<p>なお、動画の場合はどうしてもノイズが生じるため、厳密な画像比較をするとほとんど全面が差分として出力されてしまいます。対処としては <code class=\"language-text\">AE</code> を使用する場合は <code class=\"language-text\">-fuzz</code> オプションを併用すると微量の色変化では反応しなくなるため使いやすいです。</p>\n<p>10% で指定したのがこちら。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">compare -metric AE -fuzz <span class=\"token number\">10</span>% output/0000.jpg output/0001.jpg diff.jpg</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b14758bd83ca17d45382fba12b68ad05/eea4a/diff-AE-FUZZ10.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQFAf/EABcBAAMBAAAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAamqrzrSJ4z/xAAbEAEAAgIDAAAAAAAAAAAAAAABAAIREwMSIf/aAAgBAQABBQI5TG0mwllwr2p6f//EABcRAAMBAAAAAAAAAAAAAAAAAAABAhH/2gAIAQMBAT8BUaOEf//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAECAQE/Aaf/xAAXEAADAQAAAAAAAAAAAAAAAAAAATEg/9oACAEBAAY/AoyMjx//xAAcEAABBAMBAAAAAAAAAAAAAAAAAREhMRBRcfH/2gAIAQEAAT8htHOYTyBNYjXhiyuz/9oADAMBAAIAAwAAABBcD//EABcRAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQMBAT8QRuCLh//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAgEBPxBRa3//xAAbEAEAAwEAAwAAAAAAAAAAAAABABEhMUFRYf/aAAgBAQABPxDZru8RMxH1WwcuK2lO+Pkeey6UTdq2J//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"diff-AE-FUZZ10.jpg\"\n        title=\"diff-AE-FUZZ10.jpg\"\n        src=\"/static/b14758bd83ca17d45382fba12b68ad05/1c72d/diff-AE-FUZZ10.jpg\"\n        srcset=\"/static/b14758bd83ca17d45382fba12b68ad05/a80bd/diff-AE-FUZZ10.jpg 148w,\n/static/b14758bd83ca17d45382fba12b68ad05/1c91a/diff-AE-FUZZ10.jpg 295w,\n/static/b14758bd83ca17d45382fba12b68ad05/1c72d/diff-AE-FUZZ10.jpg 590w,\n/static/b14758bd83ca17d45382fba12b68ad05/a8a14/diff-AE-FUZZ10.jpg 885w,\n/static/b14758bd83ca17d45382fba12b68ad05/fbd2c/diff-AE-FUZZ10.jpg 1180w,\n/static/b14758bd83ca17d45382fba12b68ad05/eea4a/diff-AE-FUZZ10.jpg 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>30% で指定したものがこちら。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">compare -metric AE -fuzz <span class=\"token number\">30</span>% output/0000.jpg output/0001.jpg diff.jpg</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4b8ef4023c25efb969e842a402405ac4/eea4a/diff-AE-FUZZ30.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAezsRRIf/8QAFhABAQEAAAAAAAAAAAAAAAAAEgAg/9oACAEBAAEFAlKWP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAMAAwAAAAAAAAAAAAAAAAABESAxUf/aAAgBAQABPyFJNMiEceH/2gAMAwEAAgADAAAAEDPf/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAERIf/aAAgBAwEBPxDFQ//EABURAQEAAAAAAAAAAAAAAAAAAAAh/9oACAECAQE/EKr/xAAcEAEAAgEFAAAAAAAAAAAAAAABABEQITFxkfH/2gAIAQEAAT8Qdqs4iOx6nkYVqC1P/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"diff-AE-FUZZ30.jpg\"\n        title=\"diff-AE-FUZZ30.jpg\"\n        src=\"/static/4b8ef4023c25efb969e842a402405ac4/1c72d/diff-AE-FUZZ30.jpg\"\n        srcset=\"/static/4b8ef4023c25efb969e842a402405ac4/a80bd/diff-AE-FUZZ30.jpg 148w,\n/static/4b8ef4023c25efb969e842a402405ac4/1c91a/diff-AE-FUZZ30.jpg 295w,\n/static/4b8ef4023c25efb969e842a402405ac4/1c72d/diff-AE-FUZZ30.jpg 590w,\n/static/4b8ef4023c25efb969e842a402405ac4/a8a14/diff-AE-FUZZ30.jpg 885w,\n/static/4b8ef4023c25efb969e842a402405ac4/fbd2c/diff-AE-FUZZ30.jpg 1180w,\n/static/4b8ef4023c25efb969e842a402405ac4/eea4a/diff-AE-FUZZ30.jpg 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>用途によって適切な設定は異なると思いますが、ものの移動や場所の切り替えについては検出できていそうな画像が出力されていることが分かるかと思います。</p>\n<p>試しに同じ動画内でシーンが切り替わった画像を 10% で比較してみると</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/17f1a740893546a997fc01185689c7e4/eea4a/src3.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUDBAb/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAY7CQNKJTN//xAAcEAABBAMBAAAAAAAAAAAAAAABAAIDIQQRFDL/2gAIAQEAAQUC6NJmXZntD1M0Nk//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPwFH/8QAHRAAAgEEAwAAAAAAAAAAAAAAAAECEDEykTNhof/aAAgBAQAGPwLD041stHdIrsaR/8QAGRABAQEBAQEAAAAAAAAAAAAAAREAIXGR/9oACAEBAAE/IZFPvOQQ9nSi3mi5rRzCNgb/2gAMAwEAAgADAAAAEBM//8QAFhEBAQEAAAAAAAAAAAAAAAAAAAEh/9oACAEDAQE/EIx//8QAFhEBAQEAAAAAAAAAAAAAAAAAAREA/9oACAECAQE/EExRbv/EAB0QAQACAwADAQAAAAAAAAAAAAEAESExQYGRscH/2gAIAQEAAT8Q5YN0fkyGXSA9pqEuF6KfJQq4gEsFeSB1dgOT/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"src3.jpg\"\n        title=\"src3.jpg\"\n        src=\"/static/17f1a740893546a997fc01185689c7e4/1c72d/src3.jpg\"\n        srcset=\"/static/17f1a740893546a997fc01185689c7e4/a80bd/src3.jpg 148w,\n/static/17f1a740893546a997fc01185689c7e4/1c91a/src3.jpg 295w,\n/static/17f1a740893546a997fc01185689c7e4/1c72d/src3.jpg 590w,\n/static/17f1a740893546a997fc01185689c7e4/a8a14/src3.jpg 885w,\n/static/17f1a740893546a997fc01185689c7e4/fbd2c/src3.jpg 1180w,\n/static/17f1a740893546a997fc01185689c7e4/eea4a/src3.jpg 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5d3b8b4356c711faa5dcdf40518d646f/eea4a/diff-AE-FUZZ10-changed.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAv/EABYBAQEBAAAAAAAAAAAAAAAAAAIBBP/aAAwDAQACEAMQAAABRu1I3RDiP//EABkQAAIDAQAAAAAAAAAAAAAAAAACAREhMf/aAAgBAQABBQIvLGiIG6ur/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAEDERL/2gAIAQMBAT8BUtmz/8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bh//EABkQAAEFAAAAAAAAAAAAAAAAABAAARESMf/aAAgBAQAGPwLFFS4//8QAGhAAAwADAQAAAAAAAAAAAAAAAAEREEFRIf/aAAgBAQABPyFeiLRb3eDypKnHodop/9oADAMBAAIAAwAAABAz3//EABcRAQEBAQAAAAAAAAAAAAAAABEAATH/2gAIAQMBAT8Q6S0aF//EABYRAQEBAAAAAAAAAAAAAAAAAAARIf/aAAgBAgEBPxDCP//EABwQAQEAAgIDAAAAAAAAAAAAAAERACExUWGBkf/aAAgBAQABPxBVBL1l4Rdux6yOn5kjwdIcYBRFHueHHB144z//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"diff-AE-FUZZ10-changed.jpg\"\n        title=\"diff-AE-FUZZ10-changed.jpg\"\n        src=\"/static/5d3b8b4356c711faa5dcdf40518d646f/1c72d/diff-AE-FUZZ10-changed.jpg\"\n        srcset=\"/static/5d3b8b4356c711faa5dcdf40518d646f/a80bd/diff-AE-FUZZ10-changed.jpg 148w,\n/static/5d3b8b4356c711faa5dcdf40518d646f/1c91a/diff-AE-FUZZ10-changed.jpg 295w,\n/static/5d3b8b4356c711faa5dcdf40518d646f/1c72d/diff-AE-FUZZ10-changed.jpg 590w,\n/static/5d3b8b4356c711faa5dcdf40518d646f/a8a14/diff-AE-FUZZ10-changed.jpg 885w,\n/static/5d3b8b4356c711faa5dcdf40518d646f/fbd2c/diff-AE-FUZZ10-changed.jpg 1180w,\n/static/5d3b8b4356c711faa5dcdf40518d646f/eea4a/diff-AE-FUZZ10-changed.jpg 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>このように大きく変化していることがわかります。</p>\n<h2>変化率の抽出</h2>\n<p>差分画像が出力されるので画像から解析しても良いのですが、 <code class=\"language-text\">compare</code> コマンドでは差分が生じる場合には標準エラー出力に差分を示す数値が出力されます。</p>\n<p><code class=\"language-text\">AE</code> の場合は変化したピクセル数が出力されるので、全体の解像度と比較してどのくらいの割合が変化したかを算出することができます。</p>\n<p>先ほどの <code class=\"language-text\">-fuzz 30%</code> 指定の場合では</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\">compare -metric AE -fuzz <span class=\"token number\">30</span>% output/0000.jpg output/0001.jpg /dev/null</span></span>\n<span class=\"token output\">18743</span></code></pre></div>\n<p>サムネイルサイズが <code class=\"language-text\">1280x720</code> だったので</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">18743 / (1280*720) = 0.020337457</code></pre></div>\n<p>で 2% くらいの変化率ですね。</p>\n<p>このサムネイルの変化率が設定した閾値を超えた場合にシーン変更として扱うことでシーン検出を実現できるかと思います。</p>\n<h2>以上</h2>\n<p>ImageMagick も FFmpeg もオプションが豊富すぎてとっつきにくい印象がどうしてもありますが、コマンドで一括処理できるのが非常に捗るので熟達していきたいものです。</p>","excerpt":"FFmpeg のみで動画からシーン検出するスクリプトはちらほらと見かけるのですが、軽量でシンプルなシーン検出が欲しかったのでサムネイルと ImageMagick で整備してみました。","frontmatter":{"date":"2017-02-28T01:00:14+09:00","title":"FFmpeg と ImageMagick によるサムネイルを用いた動画のシーン検出","tags":["Development","Shell","Video Editing","FFmpeg","ImageMagick"],"eyecatch":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABYBAQEBAAAAAAAAAAAAAAAAAAABA//aAAwDAQACEAMQAAABq1M80YA//8QAGxAAAgIDAQAAAAAAAAAAAAAAAQIAFAQREiH/2gAIAQEAAQUCGW0tGW2jE6LHpPR//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAECEf/aAAgBAwEBPwFRo4R//8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8Bqv/EABkQAAIDAQAAAAAAAAAAAAAAAAAQAREyMf/aAAgBAQAGPwLJyDKpf//EABwQAAICAgMAAAAAAAAAAAAAAAABETEhkVFhwf/aAAgBAQABPyGDlNDWvI6GhaxcsQWXyf/aAAwDAQACAAMAAAAQ1x//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8QKC4//8QAFhEBAQEAAAAAAAAAAAAAAAAAABEB/9oACAECAQE/ENhT/8QAHBAAAgIDAQEAAAAAAAAAAAAAAREA0SExUUFh/9oACAEBAAE/EDAD3XuNDjwFcbeuNoTfnyGjsOQhDdlOE//Z","aspectRatio":1.7777777777777777,"src":"/static/265eb9a7ef8fde5d3186559f2420f7ae/ec6c5/eyecatch.jpg","srcSet":"/static/265eb9a7ef8fde5d3186559f2420f7ae/2244e/eyecatch.jpg 400w,\n/static/265eb9a7ef8fde5d3186559f2420f7ae/14b42/eyecatch.jpg 800w,\n/static/265eb9a7ef8fde5d3186559f2420f7ae/ec6c5/eyecatch.jpg 1280w","srcWebp":"/static/265eb9a7ef8fde5d3186559f2420f7ae/135cd/eyecatch.webp","srcSetWebp":"/static/265eb9a7ef8fde5d3186559f2420f7ae/1f5c5/eyecatch.webp 400w,\n/static/265eb9a7ef8fde5d3186559f2420f7ae/58556/eyecatch.webp 800w,\n/static/265eb9a7ef8fde5d3186559f2420f7ae/135cd/eyecatch.webp 1280w","sizes":"(max-width: 1280px) 100vw, 1280px"},"original":{"src":"/static/eyecatch-265eb9a7ef8fde5d3186559f2420f7ae.jpg","width":1280,"height":720}}}}}},"pageContext":{"urlPath":"/blog/ffmpeg-imagemagick-scene-detection/","previous":{"fields":{"urlPath":"/blog/create-docker-image-with-gobin-in-alpine/","jstDate":"2017-02-24"},"frontmatter":{"title":"Docker in Docker で Go 製のバイナリを持った軽量な Docker イメージを作る","date":"2017-02-24"}},"next":{"fields":{"urlPath":"/blog/aurora-matsuri20170307/","jstDate":"2017-03-07"},"frontmatter":{"title":"Amazon Aurora 事例祭り（20170307）に行ってきたメモ","date":"2017-03-07"}}}},"staticQueryHashes":["1862978031","277821901","4270455655"]}