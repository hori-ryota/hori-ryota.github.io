{"componentChunkName":"component---src-templates-blog-jsx","path":"/blog/aurora-matsuri20170307/","result":{"data":{"markdownRemark":{"fields":{"urlPath":"/blog/aurora-matsuri20170307/","jstDate":"2017-03-07"},"html":"<p><a href=\"https://aws.amazon.com/jp/about-aws/events/2017/aurora-20170307/\">Amazon Aurora 事例祭り</a> に行ってきたので、メモを公開します。</p>\n<!--more-->\n<p>社内共有で Slack に貼ろうと思っていたメモなのですが、長くなったのでブログに公開します。</p>\n<h2>概要</h2>\n<p><a href=\"https://aws.amazon.com/jp/about-aws/events/2017/aurora-20170307/\">Amazon Aurora 事例祭り （2017 年 3 月 7 日開催） | AWS</a></p>\n<h2>セッション内容</h2>\n<h3>Amazon Auroraを使いこなすためのベストプラクティスと最新アップデート</h3>\n<ul>\n<li>\n<p><a href=\"https://twitter.com/con_mame\">@con_mame</a> さん</p>\n<ul>\n<li>データベースソリューションアーキテクト</li>\n</ul>\n</li>\n<li>登壇資料: <a href=\"https://www.slideshare.net/AmazonWebServicesJapan/auroraamazon-aurora\">[Aurora事例祭り]Amazon Aurora を使いこなすためのベストプラクティス</a></li>\n<li>開発サイドからの知見と今後の展望</li>\n<li>\n<p>PostgreSQL For Aurora でるよ！</p>\n<ul>\n<li><code class=\"language-text\">9.6.4</code> と互換</li>\n<li>MySQL 版と同等の機能ができるようにする予定（まだ開発中なので確約はできない）</li>\n</ul>\n</li>\n<li><a href=\"https://aws.amazon.com/jp/rds/aurora/details/\">製品の詳細 - Amazon Aurora | AWS</a> の再紹介</li>\n<li>\n<p>Aurora は障害時のフェイルオーバーでは DNS レベルで master を切り替える</p>\n<ul>\n<li>DNS の TTL は 5s</li>\n<li>アプリケーション側で DNS キャッシュしていると切り替えが遅れるので注意</li>\n</ul>\n</li>\n<li>master か否かは read only の変数を見ると分かる（ <em>パラメータ名は聞き漏らしました</em> ）</li>\n<li>\n<p><code class=\"language-text\">JDBC Driver</code> を使っている人は <code class=\"language-text\">MariaDB Connector/J 1.2.0</code> が Aurora 対応したのでオススメ</p>\n<ul>\n<li>master 判定が組み込まれており、フェイルオーバー時の切り替えが速い</li>\n</ul>\n</li>\n<li>\n<p>Aurora のパフォーマンスを引き出すために</p>\n<ul>\n<li>クエリ並列度が高い、データサイズが大きいケースで効果を発揮</li>\n<li>ロック機構や Query Cache 、スレッドプールなどに改善を入れて性能向上を行っている</li>\n<li>\n<p>CPU / Memory の利用率が MySQL より高いがスループットが出ている</p>\n<ul>\n<li>分散ロック機構で CPU リソースを使い切ってスループットを出している</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>MySQL 互換ではあるが、マシンリソースの使い方が根本的に違う</p>\n<ul>\n<li>使い切ってスループットを出す設計なので、ベンチなどをとる際はスループットに着目してもらえると嬉しい</li>\n</ul>\n</li>\n<li>\n<p>チューニング指針</p>\n<ul>\n<li>まずはデフォルトのパラメータグループをベースに</li>\n<li>\n<p>適切なインスタンスタイプを選択することが大切</p>\n<ul>\n<li>それでもダメならパラメータグループを設定</li>\n</ul>\n</li>\n<li>\n<p>1トランザクションで大量の更新や削除を行ったり、大量のシーケンシャルリードを行う場合</p>\n<ul>\n<li>range に区切って実行すると並列度が上がって良い（ Prallel Read Ahead ）</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>移行オススメな方々</p>\n<ul>\n<li>スループットを向上させたい</li>\n<li>ディスク容量が気になる</li>\n</ul>\n</li>\n<li>\n<p>最近のリリース</p>\n<ul>\n<li>Reader Endpoint の追加</li>\n<li>クロスリージョンレプリケーション対応</li>\n<li>フェイルオーバー順の指定</li>\n<li>\n<p>Cluster View</p>\n<ul>\n<li>インスタンス状況の一覧など</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>今後の展望（ re:Invent で発表されたやつ）</p>\n<ul>\n<li>RDS MySQL DB インスタンスから Aurora Read Replica が作成可能に</li>\n<li>Advanced Auditing</li>\n<li>Zero downtime patch</li>\n<li>etc. （色々とご紹介頂きましたが、既出の内容なので省略）</li>\n</ul>\n</li>\n</ul>\n<h3>AWS Database Migration Service と Schema Conversion Tool の使いドコロ</h3>\n<ul>\n<li><a href=\"https://aws.amazon.com/jp/dms/\">AWS Database Migration Service（データベースを簡単かつ安全に AWS へ移行） | AWS</a></li>\n<li><a href=\"http://docs.aws.amazon.com/ja_jp/SchemaConversionTool/latest/userguide/Welcome.html\">AWS Schema Conversion Tool とは - AWS Schema Conversion Tool</a></li>\n<li>適用できる組み合わせが広い</li>\n<li>自動変換できないところをレポートにまとめてくれるの便利</li>\n<li>詳細なパターン、フローをご紹介いただいた。メモが追いつかないのでスライドが公開されることを期待 -> 公開していただきました！</li>\n<li>登壇資料: <a href=\"https://www.slideshare.net/AmazonWebServicesJapan/auroraaws-database-migration-service-schema-conversion-tool\">[Aurora事例祭り]AWS Database Migration Service と Schema Conversion Tool の使いドコロ</a></li>\n</ul>\n<h3>Oracle RAC から Aurora MySQL へ移行したお話</h3>\n<ul>\n<li><a href=\"https://twitter.com/darshuheider\">@darshuheider</a> さん</li>\n<li>登壇資料: <a href=\"https://techblog.recochoku.jp/1576\">Amazon Aurora 事例祭りに登壇させていただきました！ | レコチョクのエンジニアブログ</a></li>\n<li>\n<p>レコチョクとは</p>\n<ul>\n<li>デジタル音源配信サービス</li>\n<li><a href=\"http://recochoku.jp/\">音楽ダウンロードアプリ、音楽ダウンロードサイト、曲のランキング・歌詞は【レコチョク】iPhone/Android対応</a></li>\n<li>機能やサービスごとにシステムを構築（マイクロサービス？）</li>\n</ul>\n</li>\n<li>\n<p>クラブレコチョクとは</p>\n<ul>\n<li>レコチョクが展開するサービスへ会員機能を提供</li>\n<li>有効会員数は約1000万</li>\n<li>アクセス数は多いと秒間250リクエストを超える</li>\n<li>サービス横断で使われるので可用性が重要</li>\n</ul>\n</li>\n<li>\n<p>Aurora を選択した理由</p>\n<ul>\n<li>\n<p>会社全体としての課題</p>\n<ul>\n<li>データ総量の予測が困難になってきた</li>\n<li>\n<p>コスト最適化</p>\n<ul>\n<li>短期間でのサービス立ち上げ</li>\n<li>急激なアクセス増に対する対応のためインフラを多めに確保していた</li>\n</ul>\n</li>\n<li>コストの明確化</li>\n</ul>\n</li>\n<li>\n<p>既存構成</p>\n<ul>\n<li>Oracle で RAC 構成</li>\n<li>DBA がインフラを運用</li>\n</ul>\n</li>\n<li>\n<p>Aurora へのモチベーション</p>\n<ul>\n<li>可用性の担保</li>\n<li>運用工数を抑えたい</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>どのように Aurora へ移行したか</p>\n<ul>\n<li>DMS などの移行ツールが一般公開される前だったので、全て自前のスクリプト</li>\n<li>\n<p>テーブルを再作成</p>\n<ul>\n<li>DDL の作成</li>\n<li>\n<p>パラメータグループの作成</p>\n<ul>\n<li>デフォルトのトランザクション分離レベルが Oracle と違うところがやらかしポイント</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>SQL の修正</p>\n<ul>\n<li>MySQL の構文に移植。</li>\n</ul>\n</li>\n<li>\n<p>データの移行</p>\n<ul>\n<li>更新日を見ながら過去数年分を一気に移行</li>\n<li>移行後、差分を適用</li>\n</ul>\n</li>\n<li>\n<p>性能試験</p>\n<ul>\n<li>\n<p>本番相当のデータを使って運用テスト、負荷テストを実施</p>\n<ul>\n<li>スロークエリをチェック</li>\n</ul>\n</li>\n<li>実行計画を取ってフルスキャンしているものを確認</li>\n<li>\n<p>問題があったものを対応</p>\n<ul>\n<li>SQL の最適化</li>\n<li>インデックス追加</li>\n<li>サブクエリ排除</li>\n<li>検索専用のテーブルを追加（後方一致検索が重かった）</li>\n<li>\n<p>パラメータの修正は一切行わず</p>\n<ul>\n<li>Aurora のデフォルト値を信用</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>どのように Aurora を運用しているか</p>\n<ul>\n<li>\n<p>何を見ればいいかわからないところからスタート</p>\n<ul>\n<li>標準的に見る項目や閾値を策定、ダッシュボード作成</li>\n</ul>\n</li>\n<li>\n<p>Aurora に合わせた監視内容に変更</p>\n<ul>\n<li>\n<p>CPU 使用率が高い</p>\n<ul>\n<li>リソースをフル活用するため</li>\n<li>リソースの監視を止め、スループットやレイテンシーの監視のみにした</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>結果</p>\n<ul>\n<li>\n<p>Aurora による障害はこれまで 0</p>\n<ul>\n<li>メンテナンスによる停止はあったが、ゼロダウンタイムパッチにより解消</li>\n</ul>\n</li>\n<li>DB サーバ運用に工数をほとんど割かなくてよくなった</li>\n<li>性能は問題なし（むしろ早くなった）</li>\n<li>ライセンス費用が 0</li>\n</ul>\n</li>\n<li>\n<p>今後への期待</p>\n<ul>\n<li>PostgreSQL 互換</li>\n<li>\n<p>暗号化されたスナップショットの別リージョンへのコピー</p>\n<ul>\n<li>バックアップを別リージョンに置きたかった</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3>MySQL on Fusion IO から Amazon Aurora への移設による費用削減効果</h3>\n<ul>\n<li><a href=\"http://mynet.co.jp/service/sangoku.html\">三国INFINITY（三国インフィニティ） | Mynet Inc. ( 株式会社マイネット )</a></li>\n<li>\n<p>旧 DB 構成</p>\n<ul>\n<li>12 Core 3ペア</li>\n<li>32 Core （ <em>メモ取り切れなかった</em> ）</li>\n</ul>\n</li>\n<li>\n<p>サーバ費用</p>\n<ul>\n<li>全体: 185万円 / 月</li>\n<li>内、DB の費用: 92.5万円 / 月</li>\n</ul>\n</li>\n<li>\n<p>AWS 移設計画</p>\n<ul>\n<li>マスター DB 全て Aurora 化</li>\n<li>スレーブは Aurora のパフォーマンス最大5倍を信じて捨てる</li>\n</ul>\n</li>\n<li>\n<p>新構成の費用</p>\n<ul>\n<li>DBの費用が約16万円 / 月 に（82%減）</li>\n<li>リザーブドインスタンス（年間で購入、月額で割った値）</li>\n<li>オンプレサーバを見守る人が不要になり、人件費も大幅に削減</li>\n<li>順調に稼働中</li>\n</ul>\n</li>\n<li>\n<p>質疑応答</p>\n<ul>\n<li>\n<p>メンテナンスは減ったか</p>\n<ul>\n<li>移行では流石にメンテナンスした</li>\n<li>メンテナンス回数は減った</li>\n<li>そんなに止めることはない</li>\n</ul>\n</li>\n<li>\n<p>どのくらいのデータ量をどのくらいの期間で移行したか</p>\n<ul>\n<li>メンテナンス自体は2日間という長期（ゲームとしてはかなり長期）</li>\n<li>数10GB</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3>毎日新聞ニュースサイトをクラウド化 ～Amazon Aurora 導入事例紹介～</h3>\n<ul>\n<li><a href=\"http://mainichi.jp/\">毎日新聞のニュース・情報サイト</a></li>\n<li>CMS 機能</li>\n<li>\n<p>Aurora 採用理由</p>\n<ul>\n<li>\n<p>高パフォーマンス</p>\n<ul>\n<li>高スループット</li>\n<li>低レイテンシーのリードレプリカ</li>\n</ul>\n</li>\n<li>メンテナンスビリティ</li>\n<li>\n<p>コスト</p>\n<ul>\n<li>ストレージが特にメリットと感じられた</li>\n</ul>\n</li>\n<li>MySQL 互換</li>\n<li>移行の簡単さ</li>\n</ul>\n</li>\n<li>\n<p>採用による効果</p>\n<ul>\n<li>メンテンナンスレス</li>\n<li>トラブルレス</li>\n<li>\n<p>技術者、社内利用者の意識改革</p>\n<ul>\n<li>背中を気にしなくてよくなり、様々な好循環があった</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3>MySQLからAuroraへ - 劇的な性能向上に止まらない、Aurora移行によるメリット -</h3>\n<ul>\n<li><a href=\"http://www.fate-go.jp/\">スマホでフェイト！｜Fate/Grand Order 公式サイト</a></li>\n<li>リリース時は MySQL 、途中で Aurora に移行</li>\n<li>\n<p>Aurora 移行方針、準備</p>\n<ul>\n<li>\n<p>モチベーション</p>\n<ul>\n<li>\n<p>ユーザー増を考えるととりあえず移行すればメリットありそう</p>\n<ul>\n<li>MySQL5.6 との互換性</li>\n<li>5倍のパフォーマンス</li>\n</ul>\n</li>\n<li>\n<p>Aurora だけで処理を捌ききれなくなったらどうするの</p>\n<ul>\n<li>参照クエリを slave に振り分けることを考えていた</li>\n<li>MySQL ではレプリ遅延が10秒を上回ってくるのであかん</li>\n<li>Auroraなら10ms - 20msくらいなのでいけそう</li>\n</ul>\n</li>\n<li>\n<p>DBデータ量が急増するゲーム施策のインフラ対応コストを削減したい</p>\n<ul>\n<li>ストレージ容量を増やそうとするとメンテだった</li>\n<li>Aurora の自動スケール嬉しい！</li>\n<li>検討時のデータ容量は 600GB 程度だったので 64TB あれば余裕そう</li>\n<li>とはいえデータを減らす努力は忘れずに</li>\n</ul>\n</li>\n<li>\n<p>インフラ費用を削減したい</p>\n<ul>\n<li>検討当時は 200GB のデータサイズに対して 1TB 以上のストレージ容量を確保していた</li>\n<li>ユーザー数が増加していたので、余裕を持たせる必要</li>\n<li>Aurora 移行ならインフラ構成に手を入れずに対応できるので嬉しい</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>方針</p>\n<ul>\n<li>移行前後のデータ不整合はダメ</li>\n<li>移行後のAurora 障害を考慮し、切り戻しできるように移行</li>\n</ul>\n</li>\n<li>\n<p>手順</p>\n<ul>\n<li>スナップショット作成（メンテ1h）</li>\n<li>スナップショットからAurora作成（5h）</li>\n<li>---<em>メモ取りきれなかった</em>---</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>失敗</p>\n<ul>\n<li>移行後48時間後にサーバの応答速度が不安定に</li>\n<li>slow query で <code class=\"language-text\">init DB</code> が重い</li>\n<li>binlogのパージっぽい</li>\n<li>\n<p>原因</p>\n<ul>\n<li>init DB 時にパフォーマンスが劣化する Aurora v1.6 のバグ</li>\n<li>v1.6.5 でfix</li>\n</ul>\n</li>\n<li>MySQL に切り戻した後、v1.7 で再移行した</li>\n</ul>\n</li>\n<li>\n<p>成果</p>\n<ul>\n<li>オートスケール上手いこといっている</li>\n<li>30%の費用減</li>\n</ul>\n</li>\n<li>\n<p>まとめ</p>\n<ul>\n<li>互換性のため移行の難易度は高くない</li>\n<li>パフォーマンスいい感じ</li>\n<li>とはいえ移行失敗時の切り戻しはしっかりね</li>\n</ul>\n</li>\n<li>\n<p>小ネタ</p>\n<ul>\n<li>\n<p>スナップショット作成が爆速</p>\n<ul>\n<li>MySQLで15分だったのが1分で終わる</li>\n</ul>\n</li>\n<li>\n<p>アップグレード管理</p>\n<ul>\n<li>ダウンタイムなしのアップグレードがリリースされたが、実行時のパフォーマンスは劣化するようなので注意</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>質疑応答</p>\n<ul>\n<li>\n<p><code class=\"language-text\">init DB</code> の地雷は他社でも踏んだ気配？</p>\n<ul>\n<li>事後に調べたらあったご様子</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">init DB</code> のバグは事前に伝えてもらえなかったの？</p>\n<ul>\n<li>AWS 側としてはここまでの影響が生じるとは予測できなかったため、事前にお伝えすることができなかった</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2>以上</h2>\n<p>運営、登壇の皆様、ありがとうございました。</p>\n<p>メモに何か間違いなどありましたらご指摘いただければ幸いです。</p>\n<p>今回のお話を伺った限りでは既存 DB からの移行もスムーズに行なえ、ゼロダウンタイムアップグレードもリリースされて機が熟してきたなーという雰囲気でした。</p>\n<p>担当サービスでも既に Aurora が導入されているので、上手く行かないパターンの知見も溜めていきたいところです。</p>","excerpt":"Amazon Aurora 事例祭り に行ってきたので、メモを公開します。","frontmatter":{"date":"2017-03-07T18:07:40+09:00","title":"Amazon Aurora 事例祭り（20170307）に行ってきたメモ","tags":["AWS","Aurora","Conference"],"eyecatch":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHBRIlRSv/EABgQAAMBAQAAAAAAAAAAAAAAAAECEQAS/9oACAEBAAEFAr0LrigBLtAzT//EABYRAQEBAAAAAAAAAAAAAAAAAAAREv/aAAgBAwEBPwHKP//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/AVf/xAAZEAEAAwEBAAAAAAAAAAAAAAAAAREhMRL/2gAIAQEABj8CVjjFepdl/8QAHBAAAgICAwAAAAAAAAAAAAAAAAERIVFhcYGx/9oACAEBAAE/IUyqU5QoW7EtirGuGxBqGJIT2P/aAAwDAQACAAMAAAAQuy//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBh/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAECAQE/EF2P/8QAHRAAAgEFAQEAAAAAAAAAAAAAAAERITFBUWGhwf/aAAgBAQABPxBhUWB+msUsXJVs6hl/y4ovoqsN3OzjbY//2Q==","aspectRatio":1.7777777777777777,"src":"/static/b24a39a9ee946b3d025b8f9897ebc2d4/0e329/eyecatch.jpg","srcSet":"/static/b24a39a9ee946b3d025b8f9897ebc2d4/2244e/eyecatch.jpg 400w,\n/static/b24a39a9ee946b3d025b8f9897ebc2d4/14b42/eyecatch.jpg 800w,\n/static/b24a39a9ee946b3d025b8f9897ebc2d4/0e329/eyecatch.jpg 1600w,\n/static/b24a39a9ee946b3d025b8f9897ebc2d4/50587/eyecatch.jpg 2400w,\n/static/b24a39a9ee946b3d025b8f9897ebc2d4/3340d/eyecatch.jpg 3200w,\n/static/b24a39a9ee946b3d025b8f9897ebc2d4/6a059/eyecatch.jpg 6000w","srcWebp":"/static/b24a39a9ee946b3d025b8f9897ebc2d4/7c22d/eyecatch.webp","srcSetWebp":"/static/b24a39a9ee946b3d025b8f9897ebc2d4/1f5c5/eyecatch.webp 400w,\n/static/b24a39a9ee946b3d025b8f9897ebc2d4/58556/eyecatch.webp 800w,\n/static/b24a39a9ee946b3d025b8f9897ebc2d4/7c22d/eyecatch.webp 1600w,\n/static/b24a39a9ee946b3d025b8f9897ebc2d4/f1e40/eyecatch.webp 2400w,\n/static/b24a39a9ee946b3d025b8f9897ebc2d4/f9eef/eyecatch.webp 3200w,\n/static/b24a39a9ee946b3d025b8f9897ebc2d4/3041e/eyecatch.webp 6000w","sizes":"(max-width: 1600px) 100vw, 1600px"},"original":{"src":"/static/eyecatch-b24a39a9ee946b3d025b8f9897ebc2d4.jpg","width":6000,"height":3375}}}}}},"pageContext":{"urlPath":"/blog/aurora-matsuri20170307/","previous":{"fields":{"urlPath":"/blog/ffmpeg-imagemagick-scene-detection/","jstDate":"2017-02-28"},"frontmatter":{"title":"FFmpeg と ImageMagick によるサムネイルを用いた動画のシーン検出","date":"2017-02-27"}},"next":{"fields":{"urlPath":"/blog/create-s3-lifecycle-manager/","jstDate":"2017-03-11"},"frontmatter":{"title":"S3 の Lifecycle をコードベースで管理できる環境を整備した","date":"2017-03-11"}}}},"staticQueryHashes":["1862978031","277821901","4270455655"]}