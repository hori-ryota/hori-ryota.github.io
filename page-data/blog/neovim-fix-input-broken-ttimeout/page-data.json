{"componentChunkName":"component---src-templates-blog-jsx","path":"/blog/neovim-fix-input-broken-ttimeout/","result":{"data":{"markdownRemark":{"fields":{"urlPath":"/blog/neovim-fix-input-broken-ttimeout/"},"html":"<p>Neovim を使用していて日本語入力時の文字化けに長いこと苦しんでいたのですが、解決の目処が立ったのでブログに残しておきます。</p>\n<p>日本語が普通に打てるって幸せ…！</p>\n<!--more-->\n<h2>そもそものバグ</h2>\n<p>Neovim で IME （ Google 日本語入力を使用しています）からの入力時を確定したタイミングでバーンっと文字化けするという症状がありました。</p>\n<blockquote class=\"twitter-tweet\"><p lang=\"ja\" dir=\"ltr\">Neovimで日本語入力文字化けする。入れ直せば入るが結構な高頻度で困ってる。<br>SKKとの相性かなんかかと思ったけど、Googleでも発生。<br>pluginも設定ファイルも全部無効でも発生(頻度はすげー下がるけど)するし、iTermとかtmuxとか関係ありそうなの切ってもダメ。 <a href=\"https://t.co/1vtFNlFeSH\">pic.twitter.com/1vtFNlFeSH</a></p>&mdash; ゆーいち@イカX (@u1tnk) <a href=\"https://twitter.com/u1tnk/status/879360193942896640?ref_src=twsrc%5Etfw\">June 26, 2017</a></blockquote>\n\n\n<blockquote class=\"twitter-tweet\"><p lang=\"ja\" dir=\"ltr\">NeoVimで「使ってみたかったので」の入力を確定（Enterキー）したらこのぶっ壊れである。<br>改行が入ったりコピペっぽい動きをするのだけど全然わからぬ…！ <a href=\"https://t.co/ls4dye2FRC\">pic.twitter.com/ls4dye2FRC</a></p>&mdash; hori (@hori_ryota) <a href=\"https://twitter.com/hori_ryota/status/873898431051255812?ref_src=twsrc%5Etfw\">June 11, 2017</a></blockquote>\n\n<h2>直し方</h2>\n<p>詳細は後述しますが、 <code class=\"language-text\">ttmeout</code> と <code class=\"language-text\">ttimeoutlen</code> が適切に設定されていないと生じる症状でした。</p>\n<p>init.nvim に以下を追記すれば直ります。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>init.nvim</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"vim\"><pre class=\"language-vim\"><code class=\"language-vim\"><span class=\"token keyword\">set</span> <span class=\"token builtin\">ttimeout</span>\n<span class=\"token keyword\">set</span> <span class=\"token builtin\">ttimeoutlen</span><span class=\"token operator\">=</span><span class=\"token number\">50</span></code></pre></div>\n<h2>原因</h2>\n<p>Neovim に issue があります。</p>\n<blockquote>\n<p><a href=\"https://github.com/neovim/neovim/issues/3094\">Arbitrarily invoke insert mysterious words when Japanese(or not english lauguege) input · Issue #3094 · neovim/neovim</a></p>\n</blockquote>\n<p>2015 年の古い closed issue ですが、実はまだ直っていなかったという。</p>\n<p>下の方に私の（拙い）英語コメントが新しく追加されていますが、概要をブログにも記しておきます。</p>\n<p>Neovim の input の挙動ですが、 Neovim ではキー入力（ input ）を受け取った際、一定の処理量ごとにバッファリングして処理します。</p>\n<blockquote>\n<p><a href=\"https://github.com/neovim/neovim/blob/685ca180f7c96f77a79c78d3b26bd003f8cd834c/src/nvim/tui/input.c#L385-L399\">neovim/input.c at 685ca180f7c96f77a79c78d3b26bd003f8cd834c · neovim/neovim</a></p>\n</blockquote>\n<p>一回のループでは</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>input.c</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">size_t consumed <span class=\"token operator\">=</span> <span class=\"token function\">termkey_push_bytes</span><span class=\"token punctuation\">(</span>input<span class=\"token operator\">-></span>tk<span class=\"token punctuation\">,</span> ptr<span class=\"token punctuation\">,</span> <span class=\"token function\">MIN</span><span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>で input 用のバッファから <code class=\"language-text\">input-&gt;tk</code> のサイズ分だけ抽出して処理を行います。</p>\n<p>抽出した <code class=\"language-text\">input-&gt;tk</code> のバッファを</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>input.c</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">tk_getkeys</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> false<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>で処理するのですが、先ほどの <code class=\"language-text\">termkey_push_bytes</code> で取得したバッファはバイト数で切り取っただけなのでマルチバイト文字を考慮できていません。</p>\n<p><code class=\"language-text\">tk_getkeys</code> はタイムアウトした場合、もしくはタイムアウトが設定されていない場合に、第二引数を <code class=\"language-text\">true</code> で呼び直し、すぐに解釈できない（確定できない）バイト列でも確定する、という挙動をします。</p>\n<blockquote>\n<p><a href=\"https://github.com/neovim/neovim/blob/685ca180f7c96f77a79c78d3b26bd003f8cd834c/src/nvim/tui/input.c#L266-L272\">neovim/input.c at 685ca180f7c96f77a79c78d3b26bd003f8cd834c · neovim/neovim</a></p>\n</blockquote>\n<p>よってマルチバイト文字を入力した際、分割されてしまったマルチバイトが上手く解釈できず悪さをし、文字化けする場合があるというのが主旨です。</p>\n<p><code class=\"language-text\">tk_getkeys</code> のタイムアウトの設定が先述のオプション <code class=\"language-text\">ttimeout</code> と <code class=\"language-text\">ttimeoutlen</code> なので、これらを適切に設定すると直りますが、デフォルト値が無効とする設定だったため文字化けに遭遇した日本ユーザーが続出したという経緯でした。</p>\n<p>なお、 2017-07-06 にデフォルト値を設定するプルリクがマージされたため、現在の master ブランチでは直っています。</p>\n<blockquote>\n<p><a href=\"https://github.com/neovim/neovim/pull/6969\">options: Default to ‘ttimeout’ and ‘ttimeoutlen=50’ by jamessan · Pull Request #6969 · neovim/neovim</a></p>\n</blockquote>\n<p>日本語以外でもマルチバイトな入力を行うと症状が出るため、カーソルキーの連打などで変な文字が入ってしまう症状もおなじ原因と考えています。今のところ私の環境では併せて改善しました。</p>\n<p>ちなみに、 <code class=\"language-text\">ttimeout</code> と <code class=\"language-text\">timeout</code> の違いが混乱しがちなのですが、以下の区別です。</p>\n<ul>\n<li>\n<p><code class=\"language-text\">ttimeout</code> : キーコードのタイムアウト</p>\n<ul>\n<li>入力文字の確定に対するタイムアウト</li>\n<li>流れ込んでくるバイト列を文字として判定するときに使われるタイムアウトなので、本来はとくに体感するようなタイムアウトではない</li>\n<li>Esc キーのような、後ろにバイト列が付くと別のキーになるキーの入力時に、確定するまでの待ちとして体感する</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">timeout</code> : マッピングのタイムアウト</p>\n<ul>\n<li>たとえばキーマッピングで <code class=\"language-text\">gg</code> と <code class=\"language-text\">g</code> を設定したとき、 <code class=\"language-text\">g</code> だけ入力してもマッピングは確定しない。マッピングを確定するまでのタイムアウト</li>\n</ul>\n</li>\n</ul>\n<h2>以上</h2>\n<p>Neovim のコードは C なので、初めて <code class=\"language-text\">gdb</code> を使ってがっつりデバッグしてみました。</p>\n<p>デバッガは IDE でしかやったことなかったのですが、意外となんとかなるもんですね。</p>\n<p>文字化けを言い訳にブログを滞らせていたので、更新再開します。なおってよかった。</p>","excerpt":"Neovim を使用していて日本語入力時の文字化けに長いこと苦しんでいたのですが、解決の目処が立ったのでブログに残しておきます。 日本語が普通に打てるって幸せ…！","frontmatter":{"date":"2017-07-08","title":"Neovim で日本語入力の確定時に文字化けする症状の直し方","tags":["Development","Neovim","Vim"],"eyecatch":null}}},"pageContext":{"urlPath":"/blog/neovim-fix-input-broken-ttimeout/","previous":{"fields":{"urlPath":"/blog/aws-ai-api-for-broadcast/"},"frontmatter":{"title":"AWS の AI 系 API を生放送に取り入れようとしてみた","date":"2017-07-05"}},"next":{"fields":{"urlPath":"/blog/cago-1-sync-pool/"},"frontmatter":{"title":"CA.go #1 で sync.Pool について喋りました #ca_go","date":"2017-07-17"}}}},"staticQueryHashes":["2432199166","277821901","3202776293"]}