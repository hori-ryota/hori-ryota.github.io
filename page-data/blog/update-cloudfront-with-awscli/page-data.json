{"componentChunkName":"component---src-templates-blog-jsx","path":"/blog/update-cloudfront-with-awscli/","result":{"data":{"markdownRemark":{"fields":{"urlPath":"/blog/update-cloudfront-with-awscli/"},"html":"<p>CloudFrontの設定をGUIでポチポチしていると大体ミスってうまく動かなかったりするんですよね。</p>\n<p>実はCloudFrontもAWS CLIを使ってコマンドラインから更新できるので、やり方をまとめました。</p>\n<!--more-->\n<h2>使うツール</h2>\n<p>インストールは以下のリンクから。</p>\n<ul>\n<li><a href=\"https://aws.amazon.com/jp/cli/\">AWS コマンドラインインターフェイス | AWS</a></li>\n<li><a href=\"https://stedolan.github.io/jq/\">jq</a></li>\n</ul>\n<h2>下準備（Previewを有効に）</h2>\n<p>AWS的にはAWS CLIのCloudFront設定はまだPreview版のようなのですが、とりあえず使えます。</p>\n<p>ただし、Preview版なので有効にするにはconfigを設定する必要があります。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws configure <span class=\"token builtin class-name\">set</span> preview.cloudfront <span class=\"token boolean\">true</span></code></pre></div>\n<p>上記のコマンドを実行することでAWS CLIでCloudFrontが有効になります。</p>\n<h2>Distribution設定ファイルを取得する</h2>\n<p>AWS CLIのCloudFrontでは各設定項目を個別に更新することはできず、Distributionの設定すべてを丸ごと更新します。</p>\n<p>まずは以下のコマンドでDistributionの設定をjsonで取得できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws cloudfront get-distribution --id <span class=\"token variable\">${DISTRIBUTION_ID}</span> <span class=\"token operator\">></span> src.json</code></pre></div>\n<p><code class=\"language-text\">${DISTRIBUTION_ID}</code> には更新したいCloudFrontのDistributionIdを入れてください。</p>\n<h2>Distribution設定ファイルのフォーマットを変換する</h2>\n<p>残念なことに、取得用のjsonと更新用のjsonはフォーマットが少し違います。</p>\n<p>なので <code class=\"language-text\">jq</code> コマンドを使ってフォーマットを変換します。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">jq -r <span class=\"token string\">'{ DistributionConfig: .Distribution.DistributionConfig, Id: .Distribution.Id, IfMatch: .ETag }'</span> <span class=\"token punctuation\">\\</span>\n    src.json <span class=\"token operator\">></span> dst.json</code></pre></div>\n<h2>Distribution設定ファイルを編集する</h2>\n<p>変換された <code class=\"language-text\">dst.json</code> を編集してください。</p>\n<p>一点注意ですが、 <code class=\"language-text\">Quantity</code> というプロパティは配列の要素数を示しています。配列の要素数が変わった際には併せて編集してください。</p>\n<p>update時にエラーが出るので怒られたら直すでもOKです。</p>\n<h2>CloudFrontに設定ファイルを反映する</h2>\n<p>コマンド一発です。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws cloudfront update-distribution --cli-input-json file://dst.json</code></pre></div>\n<p>このコマンドでDistributionの更新が走るので、GUIでの更新と同じく反映を待ってください。</p>\n<h2>以上</h2>\n<p>shellで設定を変更できるので、shell scriptでもぶん回せます。</p>\n<p><code class=\"language-text\">aws cloudfront list-distributions</code> と組み合わせて一括で更新するようにすれば、数十個のDistributionの更新も恐くない！</p>\n<p>GUIだとどうしても漏れが発生して、最悪の場合はサービスが全くアクセスできなくなるので、CUIで更新できるのは助かりますね。</p>\n<p>ほとんど同じ操作にはなるのですが、既存のDistribution設定を元に別Distributionを作成（複製）することもできるので、別記事で書きます。</p>\n<blockquote>\n<p>追記：</p>\n<p>書きました</p>\n<blockquote>\n<p><a href=\"/blog/create-cloudfront-with-awscli\">CloudFrontの設定をコマンドラインから作成する</a></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>追記2：</p>\n<p>一連のコマンドをスクリプト化して管理ツールっぽくしました</p>\n<blockquote>\n<p><a href=\"/blog/create-cloudfront-manager\">CloudFrontのawscliでjson管理できる環境を整備した</a></p>\n</blockquote>\n</blockquote>","excerpt":"CloudFrontの設定をGUIでポチポチしていると大体ミスってうまく動かなかったりするんですよね。 実はCloudFrontもAWS CLIを使ってコマンドラインから更新できるので、やり方をまとめました。","frontmatter":{"date":"2016-06-25","title":"CloudFrontの設定をコマンドラインから更新する","tags":["Development","Shell","AWS","CloudFront"],"eyecatch":null}}},"pageContext":{"urlPath":"/blog/update-cloudfront-with-awscli/","previous":{"fields":{"urlPath":"/blog/ffmpeg-mp4-part-to-silence-nosound-missing/"},"frontmatter":{"title":"FFmpegで動画の一部を無音にするときは音声を削除せずに無音データで埋めないとダメ","date":"2016-06-19"}},"next":{"fields":{"urlPath":"/blog/log4j-default-value/"},"frontmatter":{"title":"log4j.xmlでデフォルト値を設定する方法","date":"2016-07-09"}}}},"staticQueryHashes":["2432199166","277821901","3202776293"]}